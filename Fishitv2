-- ✅ Selalu tunggu game & kamera siap
if not game:IsLoaded() then game.Loaded:Wait() end
local Workspace = game:GetService("Workspace")
while not Workspace.CurrentCamera do task.wait() end

----------------------------------------------------------------
-- ================== UI LIBRARY (Polished v2 • FIX) ===========
----------------------------------------------------------------
local ACCENT      = Color3.fromRGB(110,175,255)
local ACCENT_TEXT = Color3.fromRGB(227,229,255)
local BG_DARK     = Color3.fromRGB(42,44,56)
local BG_CARD     = Color3.fromRGB(30,31,41)
local UIS         = game:GetService("UserInputService")
local TS          = game:GetService("TweenService")
local CoreGui     = game:GetService("CoreGui")

local function protect(inst) pcall(function() if syn and syn.protect_gui then syn.protect_gui(inst) end end) end
local function tw(o,t,props) local a=TS:Create(o,TweenInfo.new(t,Enum.EasingStyle.Quad,Enum.EasingDirection.Out),props); a:Play(); return a end

local library = {}
function library:CreateWindow(name, version, icon)
    name,version,icon = name or "AegisHub", version or "Premium", icon or 10044538000

    local Gui = Instance.new("ScreenGui")
    Gui.Name = "AegisHub_UIv2"
    Gui.IgnoreGuiInset = false
    Gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    Gui.ResetOnSpawn = false
    Gui.DisplayOrder = 9999
    protect(Gui)
    Gui.Parent = CoreGui

    local function calcScale()
        local cam = Workspace.CurrentCamera
        local vp = cam and cam.ViewportSize or Vector2.new(1280,720)
        local shortest = math.min(vp.X, vp.Y)
        if shortest <= 720 then return 0.85 elseif shortest <= 900 then return 0.92 else return 1 end
    end
    local SCALE = calcScale()

    -- Overlay (toggle + draggable)
    local Overlay = Instance.new("ImageButton")
    Overlay.Name="AegisHubOverlay"; Overlay.Parent=Gui
    Overlay.Size=UDim2.fromOffset(40,40); Overlay.AutoButtonColor=true
    Overlay.BackgroundColor3=Color3.fromRGB(32,34,46); Overlay.Image="rbxassetid://10045753138"; Overlay.ImageColor3=ACCENT
    local oc=Instance.new("UICorner",Overlay); oc.CornerRadius=UDim.new(1,0)
    local os=Instance.new("UIStroke",Overlay); os.Transparency=.85; os.Color=Color3.fromRGB(255,255,255)
    local cam = Workspace.CurrentCamera
    local ox = Gui:GetAttribute("ovx") or 12
    local oy = Gui:GetAttribute("ovy") or math.floor((cam.ViewportSize.Y/2)-20)
    Overlay.Position = UDim2.fromOffset(ox, oy)
    do
        local dragging, start, origin
        Overlay.InputBegan:Connect(function(i)
            if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then
                dragging=true; start=i.Position; origin=Overlay.Position
                i.Changed:Connect(function() if i.UserInputState==Enum.UserInputState.End then
                    dragging=false
                    Gui:SetAttribute("ovx", Overlay.Position.X.Offset)
                    Gui:SetAttribute("ovy", Overlay.Position.Y.Offset)
                end end)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then
                local d=i.Position-start
                local vp=Workspace.CurrentCamera.ViewportSize
                local nx = math.clamp(origin.X.Offset + d.X, 4, vp.X-44)
                local ny = math.clamp(origin.Y.Offset + d.Y, 4, vp.Y-44)
                Overlay.Position = UDim2.fromOffset(nx, ny)
            end
        end)
    end

    -- Window
    local Window = Instance.new("Frame")
    protect(Window); Window.Parent=Gui; Window.BackgroundColor3=BG_DARK; Window.ClipsDescendants=false
    Window.Size=UDim2.fromOffset(math.floor(520*SCALE), math.floor(340*SCALE))
    Window.Position=UDim2.new(.5, -Window.Size.X.Offset/2, .52, -Window.Size.Y.Offset/2)
    local wCorner=Instance.new("UICorner",Window); wCorner.CornerRadius=UDim.new(0,6)

    -- Title bar
    local Title=Instance.new("Frame",Window); Title.BackgroundTransparency=1; Title.Size=UDim2.new(1,0,0,math.floor(30*SCALE))
    local Icon=Instance.new("ImageLabel",Title); Icon.BackgroundTransparency=1; Icon.Size=UDim2.fromOffset(math.floor(18*SCALE),math.floor(18*SCALE))
    Icon.Position=UDim2.new(0,8,0,6); Icon.Image="rbxassetid://"..tostring(icon); Icon.ImageColor3=ACCENT
    local TitleText=Instance.new("TextLabel",Title); TitleText.BackgroundTransparency=1
    TitleText.Position=UDim2.new(0,30,0,0); TitleText.Size=UDim2.new(1,-30,1,0)
    TitleText.Font=Enum.Font.GothamMedium; TitleText.TextSize=math.floor(12*SCALE); TitleText.TextXAlignment=Enum.TextXAlignment.Left
    TitleText.TextColor3=Color3.new(1,1,1); TitleText.Text=("%s • %s"):format(name,version)
    local Under=Instance.new("Frame",Title); Under.BorderSizePixel=0; Under.BackgroundColor3=ACCENT
    Under.Size=UDim2.new(1,0,0,1); Under.Position=UDim2.new(0,0,1,0)

    -- Drag window
    do local dragging,start,origin
        Title.InputBegan:Connect(function(i)
            if (i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch) and not UIS:GetFocusedTextBox() then
                dragging=true; start=i.Position; origin=Window.Position
                i.Changed:Connect(function() if i.UserInputState==Enum.UserInputState.End then dragging=false end end)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then
                local d=i.Position-start; Window.Position=UDim2.new(origin.X.Scale,origin.X.Offset+d.X,origin.Y.Scale,origin.Y.Offset+d.Y)
            end
        end)
    end

    -- Overlay toggle
    local hidden=false
    Overlay.MouseButton1Click:Connect(function()
        hidden=not hidden; Window.Visible=not hidden
        tw(Overlay,.12,{ImageColor3 = hidden and Color3.fromRGB(200,200,200) or ACCENT})
    end)

    -- Tabs rail
    local TabsRail=Instance.new("Frame",Window); TabsRail.BackgroundColor3=Color3.fromRGB(39,40,51)
    TabsRail.Position=UDim2.new(0,6,0,math.floor(36*SCALE)); TabsRail.Size=UDim2.new(0,math.floor(136*SCALE),1,-math.floor(42*SCALE))
    local trc=Instance.new("UICorner",TabsRail); trc.CornerRadius=UDim.new(0,6)
    local trlbl=Instance.new("TextLabel",TabsRail); trlbl.BackgroundTransparency=1; trlbl.Size=UDim2.new(1,-8,0,math.floor(22*SCALE)); trlbl.Position=UDim2.new(0,8,0,0)
    trlbl.Font=Enum.Font.GothamBlack; trlbl.Text="Sections"; trlbl.TextSize=math.floor(11*SCALE); trlbl.TextXAlignment=Enum.TextXAlignment.Left; trlbl.TextColor3=Color3.new(1,1,1)
    local trlist=Instance.new("UIListLayout",TabsRail); trlist.Padding=UDim.new(0,math.floor(4*SCALE)); trlist.SortOrder=Enum.SortOrder.LayoutOrder; trlist.HorizontalAlignment=Enum.HorizontalAlignment.Right

    -- Tabs API
    local firstShown=false
    local TabsAPI={}
    function TabsAPI:CreateFrame(title)
        title = title or "Page"

        local Page=Instance.new("ScrollingFrame",Window)
        Page.Name="Page"; Page.Active=true; Page.ScrollBarThickness=4; Page.ScrollBarImageColor3=ACCENT
        Page.AutomaticCanvasSize=Enum.AutomaticSize.Y; Page.CanvasSize=UDim2.new(0,0,0,0)
        Page.BackgroundColor3=BG_DARK
        Page.Position=UDim2.new(0,math.floor(150*SCALE),0,math.floor(36*SCALE))
        Page.Size=UDim2.new(1,-math.floor(156*SCALE),1,-math.floor(42*SCALE))
        Page.Visible=false
        local pc=Instance.new("UICorner",Page); pc.CornerRadius=UDim.new(0,6)
        local pad=Instance.new("UIPadding",Page); pad.PaddingTop=UDim.new(0,math.floor(6*SCALE)); pad.PaddingLeft=UDim.new(0,math.floor(6*SCALE)); pad.PaddingRight=UDim.new(0,math.floor(6*SCALE)); pad.PaddingBottom=UDim.new(0,math.floor(6*SCALE))
        local vlist=Instance.new("UIListLayout",Page); vlist.Padding=UDim.new(0,math.floor(6*SCALE)); vlist.SortOrder=Enum.SortOrder.LayoutOrder; vlist.HorizontalAlignment=Enum.HorizontalAlignment.Center

        local TabBtn=Instance.new("TextButton",TabsRail); TabBtn.BackgroundTransparency=1
        TabBtn.Size=UDim2.new(1,-8,0,math.floor(18*SCALE)); TabBtn.Text=title; TabBtn.Font=Enum.Font.Gotham
        TabBtn.TextSize=math.floor(11*SCALE); TabBtn.TextColor3=Color3.new(1,1,1); TabBtn.TextTransparency=.5
        local indicator=Instance.new("Frame",TabBtn); indicator.BackgroundColor3=ACCENT; indicator.Size=UDim2.new(0,2,1,-4)
        indicator.Position=UDim2.new(0,-8,0,2); indicator.BorderSizePixel=0; indicator.Visible=false

        local function selectThis()
            -- sembunyikan semua page & indikator
            for _,v in ipairs(Window:GetChildren()) do
                if v:IsA("ScrollingFrame") and v.Name=="Page" then v.Visible=false end
            end
            for _,btn in ipairs(TabsRail:GetChildren()) do
                if btn:IsA("TextButton") then
                    btn.TextTransparency = .5
                    local ind = btn:FindFirstChildWhichIsA("Frame")
                    if ind then ind.Visible=false end
                end
            end
            -- tampilkan yang ini
            TabBtn.TextTransparency=0
            Page.Visible=true
            indicator.Visible=true
        end
        TabBtn.MouseButton1Click:Connect(selectThis)
        if not firstShown then firstShown=true; selectThis() end

        -- COMP: Card helper (untuk elemen berbaris rapi, otomatis memanjang ke bawah)
        local function Card(baseH)
            local fr=Instance.new("Frame",Page)
            fr.BackgroundColor3=BG_CARD
            fr.Size=UDim2.new(1,0,0,math.floor((baseH or 40)*SCALE))
            fr.AutomaticSize = Enum.AutomaticSize.Y
            fr.ClipsDescendants=false
            local c=Instance.new("UICorner",fr); c.CornerRadius=UDim.new(0,6)
            return fr
        end

        local PageAPI={}
        function PageAPI:CreateLabel(text)
            local lb = Instance.new("TextLabel")
            lb.Parent = Page
            lb.BackgroundTransparency = 1
            lb.Size = UDim2.new(1, -8, 0, math.floor(16 * SCALE))
            lb.Position = UDim2.new(0, 8, 0, 0)
            lb.Font = Enum.Font.GothamBlack
            lb.TextSize = math.floor(12 * SCALE)
            lb.TextXAlignment = Enum.TextXAlignment.Left
            lb.TextColor3 = Color3.new(1, 1, 1)
            lb.Text = string.upper(text or "LABEL")
            return { UpdateLabel=function(_,t) lb.Text=string.upper(t or "") end }
        end

        function PageAPI:CreateButton(name,desc,cb)
            cb=cb or function() end
            local fr=Card(40)
            local t=Instance.new("TextLabel",fr); t.BackgroundTransparency=1; t.Position=UDim2.new(0,8,0,2); t.Size=UDim2.new(1,-100,0,math.floor(18*SCALE))
            t.Font=Enum.Font.GothamBlack; t.TextSize=math.floor(12*SCALE); t.TextColor3=Color3.new(1,1,1); t.Text=string.upper(name or "BUTTON"); t.TextXAlignment=Enum.TextXAlignment.Left
            local d=Instance.new("TextLabel",fr); d.BackgroundTransparency=1; d.Position=UDim2.new(0,8,0,math.floor(20*SCALE)); d.Size=UDim2.new(1,-100,0,math.floor(16*SCALE))
            d.Font=Enum.Font.Gotham; d.TextSize=math.floor(11*SCALE); d.TextColor3=Color3.fromRGB(170,170,170); d.TextXAlignment=Enum.TextXAlignment.Left; d.Text=desc or ""
            local run=Instance.new("TextButton",fr); run.BackgroundColor3=Color3.fromRGB(24,25,32); run.Size=UDim2.new(0,84,0,24); run.Position=UDim2.new(1,-100,0,6)
            run.Text="RUN"; run.Font=Enum.Font.GothamSemibold; run.TextSize=math.floor(11*SCALE); run.TextColor3=Color3.new(1,1,1); local rc=Instance.new("UICorner",run); rc.CornerRadius=UDim.new(0,8)
            run.MouseButton1Click:Connect(cb)
            return {}
        end

        function PageAPI:CreateToggle(title,desc,cb)
            cb=cb or function() end
            local fr=Card(40)
            local t=Instance.new("TextLabel",fr); t.BackgroundTransparency=1; t.Position=UDim2.new(0,8,0,2); t.Size=UDim2.new(1,-70,0,math.floor(18*SCALE))
            t.Font=Enum.Font.GothamBlack; t.TextSize=math.floor(12*SCALE); t.TextColor3=Color3.new(1,1,1); t.Text=string.upper(title or "TOGGLE"); t.TextXAlignment=Enum.TextXAlignment.Left
            local d=Instance.new("TextLabel",fr); d.BackgroundTransparency=1; d.Position=UDim2.new(0,8,0,math.floor(20*SCALE)); d.Size=UDim2.new(1,-70,0,math.floor(16*SCALE))
            d.Font=Enum.Font.Gotham; d.TextSize=math.floor(11*SCALE); d.TextColor3=Color3.fromRGB(170,170,170); d.TextXAlignment=Enum.TextXAlignment.Left; d.Text=desc or ""
            local track=Instance.new("Frame",fr); track.BackgroundColor3=Color3.fromRGB(24,25,32); track.Size=UDim2.fromOffset(math.floor(50*SCALE),math.floor(22*SCALE)); track.Position=UDim2.new(1,-math.floor(62*SCALE),0,math.floor(8*SCALE)); local kc=Instance.new("UICorner",track); kc.CornerRadius=UDim.new(1,0)
            local dot=Instance.new("Frame",track); dot.Size=UDim2.fromOffset(math.floor(18*SCALE),math.floor(18*SCALE)); dot.Position=UDim2.new(0,math.floor(2*SCALE),0,math.floor(2*SCALE)); dot.BackgroundColor3=ACCENT; dot.BackgroundTransparency=.6; local dc=Instance.new("UICorner",dot); dc.CornerRadius=UDim.new(1,0)
            local btn=Instance.new("TextButton",fr); btn.BackgroundTransparency=1; btn.Size=UDim2.new(1,0,1,0); btn.Text=""
            local on=false
            local function apply()
                tw(dot,.12,{Position=on and UDim2.new(1,-math.floor(20*SCALE),0,math.floor(2*SCALE)) or UDim2.new(0,math.floor(2*SCALE),0,math.floor(2*SCALE)), BackgroundTransparency=on and 0 or .6})
                cb(on)
            end
            btn.MouseButton1Click:Connect(function() on=not on; apply() end)
            return { Set=function(_,v) if v~=on then on=v; apply() end end }
        end

        function PageAPI:CreateBox(placeholder,_,cb)
            cb=cb or function() end
            local fr=Card(32)
            local t=Instance.new("TextLabel",fr); t.BackgroundTransparency=1; t.Font=Enum.Font.GothamBlack; t.TextSize=math.floor(12*SCALE); t.TextColor3=Color3.fromRGB(200,205,230)
            t.Text=string.upper(placeholder or "INPUT"); t.TextXAlignment=Enum.TextXAlignment.Left; t.Position=UDim2.new(0,8,0,0); t.Size=UDim2.new(1,-8,0,18)
            local tb=Instance.new("TextBox",fr); tb.BackgroundColor3=Color3.fromRGB(24,25,32); tb.Position=UDim2.new(0,8,0,20); tb.Size=UDim2.new(1,-16,0,26)
            tb.ClearTextOnFocus=false; tb.Text=""; tb.Font=Enum.Font.Gotham; tb.TextSize=math.floor(11*SCALE); tb.TextColor3=Color3.new(1,1,1); tb.PlaceholderText=placeholder or ""; tb.PlaceholderColor3=ACCENT_TEXT; local c=Instance.new("UICorner",tb); c.CornerRadius=UDim.new(0,8)
            tb.FocusLost:Connect(function() cb(tb.Text) end)
            return { SetText=function(_,t2) tb.Text=t2 or "" end }
        end

        function PageAPI:CreateDropdown(title, options, onChanged)
            options=options or {}; onChanged=onChanged or function() end
            local fr=Card(28); fr.Name="Dropdown"
            local ttl=Instance.new("TextLabel",fr); ttl.BackgroundTransparency=1; ttl.Position=UDim2.new(0,8,0,0); ttl.Size=UDim2.new(1,-40,0,18)
            ttl.Font=Enum.Font.GothamBlack; ttl.TextSize=math.floor(12*SCALE); ttl.TextColor3=Color3.new(1,1,1); ttl.Text=string.upper(title)
            local caret=Instance.new("TextLabel",fr); caret.BackgroundTransparency=1; caret.Size=UDim2.fromOffset(math.floor(16*SCALE),math.floor(16*SCALE)); caret.Position=UDim2.new(1,-math.floor(24*SCALE),0,0)
            caret.Font=Enum.Font.GothamBlack; caret.Text="▼"; caret.TextSize=math.floor(11*SCALE); caret.TextColor3=ACCENT

            local holder=Instance.new("Frame",fr); holder.BackgroundColor3=Color3.fromRGB(26,26,32)
            holder.Position=UDim2.new(0,6,0,20); holder.Size=UDim2.new(1,-12,0,0)
            holder.AutomaticSize=Enum.AutomaticSize.Y; holder.Visible=false
            local lc=Instance.new("UICorner",holder); lc.CornerRadius=UDim.new(0,8)
            local lv=Instance.new("UIListLayout",holder); lv.Padding=UDim.new(0,4)
            local pad=Instance.new("UIPadding",holder); pad.PaddingTop=UDim.new(0,6); pad.PaddingBottom=UDim.new(0,6); pad.PaddingLeft=UDim.new(0,6); pad.PaddingRight=UDim.new(0,6)

            local current=nil
            local function rebuild(list)
                for _,c in ipairs(holder:GetChildren()) do if c:IsA("TextButton") then c:Destroy() end end
                for _,opt in ipairs(list) do
                    local b=Instance.new("TextButton",holder)
                    b.Size=UDim2.new(1,0,0,24); b.BackgroundColor3=BG_CARD
                    b.Text=opt; b.Font=Enum.Font.Gotham; b.TextSize=math.floor(11*SCALE); b.TextColor3=Color3.new(1,1,1)
                    local bc=Instance.new("UICorner",b); bc.CornerRadius=UDim.new(0,8)
                    b.MouseButton1Click:Connect(function()
                        current=opt; ttl.Text=string.upper(("%s : %s"):format(title,opt))
                        holder.Visible=false; tw(caret,.12,{Rotation=0})
                        onChanged(opt)
                    end)
                end
            end
            rebuild(options)

            local open=false
            local header=Instance.new("TextButton",fr); header.BackgroundTransparency=1; header.Size=UDim2.new(1,0,0,20); header.Position=UDim2.new(0,0,0,0); header.Text=""
            header.MouseButton1Click:Connect(function()
                open=not open; holder.Visible=open; tw(caret,.12,{Rotation=open and 180 or 0})
            end)

            return {
                SetValue=function(_,v) current=v; ttl.Text=string.upper(("%s : %s"):format(title,tostring(v))) end,
                GetValue=function() return current end,
                SetOptions=function(_,opts) rebuild(opts or {}) end
            }
        end

        return PageAPI
    end

    local winAPI={}
    function winAPI:CreateTab(title)
        -- return objek dengan method CreateFrame
        return setmetatable({}, { __index = TabsAPI }):CreateFrame(title or "Page")
    end

    return setmetatable({}, { __index = winAPI })
end

----------------------------------------------------------------
-- =============== DEMO: BIAR MENU PASTI MUNCUL ================
----------------------------------------------------------------
local UI = library:CreateWindow("AegisHub • Fish It","Premium",10044538000)

-- Buat dua tab contoh. Kamu bisa ganti/lanjutkan sesuai kebutuhan
local PageTP = UI -- CreateTab mengembalikan Page langsung (disederhanakan)
:CreateTab("Teleport")

local PageEvent = UI:CreateTab("Event")

-- (Tambahan tab Farm – tetap ADD, tidak mengubah yang di atas)
local PageFarm = UI:CreateTab("Farm")

-- Isi contoh komponen agar kelihatan
local coord = PageTP:CreateLabel("COORDINATES • X: 0  Y: 0  Z: 0")
PageTP:CreateDropdown("Teleport Island", {"Kohana","Coral Reefs","Crater Island"}, function(opt)
    print("Teleport to:", opt)
end)

PageEvent:CreateDropdown("Event Teleport", {"Shark Hunt","Worm Hunt","Meteor Rain"}, function(opt)
    print("Event:", opt)
end)

-- (Opsional) Update label posisi biar kelihatan hidup
local Players = game:GetService("Players")
local RS = game:GetService("RunService")
RS.RenderStepped:Connect(function()
    local plr = Players.LocalPlayer
    local ch = plr and plr.Character
    local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
    if hrp and coord and coord.UpdateLabel then
        local p = hrp.Position
        coord:UpdateLabel(
            ("COORDINATES • X: %.1f  Y: %.1f  Z: %.1f"):format(p.X,p.Y,p.Z):upper()
        )
    end
end)

----------------------------------------------------------------
-- ============================================================
-- ▼ Tambahan fitur (APPEND SAJA • tidak mengubah kode di atas)
-- ============================================================
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- ---------- Helper umum ----------
local function tpTo(pos: Vector3)
    if not pos then return end
    local plr = Players.LocalPlayer
    local ch  = plr and (plr.Character or plr.CharacterAdded:Wait())
    local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
    if hrp then
        hrp.CFrame = CFrame.new(pos + Vector3.new(0, 5, 0))
    end
end

-- ---------- TELEPORT: Island/NPC/Player ----------
local islands = {
    ["Weather Machine"]   = Vector3.new(-1471,-3,1929),
    ["Esoteric Depths"]   = Vector3.new(3157,-1303,1439),
    ["Tropical Grove"]    = Vector3.new(-2038,3,3650),
    ["Stingray Shores"]   = Vector3.new(-32,4,2773),
    ["Kohana Volcano"]    = Vector3.new(-519,24,189),
    ["Coral Reefs"]       = Vector3.new(-3095,1,2177),
    ["Crater Island"]     = Vector3.new(968,1,4854),
    ["Kohana"]            = Vector3.new(-658,3,719),
    ["Winter Fest"]       = Vector3.new(1611,4,3280),
    ["Esoteric Island"]   = Vector3.new(1987,4,1400),
    ["Treasure Room"]     = Vector3.new(-3600,-267,-1558),
    ["Lost Shore"]        = Vector3.new(-3663,38,-989),
    ["Sisyphus"]          = Vector3.new(-3792,-135,-986),
    ["Crystal Cavern"]    = Vector3.new(-2026,-440,7428),
    ["Halloween"]         = Vector3.new(2127,78,3334),
    ["Ancient Underground Cave"]  = Vector3.new(2102,-91,-709),
    ["Ancient Inside Temple"]     = Vector3.new(1506,-22,-641),
    ["Ancient Jungle"]            = Vector3.new(1268,78,-183),
    ["Fisherman Island"]          = Vector3.new(-3,17,2840),
}
local islandList = {}
for name in pairs(islands) do table.insert(islandList, name) end
table.sort(islandList)

-- Dropdown baru: island lengkap (tidak mengubah dropdown demo kamu)
local ddIslandFull = PageTP:CreateDropdown("Teleport Island (Full)", islandList, function(choice)
    tpTo(islands[choice])
end)

-- Scan NPC model/humanoid/prompt
local function scanNPC_Models()
    local found = {}
    for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and #m.Name >= 3 then
            local hasHum = m:FindFirstChildOfClass("Humanoid")
            local hasPrompt = false
            for _,d in ipairs(m:GetDescendants()) do
                if d:IsA("ProximityPrompt") then hasPrompt = true break end
            end
            if hasHum or hasPrompt then found[m.Name] = true end
        end
    end
    local list = {}
    for k in pairs(found) do table.insert(list, k) end
    table.sort(list)
    return list
end

-- Dropdown NPC (scan)
local ddNPC = PageTP:CreateDropdown("Teleport NPC (Scan)", scanNPC_Models(), function(nm)
    if not nm or nm == "" then return end
    local plr = Players.LocalPlayer
    local ch  = plr and (plr.Character or plr.CharacterAdded:Wait())
    local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local best,dist
    for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and string.find(string.lower(m.Name), string.lower(nm), 1, true) then
            local p = m:FindFirstChild("HumanoidRootPart") or m.PrimaryPart or m:FindFirstChildWhichIsA("BasePart")
            if p then
                local d = (p.Position - hrp.Position).Magnitude
                if not dist or d < dist then best = p; dist = d end
            end
        end
    end
    if best then tpTo(best.Position) end
end)

-- Dropdown Player (list dinamis)
local function playersList()
    local t = {}
    for _,pl in ipairs(Players:GetPlayers()) do
        if pl ~= Players.LocalPlayer then table.insert(t, pl.Name) end
    end
    table.sort(t)
    return t
end

local ddPlayer = PageTP:CreateDropdown("Teleport Player", playersList(), function(nm)
    local p = Players:FindFirstChild(nm)
    if p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
        tpTo(p.Character.HumanoidRootPart.Position)
    end
end)

-- Refresh berkala untuk NPC & Player dropdown
task.spawn(function()
    while true do
        task.wait(8)
        if ddNPC and ddNPC.SetOptions then ddNPC:SetOptions(scanNPC_Models()) end
        if ddPlayer and ddPlayer.SetOptions then ddPlayer:SetOptions(playersList()) end
    end
end)
Players.PlayerAdded:Connect(function() if ddPlayer and ddPlayer.SetOptions then ddPlayer:SetOptions(playersList()) end end)
Players.PlayerRemoving:Connect(function() if ddPlayer and ddPlayer.SetOptions then ddPlayer:SetOptions(playersList()) end end)

-- ---------- EVENT: Live teleport + Auto watcher ----------
local staticEvents = { "Admin Event","Shark Hunt","Ghost Shark Hunt","Worm Hunt","Black Hole","Shocked","Ghost Worm","Meteor Rain" }

local function discoverEvents()
    local set = {}
    local props = Workspace:FindFirstChild("Props")
    if props then
        for _,child in ipairs(props:GetChildren()) do
            if (child:IsA("Folder") or child:IsA("Model")) and #child.Name >= 3 then
                set[child.Name] = true
            end
        end
    end
    if next(set) == nil then
        for _,n in ipairs(staticEvents) do set[n] = true end
    end
    local list = {}
    for k in pairs(set) do table.insert(list, k) end
    table.sort(list)
    return list
end

local function tpToEventByName(evName: string)
    local props = Workspace:FindFirstChild("Props")
    if not props then return false,"Props missing" end
    local node  = props:FindFirstChild(evName)
    if not node then return false,"Event missing" end
    local boat  = node:FindFirstChild("Fishing Boat")
    if not boat then return false,"Boat missing" end
    local cf    = boat:GetPivot()
    local plr   = Players.LocalPlayer
    local ch    = plr and (plr.Character or plr.CharacterAdded:Wait())
    local hrp   = ch and ch:FindFirstChild("HumanoidRootPart")
    if not hrp then return false,"HRP missing" end
    hrp.CFrame  = cf + Vector3.new(0,15,0)
    return true
end

-- Dropdown event live (tidak mengganti dropdown demo kamu)
local ddEventLive = PageEvent:CreateDropdown("Event Teleport (Live)", discoverEvents(), function(option)
    local ok, why = tpToEventByName(option)
    if not ok then warn("Event Teleport gagal:", why) end
end)

-- Pilih target event untuk auto-teleport
local autoTarget = nil
local ddAutoTarget = PageEvent:CreateDropdown("Auto Event Target", discoverEvents(), function(opt)
    autoTarget = opt
end)

-- Status + Toggle auto
local lblEventStatus = PageEvent:CreateLabel("EVENT WATCH • IDLE")
local tglAuto = PageEvent:CreateToggle("Auto Teleport (Target)", "Teleport otomatis saat event target aktif", function(on)
    _G.__AUTO_EVT_ON = on
end)

-- Worker auto (scan tiap 2 detik)
task.spawn(function()
    while true do
        if _G.__AUTO_EVT_ON and autoTarget then
            local props = Workspace:FindFirstChild("Props")
            local jumped = false
            if props then
                local node = props:FindFirstChild(autoTarget)
                if node and node:FindFirstChild("Fishing Boat") then
                    local ok = tpToEventByName(autoTarget)
                    if ok then
                        jumped = true
                        if lblEventStatus and lblEventStatus.UpdateLabel then
                            lblEventStatus:UpdateLabel(("EVENT WATCH • TELEPORTED: %s"):format(string.upper(autoTarget)))
                        end
                    end
                end
            end
            if not jumped and lblEventStatus and lblEventStatus.UpdateLabel then
                lblEventStatus:UpdateLabel(("EVENT WATCH • WAITING: %s"):format(string.upper(tostring(autoTarget))))
            end
        end
        task.wait(2)
    end
end)

-- Refresh daftar event berkala untuk kedua dropdown event
task.spawn(function()
    while true do
        task.wait(8)
        local fresh = discoverEvents()
        if ddEventLive   and ddEventLive.SetOptions   then ddEventLive:SetOptions(fresh) end
        if ddAutoTarget  and ddAutoTarget.SetOptions  then ddAutoTarget:SetOptions(fresh) end
    end
end)

-- ---------- FARM: Auto Fishing / Perfect / Bypass / Sell / Favorite ----------
-- Anti AFK ringan
local VirtualUser = game:GetService("VirtualUser")
Players.LocalPlayer.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0,0), Workspace.CurrentCamera.CFrame)
    task.wait(0.7)
    VirtualUser:Button2Up(Vector2.new(0,0), Workspace.CurrentCamera.CFrame)
end)

-- net (sleitnick)
local net; pcall(function()
    net = ReplicatedStorage:WaitForChild("Packages")
        :WaitForChild("_Index")
        :WaitForChild("sleitnick_net@0.2.0")
        :WaitForChild("net")
end)

-- Remotes
local RF_Charge, RF_Start, RE_Completed, RE_Equip, RE_Text
pcall(function()
    RF_Charge     = net:WaitForChild("RF/ChargeFishingRod",5)
    RF_Start      = net:WaitForChild("RF/RequestFishingMinigameStarted",5)
    RE_Completed  = net:WaitForChild("RE/FishingCompleted",5)
    RE_Equip      = net:WaitForChild("RE/EquipToolFromHotbar",5)
    RE_Text       = net:WaitForChild("RE/ReplicateTextEffect",5)
end)

-- Animations
local character = Players.LocalPlayer.Character or Players.LocalPlayer.CharacterAdded:Wait()
local humanoid  = character:WaitForChild("Humanoid")
local animator  = humanoid:FindFirstChildOfClass("Animator") or Instance.new("Animator", humanoid)
local AIdle, AReel, ACast
pcall(function()
    local RodIdle = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Animations"):WaitForChild("FishingRodReelIdle")
    local RodReel = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Animations"):WaitForChild("EasyFishReelStart")
    local RodCast = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Animations"):WaitForChild("CastFromFullChargePosition1Hand")
    AIdle = animator:LoadAnimation(RodIdle)
    AReel = animator:LoadAnimation(RodReel)
    ACast = animator:LoadAnimation(RodCast)
end)

-- State & delay map (auto-detect + bypass)
local Flags = { AutoFish=false, PerfectCast=true, AutoSell=false, AutoFav=false }
local RodDelays = {
    ["Ares Rod"]={custom=1.12,bypass=1.45},
    ["Angler Rod"]={custom=1.12,bypass=1.45},
    ["Ghostfinn Rod"]={custom=1.12,bypass=1.45},
    ["Astral Rod"]={custom=1.90,bypass=1.45},
    ["Chrome Rod"]={custom=2.30,bypass=2.00},
    ["Steampunk Rod"]={custom=2.50,bypass=2.30},
    ["Lucky Rod"]={custom=3.50,bypass=3.60},
    ["Midnight Rod"]={custom=3.30,bypass=3.40},
    ["Demascus Rod"]={custom=3.90,bypass=3.80},
    ["Grass Rod"]={custom=3.80,bypass=3.90},
    ["Luck Rod"]={custom=4.20,bypass=4.10},
    ["Carbon Rod"]={custom=4.00,bypass=3.80},
    ["Lava Rod"]={custom=4.20,bypass=4.10},
    ["Starter Rod"]={custom=4.30,bypass=4.20},
}
local CastDelay, BypassDelay = 1.0, 0.50
local fishingActive=false

local function getEquippedRodName()
    local ok, display = pcall(function()
        return Players.LocalPlayer.PlayerGui:WaitForChild("Backpack",5):WaitForChild("Display",5)
    end)
    if not ok or not display then return nil end
    for _, tile in ipairs(display:GetChildren()) do
        local success, label = pcall(function() return tile.Inner.Tags.ItemName end)
        if success and label and label:IsA("TextLabel") then
            local name = label.Text
            if RodDelays[name] then return name end
        end
    end
    return nil
end

local function refreshDelays()
    local rod = getEquippedRodName()
    if rod and RodDelays[rod] then
        CastDelay  = RodDelays[rod].custom
        BypassDelay= RodDelays[rod].bypass
    else
        CastDelay  = 10
        BypassDelay= 1
    end
end

-- Fast-finish: dengar efek "Exclaim"
pcall(function()
    if RE_Text then
        RE_Text.OnClientEvent:Connect(function(d)
            if not (Flags.AutoFish and fishingActive) then return end
            if d and d.TextData and d.TextData.EffectType=="Exclaim" then
                task.spawn(function()
                    for _=1,3 do
                        task.wait(BypassDelay)
                        pcall(function() if RE_Completed then RE_Completed:FireServer() end end)
                    end
                end)
            end
        end)
    end
end)

local function castOnce()
    refreshDelays()
    fishingActive=true
    if RE_Equip then RE_Equip:FireServer(1) end
    task.wait(0.05)
    local tNow = Workspace:GetServerTimeNow()
    if ACast then ACast:Play() end
    if RF_Charge then RF_Charge:InvokeServer(tNow) end
    task.wait(0.15)
    pcall(function() if RF_Charge then RF_Charge:InvokeServer(Workspace:GetServerTimeNow()) end end)
    local bx,by = -0.7499996423721313, 1
    local x,y
    if Flags.PerfectCast then
        x = bx + (math.random(-500, 500) / 1e7)
        y = by + (math.random(-500, 500) / 1e7)
    else
        x = math.random(-1000,1000)/1000
        y = math.random(0,1000)/1000
    end
    if AIdle then AIdle:Play() end
    if RF_Start then RF_Start:InvokeServer(x,y) end
    task.wait(CastDelay)
    fishingActive=false
end

local function StartAutoFish()
    if Flags.AutoFish then return end
    Flags.AutoFish = true
    task.spawn(function()
        while Flags.AutoFish do
            pcall(function()
                castOnce()
            end)
            task.wait(0.05)
        end
    end)
end

local function StopAutoFish()
    Flags.AutoFish=false
    fishingActive=false
    pcall(function() if AIdle then AIdle:Stop() end end)
    pcall(function() if AReel then AReel:Stop() end end)
    pcall(function() if ACast then ACast:Stop() end end)
end

-- Optional: Replion & ItemUtility untuk sell/favorite
local Replion, ItemUtility
task.spawn(function()
    local okRp,modRp=pcall(function() return require(ReplicatedStorage:WaitForChild("Packages"):WaitForChild("replion")) end)
    if okRp then Replion=modRp end
    local okU,modU=pcall(function() return require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("ItemUtility")) end)
    if okU then ItemUtility=modU end
end)

-- Auto Sell / Auto Favorite
local lastSell = 0
local SELL_THRESHOLD = 60
local SELL_COOLDOWN = 60
local function startAutoSell()
    task.spawn(function()
        while Flags.AutoSell do
            pcall(function()
                if not Replion then return end
                local Data = Replion.Client:WaitReplion("Data")
                local items = Data and Data:Get({"Inventory","Items"})
                if type(items)~="table" then return end
                local unfav=0
                for _,it in ipairs(items) do if not it.Favorited then unfav += (it.Count or 1) end end
                if unfav >= SELL_THRESHOLD and os.time()-lastSell >= SELL_COOLDOWN then
                    local SellAll = net and net:FindFirstChild("RF/SellAllItems")
                    if SellAll then pcall(function() SellAll:InvokeServer() end); lastSell=os.time() end
                end
            end)
            task.wait(10)
        end
    end)
end

local keepTiers = { Secret=true, Mythic=true, Legendary=true }
local function startAutoFavorite()
    task.spawn(function()
        while Flags.AutoFav do
            pcall(function()
                if not (Replion and ItemUtility) then return end
                local Data = Replion.Client:WaitReplion("Data")
                local items = Data and Data:Get({"Inventory","Items"})
                if type(items)~="table" then return end
                for _,it in ipairs(items) do
                    local base = ItemUtility:GetItemData(it.Id)
                    local tier = base and base.Data and base.Data.Tier
                    if tier and keepTiers[tier] and not it.Favorited then it.Favorited=true end
                end
            end)
            task.wait(6)
        end
    end)
end

-- ---------- UI: FARM MENU ----------
PageFarm:CreateToggle("Auto Fishing","Loop otomatis memancing (rod auto-detect delay)", function(on)
    if on then StartAutoFish() else StopAutoFish() end
end)

PageFarm:CreateToggle("Perfect Cast","Akurasi lemparan sangat presisi", function(on)
    Flags.PerfectCast = on
end)

PageFarm:CreateBox("Bypass Delay Override (ex: 1.45)", nil, function(txt)
    local n = tonumber(txt); if n then BypassDelay = math.max(0.05, n) end
end)

PageFarm:CreateToggle("Auto Sell Fish","Jual otomatis non-favorite saat jumlah banyak", function(on)
    Flags.AutoSell = on; if on then startAutoSell() end
end)

PageFarm:CreateBox("Sell Threshold (default 60)", nil, function(txt)
    local n = tonumber(txt); if n then SELL_THRESHOLD = math.max(1, math.floor(n)) end
end)

PageFarm:CreateToggle("Auto Favorite (Secret/Mythic/Legendary)","Favorit agar tidak terjual", function(on)
    Flags.AutoFav = on; if on then startAutoFavorite() end
end)
