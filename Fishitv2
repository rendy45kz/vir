--== AegisHub UI Adapter: Cerberus → (fallback) Rayfield =======================
local function try(fn, ...)
    local ok, res = pcall(fn, ...)
    return ok and res or nil
end

local function load_cerberus()
    local CERB_URL = "https://raw.githubusercontent.com/weakhoes/Roblox-UI-Libs/refs/heads/main/Cerberus%20Lib/Cerberus%20Lib%20Source.lua"
    return try(function()
        local lib = loadstring(game:HttpGet(CERB_URL, true))()
        return lib
    end)
end

local function load_rayfield()
    -- dua sumber umum Rayfield (pilih yang hidup di perangkatmu)
    return try(function()
        return loadstring(game:HttpGet("https://sirius.menu/rayfield", true))()
    end) or try(function()
        return loadstring(game:HttpGet("https://raw.githubusercontent.com/shlexware/Rayfield/main/source", true))()
    end)
end

-- Buat compat layer agar kode lama kamu tetap sama apa pun lib-nya
local function make_adapter()
    local cerb = load_cerberus()
    if cerb then
        -- Cari ctor window yang valid
        local createWindow =
              cerb.CreateWindow or cerb.NewWindow or cerb.Window or cerb.new or cerb.Create

        -- Uji coba bikin window kecil dulu untuk cek API
        if createWindow then
            local window = try(function()
                return createWindow({
                    Title = "AegisHub • Fish It",
                    Size  = UDim2.fromOffset(560, 360), -- kecil & muat di Android
                    Theme = { Accent = Color3.fromRGB(170,150,255) } -- aksen elegan
                })
            end)

            if window then
                -- Pemetaan umum fungsi Tab/Controls (nama bisa beda-beda antar fork)
                local mkTab   = window.CreateTab or window.Tab or window.AddTab
                local mkLbl   = window.CreateLabel or window.Label or window.AddLabel
                local mkTgl   = window.CreateToggle or window.Toggle or window.AddToggle
                local mkBtn   = window.CreateButton or window.Button or window.AddButton
                local mkIn    = window.CreateInput or window.Input or window.AddInput or window.Textbox
                local mkDrop  = window.CreateDropdown or window.Dropdown or window.AddDropdown

                local UI = {}
                function UI:CreateTab(name)
                    return mkTab(window, name) or mkTab(name) or mkTab({Name = name})
                end
                function UI:CreateLabel(tab, text)
                    return (mkLbl(tab, text) or mkLbl(tab, {Text = text}) or mkLbl(text))
                end
                function UI:CreateToggle(tab, opt)
                    -- opt = {Name, CurrentValue, Callback}
                    return mkTgl(tab, opt.Name, opt.CurrentValue, opt.Callback)
                           or mkTgl(tab, opt)
                end
                function UI:CreateButton(tab, opt)
                    return mkBtn(tab, opt.Name, opt.Callback) or mkBtn(tab, opt)
                end
                function UI:CreateInput(tab, opt)
                    -- sebagian lib pakai (tab, name, default, cb)
                    return mkIn(tab, opt.Name, opt.PlaceholderText or "", opt.Callback)
                           or mkIn(tab, opt)
                end
                function UI:CreateDropdown(tab, opt)
                    -- (tab, name, options, default, multi, cb)
                    return mkDrop(tab, opt.Name, opt.Options, (type(opt.CurrentOption)=="table" and opt.CurrentOption[1]) or opt.CurrentOption, opt.MultipleOptions, opt.Callback)
                           or mkDrop(tab, opt)
                end
                function UI:Notify(title, content)
                    if window.Notify then window:Notify(title, content) end
                end
                UI.__type = "cerberus"
                UI._window = window
                return UI
            end
        end
    end

    -- Fallback ke Rayfield (API stabil)
    local ray = load_rayfield()
    if not ray then
        return nil
    end
    local window = ray:CreateWindow({
        Name = "AegisHub • Fish It",
        Icon = 0,
        LoadingTitle = "AegisHub",
        LoadingSubtitle = "Fish It",
        Theme = "Default",
        DisableRayfieldPrompts = true,
        DisableBuildWarnings = true,
        ConfigurationSaving = {Enabled = false, FileName = "AegisHub_FishIt"},
        Discord = {Enabled = false},
        KeySystem = false
    })
    local UI = {}
    function UI:CreateTab(name) return window:CreateTab(name) end
    function UI:CreateLabel(tab, text) return tab:CreateLabel(text) end
    function UI:CreateToggle(tab, opt) return tab:CreateToggle(opt) end
    function UI:CreateButton(tab, opt) return tab:CreateButton(opt) end
    function UI:CreateInput(tab, opt)  return tab:CreateInput(opt) end
    function UI:CreateDropdown(tab, opt) return tab:CreateDropdown(opt) end
    function UI:Notify(t,c) if ray.Notify then ray:Notify({Title=t, Content=c, Duration=5}) end end
    UI.__type = "rayfield"
    UI._window = window
    return UI
end

-- ==== Pakai adapter untuk membangun UI kamu (TIDAK UBAH LOGIKA LAIN) =====
local UI = make_adapter()
if not UI then
    warn("[AegisHub] Gagal memuat Cerberus & Rayfield. Cek koneksi/SSL Delta.")
else
    -- Bangun tab yang kamu perlukan persis seperti sebelumnya:
    local TabMain = UI:CreateTab("Main")
    local TabInv  = UI:CreateTab("Inventory")
    local TabTP   = UI:CreateTab("Teleport")
    local TabMisc = UI:CreateTab("Misc")

    -- Label status
    local StatusLabel
    if UI.__type == "rayfield" then
        StatusLabel = TabMain:CreateLabel("Rod: ?  |  Reel: -  |  Cmpl: -  |  Spd: 5x")
    else
        StatusLabel = UI:CreateLabel(TabMain, "Rod: ?  |  Reel: -  |  Cmpl: -  |  Spd: 5x")
    end
    local function setStatusText(t)
        if UI.__type == "rayfield" and StatusLabel and StatusLabel.Set then
            StatusLabel:Set(t)
        elseif StatusLabel and StatusLabel.Text then
            StatusLabel.Text = t
        end
    end

    -- === Main ===
    UI:CreateToggle(TabMain, {
        Name = "Auto Fish (per-rod)",
        CurrentValue = false,
        Callback = function(v) if v then StartAutoFish() else StopAutoFish() end end
    })
    UI:CreateToggle(TabMain, {
        Name = "Perfect Cast",
        CurrentValue = true,
        Callback = function(v) state.perfectCast = v end
    })
    UI:CreateInput(TabMain, {
        Name = "Speed x (1–5)",
        PlaceholderText = "5",
        Callback = function(txt)
            local n = tonumber(txt) or 5
            state.SPEED = math.clamp(math.floor(n+0.5), 1, 5)
            if UI.Notify then UI:Notify("Speed", "Set ke x"..state.SPEED) end
        end
    })
    UI:CreateInput(TabMain, {
        Name = "Reel Delay (opsional)",
        PlaceholderText = "1.45",
        Callback = function(t) state.reelOverride = tonumber(t) end
    })
    UI:CreateInput(TabMain, {
        Name = "Complete Delay (opsional)",
        PlaceholderText = "3.20",
        Callback = function(t) state.completeOverride = tonumber(t) end
    })

    -- === Inventory ===
    UI:CreateToggle(TabInv, {
        Name = "Auto Sell",
        CurrentValue = false,
        Callback = function(v) state.AutoSell.on = v end
    })
    UI:CreateInput(TabInv, {
        Name = "Threshold Auto Sell",
        PlaceholderText = "60",
        Callback = function(t) local n=tonumber(t); if n then state.AutoSell.threshold = math.max(1, math.floor(n)) end end
    })
    UI:CreateButton(TabInv, { Name = "Protect High Tiers", Callback = function()
        state.protectTiers.Legendary = true; state.protectTiers.Mythic = true; state.protectTiers.Secret = true
        if protectByTiers then protectByTiers() end
    end})
    UI:CreateButton(TabInv, { Name = "Sell Non-Favorite", Callback = function()
        if sellAllNonFav then sellAllNonFav() end
    end})

    -- === Teleport ===
    local islandCoords = {
        ["Weather Machine"]=Vector3.new(-1471,-3,1929),["Esoteric Depths"]=Vector3.new(3157,-1303,1439),
        ["Tropical Grove"]=Vector3.new(-2038,3,3650),["Stingray Shores"]=Vector3.new(-32,4,2773),
        ["Kohana Volcano"]=Vector3.new(-519,24,189),["Coral Reefs"]=Vector3.new(-3095,1,2177),
        ["Crater Island"]=Vector3.new(968,1,4854),["Kohana"]=Vector3.new(-658,3,719),
        ["Winter Fest"]=Vector3.new(1611,4,3280),["Isoteric Island"]=Vector3.new(1987,4,1400),
        ["Treasure Hall"]=Vector3.new(-3600,-267,-1558),["Lost Shore"]=Vector3.new(-3663,38,-989),
        ["Sishypus Statue"]=Vector3.new(-3792,-135,-986),
    }
    local tpNames = {}; for n,_ in pairs(islandCoords) do table.insert(tpNames, n) end; table.sort(tpNames)
    local curOpt = tpNames[1]
    UI:CreateDropdown(TabTP, {
        Name = "Lokasi",
        Options = tpNames,
        CurrentOption = curOpt,
        MultipleOptions = false,
        Callback = function(opt) curOpt = type(opt) == "table" and opt[1] or opt end
    })
    UI:CreateButton(TabTP, {
        Name = "Teleport",
        Callback = function()
            local pos = islandCoords[curOpt]
            local charFolder = workspace:FindFirstChild("Characters")
            local char = charFolder and charFolder:FindFirstChild(Players.LocalPlayer.Name)
            local hrp = char and (char:FindFirstChild("HumanoidRootPart") or char:WaitForChild("HumanoidRootPart",2))
            if hrp and pos then hrp.CFrame = CFrame.new(pos + Vector3.new(0,5,0)) end
        end
    })

    -- === Misc ===
    UI:CreateToggle(TabMisc, { Name="Anti-AFK", CurrentValue=true,  Callback=function(v) if v then setAntiAFK(true) else setAntiAFK(false) end end })
    UI:CreateToggle(TabMisc, { Name="FPS Boost", CurrentValue=false, Callback=function(v) if v then BoostFPS(true) end end })
    UI:CreateButton(TabMisc, { Name="Rejoin", Callback=function() TeleportService:Teleport(game.PlaceId, Players.LocalPlayer) end })
    UI:CreateButton(TabMisc, { Name="Server Hop", Callback=function()
        local HttpService = game:GetService("HttpService")
        local placeId = game.PlaceId
        local servers, cursor = {}, ""
        for _=1,3 do
            local url = "https://games.roblox.com/v1/games/"..placeId.."/servers/Public?sortOrder=Asc&limit=100"..(cursor~="" and("&cursor="..cursor) or "")
            local ok,res = pcall(function() return HttpService:JSONDecode(game:HttpGet(url)) end)
            if ok and res and res.data then
                for _,sv in ipairs(res.data) do
                    if sv.playing < sv.maxPlayers and sv.id ~= game.JobId then table.insert(servers, sv.id) end
                end
                cursor = res.nextPageCursor or ""
                if #servers > 0 then break end
            else break end
        end
        if #servers > 0 then
            TeleportService:TeleportToPlaceInstance(placeId, servers[math.random(1,#servers)], Players.LocalPlayer)
        end
    end})

    -- ====== Live status sinkron dengan label (rod/delay/speed) ======
    local function effDelays()
        local function clamp(n,a,b) if n<a then return a elseif n>b then return b else return n end end
        local c=(state.completeOverride or state.completePreset)/state.SPEED
        local r=(state.reelOverride or state.reelPreset)/state.SPEED
        return clamp(c,0.35,12), clamp(r,0.15,6)
    end
    local function getRod()
        local pg = Players.LocalPlayer:FindFirstChild("PlayerGui")
        local display = pg and pg:FindFirstChild("Backpack") and pg.Backpack:FindFirstChild("Display")
        if not display then return nil end
        for _,tile in ipairs(display:GetChildren()) do
            local ok,lbl = pcall(function() return tile.Inner and tile.Inner.Tags and tile.Inner.Tags.ItemName end)
            if ok and lbl and lbl:IsA("TextLabel") then return lbl.Text end
        end
        return "?"
    end
    game:GetService("RunService").RenderStepped:Connect(function()
        local rod = getRod() or "?"
        local cEff, rEff = effDelays()
        setStatusText(("Rod: %s  |  Reel: %.2fs  |  Cmpl: %.2fs  |  Spd: %dx"):format(rod, rEff, cEff, state.SPEED))
    end)
end
--=============================================================================
