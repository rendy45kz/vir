--========================================================
-- AegisHub • Fish It (Vanis UI • Clean Build)
-- Menu: Farm (Auto Fish V2, Perfect Cast, Bypass Delay, Auto Sell, Auto Favorite)
--       Teleport (Island, NPC, Player)
-- Android/Delta friendly • Plug & Play
--========================================================
if not game:IsLoaded() then game.Loaded:Wait() end

-- ========== Services ==========
local Players            = game:GetService("Players")
local RS                 = game:GetService("RunService")
local ReplicatedStorage  = game:GetService("ReplicatedStorage")
local UIS                = game:GetService("UserInputService")
local TeleportService    = game:GetService("TeleportService")
local LocalPlayer        = Players.LocalPlayer
local Workspace          = game:GetService("Workspace")
local VirtualUser        = game:GetService("VirtualUser")

-- ========== Anti AFK ==========
LocalPlayer.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0,0), Workspace.CurrentCamera and Workspace.CurrentCamera.CFrame or CFrame.new())
    task.wait(0.7)
    VirtualUser:Button2Up(Vector2.new(0,0), Workspace.CurrentCamera and Workspace.CurrentCamera.CFrame or CFrame.new())
end)

-- ========== Load Vanis UI ==========
local UI_URL = "https://raw.githubusercontent.com/rendy45kz/vir/main/guilibs.lua"
local library
do
    local ok, lib = pcall(function() return loadstring(game:HttpGet(UI_URL))() end)
    if not ok then
        warn("UI load failed: ", lib)
        return error("Gagal memuat UI. Coba jalankan ulang atau cek koneksi.")
    end
    library = lib
end

-- ========== NET/Remotes ==========
local net; pcall(function()
    net = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
        :WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net")
end)

local RF_Charge, RF_Start, RE_Completed, RE_Equip, RE_Text
pcall(function()
    RF_Charge     = net and net:WaitForChild("RF/ChargeFishingRod",10)
    RF_Start      = net and net:WaitForChild("RF/RequestFishingMinigameStarted",10)
    RE_Completed  = net and net:WaitForChild("RE/FishingCompleted",10)
    RE_Equip      = net and net:WaitForChild("RE/EquipToolFromHotbar",10)
    RE_Text       = net and net:WaitForChild("RE/ReplicateTextEffect",10)
end)

-- ========== Animations ==========
local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local humanoid  = character:WaitForChild("Humanoid")
local animator  = humanoid:FindFirstChildOfClass("Animator") or Instance.new("Animator", humanoid)

local AIdle, AReel, ACast
pcall(function()
    local RodIdle = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Animations"):WaitForChild("FishingRodReelIdle")
    local RodReel = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Animations"):WaitForChild("EasyFishReelStart")
    local RodCast = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Animations"):WaitForChild("CastFromFullChargePosition1Hand")
    AIdle = animator:LoadAnimation(RodIdle)
    AReel = animator:LoadAnimation(RodReel)
    ACast = animator:LoadAnimation(RodCast)
end)

-- ========== State & Logic ==========
local Flags = { AutoFish=false, PerfectCast=true, AutoSell=false, AutoFav=false }
local CastDelay, BypassDelay = 1.0, 1.45
local fishingActive=false

local RodDelays = {
    ["Ares Rod"]={custom=1.12,bypass=1.45},
    ["Angler Rod"]={custom=1.12,bypass=1.45},
    ["Ghostfinn Rod"]={custom=1.12,bypass=1.45},
    ["Astral Rod"]={custom=1.90,bypass=1.45},
    ["Chrome Rod"]={custom=2.30,bypass=2.00},
    ["Steampunk Rod"]={custom=2.50,bypass=2.30},
    ["Lucky Rod"]={custom=3.50,bypass=3.60},
    ["Midnight Rod"]={custom=3.30,bypass=3.40},
    ["Demascus Rod"]={custom=3.90,bypass=3.80},
    ["Grass Rod"]={custom=3.80,bypass=3.90},
    ["Luck Rod"]={custom=4.20,bypass=4.10},
    ["Carbon Rod"]={custom=4.00,bypass=3.80},
    ["Lava Rod"]={custom=4.20,bypass=4.10},
    ["Starter Rod"]={custom=4.30,bypass=4.20},
}

local function getEquippedRodName()
    local ok, display = pcall(function()
        return LocalPlayer.PlayerGui:WaitForChild("Backpack",5):WaitForChild("Display",5)
    end)
    if not ok or not display then return nil end
    for _, tile in ipairs(display:GetChildren()) do
        local success, label = pcall(function() return tile.Inner.Tags.ItemName end)
        if success and label and label:IsA("TextLabel") then
            local name = label.Text
            if RodDelays[name] then return name end
        end
    end
    return nil
end

local function refreshDelays()
    local rod = getEquippedRodName()
    if rod and RodDelays[rod] then
        CastDelay  = RodDelays[rod].custom
        BypassDelay= RodDelays[rod].bypass
    else
        CastDelay  = 10
        BypassDelay= 1
    end
end

pcall(function()
    if RE_Text then
        RE_Text.OnClientEvent:Connect(function(d)
            if not (Flags.AutoFish and fishingActive) then return end
            if d and d.TextData and d.TextData.EffectType=="Exclaim" then
                task.spawn(function()
                    for _=1,3 do
                        task.wait(BypassDelay)
                        pcall(function() if RE_Completed then RE_Completed:FireServer() end end)
                    end
                end)
            end
        end)
    end
end)

local function castOnce()
    refreshDelays()
    fishingActive=true
    if RE_Equip then RE_Equip:FireServer(1) end
    task.wait(0.05)

    local tNow = Workspace:GetServerTimeNow()
    if ACast then ACast:Play() end
    if RF_Charge then RF_Charge:InvokeServer(tNow) end
    task.wait(0.15)
    pcall(function() if RF_Charge then RF_Charge:InvokeServer(Workspace:GetServerTimeNow()) end end)

    local bx,by = -0.7499996423721313, 1
    local x,y
    if Flags.PerfectCast then
        x = bx + (math.random(-500, 500) / 1e7)
        y = by + (math.random(-500, 500) / 1e7)
    else
        x = math.random(-1000,1000)/1000
        y = math.random(0,1000)/1000
    end
    if AIdle then AIdle:Play() end
    if RF_Start then RF_Start:InvokeServer(x,y) end

    task.wait(CastDelay)
    fishingActive=false
end

local function StartAutoFish()
    if Flags.AutoFish then return end
    Flags.AutoFish = true
    task.spawn(function()
        while Flags.AutoFish do
            pcall(function() castOnce() end)
            task.wait(0.05)
        end
    end)
end

local function StopAutoFish()
    Flags.AutoFish=false
    fishingActive=false
    pcall(function() if AIdle then AIdle:Stop() end end)
    pcall(function() if AReel then AReel:Stop() end end)
    pcall(function() if ACast then ACast:Stop() end end)
end

-- Replion & ItemUtility
local Replion, ItemUtility
task.spawn(function()
    local okRp,modRp=pcall(function() return require(ReplicatedStorage:WaitForChild("Packages"):WaitForChild("replion")) end)
    if okRp then Replion=modRp end
    local okU,modU=pcall(function() return require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("ItemUtility")) end)
    if okU then ItemUtility=modU end
end)

-- Auto Sell / Auto Favorite
local lastSell = 0
local SELL_THRESHOLD = 60
local SELL_COOLDOWN = 60

local function startAutoSell()
    task.spawn(function()
        while Flags.AutoSell do
            pcall(function()
                if not (net and Replion) then return end
                local Data = Replion.Client:WaitReplion("Data")
                local items = Data and Data:Get({"Inventory","Items"})
                if type(items)~="table" then return end
                local unfav=0
                for _,it in ipairs(items) do if not it.Favorited then unfav += (it.Count or 1) end end
                if unfav >= SELL_THRESHOLD and os.time()-lastSell >= SELL_COOLDOWN then
                    local SellAll = net:FindFirstChild("RF/SellAllItems")
                    if SellAll then pcall(function() SellAll:InvokeServer() end); lastSell=os.time() end
                end
            end)
            task.wait(10)
        end
    end)
end

local keepTiers = { Secret=true, Mythic=true, Legendary=true }
local function startAutoFavorite()
    task.spawn(function()
        while Flags.AutoFav do
            pcall(function()
                if not (Replion and ItemUtility) then return end
                local Data = Replion.Client:WaitReplion("Data")
                local items = Data and Data:Get({"Inventory","Items"})
                if type(items)~="table" then return end
                for _,it in ipairs(items) do
                    local base = ItemUtility:GetItemData(it.Id)
                    local tier = base and base.Data and base.Data.Tier
                    if tier and keepTiers[tier] and not it.Favorited then it.Favorited=true end
                end
            end)
            task.wait(6)
        end
    end)
end

-- ========== Teleport Helpers ==========
local function tpTo(pos)
    if not pos then return end
    local ch  = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
    if hrp then hrp.CFrame = CFrame.new(pos + Vector3.new(0,5,0)) end
end

local islands = {
    ["Weather Machine"]   = Vector3.new(-1471,-3,1929),
    ["Esoteric Depths"]   = Vector3.new(3157,-1303,1439),
    ["Tropical Grove"]    = Vector3.new(-2038,3,3650),
    ["Stingray Shores"]   = Vector3.new(-32,4,2773),
    ["Kohana Volcano"]    = Vector3.new(-519,24,189),
    ["Coral Reefs"]       = Vector3.new(-3095,1,2177),
    ["Crater Island"]     = Vector3.new(968,1,4854),
    ["Kohana"]            = Vector3.new(-658,3,719),
    ["Winter Fest"]       = Vector3.new(1611,4,3280),
    ["Esoteric Island"]   = Vector3.new(1987,4,1400),
    ["Treasure Room"]     = Vector3.new(-3600,-267,-1558),
    ["Lost Shore"]        = Vector3.new(-3663,38,-989),
    ["Sisyphus"]          = Vector3.new(-3792,-135,-986),
    ["Crystal Cavern"]    = Vector3.new(-2026,-440,7428),
    ["Halloween"]         = Vector3.new(2127,78,3334),
    ["Ancient Underground Cave"]  = Vector3.new(2102,-91,-709),
    ["Ancient Inside Temple"]     = Vector3.new(1506,-22,-641),
    ["Ancient Jungle"]            = Vector3.new(1268,78,-183),
    ["Fisherman Island"]          = Vector3.new(-3,17,2840),
}
local islandList = {} for n in pairs(islands) do table.insert(islandList, n) end table.sort(islandList)

local function scanNPC_Models()
    local found = {}
    for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and #m.Name >= 3 then
            local hasHum = m:FindFirstChildOfClass("Humanoid")
            local hasPrompt = false
            for _,d in ipairs(m:GetDescendants()) do
                if d:IsA("ProximityPrompt") then hasPrompt = true break end
            end
            if hasHum or hasPrompt then found[m.Name] = true end
        end
    end
    local list = {}; for k in pairs(found) do table.insert(list, k) end
    table.sort(list); return list
end

local function playersList()
    local t = {}
    for _,pl in ipairs(Players:GetPlayers()) do
        if pl ~= LocalPlayer then table.insert(t, pl.Name) end
    end
    table.sort(t); return t
end

-- ========== BUILD UI ==========
local win  = library:CreateWindow("AegisHub • Fish It","Premium",10044538000)

-- FARM PAGE
local TabFarm  = win:CreateTab("Farm")
local PageFarm = TabFarm:CreateFrame("Farm")

PageFarm:CreateLabel("FARMING")

PageFarm:CreateToggle("Auto Fish V2 (Optimized)","Otomatis memancing (rod auto-detect)", function(on)
    if on then StartAutoFish() else StopAutoFish() end
end)

PageFarm:CreateToggle("Auto Perfect Cast","Usahakan selalu perfect", function(on)
    Flags.PerfectCast = on
end)

PageFarm:CreateBox("Bypass Delay (ex: 1.45)", nil, function(txt)
    local n = tonumber(txt); if n then BypassDelay = math.max(0.05, n) end
end)

PageFarm:CreateToggle("Auto Sell Fish","Jual otomatis saat non-favorite mencapai ambang", function(on)
    Flags.AutoSell = on; if on then startAutoSell() end
end)

PageFarm:CreateBox("Sell Threshold (default 60)", nil, function(txt)
    local n = tonumber(txt); if n then SELL_THRESHOLD = math.max(1, math.floor(n)) end
end)

PageFarm:CreateToggle("Auto Favorite Fish","Favoritkan Secret/Mythic/Legendary", function(on)
    Flags.AutoFav = on; if on then startAutoFavorite() end
end)

-- TELEPORT PAGE
local TabTP  = win:CreateTab("Teleport")
local PageTP = TabTP:CreateFrame("Teleport")

local coord = PageTP:CreateLabel("COORDINATES • X: 0.0  Y: 0.0  Z: 0.0")

local ddIsland = PageTP:CreateDropdown("Teleport Island", islandList, function(choice)
    tpTo(islands[choice])
end)

local ddNPC = PageTP:CreateDropdown("Teleport NPC (Scan)", scanNPC_Models(), function(name)
    if not name or name=="" then return end
    local ch  = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp = ch and ch:FindFirstChild("HumanoidRootPart"); if not hrp then return end
    local best,dist
    for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and string.find(string.lower(m.Name), string.lower(name), 1, true) then
            local p = m:FindFirstChild("HumanoidRootPart") or m.PrimaryPart or m:FindFirstChildWhichIsA("BasePart")
            if p then
                local d = (p.Position - hrp.Position).Magnitude
                if not dist or d < dist then best = p; dist = d end
            end
        end
    end
    if best then tpTo(best.Position) end
end)

local ddPlayer = PageTP:CreateDropdown("Teleport Player", playersList(), function(nm)
    local p=Players:FindFirstChild(nm)
    if p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
        tpTo(p.Character.HumanoidRootPart.Position)
    end
end)

-- Live updates
RS.RenderStepped:Connect(function()
    local ch = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
    if hrp and coord and coord.UpdateLabel then
        local p = hrp.Position
        coord:UpdateLabel(("COORDINATES • X: %.1f  Y: %.1f  Z: %.1f"):format(p.X,p.Y,p.Z):upper())
    end
end)

-- Periodic refresh for dropdowns
task.spawn(function()
    while task.wait(8) do
        pcall(function()
            if ddNPC and ddNPC.UpdateDropdown then ddNPC:UpdateDropdown(scanNPC_Models()) end
            if ddPlayer and ddPlayer.UpdateDropdown then ddPlayer:UpdateDropdown(playersList()) end
        end)
    end
end)
