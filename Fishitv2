-- ==== BOOT ====
if not game:IsLoaded() then game.Loaded:Wait() end
local Workspace = game:GetService("Workspace")
while not Workspace.CurrentCamera do task.wait() end

----------------------------------------------------------------
-- ================== UI LIBRARY (Polished v2 • HOTFIX) ========
----------------------------------------------------------------
local ACCENT      = Color3.fromRGB(110,175,255)
local ACCENT_TEXT = Color3.fromRGB(227,229,255)
local BG_DARK     = Color3.fromRGB(42,44,56)
local BG_CARD     = Color3.fromRGB(30,31,41)
local UIS         = game:GetService("UserInputService")
local TS          = game:GetService("TweenService")
local CoreGui     = game:GetService("CoreGui")

local function protect(inst) pcall(function() if syn and syn.protect_gui then syn.protect_gui(inst) end end) end
local function tw(o,t,props) local a=TS:Create(o, TweenInfo.new(t, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), props); a:Play(); return a end

local library = {}
function library:CreateWindow(name, version, icon)
    name,version,icon = name or "AegisHub", version or "Premium", icon or 10044538000

    local parentGui = (gethui and gethui()) or CoreGui

    local Gui = Instance.new("ScreenGui")
    Gui.Name = "AegisHub_UIv2"
    Gui.IgnoreGuiInset = false
    Gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    Gui.ResetOnSpawn = false
    Gui.DisplayOrder = 2^16 - 1
    Gui.Enabled = true
    protect(Gui)
    Gui.Parent = parentGui

    local function calcScale()
        local vp = Workspace.CurrentCamera and Workspace.CurrentCamera.ViewportSize or Vector2.new(1280,720)
        local shortest = math.min(vp.X, vp.Y)
        if shortest <= 720 then return 0.85 elseif shortest <= 900 then return 0.92 else return 1 end
    end
    local SCALE = calcScale()

    -- Overlay (toggle + draggable)
    local Overlay = Instance.new("ImageButton")
    Overlay.Name="AegisHubOverlay"; Overlay.Parent=Gui
    Overlay.Size=UDim2.fromOffset(40,40); Overlay.AutoButtonColor=true
    Overlay.BackgroundColor3=Color3.fromRGB(32,34,46); Overlay.Image="rbxassetid://10045753138"; Overlay.ImageColor3=ACCENT
    local oc=Instance.new("UICorner",Overlay); oc.CornerRadius=UDim.new(1,0)
    local os=Instance.new("UIStroke",Overlay); os.Transparency=.85; os.Color=Color3.fromRGB(255,255,255)

    local vp = Workspace.CurrentCamera.ViewportSize
    local ox = Gui:GetAttribute("ovx") or 12
    local oy = Gui:GetAttribute("ovy") or math.floor((vp.Y/2)-20)
    Overlay.Position = UDim2.fromOffset(ox, oy)
    do
        local dragging, start, origin
        Overlay.InputBegan:Connect(function(i)
            if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then
                dragging=true; start=i.Position; origin=Overlay.Position
                i.Changed:Connect(function() if i.UserInputState==Enum.UserInputState.End then
                    dragging=false
                    Gui:SetAttribute("ovx", Overlay.Position.X.Offset)
                    Gui:SetAttribute("ovy", Overlay.Position.Y.Offset)
                end end)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then
                local d=i.Position-start
                local vps=Workspace.CurrentCamera.ViewportSize
                local nx = math.clamp(origin.X.Offset + d.X, 4, vps.X-44)
                local ny = math.clamp(origin.Y.Offset + d.Y, 4, vps.Y-44)
                Overlay.Position = UDim2.fromOffset(nx, ny)
            end
        end)
    end

    -- Window
    local Window = Instance.new("Frame")
    protect(Window); Window.Parent=Gui; Window.BackgroundColor3=BG_DARK; Window.ClipsDescendants=false
    Window.Size=UDim2.fromOffset(math.floor(560*SCALE), math.floor(360*SCALE))
    Window.Position=UDim2.new(.5, -Window.Size.X.Offset/2, .52, -Window.Size.Y.Offset/2)
    Window.Visible = true
    local wCorner=Instance.new("UICorner",Window); wCorner.CornerRadius=UDim.new(0,8)

    -- Title bar
    local Title=Instance.new("Frame",Window); Title.BackgroundTransparency=1; Title.Size=UDim2.new(1,0,0,math.floor(34*SCALE))
    local IconImg=Instance.new("ImageLabel",Title); IconImg.BackgroundTransparency=1; IconImg.Size=UDim2.fromOffset(math.floor(18*SCALE),math.floor(18*SCALE))
    IconImg.Position=UDim2.new(0,8,0,8); IconImg.Image="rbxassetid://"..tostring(icon); IconImg.ImageColor3=ACCENT
    local TitleText=Instance.new("TextLabel",Title); TitleText.BackgroundTransparency=1
    TitleText.Position=UDim2.new(0,30,0,0); TitleText.Size=UDim2.new(1,-30,1,0)
    TitleText.Font=Enum.Font.GothamSemibold; TitleText.TextSize=math.floor(13*SCALE); TitleText.TextXAlignment=Enum.TextXAlignment.Left
    TitleText.TextColor3=Color3.new(1,1,1); TitleText.Text=string.upper(("%s • %s"):format(name,version))
    local Under=Instance.new("Frame",Title); Under.BorderSizePixel=0; Under.BackgroundColor3=ACCENT
    Under.Size=UDim2.new(1,0,0,2); Under.Position=UDim2.new(0,0,1,0)

    -- Drag window
    do local dragging,start,origin
        Title.InputBegan:Connect(function(i)
            if (i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch) and not UIS:GetFocusedTextBox() then
                dragging=true; start=i.Position; origin=Window.Position
                i.Changed:Connect(function() if i.UserInputState==Enum.UserInputState.End then dragging=false end end)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then
                local d=i.Position-start; Window.Position=UDim2.new(origin.X.Scale,origin.X.Offset+d.X,origin.Y.Scale,origin.Y.Offset+d.Y)
            end
        end)
    end

    -- Overlay toggle
    local hidden=false
    Overlay.MouseButton1Click:Connect(function()
        hidden=not hidden; Window.Visible=not hidden
        tw(Overlay,.12,{ImageColor3 = hidden and Color3.fromRGB(200,200,200) or ACCENT})
    end)

    -- Tabs rail
    local TabsRail=Instance.new("Frame",Window); TabsRail.BackgroundColor3=Color3.fromRGB(39,40,51)
    TabsRail.Position=UDim2.new(0,8,0,math.floor(44*SCALE)); TabsRail.Size=UDim2.new(0,148,1,-math.floor(52*SCALE))
    local trc=Instance.new("UICorner",TabsRail); trc.CornerRadius=UDim.new(0,8)
    local trlbl=Instance.new("TextLabel",TabsRail); trlbl.BackgroundTransparency=1; trlbl.Size=UDim2.new(1,-12,0,math.floor(22*SCALE)); trlbl.Position=UDim2.new(0,12,0,6)
    trlbl.Font=Enum.Font.GothamBlack; trlbl.Text="SECTIONS"; trlbl.TextSize=12; trlbl.TextXAlignment=Enum.TextXAlignment.Left; trlbl.TextColor3=Color3.new(1,1,1)
    local trlist=Instance.new("UIListLayout",TabsRail); trlist.Padding=UDim.new(0,8); trlist.SortOrder=Enum.SortOrder.LayoutOrder; trlist.HorizontalAlignment=Enum.HorizontalAlignment.Right

    -- Tabs API
    local firstShown=false
    local TabsAPI={}
    function TabsAPI:CreateFrame(title)
        title = title or "Page"

        local Page=Instance.new("ScrollingFrame",Window)
        Page.Name="Page"; Page.Active=true; Page.ScrollBarThickness=5; Page.ScrollBarImageColor3=ACCENT
        Page.AutomaticCanvasSize=Enum.AutomaticSize.Y; Page.CanvasSize=UDim2.new(0,0,0,0)
        Page.BackgroundColor3=BG_DARK
        Page.Position=UDim2.new(0,148+8+8,0,math.floor(44*SCALE))
        Page.Size=UDim2.new(1,-(148+8+16),1,-math.floor(52*SCALE))
        Page.Visible=false
        local pc=Instance.new("UICorner",Page); pc.CornerRadius=UDim.new(0,8)
        local pad=Instance.new("UIPadding",Page); pad.PaddingTop=UDim.new(0,8); pad.PaddingLeft=UDim.new(0,8); pad.PaddingRight=UDim.new(0,8); pad.PaddingBottom=UDim.new(0,8)
        local vlist=Instance.new("UIListLayout",Page); vlist.Padding=UDim.new(0,8); vlist.SortOrder=Enum.SortOrder.LayoutOrder; vlist.HorizontalAlignment=Enum.HorizontalAlignment.Center

        local TabBtn=Instance.new("TextButton",TabsRail); TabBtn.BackgroundTransparency=1
        TabBtn.Size=UDim2.new(1,-16,0,20); TabBtn.Text=string.upper(title); TabBtn.Font=Enum.Font.Gotham
        TabBtn.TextSize=11; TabBtn.TextColor3=Color3.new(1,1,1); TabBtn.TextTransparency=.5
        local indicator=Instance.new("Frame",TabBtn); indicator.BackgroundColor3=ACCENT; indicator.Size=UDim2.new(0,3,1,-4)
        indicator.Position=UDim2.new(0,-8,0,2); indicator.BorderSizePixel=0; indicator.Visible=false

        local function selectThis()
            for _,v in ipairs(Window:GetChildren()) do if v:IsA("ScrollingFrame") and v.Name=="Page" then v.Visible=false end end
            for _,v in ipairs(TabsRail:GetChildren()) do
                if v:IsA("TextButton") then
                    v.TextTransparency=.5
                    local t=v:FindFirstChildWhichIsA("Frame"); if t then t.Visible=false end
                end
            end
            TabBtn.TextTransparency=0; Page.Visible=true; indicator.Visible=true
        end
        TabBtn.MouseButton1Click:Connect(selectThis)
        if not firstShown then firstShown=true; selectThis() end

        local function Card(baseH)
            local fr=Instance.new("Frame",Page)
            fr.BackgroundColor3=BG_CARD
            fr.Size=UDim2.new(1,0,0,math.floor((baseH or 40)*SCALE))
            fr.AutomaticSize = Enum.AutomaticSize.Y
            fr.ClipsDescendants=false
            local c=Instance.new("UICorner",fr); c.CornerRadius=UDim.new(0,8)
            local pad=Instance.new("UIPadding",fr); pad.PaddingTop=UDim.new(0,8); pad.PaddingBottom=UDim.new(0,8); pad.PaddingLeft=UDim.new(0,14); pad.PaddingRight=UDim.new(0,14)
            return fr
        end

        local PageAPI={}
        function PageAPI:CreateLabel(text)
            local lb = Instance.new("TextLabel")
            lb.Parent = Page
            lb.BackgroundTransparency = 1
            lb.Size = UDim2.new(1, -8, 0, 16)
            lb.Position = UDim2.new(0, 8, 0, 0)
            lb.Font = Enum.Font.GothamBlack
            lb.TextSize = 12
            lb.TextXAlignment = Enum.TextXAlignment.Left
            lb.TextColor3 = Color3.new(1, 1, 1)
            lb.Text = string.upper(text or "LABEL")
            return { UpdateLabel=function(_,t) lb.Text=string.upper(t or "") end }
        end

        function PageAPI:CreateButton(name,desc,cb)
            cb=cb or function() end
            local fr=Card(40)
            local t=Instance.new("TextLabel",fr); t.BackgroundTransparency=1; t.Position=UDim2.new(0,0,0,0); t.Size=UDim2.new(1,-100,0,18)
            t.Font=Enum.Font.GothamBlack; t.TextSize=12; t.TextColor3=Color3.new(1,1,1); t.Text=string.upper(name or "BUTTON"); t.TextXAlignment=Enum.TextXAlignment.Left
            local d=Instance.new("TextLabel",fr); d.BackgroundTransparency=1; d.Position=UDim2.new(0,0,0,20); d.Size=UDim2.new(1,-100,0,16)
            d.Font=Enum.Font.Gotham; d.TextSize=11; d.TextColor3=Color3.fromRGB(170,170,170); d.TextXAlignment=Enum.TextXAlignment.Left; d.Text=desc or ""
            local run=Instance.new("TextButton",fr); run.BackgroundColor3=Color3.fromRGB(24,25,32); run.Size=UDim2.new(0,84,0,24); run.Position=UDim2.new(1,-100,0,2)
            run.Text="RUN"; run.Font=Enum.Font.GothamSemibold; run.TextSize=11; run.TextColor3=Color3.new(1,1,1); local rc=Instance.new("UICorner",run); rc.CornerRadius=UDim.new(0,8)
            run.MouseButton1Click:Connect(cb)
            return {}
        end

        function PageAPI:CreateToggle(title,desc,cb)
            cb=cb or function() end
            local fr=Card(40)
            local t=Instance.new("TextLabel",fr); t.BackgroundTransparency=1; t.Position=UDim2.new(0,0,0,0); t.Size=UDim2.new(1,-70,0,18)
            t.Font=Enum.Font.GothamBlack; t.TextSize=12; t.TextColor3=Color3.new(1,1,1); t.Text=string.upper(title or "TOGGLE"); t.TextXAlignment=Enum.TextXAlignment.Left
            local d=Instance.new("TextLabel",fr); d.BackgroundTransparency=1; d.Position=UDim2.new(0,0,0,20); d.Size=UDim2.new(1,-70,0,16)
            d.Font=Enum.Font.Gotham; d.TextSize=11; d.TextColor3=Color3.fromRGB(170,170,170); d.TextXAlignment=Enum.TextXAlignment.Left; d.Text=desc or ""
            local track=Instance.new("Frame",fr); track.BackgroundColor3=Color3.fromRGB(24,25,32); track.Size=UDim2.fromOffset(50,22); track.Position=UDim2.new(1,-62,0,6); local kc=Instance.new("UICorner",track); kc.CornerRadius=UDim.new(1,0)
            local dot=Instance.new("Frame",track); dot.Size=UDim2.fromOffset(18,18); dot.Position=UDim2.new(0,2,0,2); dot.BackgroundColor3=ACCENT; dot.BackgroundTransparency=.6; local dc=Instance.new("UICorner",dot); dc.CornerRadius=UDim.new(1,0)
            local btn=Instance.new("TextButton",fr); btn.BackgroundTransparency=1; btn.Size=UDim2.new(1,0,1,0); btn.Text=""
            local on=false
            local function apply()
                tw(dot,.12,{Position=on and UDim2.new(1,-20,0,2) or UDim2.new(0,2,0,2), BackgroundTransparency=on and 0 or .6})
                cb(on)
            end
            btn.MouseButton1Click:Connect(function() on=not on; apply() end)
            return { Set=function(_,v) if v~=on then on=v; apply() end end }
        end

        function PageAPI:CreateBox(placeholder,_,cb)
            cb=cb or function() end
            local fr=Card(34)
            local t=Instance.new("TextLabel",fr); t.BackgroundTransparency=1; t.Font=Enum.Font.GothamBlack; t.TextSize=12; t.TextColor3=Color3.fromRGB(200,205,230)
            t.Text=string.upper(placeholder or "INPUT"); t.TextXAlignment=Enum.TextXAlignment.Left; t.Position=UDim2.new(0,0,0,0); t.Size=UDim2.new(1,-8,0,18)
            local tb=Instance.new("TextBox",fr); tb.BackgroundColor3=Color3.fromRGB(24,25,32); tb.Position=UDim2.new(0,0,0,20); tb.Size=UDim2.new(1,0,0,26)
            tb.ClearTextOnFocus=false; tb.Text=""; tb.Font=Enum.Font.Gotham; tb.TextSize=11; tb.TextColor3=Color3.new(1,1,1); tb.PlaceholderText=placeholder or ""; tb.PlaceholderColor3=ACCENT_TEXT; local c=Instance.new("UICorner",tb); c.CornerRadius=UDim.new(0,8)
            tb.FocusLost:Connect(function() cb(tb.Text) end)
            return { SetText=function(_,t2) tb.Text=t2 or "" end }
        end

        function PageAPI:CreateDropdown(title, options, onChanged)
            options=options or {}; onChanged=onChanged or function() end
            local fr=Card(28); fr.Name="Dropdown"
            local ttl=Instance.new("TextLabel",fr); ttl.BackgroundTransparency=1; ttl.Position=UDim2.new(0,0,0,0); ttl.Size=UDim2.new(1,-40,0,18)
            ttl.Font=Enum.Font.GothamBlack; ttl.TextSize=12; ttl.TextColor3=Color3.new(1,1,1); ttl.Text=string.upper(title)
            local caret=Instance.new("TextLabel",fr); caret.BackgroundTransparency=1; caret.Size=UDim2.fromOffset(16,16); caret.Position=UDim2.new(1,-24,0,0)
            caret.Font=Enum.Font.GothamBlack; caret.Text="▼"; caret.TextSize=11; caret.TextColor3=ACCENT

            local holder=Instance.new("Frame",fr); holder.BackgroundColor3=Color3.fromRGB(26,26,32)
            holder.Position=UDim2.new(0,0,0,22); holder.Size=UDim2.new(1,0,0,0)
            holder.AutomaticSize=Enum.AutomaticSize.Y; holder.Visible=false
            local lc=Instance.new("UICorner",holder); lc.CornerRadius=UDim.new(0,8)
            local lv=Instance.new("UIListLayout",holder); lv.Padding=UDim.new(0,4)
            local pad=Instance.new("UIPadding",holder); pad.PaddingTop=UDim.new(0,6); pad.PaddingBottom=UDim.new(0,6); pad.PaddingLeft=UDim.new(0,6); pad.PaddingRight=UDim.new(0,6)

            local current=nil
            local function rebuild(list)
                for _,c in ipairs(holder:GetChildren()) do if c:IsA("TextButton") then c:Destroy() end end
                for _,opt in ipairs(list) do
                    local b=Instance.new("TextButton",holder)
                    b.Size=UDim2.new(1,0,0,24); b.BackgroundColor3=BG_CARD
                    b.Text=opt; b.Font=Enum.Font.Gotham; b.TextSize=11; b.TextColor3=Color3.new(1,1,1)
                    local bc=Instance.new("UICorner",b); bc.CornerRadius=UDim.new(0,8)
                    b.MouseButton1Click:Connect(function()
                        current=opt; ttl.Text=string.upper(("%s : %s"):format(title,opt))
                        holder.Visible=false; tw(caret,.12,{Rotation=0})
                        onChanged(opt)
                    end)
                end
            end
            rebuild(options)

            local open=false
            local header=Instance.new("TextButton",fr); header.BackgroundTransparency=1; header.Size=UDim2.new(1,0,0,20); header.Position=UDim2.new(0,0,0,0); header.Text=""
            header.MouseButton1Click:Connect(function()
                open=not open; holder.Visible=open; tw(caret,.12,{Rotation=open and 180 or 0})
            end)

            return {
                SetValue=function(_,v) current=v; ttl.Text=string.upper(("%s : %s"):format(title,tostring(v))) end,
                GetValue=function() return current end,
                SetOptions=function(_,opts) rebuild(opts or {}) end
            }
        end

        function PageAPI:CreateDropdownMulti(title, options, onChanged)
            options=options or {}; onChanged=onChanged or function() end
            local fr=Card(28); fr.Name="DropdownMulti"
            local ttl=Instance.new("TextLabel",fr); ttl.BackgroundTransparency=1; ttl.Position=UDim2.new(0,0,0,0); ttl.Size=UDim2.new(1,-40,0,18)
            ttl.Font=Enum.Font.GothamBlack; ttl.TextSize=12; ttl.TextColor3=Color3.new(1,1,1); ttl.Text=string.upper(title)
            local caret=Instance.new("TextLabel",fr); caret.BackgroundTransparency=1; caret.Size=UDim2.fromOffset(16,16); caret.Position=UDim2.new(1,-24,0,0)
            caret.Font=Enum.Font.GothamBlack; caret.Text="▼"; caret.TextSize=11; caret.TextColor3=ACCENT

            local holder=Instance.new("Frame",fr); holder.BackgroundColor3=Color3.fromRGB(26,26,32)
            holder.Position=UDim2.new(0,0,0,22); holder.Size=UDim2.new(1,0,0,0)
            holder.AutomaticSize=Enum.AutomaticSize.Y; holder.Visible=false
            local lc=Instance.new("UICorner",holder); lc.CornerRadius=UDim.new(0,8)
            local lv=Instance.new("UIListLayout",holder); lv.Padding=UDim.new(0,4)
            local pad=Instance.new("UIPadding",holder); pad.PaddingTop=UDim.new(0,6); pad.PaddingBottom=UDim.new(0,6); pad.PaddingLeft=UDim.new(0,6); pad.PaddingRight=UDim.new(0,6)

            local selected = {}

            local function refreshTitle()
                local n=0 for _ in pairs(selected) do n+=1 end
                ttl.Text = n>0 and string.upper(("%s : %d SELECTED"):format(title,n)) or string.upper(title)
            end

            local function rebuild(list)
                for _,c in ipairs(holder:GetChildren()) do if c:IsA("Frame") then c:Destroy() end end
                for _,opt in ipairs(list) do
                    local row = Instance.new("Frame",holder); row.BackgroundColor3=BG_CARD; row.Size=UDim2.new(1,0,0,24)
                    local rc=Instance.new("UICorner",row); rc.CornerRadius=UDim.new(0,8)

                    local txt=Instance.new("TextLabel",row); txt.BackgroundTransparency=1; txt.TextXAlignment=Enum.TextXAlignment.Left
                    txt.Size=UDim2.new(1,-34,1,0); txt.Position=UDim2.new(0,8,0,0)
                    txt.Font=Enum.Font.Gotham; txt.TextSize=11; txt.TextColor3=Color3.new(1,1,1); txt.Text=opt

                    local box=Instance.new("Frame",row); box.Size=UDim2.fromOffset(20,20); box.Position=UDim2.new(1,-24,0,2); box.BackgroundColor3=Color3.fromRGB(24,25,32)
                    local bc=Instance.new("UICorner",box); bc.CornerRadius=UDim.new(0,6)
                    local tick=Instance.new("Frame",box); tick.BackgroundColor3=ACCENT; tick.Size=UDim2.new(1,-6,1,-6); tick.Position=UDim2.new(0,3,0,3); tick.Visible=selected[opt] and true or false
                    local tc=Instance.new("UICorner",tick); tc.CornerRadius=UDim.new(0,5)

                    local btn=Instance.new("TextButton",row); btn.BackgroundTransparency=1; btn.Text=""; btn.Size=UDim2.new(1,0,1,0)
                    btn.MouseButton1Click:Connect(function()
                        selected[opt] = not selected[opt]
                        tick.Visible = selected[opt] and true or false
                        refreshTitle()
                        onChanged(selected)
                    end)
                end
                refreshTitle()
            end
            rebuild(options)

            local open=false
            local header=Instance.new("TextButton",fr); header.BackgroundTransparency=1; header.Size=UDim2.new(1,0,0,20); header.Position=UDim2.new(0,0,0,0); header.Text=""
            header.MouseButton1Click:Connect(function()
                open=not open; holder.Visible=open; tw(caret,.12,{Rotation=open and 180 or 0})
            end)

            return {
                GetSelected=function() return selected end,
                SetOptions=function(_,opts) rebuild(opts or {}) end,
                SetSelected=function(_,map) selected = map or {}; rebuild(options) end,
            }
        end

        return PageAPI
    end

    local winAPI={}
    function winAPI:CreateTab(title)
        -- langsung buat 1 page (tab) baru
        return setmetatable({}, { __index = TabsAPI }):CreateFrame(title or "Page")
    end

    return setmetatable({}, { __index = winAPI })
end

----------------------------------------------------------------
-- ======================= CORE / GAME =========================
----------------------------------------------------------------
local Players            = game:GetService("Players")
local LocalPlayer        = Players.LocalPlayer
local RS                 = game:GetService("RunService")
local TeleportService    = game:GetService("TeleportService")
local VirtualUser        = game:GetService("VirtualUser")
local ReplicatedStorage  = game:GetService("ReplicatedStorage")

local TARGET_PLACE = 121864768012064

-- Anti AFK
LocalPlayer.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0,0), Workspace.CurrentCamera.CFrame)
    task.wait(.7); VirtualUser:Button2Up(Vector2.new(0,0), Workspace.CurrentCamera.CFrame)
end)

-- Optional modules
local Replion,ItemUtility
task.spawn(function()
    local okRp,modRp=pcall(function() return require(ReplicatedStorage:WaitForChild("Packages"):WaitForChild("replion")) end)
    if okRp then Replion=modRp end
    local okU,modU=pcall(function() return require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("ItemUtility")) end)
    if okU then ItemUtility=modU end
end)

----------------------------------------------------------------
-- ========================= TELEPORT ==========================
----------------------------------------------------------------
local islands = {
    ["Weather Machine"]   = Vector3.new(-1471,-3,1929),
    ["Esoteric Depths"]   = Vector3.new(3157,-1303,1439),
    ["Tropical Grove"]    = Vector3.new(-2038,3,3650),
    ["Stingray Shores"]   = Vector3.new(-32,4,2773),
    ["Kohana Volcano"]    = Vector3.new(-519,24,189),
    ["Coral Reefs"]       = Vector3.new(-3095,1,2177),
    ["Crater Island"]     = Vector3.new(968,1,4854),
    ["Kohana"]            = Vector3.new(-658,3,719),
    ["Winter Fest"]       = Vector3.new(1611,4,3280),
    ["Esoteric Island"]   = Vector3.new(1987,4,1400),
    ["Treasure Room"]     = Vector3.new(-3600,-267,-1558),
    ["Lost Shore"]        = Vector3.new(-3663,38,-989),
    ["Sisyphus"]          = Vector3.new(-3792,-135,-986),
    ["Crystal Cavern"]    = Vector3.new(-2026,-440,7428),
    ["Halloween"]         = Vector3.new(2127,78,3334),
    ["Ancient Underground Cave"]  = Vector3.new(2102,-91,-709),
    ["Ancient Inside Temple"]     = Vector3.new(1506,-22,-641),
    ["Ancient Jungle"]            = Vector3.new(1268,78,-183),
    ["Fisherman Island"]          = Vector3.new(-3,17,2840),
}
local islandList = {} for n,_ in pairs(islands) do table.insert(islandList, n) end table.sort(islandList)

local function tpTo(pos)
    if not pos then return end
    local char=LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp=char:FindFirstChild("HumanoidRootPart")
    if hrp then hrp.CFrame=CFrame.new(pos+Vector3.new(0,5,0)) end
end

local function playersList()
    local t={} for _,pl in ipairs(Players:GetPlayers()) do if pl~=LocalPlayer then table.insert(t,pl.Name) end end
    table.sort(t); return t
end

local function scanNPC_Models()
    local found = {}
    for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and #m.Name >= 3 then
            local hasHum = m:FindFirstChildOfClass("Humanoid")
            local hasPrompt = false
            for _,d in ipairs(m:GetDescendants()) do
                if d:IsA("ProximityPrompt") then hasPrompt = true break end
            end
            if hasHum or hasPrompt then found[m.Name] = true end
        end
    end
    local list = {}; for name in pairs(found) do table.insert(list,name) end
    table.sort(list); return list
end

----------------------------------------------------------------
-- ============================ FARM ===========================
----------------------------------------------------------------
-- net (sleitnick)
local net; pcall(function()
    net = ReplicatedStorage:WaitForChild("Packages")
        :WaitForChild("_Index")
        :WaitForChild("sleitnick_net@0.2.0")
        :WaitForChild("net")
end)

-- Remotes
local RF_Charge, RF_Start, RE_Completed, RE_Equip, RE_Text
pcall(function()
    RF_Charge     = net:WaitForChild("RF/ChargeFishingRod",5)
    RF_Start      = net:WaitForChild("RF/RequestFishingMinigameStarted",5)
    RE_Completed  = net:WaitForChild("RE/FishingCompleted",5)
    RE_Equip      = net:WaitForChild("RE/EquipToolFromHotbar",5)
    RE_Text       = net:WaitForChild("RE/ReplicateTextEffect",5)
end)

-- Animations
local character = Players.LocalPlayer.Character or Players.LocalPlayer.CharacterAdded:Wait()
local humanoid  = character:WaitForChild("Humanoid")
local animator  = humanoid:FindFirstChildOfClass("Animator") or Instance.new("Animator", humanoid)
local AIdle, AReel, ACast
pcall(function()
    local RodIdle = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Animations"):WaitForChild("FishingRodReelIdle")
    local RodReel = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Animations"):WaitForChild("EasyFishReelStart")
    local RodCast = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Animations"):WaitForChild("CastFromFullChargePosition1Hand")
    AIdle = animator:LoadAnimation(RodIdle)
    AReel = animator:LoadAnimation(RodReel)
    ACast = animator:LoadAnimation(RodCast)
end)

-- State & delay map (auto-detect + bypass)
local Flags = { AutoFish=false, PerfectCast=true, AutoSell=false, AutoFav=false }
local RodDelays = {
    ["Ares Rod"]={custom=1.12,bypass=1.45},
    ["Angler Rod"]={custom=1.12,bypass=1.45},
    ["Ghostfinn Rod"]={custom=1.12,bypass=1.45},
    ["Astral Rod"]={custom=1.90,bypass=1.45},
    ["Chrome Rod"]={custom=2.30,bypass=2.00},
    ["Steampunk Rod"]={custom=2.50,bypass=2.30},
    ["Lucky Rod"]={custom=3.50,bypass=3.60},
    ["Midnight Rod"]={custom=3.30,bypass=3.40},
    ["Demascus Rod"]={custom=3.90,bypass=3.80},
    ["Grass Rod"]={custom=3.80,bypass=3.90},
    ["Luck Rod"]={custom=4.20,bypass=4.10},
    ["Carbon Rod"]={custom=4.00,bypass=3.80},
    ["Lava Rod"]={custom=4.20,bypass=4.10},
    ["Starter Rod"]={custom=4.30,bypass=4.20},
}
local CastDelay, BypassDelay = 1.0, 0.50
local fishingActive=false

local function getEquippedRodName()
    local ok, display = pcall(function()
        return Players.LocalPlayer.PlayerGui:WaitForChild("Backpack",5):WaitForChild("Display",5)
    end)
    if not ok or not display then return nil end
    for _, tile in ipairs(display:GetChildren()) do
        local success, label = pcall(function() return tile.Inner and tile.Inner.Tags and tile.Inner.Tags.ItemName end)
        if success and label and label:IsA("TextLabel") then
            local name = label.Text
            if RodDelays[name] then return name end
        end
    end
    return nil
end

local function refreshDelays()
    local rod = getEquippedRodName()
    if rod and RodDelays[rod] then
        CastDelay  = RodDelays[rod].custom
        BypassDelay= RodDelays[rod].bypass
    else
        CastDelay  = 10
        BypassDelay= 1
    end
end

-- Fast-finish: dengar efek "Exclaim"
pcall(function()
    if RE_Text then
        RE_Text.OnClientEvent:Connect(function(d)
            if not (Flags.AutoFish and fishingActive) then return end
            if d and d.TextData and d.TextData.EffectType=="Exclaim" then
                task.spawn(function()
                    for _=1,3 do
                        task.wait(BypassDelay)
                        pcall(function() if RE_Completed then RE_Completed:FireServer() end end)
                    end
                end)
            end
        end)
    end
end)

local function castOnce()
    refreshDelays()
    fishingActive=true
    if RE_Equip then RE_Equip:FireServer(1) end
    task.wait(0.05)
    local tNow = Workspace:GetServerTimeNow()
    if ACast then ACast:Play() end
    if RF_Charge then RF_Charge:InvokeServer(tNow) end
    task.wait(0.15)
    pcall(function() if RF_Charge then RF_Charge:InvokeServer(Workspace:GetServerTimeNow()) end end)
    local bx,by = -0.7499996423721313, 1
    local x,y
    if Flags.PerfectCast then
        x = bx + (math.random(-500, 500) / 1e7)
        y = by + (math.random(-500, 500) / 1e7)
    else
        x = math.random(-1000,1000)/1000
        y = math.random(0,1000)/1000
    end
    if AIdle then AIdle:Play() end
    if RF_Start then RF_Start:InvokeServer(x,y) end
    task.wait(CastDelay)
    fishingActive=false
end

local function StartAutoFish()
    if Flags.AutoFish then return end
    Flags.AutoFish = true
    task.spawn(function()
        while Flags.AutoFish do
            pcall(function()
                castOnce()
            end)
            task.wait(0.05)
        end
    end)
end

local function StopAutoFish()
    Flags.AutoFish=false
    fishingActive=false
    pcall(function() if AIdle then AIdle:Stop() end end)
    pcall(function() if AReel then AReel:Stop() end end)
    pcall(function() if ACast then ACast:Stop() end end)
end

-- Auto Sell / Auto Favorite (opsional)
local lastSell = 0
local SELL_THRESHOLD = 60
local SELL_COOLDOWN = 60
local function startAutoSell()
    task.spawn(function()
        while Flags.AutoSell do
            pcall(function()
                if not Replion then return end
                local Data = Replion.Client:WaitReplion("Data")
                local items = Data and Data:Get({"Inventory","Items"})
                if type(items)~="table" then return end
                local unfav=0
                for _,it in ipairs(items) do if not it.Favorited then unfav += (it.Count or 1) end end
                if unfav >= SELL_THRESHOLD and os.time()-lastSell >= SELL_COOLDOWN then
                    local SellAll = net and net:FindFirstChild("RF/SellAllItems")
                    if SellAll then pcall(function() SellAll:InvokeServer() end); lastSell=os.time() end
                end
            end)
            task.wait(10)
        end
    end)
end

local keepTiers = { Secret=true, Mythic=true, Legendary=true }
local function startAutoFavorite()
    task.spawn(function()
        while Flags.AutoFav do
            pcall(function()
                if not (Replion and ItemUtility) then return end
                local Data = Replion.Client:WaitReplion("Data")
                local items = Data and Data:Get({"Inventory","Items"})
                if type(items)~="table" then return end
                for _,it in ipairs(items) do
                    local base = ItemUtility:GetItemData(it.Id)
                    local tier = base and base.Data and base.Data.Tier
                    if tier and keepTiers[tier] and not it.Favorited then it.Favorited=true end
                end
            end)
            task.wait(6)
        end
    end)
end

----------------------------------------------------------------
-- ============================ EVENTS =========================
----------------------------------------------------------------
local staticEvents = { "Admin Event","Shark Hunt","Ghost Shark Hunt","Worm Hunt","Black Hole","Shocked","Ghost Worm","Meteor Rain" }

local function discoverEvents()
    local set = {}
    local props = Workspace:FindFirstChild("Props")
    if props then
        for _,child in ipairs(props:GetChildren()) do
            if (child:IsA("Folder") or child:IsA("Model")) and #child.Name>=3 then
                set[child.Name]=true
            end
        end
    end
    if (next(set)==nil) then for _,n in ipairs(staticEvents) do set[n]=true end end
    local list={} for k in pairs(set) do table.insert(list,k) end
    table.sort(list); return list
end

local function tpToEventByName(evName)
    local props = Workspace:FindFirstChild("Props")
    if not props then return false,"Props missing" end
    local node = props:FindFirstChild(evName)
    if not node then return false,"Event missing" end
    local boat = node:FindFirstChild("Fishing Boat")
    if not boat then return false,"Boat missing" end
    local cf = boat:GetPivot()
    local ch = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
    if not hrp then return false,"HRP missing" end
    hrp.CFrame = cf + Vector3.new(0,15,0)
    return true
end

----------------------------------------------------------------
-- ========================= BUILD UI ==========================
----------------------------------------------------------------
local UI = library:CreateWindow("AegisHub • Fish It","Premium",10044538000)

local PageTP    = UI:CreateTab("Teleport")
local PageEvent = UI:CreateTab("Event")
local PageFarm  = UI:CreateTab("Farm")
local PageShop  = UI:CreateTab("Shop")
local PageInv   = UI:CreateTab("Inventory")

-- ===== Teleport =====
local CoordLabel = PageTP:CreateLabel("COORDINATES • X: 0.0  Y: 0.0  Z: 0.0")

local ddIsland = PageTP:CreateDropdown("Teleport Island", islandList, function(choice)
    tpTo(islands[choice])
end)

local ddNPC = PageTP:CreateDropdown("Teleport NPC", scanNPC_Models(), function(nm)
    if not nm or nm=="" then return end
    local char=LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp=char and char:FindFirstChild("HumanoidRootPart"); if not hrp then return end
    local best,dist
    for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and string.find(string.lower(m.Name), string.lower(nm)) then
            local p=m:FindFirstChild("HumanoidRootPart") or m.PrimaryPart or m:FindFirstChildWhichIsA("BasePart")
            if p then local d=(p.Position-hrp.Position).Magnitude; if not dist or d<dist then best=p; dist=d end end
        end
    end
    if best then tpTo(best.Position) end
end)

local ddPlayer = PageTP:CreateDropdown("Teleport Player", playersList(), function(nm)
    local p=Players:FindFirstChild(nm); if p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then tpTo(p.Character.HumanoidRootPart.Position) end
end)

if game.PlaceId ~= TARGET_PLACE then
    PageTP:CreateButton("Teleport ke Fish It","Masuk ke game Fish It",function() TeleportService:Teleport(TARGET_PLACE,LocalPlayer) end)
end

-- Live coordinate updater
RS.RenderStepped:Connect(function()
    local ch = LocalPlayer.Character
    local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
    if hrp and CoordLabel and CoordLabel.UpdateLabel then
        local p = hrp.Position
        CoordLabel:UpdateLabel(("COORDINATES • X: %.1f  Y: %.1f  Z: %.1f"):format(p.X,p.Y,p.Z):upper())
    end
end)

-- Refresh NPC/Players berkala
task.spawn(function()
    while true do
        task.wait(8)
        if ddNPC and ddNPC.SetOptions then ddNPC:SetOptions(scanNPC_Models()) end
        if ddPlayer and ddPlayer.SetOptions then ddPlayer:SetOptions(playersList()) end
    end
end)

-- ===== Event =====
local currentEvents = discoverEvents()
local ddEventSingle = PageEvent:CreateDropdown("Event Teleport", currentEvents, function(option)
    local ok,reason = tpToEventByName(option)
    if not ok then warn("Event Teleport failed:",reason) end
end)

local SELECTED = {}
for _,n in ipairs(currentEvents) do SELECTED[n]=true end

local multi = PageEvent:CreateDropdownMulti("Select Events (Auto)", currentEvents, function(map)
    SELECTED = map or {}
end)

local statusLbl = PageEvent:CreateLabel("EVENT WATCH • SCANNING")
local autoEvtToggle = PageEvent:CreateToggle("Auto Teleport Selected Events","Otomatis teleport saat event ditemukan", function(on)
    _G.__AUTO_EVT_ON = on
end)
autoEvtToggle:Set(true)

task.spawn(function()
    while true do
        if _G.__AUTO_EVT_ON then
            local props = Workspace:FindFirstChild("Props")
            local jumped=false
            if props then
                for ev,_ in pairs(SELECTED) do
                    local node = props:FindFirstChild(ev)
                    if node and node:FindFirstChild("Fishing Boat") then
                        if tpToEventByName(ev) then
                            jumped=true
                            if statusLbl and statusLbl.UpdateLabel then
                                statusLbl:UpdateLabel(string.upper("EVENT WATCH • TELEPORTED: "..ev))
                            end
                            break
                        end
                    end
                end
            end
            if not jumped and statusLbl and statusLbl.UpdateLabel then
                statusLbl:UpdateLabel(string.upper("EVENT WATCH • NO ACTIVE (WAITING)"))
            end
        end
        task.wait(2)
    end
end)

task.spawn(function()
    while true do
        task.wait(8)
        local fresh = discoverEvents()
        currentEvents = fresh
        if ddEventSingle and ddEventSingle.SetOptions then ddEventSingle:SetOptions(fresh) end
        if multi and multi.SetOptions then multi:SetOptions(fresh) end
    end
end)

-- ===== Farm =====
PageFarm:CreateToggle("Auto Fishing","Loop otomatis memancing (rod auto-detect delay)", function(on)
    if on then StartAutoFish() else StopAutoFish() end
end)

PageFarm:CreateToggle("Perfect Cast","Akurasi lemparan sangat presisi", function(on)
    Flags.PerfectCast = on
end)

PageFarm:CreateBox("Bypass Delay Override (ex: 1.45)", nil, function(txt)
    local n = tonumber(txt); if n then BypassDelay = math.max(0.05, n) end
end)

PageFarm:CreateToggle("Auto Sell Fish","Jual otomatis non-favorite saat jumlah banyak", function(on)
    Flags.AutoSell = on; if on then startAutoSell() end
end)

PageFarm:CreateBox("Sell Threshold (default 60)", nil, function(txt)
    local n = tonumber(txt); if n then SELL_THRESHOLD = math.max(1, math.floor(n)) end
end)

PageFarm:CreateToggle("Auto Favorite (Secret/Mythic/Legendary)","Favorit agar tidak terjual", function(on)
    Flags.AutoFav = on; if on then startAutoFavorite() end
end)

-- ===== Shop / Inventory =====
PageShop:CreateButton("Traveling Merchant","Buka merchant terdekat",function() end)
PageShop:CreateButton("Bobber Shop","",function() end)
PageShop:CreateButton("Rod Shop","",function() end)
PageShop:CreateButton("Weather Shop","",function() end)

PageInv:CreateLabel("INVENTORY • UTILITIES")
PageInv:CreateButton("Sell ALL Now","Menjual semua item non-favorite", function()
    local SellAll = net and net:FindFirstChild("RF/SellAllItems")
    if SellAll then pcall(function() SellAll:InvokeServer() end) end
end)
