-- AegisHub • Fish It (Android-Delta Safe ORI)
-- Fokus: UI pasti muncul + Farm (Auto Fish/Perfect/Bypass/Auto Sell/Auto Fav) + Teleport (Island/NPC/Player)

-- ====== BOOT ======
if not game:IsLoaded() then game.Loaded:Wait() end
local ws = game:GetService("Workspace")
while not ws.CurrentCamera do task.wait() end

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local VirtualUser = game:GetService("VirtualUser")

-- ====== ANTI AFK ======
LocalPlayer.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0,0), ws.CurrentCamera.CFrame)
    task.wait(0.7)
    VirtualUser:Button2Up(Vector2.new(0,0), ws.CurrentCamera.CFrame)
end)

-- ====== NET/REMOTES (aman pcall supaya tidak break UI) ======
local net; pcall(function()
    net = ReplicatedStorage:WaitForChild("Packages"):WaitForChild("_Index")
        :WaitForChild("sleitnick_net@0.2.0"):WaitForChild("net")
end)

local RF_Charge, RF_Start, RE_Completed, RE_Equip, RE_Text
pcall(function()
    RF_Charge     = net and net:WaitForChild("RF/ChargeFishingRod",10)
    RF_Start      = net and net:WaitForChild("RF/RequestFishingMinigameStarted",10)
    RE_Completed  = net and net:WaitForChild("RE/FishingCompleted",10)
    RE_Equip      = net and net:WaitForChild("RE/EquipToolFromHotbar",10)
    RE_Text       = net and net:WaitForChild("RE/ReplicateTextEffect",10)
end)

-- ====== Animations (aman pcall) ======
local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
local humanoid  = character:WaitForChild("Humanoid")
local animator  = humanoid:FindFirstChildOfClass("Animator") or Instance.new("Animator", humanoid)

local AIdle, AReel, ACast
pcall(function()
    local RodIdle = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Animations"):WaitForChild("FishingRodReelIdle")
    local RodReel = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Animations"):WaitForChild("EasyFishReelStart")
    local RodCast = ReplicatedStorage:WaitForChild("Modules"):WaitForChild("Animations"):WaitForChild("CastFromFullChargePosition1Hand")
    AIdle = animator:LoadAnimation(RodIdle)
    AReel = animator:LoadAnimation(RodReel)
    ACast = animator:LoadAnimation(RodCast)
end)

-- ====== STATE & LOGIC ======
local Flags = { AutoFish=false, PerfectCast=true, AutoSell=false, AutoFav=false }
local CastDelay, BypassDelay = 1.0, 0.50
local fishingActive=false

local RodDelays = {
    ["Ares Rod"]={custom=1.12,bypass=1.45},
    ["Angler Rod"]={custom=1.12,bypass=1.45},
    ["Ghostfinn Rod"]={custom=1.12,bypass=1.45},
    ["Astral Rod"]={custom=1.90,bypass=1.45},
    ["Chrome Rod"]={custom=2.30,bypass=2.00},
    ["Steampunk Rod"]={custom=2.50,bypass=2.30},
    ["Lucky Rod"]={custom=3.50,bypass=3.60},
    ["Midnight Rod"]={custom=3.30,bypass=3.40},
    ["Demascus Rod"]={custom=3.90,bypass=3.80},
    ["Grass Rod"]={custom=3.80,bypass=3.90},
    ["Luck Rod"]={custom=4.20,bypass=4.10},
    ["Carbon Rod"]={custom=4.00,bypass=3.80},
    ["Lava Rod"]={custom=4.20,bypass=4.10},
    ["Starter Rod"]={custom=4.30,bypass=4.20},
}

local function getEquippedRodName()
    local ok, display = pcall(function()
        return LocalPlayer.PlayerGui:WaitForChild("Backpack",5):WaitForChild("Display",5)
    end)
    if not ok or not display then return nil end
    for _, tile in ipairs(display:GetChildren()) do
        local success, label = pcall(function() return tile.Inner.Tags.ItemName end)
        if success and label and label:IsA("TextLabel") then
            local name = label.Text
            if RodDelays[name] then return name end
        end
    end
    return nil
end

local function refreshDelays()
    local rod = getEquippedRodName()
    if rod and RodDelays[rod] then
        CastDelay  = RodDelays[rod].custom
        BypassDelay= RodDelays[rod].bypass
    else
        CastDelay  = 10
        BypassDelay= 1
    end
end

pcall(function()
    if RE_Text then
        RE_Text.OnClientEvent:Connect(function(d)
            if not (Flags.AutoFish and fishingActive) then return end
            if d and d.TextData and d.TextData.EffectType=="Exclaim" then
                task.spawn(function()
                    for _=1,3 do
                        task.wait(BypassDelay)
                        pcall(function() if RE_Completed then RE_Completed:FireServer() end end)
                    end
                end)
            end
        end)
    end
end)

local function castOnce()
    refreshDelays()
    fishingActive=true
    if RE_Equip then RE_Equip:FireServer(1) end
    task.wait(0.05)

    local tNow = ws:GetServerTimeNow()
    if ACast then ACast:Play() end
    if RF_Charge then RF_Charge:InvokeServer(tNow) end
    task.wait(0.15)
    pcall(function() if RF_Charge then RF_Charge:InvokeServer(ws:GetServerTimeNow()) end end)

    local bx,by = -0.7499996423721313, 1
    local x,y
    if Flags.PerfectCast then
        x = bx + (math.random(-500, 500) / 1e7)
        y = by + (math.random(-500, 500) / 1e7)
    else
        x = math.random(-1000,1000)/1000
        y = math.random(0,1000)/1000
    end
    if AIdle then AIdle:Play() end
    if RF_Start then RF_Start:InvokeServer(x,y) end

    task.wait(CastDelay)
    fishingActive=false
end

local function StartAutoFish()
    if Flags.AutoFish then return end
    Flags.AutoFish = true
    task.spawn(function()
        while Flags.AutoFish do
            pcall(function() castOnce() end)
            task.wait(0.05)
        end
    end)
end

local function StopAutoFish()
    Flags.AutoFish=false
    fishingActive=false
    pcall(function() if AIdle then AIdle:Stop() end end)
    pcall(function() if AReel then AReel:Stop() end end)
    pcall(function() if ACast then ACast:Stop() end end)
end

-- Replion & ItemUtility untuk AutoSell / AutoFav
local Replion, ItemUtility
task.spawn(function()
    local okRp,modRp=pcall(function() return require(ReplicatedStorage:WaitForChild("Packages"):WaitForChild("replion")) end)
    if okRp then Replion=modRp end
    local okU,modU=pcall(function() return require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("ItemUtility")) end)
    if okU then ItemUtility=modU end
end)

local lastSell = 0
local SELL_THRESHOLD = 60
local SELL_COOLDOWN = 60

local function startAutoSell()
    task.spawn(function()
        while Flags.AutoSell do
            pcall(function()
                if not (net and Replion) then return end
                local Data = Replion.Client:WaitReplion("Data")
                local items = Data and Data:Get({"Inventory","Items"})
                if type(items)~="table" then return end
                local unfav=0
                for _,it in ipairs(items) do if not it.Favorited then unfav += (it.Count or 1) end end
                if unfav >= SELL_THRESHOLD and os.time()-lastSell >= SELL_COOLDOWN then
                    local SellAll = net:FindFirstChild("RF/SellAllItems")
                    if SellAll then pcall(function() SellAll:InvokeServer() end); lastSell=os.time() end
                end
            end)
            task.wait(10)
        end
    end)
end

local keepTiers = { Secret=true, Mythic=true, Legendary=true }
local function startAutoFavorite()
    task.spawn(function()
        while Flags.AutoFav do
            pcall(function()
                if not (Replion and ItemUtility) then return end
                local Data = Replion.Client:WaitReplion("Data")
                local items = Data and Data:Get({"Inventory","Items"})
                if type(items)~="table" then return end
                for _,it in ipairs(items) do
                    local base = ItemUtility:GetItemData(it.Id)
                    local tier = base and base.Data and base.Data.Tier
                    if tier and keepTiers[tier] and not it.Favorited then it.Favorited=true end
                end
            end)
            task.wait(6)
        end
    end)
end

-- ====== Teleport helpers ======
local function tpTo(pos: Vector3)
    if not pos then return end
    local ch  = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
    if hrp then hrp.CFrame = CFrame.new(pos + Vector3.new(0,5,0)) end
end

local islands = {
    ["Weather Machine"]   = Vector3.new(-1471,-3,1929),
    ["Esoteric Depths"]   = Vector3.new(3157,-1303,1439),
    ["Tropical Grove"]    = Vector3.new(-2038,3,3650),
    ["Stingray Shores"]   = Vector3.new(-32,4,2773),
    ["Kohana Volcano"]    = Vector3.new(-519,24,189),
    ["Coral Reefs"]       = Vector3.new(-3095,1,2177),
    ["Crater Island"]     = Vector3.new(968,1,4854),
    ["Kohana"]            = Vector3.new(-658,3,719),
    ["Winter Fest"]       = Vector3.new(1611,4,3280),
    ["Esoteric Island"]   = Vector3.new(1987,4,1400),
    ["Treasure Room"]     = Vector3.new(-3600,-267,-1558),
    ["Lost Shore"]        = Vector3.new(-3663,38,-989),
    ["Sisyphus"]          = Vector3.new(-3792,-135,-986),
    ["Crystal Cavern"]    = Vector3.new(-2026,-440,7428),
    ["Halloween"]         = Vector3.new(2127,78,3334),
    ["Ancient Underground Cave"]  = Vector3.new(2102,-91,-709),
    ["Ancient Inside Temple"]     = Vector3.new(1506,-22,-641),
    ["Ancient Jungle"]            = Vector3.new(1268,78,-183),
    ["Fisherman Island"]          = Vector3.new(-3,17,2840),
}
local islandList = {} for k in pairs(islands) do table.insert(islandList,k) end table.sort(islandList)

local function scanNPC_Models()
    local found = {}
    for _,m in ipairs(ws:GetDescendants()) do
        if m:IsA("Model") and #m.Name >= 3 then
            local hasHum = m:FindFirstChildOfClass("Humanoid")
            local hasPrompt = false
            for _,d in ipairs(m:GetDescendants()) do
                if d:IsA("ProximityPrompt") then hasPrompt = true break end
            end
            if hasHum or hasPrompt then found[m.Name] = true end
        end
    end
    local list = {}; for n in pairs(found) do table.insert(list,n) end
    table.sort(list); return list
end

local function playersList()
    local t = {}
    for _,pl in ipairs(Players:GetPlayers()) do
        if pl ~= LocalPlayer then table.insert(t, pl.Name) end
    end
    table.sort(t); return t
end

-- ====== SUPER SIMPLE UI (selalu muncul di PlayerGui) ======
local function guiParent()
    return LocalPlayer:FindFirstChildOfClass("PlayerGui") or LocalPlayer:WaitForChild("PlayerGui")
end

local function safeDestroy(obj) if obj and obj.Destroy then pcall(function() obj:Destroy() end) end end

local function buildUI()
    safeDestroy(guiParent():FindFirstChild("AegisHub_UI_MIN"))
    local gui = Instance.new("ScreenGui")
    gui.Name = "AegisHub_UI_MIN"
    gui.ResetOnSpawn = false
    gui.IgnoreGuiInset = true
    gui.DisplayOrder = 9999
    gui.Parent = guiParent()

    -- Header
    local header = Instance.new("Frame", gui)
    header.Size = UDim2.new(1,0,0,44)
    header.BackgroundColor3 = Color3.fromRGB(42,44,56)
    local hstroke = Instance.new("UIStroke", header); hstroke.Thickness = 1

    local title = Instance.new("TextLabel", header)
    title.Size = UDim2.new(0.5,0,1,0)
    title.Position = UDim2.new(0,8,0,0)
    title.BackgroundTransparency = 1
    title.Font = Enum.Font.GothamBold
    title.TextSize = 16
    title.TextXAlignment = Enum.TextXAlignment.Left
    title.TextColor3 = Color3.fromRGB(230,235,255)
    title.Text = "AegisHub • Fish It (Android)"

    local tabFarmBtn = Instance.new("TextButton", header)
    tabFarmBtn.Size = UDim2.new(0,100,0,28)
    tabFarmBtn.Position = UDim2.new(1,-220,0,8)
    tabFarmBtn.Text = "Farm"
    tabFarmBtn.BackgroundColor3 = Color3.fromRGB(30,31,41)
    tabFarmBtn.TextColor3 = Color3.new(1,1,1)
    tabFarmBtn.Font = Enum.Font.Gotham
    tabFarmBtn.TextSize = 14
    local t1c = Instance.new("UICorner", tabFarmBtn); t1c.CornerRadius = UDim.new(0,6)

    local tabTPBtn = tabFarmBtn:Clone()
    tabTPBtn.Parent = header
    tabTPBtn.Position = UDim2.new(1,-110,0,8)
    tabTPBtn.Text = "Teleport"

    -- Body pages
    local body = Instance.new("Frame", gui)
    body.Size = UDim2.new(1,0,1,-44)
    body.Position = UDim2.new(0,0,0,44)
    body.BackgroundColor3 = Color3.fromRGB(32,33,43)

    local pageFarm = Instance.new("ScrollingFrame", body)
    pageFarm.Name = "Farm"
    pageFarm.Size = UDim2.new(1,0,1,0)
    pageFarm.BackgroundTransparency = 1
    pageFarm.ScrollBarThickness = 4
    local pfList = Instance.new("UIListLayout", pageFarm); pfList.Padding = UDim.new(0,6)
    local pfPad  = Instance.new("UIPadding", pageFarm); pfPad.PaddingLeft = UDim.new(0,8); pfPad.PaddingTop = UDim.new(0,8); pfPad.PaddingRight = UDim.new(0,8); pfPad.PaddingBottom = UDim.new(0,8)

    local pageTP = pageFarm:Clone()
    pageTP.Parent = body
    pageTP.Name = "Teleport"
    pageTP.Visible = false

    -- Helpers
    local function card(parent, h)
        local fr = Instance.new("Frame", parent)
        fr.Size = UDim2.new(1, -16, 0, h or 58)
        fr.BackgroundColor3 = Color3.fromRGB(30,31,41)
        local c = Instance.new("UICorner", fr); c.CornerRadius = UDim.new(0,8)
        return fr
    end
    local function toggle(parent, label, callback)
        local fr = card(parent, 58)
        local t = Instance.new("TextLabel", fr)
        t.BackgroundTransparency=1
        t.Position=UDim2.new(0,10,0,6)
        t.Size=UDim2.new(1,-120,0,20)
        t.Font=Enum.Font.GothamBold
        t.TextSize=14
        t.TextXAlignment=Enum.TextXAlignment.Left
        t.TextColor3=Color3.new(1,1,1)
        t.Text=label

        local btn = Instance.new("TextButton", fr)
        btn.Size=UDim2.new(0,92,0,28)
        btn.Position=UDim2.new(1,-110,0,10)
        btn.Text="[ OFF ]"
        btn.BackgroundColor3=Color3.fromRGB(24,25,32)
        btn.TextColor3=Color3.new(1,1,1)
        btn.Font=Enum.Font.Gotham
        btn.TextSize=14
        local bc = Instance.new("UICorner", btn); bc.CornerRadius=UDim.new(0,6)

        local on=false
        btn.MouseButton1Click:Connect(function()
            on = not on
            btn.Text = on and "[ ON ]" or "[ OFF ]"
            pcall(callback, on)
        end)
        return {set=function(v) on=v; btn.Text = on and "[ ON ]" or "[ OFF ]"; pcall(callback,on) end}
    end
    local function input(parent, label, placeholder, callback)
        local fr = card(parent, 72)
        local t = Instance.new("TextLabel", fr)
        t.BackgroundTransparency=1
        t.Position=UDim2.new(0,10,0,6)
        t.Size=UDim2.new(1,-20,0,20)
        t.Font=Enum.Font.GothamBold
        t.TextSize=14
        t.TextXAlignment=Enum.TextXAlignment.Left
        t.TextColor3=Color3.new(1,1,1)
        t.Text=label

        local tb = Instance.new("TextBox", fr)
        tb.Size=UDim2.new(1,-20,0,28)
        tb.Position=UDim2.new(0,10,0,34)
        tb.Text=""
        tb.PlaceholderText=placeholder or ""
        tb.BackgroundColor3=Color3.fromRGB(24,25,32)
        tb.TextColor3=Color3.new(1,1,1)
        tb.Font=Enum.Font.Gotham
        tb.TextSize=14
        local bc = Instance.new("UICorner", tb); bc.CornerRadius=UDim.new(0,6)

        tb.FocusLost:Connect(function() pcall(callback, tb.Text) end)
        return {set=function(v) tb.Text = tostring(v or "") end}
    end
    local function dropdown(parent, label, values, callback)
        local fr = card(parent, 58)
        local t = Instance.new("TextLabel", fr)
        t.BackgroundTransparency=1
        t.Position=UDim2.new(0,10,0,6)
        t.Size=UDim2.new(1,-140,0,20)
        t.Font=Enum.Font.GothamBold
        t.TextSize=14
        t.TextXAlignment=Enum.TextXAlignment.Left
        t.TextColor3=Color3.new(1,1,1)
        t.Text=label

        local openBtn = Instance.new("TextButton", fr)
        openBtn.Size=UDim2.new(0,120,0,28)
        openBtn.Position=UDim2.new(1,-130,0,10)
        openBtn.Text="Select"
        openBtn.BackgroundColor3=Color3.fromRGB(24,25,32)
        openBtn.TextColor3=Color3.new(1,1,1)
        openBtn.Font=Enum.Font.Gotham
        openBtn.TextSize=14
        local bc = Instance.new("UICorner", openBtn); bc.CornerRadius=UDim.new(0,6)

        local listGui = Instance.new("ScrollingFrame", fr)
        listGui.Visible=false
        listGui.Size=UDim2.new(1,-20,0,140)
        listGui.Position=UDim2.new(0,10,0,42)
        listGui.BackgroundColor3=Color3.fromRGB(26,26,34)
        listGui.ScrollBarThickness=4
        local lc = Instance.new("UICorner", listGui); lc.CornerRadius=UDim.new(0,6)
        local lv = Instance.new("UIListLayout", listGui); lv.Padding=UDim.new(0,4)
        local pad=Instance.new("UIPadding", listGui); pad.PaddingLeft=UDim.new(0,6); pad.PaddingTop=UDim.new(0,6); pad.PaddingRight=UDim.new(0,6); pad.PaddingBottom=UDim.new(0,6)

        local function rebuild(opts)
            for _,c in ipairs(listGui:GetChildren()) do
                if c:IsA("TextButton") then c:Destroy() end
            end
            for _,v in ipairs(opts or {}) do
                local b=Instance.new("TextButton", listGui)
                b.Size=UDim2.new(1,0,0,28)
                b.BackgroundColor3=Color3.fromRGB(30,31,41)
                b.TextColor3=Color3.new(1,1,1)
                b.Font=Enum.Font.Gotham
                b.TextSize=14
                b.Text=tostring(v)
                local bc=Instance.new("UICorner", b); bc.CornerRadius=UDim.new(0,6)
                b.MouseButton1Click:Connect(function()
                    openBtn.Text = tostring(v)
                    listGui.Visible=false
                    pcall(callback, v)
                end)
            end
        end
        rebuild(values or {})

        openBtn.MouseButton1Click:Connect(function()
            listGui.Visible = not listGui.Visible
        end)

        return {
            setOptions = function(_, opts) rebuild(opts or {}) end,
            setValue = function(_, v) openBtn.Text = tostring(v or "Select") end
        }
    end

    -- Tabs behavior
    local function showFarm()
        pageFarm.Visible = true
        pageTP.Visible   = false
        tabFarmBtn.BackgroundColor3 = Color3.fromRGB(47,110,255)
        tabTPBtn.BackgroundColor3   = Color3.fromRGB(30,31,41)
    end
    local function showTP()
        pageFarm.Visible = false
        pageTP.Visible   = true
        tabTPBtn.BackgroundColor3   = Color3.fromRGB(47,110,255)
        tabFarmBtn.BackgroundColor3 = Color3.fromRGB(30,31,41)
    end
    tabFarmBtn.MouseButton1Click:Connect(showFarm)
    tabTPBtn.MouseButton1Click:Connect(showTP)
    showFarm() -- default

    -- ======== FARM CONTROLS ========
    local lb1 = card(pageFarm, 40)
    local lbt = Instance.new("TextLabel", lb1)
    lbt.BackgroundTransparency=1; lbt.Size=UDim2.new(1,-20,1,0); lbt.Position=UDim2.new(0,10,0,0)
    lbt.Font=Enum.Font.GothamBlack; lbt.TextSize=14; lbt.TextXAlignment=Enum.TextXAlignment.Left
    lbt.TextColor3=Color3.new(1,1,1); lbt.Text="FARMING"

    toggle(pageFarm, "Auto Fishing", function(on) if on then StartAutoFish() else StopAutoFish() end end)
    toggle(pageFarm, "Perfect Cast", function(on) Flags.PerfectCast = on end)
    input(pageFarm, "Bypass Delay Override (ex: 1.45)", "1.45", function(txt)
        local n = tonumber(txt); if n then BypassDelay = math.max(0.05, n) end
    end)
    toggle(pageFarm, "Auto Sell (non-favorite)", function(on)
        Flags.AutoSell = on; if on then startAutoSell() end
    end)
    input(pageFarm, "Sell Threshold (default 60)", "60", function(txt)
        local n = tonumber(txt); if n then SELL_THRESHOLD = math.max(1, math.floor(n)) end
    end)
    toggle(pageFarm, "Auto Favorite (Secret/Mythic/Legendary)", function(on)
        Flags.AutoFav = on; if on then startAutoFavorite() end
    end)

    -- ======== TELEPORT CONTROLS ========
    local coordLabel = card(pageTP, 40)
    local ctext = Instance.new("TextLabel", coordLabel)
    ctext.BackgroundTransparency=1; ctext.Size=UDim2.new(1,-20,1,0); ctext.Position=UDim2.new(0,10,0,0)
    ctext.Font=Enum.Font.GothamBlack; ctext.TextSize=14; ctext.TextXAlignment=Enum.TextXAlignment.Left
    ctext.TextColor3=Color3.new(1,1,1); ctext.Text="COORDINATES • X: 0.0  Y: 0.0  Z: 0.0"

    local ddIsland = dropdown(pageTP, "Teleport Island", islandList, function(choice)
        tpTo(islands[choice])
    end)

    local ddNPC = dropdown(pageTP, "Teleport NPC (Scan)", scanNPC_Models(), function(name)
        if not name or name=="" then return end
        local ch  = (LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait())
        local hrp = ch and ch:FindFirstChild("HumanoidRootPart"); if not hrp then return end
        local best,dist
        for _,m in ipairs(ws:GetDescendants()) do
            if m:IsA("Model") and string.find(string.lower(m.Name), string.lower(name), 1, true) then
                local p = m:FindFirstChild("HumanoidRootPart") or m.PrimaryPart or m:FindFirstChildWhichIsA("BasePart")
                if p then
                    local d = (p.Position - hrp.Position).Magnitude
                    if not dist or d < dist then best = p; dist = d end
                end
            end
        end
        if best then tpTo(best.Position) end
    end)

    local ddPlayer = dropdown(pageTP, "Teleport Player", playersList(), function(nm)
        local p=Players:FindFirstChild(nm)
        if p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
            tpTo(p.Character.HumanoidRootPart.Position)
        end
    end)

    -- Live updates
    RunService.RenderStepped:Connect(function()
        local ch = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
        local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
        if hrp then
            local p = hrp.Position
            ctext.Text = ("COORDINATES • X: %.1f  Y: %.1f  Z: %.1f"):format(p.X,p.Y,p.Z):upper()
        end
    end)

    task.spawn(function()
        while gui.Parent do
            task.wait(8)
            pcall(function()
                ddNPC:setOptions(scanNPC_Models())
                ddPlayer:setOptions(playersList())
            end)
        end
    end)

    return gui
end

-- ====== BUILD (dengan fallback) ======
local ok, gui = pcall(buildUI)
if not ok or not gui then
    -- Fallback panel jika UI gagal
    local pg = guiParent()
    local fb = Instance.new("ScreenGui", pg)
    fb.Name = "AegisHub_FALLBACK"
    fb.ResetOnSpawn=false
    local f = Instance.new("Frame", fb)
    f.Size=UDim2.new(0,260,0,120); f.Position=UDim2.new(0.5,-130,0.5,-60)
    f.BackgroundColor3=Color3.fromRGB(30,31,41)
    local c=Instance.new("UICorner",f); c.CornerRadius=UDim.new(0,8)
    local l=Instance.new("TextLabel", f)
    l.BackgroundTransparency=1; l.Size=UDim2.new(1,-16,0,60); l.Position=UDim2.new(0,8,0,8)
    l.Font=Enum.Font.GothamBold; l.TextSize=14; l.TextColor3=Color3.new(1,1,1)
    l.TextWrapped=true
    l.Text="UI gagal dibuat.\nTap RELOAD untuk mencoba lagi (Android safe)."
    local b=Instance.new("TextButton", f)
    b.Size=UDim2.new(1,-16,0,32); b.Position=UDim2.new(0,8,1,-40)
    b.BackgroundColor3=Color3.fromRGB(47,110,255); b.TextColor3=Color3.new(1,1,1)
    b.Font=Enum.Font.Gotham; b.TextSize=14; b.Text="RELOAD UI"
    local bc=Instance.new("UICorner", b); bc.CornerRadius=UDim.new(0,6)
    b.MouseButton1Click:Connect(function()
        pcall(function() fb:Destroy() end)
        pcall(buildUI)
    end)
end
