--========================================================
-- AEGISHUB UI LIBRARY - CLEAN BASE
--========================================================

if not game:IsLoaded() then game.Loaded:Wait() end

local Players            = game:GetService("Players")
local RunService         = game:GetService("RunService")
local Lighting           = game:GetService("Lighting")
local Workspace          = game:GetService("Workspace")
local UserInputService   = game:GetService("UserInputService")
local TweenService       = game:GetService("TweenService")
local CoreGui            = game:GetService("CoreGui")

local LocalPlayer        = Players.LocalPlayer
local UIS                = UserInputService

local ACCENT      = Color3.fromRGB(110,175,255)
local ACCENT_TEXT = Color3.fromRGB(227,229,255)
local BG_DARK     = Color3.fromRGB(42,44,56)
local BG_CARD     = Color3.fromRGB(30,31,41)

local function protect(inst)
    if syn and syn.protect_gui then syn.protect_gui(inst) end
end

local function tw(o,t,props)
    local a = TweenService:Create(o, TweenInfo.new(t, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), props)
    a:Play()
    return a
end

----------------------------------------------------------------
-- UI LIBRARY
----------------------------------------------------------------
local library = {}

function library:CreateWindow(name, version, icon)
    name    = name    or "AegisHub"
    version = version or "Premium"
    icon    = icon    or 10044538000

    -- ScreenGui
    local Gui = Instance.new("ScreenGui")
    Gui.Name = "AegisHub_UI"
    Gui.ResetOnSpawn = false
    Gui.IgnoreGuiInset = false
    Gui.DisplayOrder = 9999
    Gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    protect(Gui)
    Gui.Parent = CoreGui

    -- Scale
    local function calcScale()
        local cam = Workspace.CurrentCamera
        local vp  = cam and cam.ViewportSize or Vector2.new(1280,720)
        local s   = math.min(vp.X, vp.Y)
        if s <= 720 then return .85 elseif s <= 900 then return .92 else return 1 end
    end
    local SCALE = calcScale()

    -- Overlay toggle (floating ball)
    local Overlay = Instance.new("ImageButton")
    Overlay.Parent = Gui
    Overlay.Size = UDim2.fromOffset(40,40)
    Overlay.BackgroundColor3 = Color3.fromRGB(32,34,46)
    Overlay.Image = "rbxassetid://10045753138"
    Overlay.ImageColor3 = ACCENT
    local u = Instance.new("UICorner",Overlay) u.CornerRadius = UDim.new(1,0)
    local s = Instance.new("UIStroke",Overlay) s.Transparency = .85

    -- Position overlay
    task.wait()
    local cam = Workspace.CurrentCamera
    Overlay.Position = UDim2.fromOffset(12, (cam.ViewportSize.Y/2)-20)

    -- Drag overlay
    do
        local dragging, startPos, startUIPos
        Overlay.InputBegan:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                startPos = i.Position
                startUIPos = Overlay.Position
                i.Changed:Connect(function()
                    if i.UserInputState == Enum.UserInputState.End then dragging = false end
                end)
            end
        end)

        UIS.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement) then
                local delta = i.Position - startPos
                local nx = startUIPos.X.Offset + delta.X
                local ny = startUIPos.Y.Offset + delta.Y
                Overlay.Position = UDim2.fromOffset(nx, ny)
            end
        end)
    end

    -- Window
    local Window = Instance.new("Frame")
    Window.Parent = Gui
    Window.Size = UDim2.fromOffset(520*SCALE, 340*SCALE)
    Window.Position = UDim2.new(.5, -260*SCALE, .5, -170*SCALE)
    Window.BackgroundColor3 = BG_DARK
    Instance.new("UICorner",Window).CornerRadius = UDim.new(0,6)

    -- Title bar
    local Title = Instance.new("Frame",Window)
    Title.Size = UDim2.new(1,0,0,30*SCALE)
    Title.BackgroundTransparency = 1

    local Icon = Instance.new("ImageLabel",Title)
    Icon.BackgroundTransparency = 1
    Icon.Size = UDim2.fromOffset(18*SCALE,18*SCALE)
    Icon.Position = UDim2.fromOffset(8,6)
    Icon.Image = "rbxassetid://"..icon
    Icon.ImageColor3 = ACCENT

    local TitleText = Instance.new("TextLabel",Title)
    TitleText.BackgroundTransparency = 1
    TitleText.Position = UDim2.fromOffset(30,0)
    TitleText.Size = UDim2.new(1,-30,1,0)
    TitleText.Font = Enum.Font.GothamMedium
    TitleText.TextSize = 12*SCALE
    TitleText.TextXAlignment = Enum.TextXAlignment.Left
    TitleText.Text = name.." - "..version
    TitleText.TextColor3 = Color3.new(1,1,1)

    local CloseBtn = Instance.new("TextButton",Title)
    CloseBtn.BackgroundTransparency = 1
    CloseBtn.Text = "X"
    CloseBtn.TextColor3 = Color3.fromRGB(255,80,80)
    CloseBtn.Font = Enum.Font.GothamBold
    CloseBtn.TextSize = 14*SCALE
    CloseBtn.Size = UDim2.fromOffset(20,20)
    CloseBtn.Position = UDim2.new(1,-26,0,4)
    CloseBtn.MouseButton1Click:Connect(function() Gui:Destroy() end)

    -- Window Drag
    do
        local dragging, startPos, windowPos
        Title.InputBegan:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = true
                startPos = i.Position
                windowPos = Window.Position
                i.Changed:Connect(function()
                    if i.UserInputState == Enum.UserInputState.End then
                        dragging = false
                    end
                end)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if dragging and i.UserInputType == Enum.UserInputType.MouseMovement then
                local d = i.Position - startPos
                Window.Position = UDim2.new(windowPos.X.Scale, windowPos.X.Offset+d.X, windowPos.Y.Scale, windowPos.Y.Offset+d.Y)
            end
        end)
    end

    -- Toggle show/hide window
    local hidden = false
    Overlay.MouseButton1Click:Connect(function()
        hidden = not hidden
        Window.Visible = not hidden
        tw(Overlay,.12,{ImageColor3 = hidden and Color3.fromRGB(200,200,200) or ACCENT})
    end)

    -- Tabs rail
    local TabsRail = Instance.new("Frame",Window)
    TabsRail.Position = UDim2.fromOffset(6,36*SCALE)
    TabsRail.Size = UDim2.fromOffset(136*SCALE, 340*SCALE - 42*SCALE)
    TabsRail.BackgroundColor3 = Color3.fromRGB(39,40,51)
    Instance.new("UICorner",TabsRail).CornerRadius = UDim.new(0,6)

    local TabsLayout = Instance.new("UIListLayout",TabsRail)
    TabsLayout.Padding = UDim.new(0,6)

    local label = Instance.new("TextLabel",TabsRail)
    label.BackgroundTransparency = 1
    label.Text = "Sections"
    label.TextColor3 = Color3.new(1,1,1)
    label.Font = Enum.Font.GothamBlack
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Position = UDim2.fromOffset(8,0)
    label.Size = UDim2.fromOffset(100,20)

    local firstTabLoaded = false

    --------------------------------------------------------
    -- MAKE PAGE FUNCTION
    --------------------------------------------------------
    local function makePage(title)
        local Page = Instance.new("ScrollingFrame",Window)
        Page.Visible = false
        Page.Position = UDim2.fromOffset(150*SCALE, 36*SCALE)
        Page.Size = UDim2.new(1,-156*SCALE,1,-42*SCALE)
        Page.CanvasSize = UDim2.new(0,0,0,0)
        Page.AutomaticCanvasSize = Enum.AutomaticSize.Y
        Page.ScrollBarThickness = 4
        Page.ScrollBarImageColor3 = ACCENT
        Page.BackgroundColor3 = BG_DARK
        Instance.new("UICorner",Page).CornerRadius = UDim.new(0,6)

        local pad = Instance.new("UIPadding",Page)
        pad.PaddingTop = UDim.new(0,6)
        pad.PaddingLeft = UDim.new(0,6)
        pad.PaddingRight = UDim.new(0,6)
        pad.PaddingBottom = UDim.new(0,6)

        local vlist = Instance.new("UIListLayout",Page)
        vlist.Padding = UDim.new(0,6)

        local TabBtn = Instance.new("TextButton",TabsRail)
        TabBtn.Text = title
        TabBtn.BackgroundTransparency = 1
        TabBtn.TextColor3 = Color3.new(1,1,1)
        TabBtn.TextTransparency = .5
        TabBtn.Font = Enum.Font.Gotham
        TabBtn.TextSize = 11*SCALE
        TabBtn.Size = UDim2.fromOffset(130*SCALE,20)

        local indicator = Instance.new("Frame",TabBtn)
        indicator.Size = UDim2.fromOffset(2, 16)
        indicator.Position = UDim2.fromOffset(-6,2)
        indicator.BackgroundColor3 = ACCENT
        indicator.Visible = false

        local function select()
            -- hide all pages
            for _,v in ipairs(Window:GetChildren()) do
                if v:IsA("ScrollingFrame") then v.Visible = false end
            end
            -- reset all tabs
            for _,b in ipairs(TabsRail:GetChildren()) do
                if b:IsA("TextButton") then
                    b.TextTransparency = .5
                    local ind = b:FindFirstChildWhichIsA("Frame")
                    if ind then ind.Visible = false end
                end
            end
            -- activate this
            indicator.Visible = true
            TabBtn.TextTransparency = 0
            Page.Visible = true
        end

        TabBtn.MouseButton1Click:Connect(select)
        if not firstTabLoaded then firstTabLoaded = true; select() end

        ----------------------------------------------------
        -- PAGE API (label, toggle, box, dropdown)
        ----------------------------------------------------
        local PageAPI = {}

        function PageAPI:CreateLabel(text)
            local L = Instance.new("TextLabel",Page)
            L.BackgroundTransparency = 1
            L.Font = Enum.Font.GothamBlack
            L.TextSize = 12*SCALE
            L.TextColor3 = Color3.new(1,1,1)
            L.TextXAlignment = Enum.TextXAlignment.Left
            L.Size = UDim2.new(1,0,0,16)
            L.Text = string.upper(text)
            return L
        end

        function PageAPI:CreateButton(text, callback)
            callback = callback or function() end
            local B = Instance.new("TextButton",Page)
            B.Size = UDim2.new(1,0,0,30)
            B.BackgroundColor3 = BG_CARD
            B.Font = Enum.Font.GothamSemibold
            B.TextSize = 11*SCALE
            B.TextColor3 = Color3.new(1,1,1)
            B.Text = text
            Instance.new("UICorner",B).CornerRadius = UDim.new(0,6)
            B.MouseButton1Click:Connect(callback)
            return B
        end

        function PageAPI:CreateBox(placeholder, callback)
            callback = callback or function() end

            local container = Instance.new("Frame",Page)
            container.BackgroundColor3 = BG_CARD
            container.Size = UDim2.new(1,0,0,50)
            Instance.new("UICorner",container).CornerRadius = UDim.new(0,6)

            local txt = Instance.new("TextLabel",container)
            txt.BackgroundTransparency = 1
            txt.Position = UDim2.fromOffset(8,4)
            txt.Size = UDim2.new(1,-16,0,16)
            txt.Font = Enum.Font.GothamBlack
            txt.TextSize = 12*SCALE
            txt.TextColor3 = Color3.new(1,1,1)
            txt.TextXAlignment = Enum.TextXAlignment.Left
            txt.Text = placeholder

            local box = Instance.new("TextBox",container)
            box.Position = UDim2.fromOffset(8,22)
            box.Size = UDim2.new(1,-16,0,22)
            box.BackgroundColor3 = Color3.fromRGB(24,25,32)
            box.Font = Enum.Font.Gotham
            box.TextColor3 = Color3.new(1,1,1)
            box.PlaceholderText = placeholder
            box.TextSize = 11*SCALE
            Instance.new("UICorner",box).CornerRadius = UDim.new(0,6)

            box.FocusLost:Connect(function()
                callback(box.Text)
            end)

            return box
        end

        function PageAPI:CreateToggle(text, callback)
            callback = callback or function() end

            local container = Instance.new("Frame",Page)
            container.Size = UDim2.new(1,0,0,30)
            container.BackgroundColor3 = BG_CARD
            Instance.new("UICorner",container).CornerRadius = UDim.new(0,6)

            local lbl = Instance.new("TextLabel",container)
            lbl.BackgroundTransparency = 1
            lbl.Font = Enum.Font.Gotham
            lbl.TextSize = 11*SCALE
            lbl.TextColor3 = Color3.new(1,1,1)
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.Position = UDim2.fromOffset(8,6)
            lbl.Size = UDim2.new(1,-50,1,-12)
            lbl.Text = text

            local btn = Instance.new("TextButton",container)
            btn.Size = UDim2.fromOffset(36,18)
            btn.Position = UDim2.new(1,-44,0.5,-9)
            btn.BackgroundColor3 = Color3.fromRGB(24,25,32)
            btn.Text = ""
            Instance.new("UICorner",btn).CornerRadius = UDim.new(1,0)

            local dot = Instance.new("Frame",btn)
            dot.Size = UDim2.fromOffset(16,16)
            dot.Position = UDim2.fromOffset(2,1)
            dot.BackgroundColor3 = ACCENT
            dot.BackgroundTransparency = .5
            Instance.new("UICorner",dot).CornerRadius = UDim.new(1,0)

            local state = false

            local function update()
                if state then
                    tw(dot,.12,{
                        Position = UDim2.fromOffset(18,1),
                        BackgroundTransparency = 0
                    })
                else
                    tw(dot,.12,{
                        Position = UDim2.fromOffset(2,1),
                        BackgroundTransparency = .5
                    })
                end
                callback(state)
            end

            btn.MouseButton1Click:Connect(function()
                state = not state
                update()
            end)

            return {
                Set = function(_,v)
                    state = v
                    update()
                end
            }
        end

        function PageAPI:CreateDropdown(title, options, callback)
            callback = callback or function() end
            options = options or {}

            local container = Instance.new("Frame",Page)
            container.Size = UDim2.new(1,0,0,60)
            container.BackgroundColor3 = BG_CARD
            Instance.new("UICorner",container).CornerRadius = UDim.new(0,6)

            local lbl = Instance.new("TextLabel",container)
            lbl.Text = title
            lbl.Font = Enum.Font.GothamBlack
            lbl.TextSize = 12*SCALE
            lbl.TextColor3 = Color3.new(1,1,1)
            lbl.BackgroundTransparency = 1
            lbl.Position = UDim2.fromOffset(8,4)
            lbl.Size = UDim2.new(1,-16,0,16)
            lbl.TextXAlignment = Enum.TextXAlignment.Left

            local mainBtn = Instance.new("TextButton",container)
            mainBtn.Position = UDim2.fromOffset(8,24)
            mainBtn.Size = UDim2.new(1,-16,0,24)
            mainBtn.BackgroundColor3 = Color3.fromRGB(24,25,32)
            mainBtn.TextColor3 = Color3.new(1,1,1)
            mainBtn.Font = Enum.Font.Gotham
            mainBtn.Text = "Select"
            mainBtn.TextSize = 11*SCALE
            Instance.new("UICorner",mainBtn).CornerRadius = UDim.new(0,6)

            local listHolder = Instance.new("Frame",container)
            listHolder.Visible = false
            listHolder.BackgroundColor3 = BG_CARD
            listHolder.Position = UDim2.fromOffset(8,52)
            listHolder.Size = UDim2.new(1,-16,0,0)
            listHolder.AutomaticSize = Enum.AutomaticSize.Y
            Instance.new("UICorner",listHolder).CornerRadius = UDim.new(0,6)

            local layout = Instance.new("UIListLayout",listHolder)
            layout.Padding = UDim.new(0,4)

            local currentValue = nil

            local function rebuild()
                for _,v in ipairs(listHolder:GetChildren()) do
                    if v:IsA("TextButton") then v:Destroy() end
                end

                for _,opt in ipairs(options) do
                    local op = Instance.new("TextButton",listHolder)
                    op.Size = UDim2.new(1,0,0,22)
                    op.BackgroundColor3 = Color3.fromRGB(24,25,32)
                    op.Font = Enum.Font.Gotham
                    op.TextSize = 11*SCALE
                    op.TextColor3 = Color3.new(1,1,1)
                    op.Text = opt
                    Instance.new("UICorner",op).CornerRadius = UDim.new(0,6)

                    op.MouseButton1Click:Connect(function()
                        currentValue = opt
                        mainBtn.Text = opt
                        listHolder.Visible = false
                        callback(opt)
                    end)
                end
            end

            rebuild()

            mainBtn.MouseButton1Click:Connect(function()
                listHolder.Visible = not listHolder.Visible
            end)

            return {
                SetValue = function(_,v)
                    currentValue = v
                    mainBtn.Text = tostring(v)
                end,
                SetOptions = function(_,opts)
                    options = opts
                    rebuild()
                end,
                GetValue = function() return currentValue end
            }
        end

        return PageAPI
    end

    --------------------------------------------------------
    -- RETURN WINDOW API
    --------------------------------------------------------
    local winAPI = {}

    function winAPI:CreateTab(title)
        local tabObj = {}
        function tabObj:CreateFrame(pageTitle)
            return makePage(pageTitle or title)
        end
        return tabObj
    end

    return winAPI
end

--========================================================
-- Buat window utama
--========================================================
local win = library:CreateWindow("AegisHub - Fish It", "Premium")

--========================================================
-- PART 2 - FARM (Auto Fish + Auto Favorite + Auto Sell + Auto Enchant + Weather)
--========================================================

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players2          = game:GetService("Players")
local Workspace2        = game:GetService("Workspace")
local LocalPlayer2      = Players2.LocalPlayer

-- sleitnick/net
local netIndex = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")

local net = netIndex:WaitForChild("net")

local RF_Charge              = net:WaitForChild("RF/ChargeFishingRod")
local RF_RequestMinigame     = net:WaitForChild("RF/RequestFishingMinigameStarted")
local RE_FishingCompleted    = net:WaitForChild("RE/FishingCompleted")
local RE_EquipHotbar         = net:WaitForChild("RE/EquipToolFromHotbar")
local RE_TextEffect          = net:WaitForChild("RE/ReplicateTextEffect")
local RE_FishCaught          = net:FindFirstChild("RE/FishCaught")

-- Tambahan dari decompile (favorit, jual, weather, enchant)
local RE_ObtainedNewFish     = net:WaitForChild("RE/ObtainedNewFishNotification")
local RE_FavoriteItem        = net:WaitForChild("RE/FavoriteItem")
local RF_SellAllItems        = net:WaitForChild("RF/SellAllItems")
local RF_PurchaseWeather     = net:WaitForChild("RF/PurchaseWeatherEvent")
local RE_ActivateEnchant     = net:WaitForChild("RE/ActivateEnchantingAltar")

--========================================================
-- TAB FARM
--========================================================
local TabFarm   = win:CreateTab("Farm")
local PageFarm  = TabFarm:CreateFrame("Farm")
PageFarm:CreateLabel("FARM MENU")

--========================================================
-- STATE FARM
--========================================================
local Farm = {
    -- AUTO FISH
    AutoFish_Enabled        = false,
    AutoFish_CompleteDelay  = 0.10, -- jeda dari ! ke tarik
    AutoFish_ReelDelay      = 0.05, -- jeda dari tarik ke lempar

    -- FAVORITE
    AutoFavorite_Enabled    = false,
    AutoFavorite_Rarity     = {
        COMMON    = false,
        UNCOMMON  = false,
        RARE      = false,
        EPIC      = false,
        LEGENDARY = false,
        MYTHIC    = false,
        SECRET    = false,
    },

    -- AUTO SELL
    AutoSell_Enabled        = false,
    AutoSell_Threshold      = 30,
    AutoSell_Delay          = 1.0,

    -- AUTO WEATHER (hanya satu aktif sekaligus via dropdown)
    AutoWeather             = {
        Storm   = false,
        Cloudy  = false,
        Snow    = false,
        Wind    = false,
        Radiant = false,
    },

    -- AUTO ENCHANT (manual sekali via dropdown)
    AutoEnchant_LastRun     = 0,
}

--========================================================
-- EQUIP ROD SEKALI
--========================================================
local RodEquippedOnce = false

local function EquipRodOnce()
    if RodEquippedOnce then return end
    RodEquippedOnce = true
    RE_EquipHotbar:FireServer(1) -- slot 1
    task.wait(0.30)
end

--========================================================
-- AUTO FISH - CAST + EXCLAIM HANDLER GLOBAL
--========================================================
local BASE_X, BASE_Y = -0.75, 1

local function DoCastOnce()
    if not Farm.AutoFish_Enabled then return end

    EquipRodOnce()

    local serverTime = Workspace2:GetServerTimeNow()
    RF_Charge:InvokeServer(serverTime)

    local rx = BASE_X + math.random(-300, 300) / 1e7
    local ry = BASE_Y + math.random(-300, 300) / 1e7

    RF_RequestMinigame:InvokeServer(rx, ry)
end

-- Exclaim global → tarik + recast (bypass delay = delay kecil, bisa diatur)
RE_TextEffect.OnClientEvent:Connect(function(data)
    if not Farm.AutoFish_Enabled then return end
    if not data or not data.TextData then return end
    if data.TextData.EffectType ~= "Exclaim" then return end

    local char = LocalPlayer2.Character
    local head = char and char:FindFirstChild("Head")
    if not head or data.Container ~= head then return end

    local completeDelay = tonumber(Farm.AutoFish_CompleteDelay) or 0.10
    local reelDelay     = tonumber(Farm.AutoFish_ReelDelay)     or 0.05

    if completeDelay < 0 then completeDelay = 0 end
    if reelDelay     < 0 then reelDelay     = 0 end

    task.delay(completeDelay, function()
        if not Farm.AutoFish_Enabled then return end

        RE_FishingCompleted:FireServer()

        task.delay(reelDelay, function()
            if Farm.AutoFish_Enabled then
                DoCastOnce()
            end
        end)
    end)
end)

--========================================================
-- RARITY MAP (FishId → Rarity) untuk Auto Favorite
--========================================================
local FishIdToRarity = {}
local tierToRarity = {
    [1] = "COMMON",
    [2] = "UNCOMMON",
    [3] = "RARE",
    [4] = "EPIC",
    [5] = "LEGENDARY",
    [6] = "MYTHIC",
    [7] = "SECRET",
}

do
    local itemsFolder = ReplicatedStorage:FindFirstChild("Items")
    if itemsFolder then
        for _, module in ipairs(itemsFolder:GetChildren()) do
            if module:IsA("ModuleScript") then
                local ok, data = pcall(require, module)
                if ok and data and data.Data and data.Data.Type == "Fish" then
                    local id   = data.Data.Id
                    local tier = tonumber(data.Data.Tier) or 0
                    local rarity = data.Data.Rarity
                    if not rarity then
                        rarity = tierToRarity[tier] or "UNKNOWN"
                    end
                    if id then
                        FishIdToRarity[id] = string.upper(tostring(rarity))
                    end
                end
            end
        end
    end
end

--========================================================
-- AUTO FAVORITE + AUTO SELL (pakai ObtainedNewFish)
--========================================================
local AutoSell_Count    = 0
local AutoSell_Cooldown = false

RE_ObtainedNewFish.OnClientEvent:Connect(function(itemId, _, data)
    if not data or not data.InventoryItem then return end
    local invItem = data.InventoryItem
    local uuid    = invItem.UUID
    if not uuid then return end

    -- AUTO FAVORITE BY RARITY
    if Farm.AutoFavorite_Enabled and itemId then
        local rarity = FishIdToRarity[itemId] or "UNKNOWN"
        rarity = string.upper(rarity)
        if Farm.AutoFavorite_Rarity[rarity] then
            pcall(function()
                RE_FavoriteItem:FireServer(uuid)
            end)
        end
    end

    -- AUTO SELL DENGAN DELAY
    if Farm.AutoSell_Enabled then
        AutoSell_Count += 1
        local limit = tonumber(Farm.AutoSell_Threshold) or 30
        if AutoSell_Count >= limit and not AutoSell_Cooldown then
            AutoSell_Cooldown = true
            task.spawn(function()
                pcall(function()
                    RF_SellAllItems:InvokeServer()
                end)
                local delaySell = tonumber(Farm.AutoSell_Delay) or 1.0
                if delaySell < 0 then delaySell = 0 end
                task.wait(delaySell)
                AutoSell_Count    = 0
                AutoSell_Cooldown = false
            end)
        end
    end
end)

--========================================================
-- AUTO ENCHANT ROD (teleport ke altar, slot 5)
--========================================================
local ENCHANT_POSITION = Vector3.new(3231, -1303, 1402) -- contoh dari decompile

local function AutoEnchantRod()
    local chars = Workspace2:FindFirstChild("Characters")
    local char  = chars and chars:FindFirstChild(LocalPlayer2.Name)
    local hrp   = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then
        warn("[AutoEnchant] HRP tidak ditemukan")
        return
    end

    print("[AutoEnchant] Pastikan Enchant Stone ada di slot 5")

    local originalCFrame = hrp.CFrame

    task.wait(0.5)
    hrp.CFrame = CFrame.new(ENCHANT_POSITION + Vector3.new(0, 5, 0))
    task.wait(1.0)

    pcall(function()
        RE_EquipHotbar:FireServer(5)
        task.wait(0.5)
        RE_ActivateEnchant:FireServer()
    end)

    task.wait(7)
    hrp.CFrame = originalCFrame

    print("[AutoEnchant] Selesai")
end

--========================================================
-- AUTO BUY WEATHER
--========================================================
local function randomDelay(min, max)
    return math.random(min * 100, max * 100) / 100
end

local function startWeatherLoop(weatherName)
    task.spawn(function()
        while Farm.AutoWeather[weatherName] do
            pcall(function()
                RF_PurchaseWeather:InvokeServer(weatherName)
                print("[AutoWeather] Beli weather:", weatherName)
            end)

            local baseDuration = 900 -- 15 menit
            local extraDelay   = randomDelay(1, 5)
            local totalWait    = baseDuration + extraDelay

            local t0 = tick()
            while tick() - t0 < totalWait do
                if not Farm.AutoWeather[weatherName] then
                    return
                end
                task.wait(1)
            end
        end
    end)
end

local function setWeatherMode(mode)
    -- matikan semua dulu
    for k in pairs(Farm.AutoWeather) do
        Farm.AutoWeather[k] = false
    end

    if mode == "Off" then
        return
    end

    if Farm.AutoWeather[mode] ~= nil then
        Farm.AutoWeather[mode] = true
        startWeatherLoop(mode)
    end
end

--========================================================
-- UI / DROPDOWN FARM
--========================================================

----------------------------------------------------------------
-- AUTO FISH DROPDOWN (mode + preset delay)
----------------------------------------------------------------
PageFarm:CreateLabel("AUTO FISH (EXCLAIM)")

local ddAutoFishMode = PageFarm:CreateDropdown("Auto Fish Mode", {"Off","On"}, function(opt)
    if opt == "On" then
        Farm.AutoFish_Enabled = true
        DoCastOnce()
    else
        Farm.AutoFish_Enabled = false
    end
end)

-- Preset speed: Safe / Fast / Ultra
local ddAutoFishPreset = PageFarm:CreateDropdown("Auto Fish Speed Preset", {"Safe","Fast","Ultra"}, function(opt)
    if opt == "Safe" then
        Farm.AutoFish_CompleteDelay = 0.18
        Farm.AutoFish_ReelDelay     = 0.10
    elseif opt == "Fast" then
        Farm.AutoFish_CompleteDelay = 0.12
        Farm.AutoFish_ReelDelay     = 0.06
    elseif opt == "Ultra" then
        Farm.AutoFish_CompleteDelay = 0.08
        Farm.AutoFish_ReelDelay     = 0.04
    end
end)
ddAutoFishPreset:SetValue("Fast")

-- Box manual (kalau mau tuning halus)
PageFarm:CreateBox("Manual Complete Delay (detik)", function(txt)
    local n = tonumber(txt)
    if n and n >= 0 then
        Farm.AutoFish_CompleteDelay = n
    end
end)

PageFarm:CreateBox("Manual Reel Delay (detik)", function(txt)
    local n = tonumber(txt)
    if n and n >= 0 then
        Farm.AutoFish_ReelDelay = n
    end
end)

----------------------------------------------------------------
-- AUTO FAVORITE BY RARITY (dropdown preset)
----------------------------------------------------------------
PageFarm:CreateLabel("AUTO FAVORITE BY RARITY")

local ddAutoFavorite = PageFarm:CreateDropdown("Favorite Preset", {
    "Off",
    "Rare+ (RARE,EPIC,LEGENDARY,MYTHIC,SECRET)",
    "Epic+ (EPIC,LEGENDARY,MYTHIC,SECRET)",
    "Legendary+ (LEGENDARY,MYTHIC,SECRET)",
    "Mythic+ (MYTHIC,SECRET)",
    "Secret only"
}, function(opt)
    -- reset semua
    for k in pairs(Farm.AutoFavorite_Rarity) do
        Farm.AutoFavorite_Rarity[k] = false
    end

    if opt == "Off" then
        Farm.AutoFavorite_Enabled = false
        return
    end

    Farm.AutoFavorite_Enabled = true

    local function setRange(list)
        for _,r in ipairs(list) do
            Farm.AutoFavorite_Rarity[r] = true
        end
    end

    if opt:sub(1,4) == "Rare" then
        setRange({"RARE","EPIC","LEGENDARY","MYTHIC","SECRET"})
    elseif opt:sub(1,4) == "Epic" then
        setRange({"EPIC","LEGENDARY","MYTHIC","SECRET"})
    elseif opt:sub(1,9) == "Legendary" then
        setRange({"LEGENDARY","MYTHIC","SECRET"})
    elseif opt:sub(1,6) == "Mythic" then
        setRange({"MYTHIC","SECRET"})
    elseif opt:sub(1,6) == "Secret" then
        setRange({"SECRET"})
    end
end)
ddAutoFavorite:SetValue("Epic+ (EPIC,LEGENDARY,MYTHIC,SECRET)")

----------------------------------------------------------------
-- AUTO SELL (dropdown interval + delay)
----------------------------------------------------------------
PageFarm:CreateLabel("AUTO SELL (SELL ALL)")

local ddAutoSell = PageFarm:CreateDropdown("Auto Sell Mode", {
    "Off",
    "Every 10 fish",
    "Every 20 fish",
    "Every 30 fish",
    "Every 50 fish"
}, function(opt)
    if opt == "Off" then
        Farm.AutoSell_Enabled   = false
        AutoSell_Count          = 0
        return
    end

    Farm.AutoSell_Enabled = true
    if opt == "Every 10 fish" then
        Farm.AutoSell_Threshold = 10
    elseif opt == "Every 20 fish" then
        Farm.AutoSell_Threshold = 20
    elseif opt == "Every 30 fish" then
        Farm.AutoSell_Threshold = 30
    elseif opt == "Every 50 fish" then
        Farm.AutoSell_Threshold = 50
    end
end)
ddAutoSell:SetValue("Off")

PageFarm:CreateBox("Sell Delay setelah SellAll (detik, contoh 1.0)", function(txt)
    local n = tonumber(txt)
    if n and n >= 0 then
        Farm.AutoSell_Delay = n
    end
end)

----------------------------------------------------------------
-- AUTO ENCHANT (Dropdown trigger sekali)
----------------------------------------------------------------
PageFarm:CreateLabel("AUTO ENCHANT")

local ddAutoEnchant = PageFarm:CreateDropdown("Auto Enchant Action", {
    "Idle",
    "Run once now"
}, function(opt)
    if opt == "Run once now" then
        if tick() - Farm.AutoEnchant_LastRun < 5 then
            warn("[AutoEnchant] Tunggu sebentar sebelum menjalankan lagi.")
            return
        end
        Farm.AutoEnchant_LastRun = tick()
        AutoEnchantRod()
        -- balik ke Idle biar jelas
        ddAutoEnchant:SetValue("Idle")
    end
end)
ddAutoEnchant:SetValue("Idle")

----------------------------------------------------------------
-- AUTO BUY WEATHER (Dropdown)
----------------------------------------------------------------
PageFarm:CreateLabel("AUTO BUY WEATHER")

local ddWeather = PageFarm:CreateDropdown("Weather Mode", {
    "Off",
    "Storm",
    "Cloudy",
    "Snow",
    "Wind",
    "Radiant"
}, function(opt)
    setWeatherMode(opt)
end)
ddWeather:SetValue("Off")


--========================================================
-- PART 3 - TELEPORT + MISC + FPS/PING OVERLAY
--========================================================

local VirtualUser = game:GetService("VirtualUser")
local Stats       = game:GetService("Stats")

--------------------------------------------------------
-- TELEPORT TAB
--------------------------------------------------------
local function tpTo(pos: Vector3)
    if not pos then return end
    local plr = LocalPlayer
    local ch  = plr and (plr.Character or plr.CharacterAdded:Wait())
    local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
    if hrp then
        hrp.CFrame = CFrame.new(pos + Vector3.new(0, 5, 0))
    end
end

local TabTP  = win:CreateTab("Teleport")
local PageTP = TabTP:CreateFrame("Teleport")
PageTP:CreateLabel("TELEPORT MENU")

-- Island list
local islands = {
    ["Weather Machine"]            = Vector3.new(-1471,-3,1929),
    ["Esoteric Depths"]            = Vector3.new(3157,-1303,1439),
    ["Tropical Grove"]             = Vector3.new(-2038,3,3650),
    ["Stingray Shores"]            = Vector3.new(-32,4,2773),
    ["Kohana Volcano"]             = Vector3.new(-519,24,189),
    ["Coral Reefs"]                = Vector3.new(-3095,1,2177),
    ["Crater Island"]              = Vector3.new(968,1,4854),
    ["Kohana"]                     = Vector3.new(-658,3,719),
    ["Winter Fest"]                = Vector3.new(1611,4,3280),
    ["Esoteric Island"]            = Vector3.new(1987,4,1400),
    ["Treasure Room"]              = Vector3.new(-3600,-267,-1558),
    ["Lost Shore"]                 = Vector3.new(-3663,38,-989),
    ["Sisyphus"]                   = Vector3.new(-3792,-135,-986),
    ["Crystal Cavern"]             = Vector3.new(-2026,-440,7428),
    ["Halloween"]                  = Vector3.new(2127,78,3334),
    ["Ancient Underground Cave"]   = Vector3.new(2102,-91,-709),
    ["Ancient Inside Temple"]      = Vector3.new(1506,-22,-641),
    ["Ancient Jungle"]             = Vector3.new(1268,78,-183),
    ["Fisherman Island"]           = Vector3.new(-3,17,2840),
}
local islandList = {}
for name in pairs(islands) do table.insert(islandList, name) end
table.sort(islandList)

PageTP:CreateDropdown("Teleport Island", islandList, function(choice)
    local v = islands[choice]
    if v then tpTo(v) end
end)

-- Scan NPC models
local function scanNPC_Models()
    local found = {}
    for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and #m.Name >= 3 then
            if Players:GetPlayerFromCharacter(m) == nil then
                local hasHum = m:FindFirstChildOfClass("Humanoid") ~= nil
                local hasPrompt = false
                if not hasHum then
                    for _,d in ipairs(m:GetDescendants()) do
                        if d:IsA("ProximityPrompt") then hasPrompt = true break end
                    end
                end
                if hasHum or hasPrompt then
                    found[m.Name] = true
                end
            end
        end
    end
    local list = {}
    for k in pairs(found) do table.insert(list, k) end
    table.sort(list)
    return list
end

local npcList = scanNPC_Models()
local ddNPC = PageTP:CreateDropdown("Teleport NPC", npcList, function(nm)
    if not nm or nm == "" then return end
    local me   = LocalPlayer
    local ch   = me and (me.Character or me.CharacterAdded:Wait())
    local hrp  = ch and ch:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local best,dist
    for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and Players:GetPlayerFromCharacter(m) == nil then
            if string.find(string.lower(m.Name), string.lower(nm), 1, true) then
                local p = m:FindFirstChild("HumanoidRootPart") or m.PrimaryPart or m:FindFirstChildWhichIsA("BasePart")
                if p then
                    local d = (p.Position - hrp.Position).Magnitude
                    if not dist or d < dist then best = p; dist = d end
                end
            end
        end
    end
    if best then tpTo(best.Position) end
end)

-- Players dropdown
local function playersList()
    local t = {}
    for _,pl in ipairs(Players:GetPlayers()) do
        if pl ~= LocalPlayer then table.insert(t, pl.Name) end
    end
    table.sort(t)
    return t
end

local plrList = playersList()
local ddPlayer = PageTP:CreateDropdown("Teleport Player", plrList, function(nm)
    local p = Players:FindFirstChild(nm)
    if p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
        tpTo(p.Character.HumanoidRootPart.Position)
    end
end)

-- Refresh NPC & Player lists berkala
task.spawn(function()
    while true do
        task.wait(8)
        -- NPC refresh
        local newNPC = scanNPC_Models()
        if ddNPC and ddNPC.SetOptions then
            ddNPC:SetOptions(newNPC)
        end
        -- Player refresh
        local newPL = playersList()
        if ddPlayer and ddPlayer.SetOptions then
            ddPlayer:SetOptions(newPL)
        end
    end
end)

Players.PlayerAdded:Connect(function()
    if ddPlayer and ddPlayer.SetOptions then ddPlayer:SetOptions(playersList()) end
end)
Players.PlayerRemoving:Connect(function()
    if ddPlayer and ddPlayer.SetOptions then ddPlayer:SetOptions(playersList()) end
end)

--------------------------------------------------------
-- MISC TAB (ANTI AFK, FPS BOOST, LIGHTING, DLL)
--------------------------------------------------------
local TabMisc   = win:CreateTab("Misc")
local PageMisc  = TabMisc:CreateFrame("Misc")
PageMisc:CreateLabel("MISC / PERFORMANCE")

local MiscState = {
    AntiAFK        = false,
    FPSBoost       = false,
    LightingSimple = false,
    TexturesOff    = false,
    SmoothPlastic  = false,
    UltraNoEffects = false,
    FPSCapValue    = 120,
}

local Saved = {
    PostEffects   = {},
    GlobalShadows = nil,
    FogEnd        = nil,
}

-- ANTI AFK
local AntiAFK_Conn

local function EnableAntiAFK()
    if AntiAFK_Conn then AntiAFK_Conn:Disconnect() end
    AntiAFK_Conn = LocalPlayer.Idled:Connect(function()
        local cam = Workspace.CurrentCamera
        VirtualUser:Button2Down(Vector2.new(0,0), cam and cam.CFrame or CFrame.new())
        task.wait(0.7)
        VirtualUser:Button2Up(Vector2.new(0,0), cam and cam.CFrame or CFrame.new())
    end)
end

local function DisableAntiAFK()
    if AntiAFK_Conn then AntiAFK_Conn:Disconnect(); AntiAFK_Conn = nil end
end

-- FPS BOOST HELPERS
local function ApplySmoothPlastic()
    for _, v in ipairs(game:GetDescendants()) do
        if v:IsA("BasePart") then
            v.Material = Enum.Material.SmoothPlastic
            v.Reflectance = 0
        end
    end
end

local function DisableTextures()
    for _, v in ipairs(game:GetDescendants()) do
        if v:IsA("Decal") or v:IsA("Texture") then
            v.Transparency = 1
        end
    end
end

local function LightingSimplify()
    if Saved.GlobalShadows == nil then
        Saved.GlobalShadows = Lighting.GlobalShadows
    end
    if Saved.FogEnd == nil then
        Saved.FogEnd = Lighting.FogEnd
    end
    if #Saved.PostEffects == 0 then
        for _, eff in ipairs(Lighting:GetChildren()) do
            if eff:IsA("PostEffect") then
                table.insert(Saved.PostEffects, {ref = eff, enabled = eff.Enabled})
            end
        end
    end

    for _, eff in ipairs(Lighting:GetChildren()) do
        if eff:IsA("PostEffect") then
            eff.Enabled = false
        end
    end

    Lighting.GlobalShadows = false
    Lighting.FogEnd = 1e10
    Lighting.Brightness = 1
    Lighting.EnvironmentDiffuseScale  = 0
    Lighting.EnvironmentSpecularScale = 0
end

local function ResetLighting()
    for _, item in ipairs(Saved.PostEffects) do
        if item.ref and item.ref.Parent then
            item.ref.Enabled = item.enabled
        end
    end
    if Saved.GlobalShadows ~= nil then
        Lighting.GlobalShadows = Saved.GlobalShadows
    end
    if Saved.FogEnd ~= nil then
        Lighting.FogEnd = Saved.FogEnd
    end
end

local function KillCharacterAnimation(char)
    if not char then return end
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if humanoid then
        for _, track in ipairs(humanoid:GetPlayingAnimationTracks()) do
            pcall(function() track:Stop() end)
        end
        local animator = humanoid:FindFirstChildOfClass("Animator")
        if animator then
            pcall(function() animator:Destroy() end)
        end
    end
    local animate = char:FindFirstChild("Animate")
    if animate then
        pcall(function() animate:Destroy() end)
    end
end

local function KillAllHumanoidAnimations()
    for _, hum in ipairs(game:GetDescendants()) do
        if hum:IsA("Humanoid") then
            KillCharacterAnimation(hum.Parent)
        end
    end
end

local function KillParticlesAndLights()
    for _, v in ipairs(game:GetDescendants()) do
        if v:IsA("ParticleEmitter")
        or v:IsA("Trail")
        or v:IsA("Fire")
        or v:IsA("Smoke")
        or v:IsA("Sparkles")
        or v:IsA("Explosion")
        or v:IsA("Beam") then
            v.Enabled = false
        elseif v:IsA("PointLight")
        or v:IsA("SpotLight")
        or v:IsA("SurfaceLight") then
            v.Enabled = false
        end
    end

    local terrain = Workspace:FindFirstChildOfClass("Terrain")
    if terrain then
        terrain.WaterWaveSize        = 0
        terrain.WaterWaveSpeed       = 0
        terrain.WaterReflectance     = 0
        terrain.WaterTransparency    = 0
    end
end

local function UltraNoEffectsApply()
    KillAllHumanoidAnimations()
    KillParticlesAndLights()

    local function onChar(char)
        task.delay(1, function()
            if MiscState.UltraNoEffects then
                KillCharacterAnimation(char)
            end
        end)
    end

    if LocalPlayer.Character then
        onChar(LocalPlayer.Character)
    end
    LocalPlayer.CharacterAdded:Connect(onChar)
end

local function FPSBoostApply()
    if MiscState.SmoothPlastic   then ApplySmoothPlastic()   end
    if MiscState.TexturesOff     then DisableTextures()      end
    if MiscState.LightingSimple  then LightingSimplify()     end
    if MiscState.UltraNoEffects  then UltraNoEffectsApply()  end

    settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
end

local function ApplyFPSCap()
    if typeof(setfpscap) == "function" then
        setfpscap(tonumber(MiscState.FPSCapValue) or 120)
    end
end

-- UI DROPDOWNS MISC

-- Anti AFK
local ddAntiAFK = PageMisc:CreateDropdown("Anti AFK", {"Off","On"}, function(opt)
    MiscState.AntiAFK = (opt == "On")
    if MiscState.AntiAFK then
        EnableAntiAFK()
    else
        DisableAntiAFK()
    end
end)
ddAntiAFK:SetValue("On")
MiscState.AntiAFK = true
EnableAntiAFK()

-- FPS Boost
local ddFPSBoost = PageMisc:CreateDropdown("FPS Boost (Aggressive)", {"Off","On"}, function(opt)
    MiscState.FPSBoost = (opt == "On")
    if MiscState.FPSBoost then
        FPSBoostApply()
    else
        ResetLighting()
    end
end)
ddFPSBoost:SetValue("On")
MiscState.FPSBoost = true
FPSBoostApply()

-- Lighting Simplify
local ddLighting = PageMisc:CreateDropdown("Lighting Simplify", {"Off","On"}, function(opt)
    MiscState.LightingSimple = (opt == "On")
    if MiscState.LightingSimple then
        LightingSimplify()
    else
        ResetLighting()
    end
end)
ddLighting:SetValue("On")
MiscState.LightingSimple = true
LightingSimplify()

-- Textures/Decals
local ddTextures = PageMisc:CreateDropdown("Textures / Decals", {"Keep","Hide All"}, function(opt)
    MiscState.TexturesOff = (opt == "Hide All")
    if MiscState.TexturesOff then
        DisableTextures()
    end
end)
ddTextures:SetValue("Hide All")
MiscState.TexturesOff = true
DisableTextures()

-- SmoothPlastic
local ddSmooth = PageMisc:CreateDropdown("Part Material", {"Default","SmoothPlastic"}, function(opt)
    MiscState.SmoothPlastic = (opt == "SmoothPlastic")
    if MiscState.SmoothPlastic then
        ApplySmoothPlastic()
    end
end)
ddSmooth:SetValue("SmoothPlastic")
MiscState.SmoothPlastic = true
ApplySmoothPlastic()

-- Ultra No Effects
local ddUltra = PageMisc:CreateDropdown("ULTRA: No Anim/Particles", {"Off","On (One-way)"}, function(opt)
    MiscState.UltraNoEffects = (opt == "On (One-way)")
    if MiscState.UltraNoEffects then
        UltraNoEffectsApply()
    end
end)
ddUltra:SetValue("On (One-way)")
MiscState.UltraNoEffects = true
UltraNoEffectsApply()

-- FPS Cap Dropdown
local ddFPSCap = PageMisc:CreateDropdown("FPS Cap", {"60","90","120","144","240","Unlimited"}, function(opt)
    if opt == "Unlimited" then
        MiscState.FPSCapValue = 1000
    else
        MiscState.FPSCapValue = tonumber(opt) or 120
    end
    ApplyFPSCap()
end)
ddFPSCap:SetValue("120")
MiscState.FPSCapValue = 120
ApplyFPSCap()

-- Reset Lighting action
local ddResetLight = PageMisc:CreateDropdown("Lighting Action", {"Idle","Reset Lighting Now"}, function(opt)
    if opt == "Reset Lighting Now" then
        ResetLighting()
        ddResetLight:SetValue("Idle")
    end
end)
ddResetLight:SetValue("Idle")

--------------------------------------------------------
-- FPS + PING OVERLAY (TEXT, DRAGGABLE)
--------------------------------------------------------
local guiParent = (gethui and gethui()) or CoreGui

local oldOverlay = guiParent:FindFirstChild("FPS_PING_TEXT_ONLY")
if oldOverlay then
    oldOverlay:Destroy()
end

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FPS_PING_TEXT_ONLY"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
if syn and syn.protect_gui then
    syn.protect_gui(screenGui)
end
screenGui.Parent = guiParent

local holder = Instance.new("Frame")
holder.Name = "Holder"
holder.Parent = screenGui
holder.BackgroundTransparency = 1
holder.BorderSizePixel = 0
holder.AnchorPoint = Vector2.new(0, 0)
holder.Position = UDim2.new(0, 0, 0, 6)
holder.Size = UDim2.new(0, 320, 0, 20)

task.spawn(function()
    task.wait(0.15)
    local cam3 = Workspace.CurrentCamera
    if cam3 then
        local vp = cam3.ViewportSize
        holder.Position = UDim2.new(0, (vp.X - holder.AbsoluteSize.X) / 2, 0, 6)
    else
        holder.Position = UDim2.new(0, 10, 0, 6)
    end
end)

local hList = Instance.new("UIListLayout", holder)
hList.FillDirection = Enum.FillDirection.Horizontal
hList.SortOrder = Enum.SortOrder.LayoutOrder
hList.VerticalAlignment = Enum.VerticalAlignment.Center
hList.Padding = UDim.new(0, 6)

local infoLabel = Instance.new("TextLabel")
infoLabel.Name = "InfoLabel"
infoLabel.Parent = holder
infoLabel.BackgroundTransparency = 1
infoLabel.BorderSizePixel = 0
infoLabel.Size = UDim2.new(0, 320, 0, 20)
infoLabel.Font = Enum.Font.Code
infoLabel.TextSize = 14
infoLabel.TextXAlignment = Enum.TextXAlignment.Left
infoLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
infoLabel.TextStrokeTransparency = 0.5
infoLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
infoLabel.Text = "FPS: ... | Ping: ..."

-- drag overlay
do
    local dragging = false
    local dragStart, startPos

    holder.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = holder.Position

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    UIS.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            local newX = startPos.X.Offset + delta.X
            local newY = startPos.Y.Offset + delta.Y

            local cam3 = Workspace.CurrentCamera
            if cam3 then
                local vp = cam3.ViewportSize
                newX = math.clamp(newX, 0, vp.X - holder.AbsoluteSize.X)
                newY = math.clamp(newY, 0, vp.Y - holder.AbsoluteSize.Y)
            end

            holder.Position = UDim2.new(0, newX, 0, newY)
        end
    end)
end

-- FPS smoothing
local fps = 0
local avgFPS = 0
local alphaFPS = 0.15

RunService.RenderStepped:Connect(function(dt)
    local instFPS = 1 / math.max(dt, 1/1000)
    if avgFPS == 0 then
        avgFPS = instFPS
    else
        avgFPS = avgFPS + (instFPS - avgFPS) * alphaFPS
    end
    fps = avgFPS
end)

local function getPingMs()
    local pingStat
    local ok = pcall(function()
        pingStat = Stats.Network.ServerStatsItem["Data Ping"]
    end)

    if ok and pingStat then
        local str = pingStat:GetValueString() or ""
        local num = tonumber(string.match(str, "(%d+)"))
        return num or 0
    end

    return 0
end

task.spawn(function()
    while screenGui.Parent do
        local fpsRounded = math.floor(fps + 0.5)
        local pingMs = getPingMs()

        if pingMs > 0 then
            infoLabel.Text = "FPS: " .. tostring(fpsRounded) .. " | Ping: " .. tostring(pingMs) .. " ms"
        else
            infoLabel.Text = "FPS: " .. tostring(fpsRounded) .. " | Ping: N/A"
        end

        task.wait(0.25)
    end
end)

-- Dropdown untuk show/hide overlay
PageMisc:CreateDropdown("Stats Overlay", {"On","Off"}, function(opt)
    if screenGui then
        screenGui.Enabled = (opt == "On")
    end
end)
