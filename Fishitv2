--========================================================
-- AegisHub â€¢ Fish It â€” UI + Misc Features (REVISED)
--========================================================

if not game:IsLoaded() then game.Loaded:Wait() end

-- Services
local Players            = game:GetService("Players")
local RunService         = game:GetService("RunService")
local Lighting           = game:GetService("Lighting")
local Workspace          = game:GetService("Workspace")
local UserInputService   = game:GetService("UserInputService")
local TweenService       = game:GetService("TweenService")
local CoreGui            = game:GetService("CoreGui")
local LocalPlayer        = Players.LocalPlayer
local VirtualUser        = game:GetService("VirtualUser")

----------------------------------------------------------------
-- ================== UI LIBRARY (Polished v2 â€¢ FIX) ===========
----------------------------------------------------------------
local ACCENT      = Color3.fromRGB(110,175,255)
local ACCENT_TEXT = Color3.fromRGB(227,229,255)
local BG_DARK     = Color3.fromRGB(42,44,56)
local BG_CARD     = Color3.fromRGB(30,31,41)

local function protect(inst)
    -- Tanpa pcall: aman selama 'syn' ada
    if syn and syn.protect_gui then
        syn.protect_gui(inst)
    end
end

local function tw(o,t,props)
    local a = TweenService:Create(o, TweenInfo.new(t, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), props)
    a:Play()
    return a
end

local UIS = UserInputService

local library = {}

function library:CreateWindow(name, version, icon)
    name,version,icon = name or "AegisHub", version or "Premium", icon or 10044538000

    -- ScreenGui
    local Gui = Instance.new("ScreenGui")
    Gui.Name = "AegisHub_UIv2"
    Gui.IgnoreGuiInset = false
    Gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    Gui.ResetOnSpawn = false
    Gui.DisplayOrder = 9999
    protect(Gui)
    Gui.Parent = CoreGui  -- NOTE: jika tidak muncul di sebagian game, ganti ke PlayerGui

    -- scale kecil utk layar kecil
    local function calcScale()
        local cam = Workspace.CurrentCamera
        local vp = cam and cam.ViewportSize or Vector2.new(1280,720)
        local shortest = math.min(vp.X, vp.Y)
        if shortest <= 720 then return 0.85 elseif shortest <= 900 then return 0.92 else return 1 end
    end
    local SCALE = calcScale()

    -- Overlay (toggle + draggable)
    local Overlay = Instance.new("ImageButton")
    Overlay.Name="AegisHubOverlay"; Overlay.Parent=Gui
    Overlay.Size=UDim2.fromOffset(40,40); Overlay.AutoButtonColor=true
    Overlay.BackgroundColor3=Color3.fromRGB(32,34,46)
    Overlay.Image="rbxassetid://10045753138"; Overlay.ImageColor3=ACCENT
    Instance.new("UICorner", Overlay).CornerRadius = UDim.new(1,0)
    local os=Instance.new("UIStroke",Overlay); os.Transparency=.85; os.Color=Color3.fromRGB(255,255,255)

    local cam = Workspace.CurrentCamera
    local ox = Gui:GetAttribute("ovx") or 12
    local oy = Gui:GetAttribute("ovy") or math.floor((cam.ViewportSize.Y/2)-20)
    Overlay.Position = UDim2.fromOffset(ox, oy)

    do
        local dragging, start, origin
        Overlay.InputBegan:Connect(function(i)
            if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then
                dragging=true; start=i.Position; origin=Overlay.Position
                i.Changed:Connect(function()
                    if i.UserInputState==Enum.UserInputState.End then
                        dragging=false
                        Gui:SetAttribute("ovx", Overlay.Position.X.Offset)
                        Gui:SetAttribute("ovy", Overlay.Position.Y.Offset)
                    end
                end)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then
                local d=i.Position-start
                local vp=Workspace.CurrentCamera.ViewportSize
                local nx = math.clamp(origin.X.Offset + d.X, 4, vp.X-44)
                local ny = math.clamp(origin.Y.Offset + d.Y, 4, vp.Y-44)
                Overlay.Position = UDim2.fromOffset(nx, ny)
            end
        end)
    end

    -- Window
    local Window = Instance.new("Frame")
    protect(Window)
    Window.Parent=Gui
    Window.BackgroundColor3=BG_DARK
    Window.ClipsDescendants=false
    Window.Size=UDim2.fromOffset(math.floor(520*SCALE), math.floor(340*SCALE))
    Window.Position=UDim2.new(.5, -Window.Size.X.Offset/2, .52, -Window.Size.Y.Offset/2)
    Instance.new("UICorner",Window).CornerRadius=UDim.new(0,6)

    -- Title bar
    local Title=Instance.new("Frame",Window)
    Title.BackgroundTransparency=1
    Title.Size=UDim2.new(1,0,0,math.floor(30*SCALE))

    local Icon=Instance.new("ImageLabel",Title)
    Icon.BackgroundTransparency=1
    Icon.Size=UDim2.fromOffset(math.floor(18*SCALE),math.floor(18*SCALE))
    Icon.Position=UDim2.new(0,8,0,6)
    Icon.Image="rbxassetid://"..tostring(icon)
    Icon.ImageColor3=ACCENT

    local TitleText=Instance.new("TextLabel",Title)
    TitleText.BackgroundTransparency=1
    TitleText.Position=UDim2.new(0,30,0,0)
    TitleText.Size=UDim2.new(1,-30,1,0)
    TitleText.Font=Enum.Font.GothamMedium
    TitleText.TextSize=math.floor(12*SCALE)
    TitleText.TextXAlignment=Enum.TextXAlignment.Left
    TitleText.TextColor3=Color3.new(1,1,1)
    TitleText.Text=("%s â€¢ %s"):format(name,version)

    local Under=Instance.new("Frame",Title)
    Under.BorderSizePixel=0; Under.BackgroundColor3=ACCENT
    Under.Size=UDim2.new(1,0,0,1); Under.Position=UDim2.new(0,0,1,0)

    -- Drag window
    do local dragging,start,origin
        Title.InputBegan:Connect(function(i)
            if (i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch) and not UIS:GetFocusedTextBox() then
                dragging=true; start=i.Position; origin=Window.Position
                i.Changed:Connect(function() if i.UserInputState==Enum.UserInputState.End then dragging=false end end)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then
                local d=i.Position-start
                Window.Position=UDim2.new(origin.X.Scale,origin.X.Offset+d.X,origin.Y.Scale,origin.Y.Offset+d.Y)
            end
        end)
    end

    -- Overlay toggle
    local hidden=false
    Overlay.MouseButton1Click:Connect(function()
        hidden=not hidden; Window.Visible=not hidden
        tw(Overlay,.12,{ImageColor3 = hidden and Color3.fromRGB(200,200,200) or ACCENT})
    end)

    -- Tabs rail
    local TabsRail=Instance.new("Frame",Window)
    TabsRail.BackgroundColor3=Color3.fromRGB(39,40,51)
    TabsRail.Position=UDim2.new(0,6,0,math.floor(36*SCALE))
    TabsRail.Size=UDim2.new(0,math.floor(136*SCALE),1,-math.floor(42*SCALE))
    Instance.new("UICorner",TabsRail).CornerRadius=UDim.new(0,6)

    local trlbl=Instance.new("TextLabel",TabsRail)
    trlbl.BackgroundTransparency=1
    trlbl.Size=UDim2.new(1,-8,0,math.floor(22*SCALE))
    trlbl.Position=UDim2.new(0,8,0,0)
    trlbl.Font=Enum.Font.GothamBlack; trlbl.Text="Sections"
    trlbl.TextSize=math.floor(11*SCALE); trlbl.TextXAlignment=Enum.TextXAlignment.Left
    trlbl.TextColor3=Color3.new(1,1,1)

    local trlist=Instance.new("UIListLayout",TabsRail)
    trlist.Padding=UDim.new(0,math.floor(4*SCALE))
    trlist.SortOrder=Enum.SortOrder.LayoutOrder
    trlist.HorizontalAlignment=Enum.HorizontalAlignment.Right

    ----------------------------------------------------------------
    -- Tab/Page API (FIXED)
    ----------------------------------------------------------------
    local firstShown=false

    local function makePage(title)
        title = title or "Page"

        local Page=Instance.new("ScrollingFrame",Window)
        Page.Name="Page"; Page.Active=true; Page.ScrollBarThickness=4; Page.ScrollBarImageColor3=ACCENT
        Page.AutomaticCanvasSize=Enum.AutomaticSize.Y; Page.CanvasSize=UDim2.new(0,0,0,0)
        Page.BackgroundColor3=BG_DARK
        Page.Position=UDim2.new(0,math.floor(150*SCALE),0,math.floor(36*SCALE))
        Page.Size=UDim2.new(1,-math.floor(156*SCALE),1,-math.floor(42*SCALE))
        Page.Visible=false
        Instance.new("UICorner",Page).CornerRadius=UDim.new(0,6)
        local pad=Instance.new("UIPadding",Page)
        pad.PaddingTop=UDim.new(0,math.floor(6*SCALE))
        pad.PaddingLeft=UDim.new(0,math.floor(6*SCALE))
        pad.PaddingRight=UDim.new(0,math.floor(6*SCALE))
        pad.PaddingBottom=UDim.new(0,math.floor(6*SCALE))
        local vlist=Instance.new("UIListLayout",Page)
        vlist.Padding=UDim.new(0,math.floor(6*SCALE))
        vlist.SortOrder=Enum.SortOrder.LayoutOrder
        vlist.HorizontalAlignment=Enum.HorizontalAlignment.Center

        local TabBtn=Instance.new("TextButton",TabsRail)
        TabBtn.BackgroundTransparency=1
        TabBtn.Size=UDim2.new(1,-8,0,math.floor(18*SCALE))
        TabBtn.Text=title; TabBtn.Font=Enum.Font.Gotham
        TabBtn.TextSize=math.floor(11*SCALE); TabBtn.TextColor3=Color3.new(1,1,1)
        TabBtn.TextTransparency=.5

        local indicator=Instance.new("Frame",TabBtn)
        indicator.BackgroundColor3=ACCENT
        indicator.Size=UDim2.new(0,2,1,-4)
        indicator.Position=UDim2.new(0,-8,0,2)
        indicator.BorderSizePixel=0
        indicator.Visible=false

        local function selectThis()
            -- sembunyikan semua page & indikator
            for _,v in ipairs(Window:GetChildren()) do
                if v:IsA("ScrollingFrame") and v.Name=="Page" then v.Visible=false end
            end
            for _,btn in ipairs(TabsRail:GetChildren()) do
                if btn:IsA("TextButton") then
                    btn.TextTransparency = .5
                    local ind = btn:FindFirstChildWhichIsA("Frame")
                    if ind then ind.Visible=false end
                end
            end
            -- tampilkan yang ini
            TabBtn.TextTransparency=0
            Page.Visible=true
            indicator.Visible=true
        end
        TabBtn.MouseButton1Click:Connect(selectThis)
        if not firstShown then firstShown=true; selectThis() end

        -- helper: card konten
        local function Card(baseH)
            local fr=Instance.new("Frame",Page)
            fr.BackgroundColor3=BG_CARD
            fr.Size=UDim2.new(1,0,0,math.floor((baseH or 40)*SCALE))
            fr.AutomaticSize = Enum.AutomaticSize.Y
            fr.ClipsDescendants=false
            Instance.new("UICorner",fr).CornerRadius=UDim.new(0,6)
            return fr
        end

        -- ===== PageAPI (komponen) =====
        local PageAPI = {}

        function PageAPI:CreateLabel(text)
            local lb = Instance.new("TextLabel")
            lb.Parent = Page
            lb.BackgroundTransparency = 1
            lb.Size = UDim2.new(1, -8, 0, math.floor(16 * SCALE))
            lb.Position = UDim2.new(0, 8, 0, 0)
            lb.Font = Enum.Font.GothamBlack
            lb.TextSize = math.floor(12 * SCALE)
            lb.TextXAlignment = Enum.TextXAlignment.Left
            lb.TextColor3 = Color3.new(1, 1, 1)
            lb.Text = string.upper(text or "LABEL")
            return { UpdateLabel=function(_,t) lb.Text=string.upper(t or "") end }
        end

        function PageAPI:CreateButton(name,desc,cb)
            cb=cb or function() end
            local fr=Card(40)
            local t=Instance.new("TextLabel",fr); t.BackgroundTransparency=1; t.Position=UDim2.new(0,8,0,2); t.Size=UDim2.new(1,-100,0,math.floor(18*SCALE))
            t.Font=Enum.Font.GothamBlack; t.TextSize=math.floor(12*SCALE); t.TextColor3=Color3.new(1,1,1); t.Text=string.upper(name or "BUTTON"); t.TextXAlignment=Enum.TextXAlignment.Left
            local d=Instance.new("TextLabel",fr); d.BackgroundTransparency=1; d.Position=UDim2.new(0,8,0,math.floor(20*SCALE)); d.Size=UDim2.new(1,-100,0,math.floor(16*SCALE))
            d.Font=Enum.Font.Gotham; d.TextSize=math.floor(11*SCALE); d.TextColor3=Color3.fromRGB(170,170,170); d.TextXAlignment=Enum.TextXAlignment.Left; d.Text=desc or ""
            local run=Instance.new("TextButton",fr); run.BackgroundColor3=Color3.fromRGB(24,25,32); run.Size=UDim2.new(0,84,0,24); run.Position=UDim2.new(1,-100,0,6)
            run.Text="RUN"; run.Font=Enum.Font.GothamSemibold; run.TextSize=math.floor(11*SCALE); run.TextColor3=Color3.new(1,1,1)
            Instance.new("UICorner",run).CornerRadius=UDim.new(0,8)
            run.MouseButton1Click:Connect(cb)
            return {}
        end

        function PageAPI:CreateToggle(title,desc,cb)
            cb=cb or function() end
            local fr=Card(40)
            local t=Instance.new("TextLabel",fr); t.BackgroundTransparency=1; t.Position=UDim2.new(0,8,0,2); t.Size=UDim2.new(1,-70,0,math.floor(18*SCALE))
            t.Font=Enum.Font.GothamBlack; t.TextSize=math.floor(12*SCALE); t.TextColor3=Color3.new(1,1,1); t.Text=string.upper(title or "TOGGLE"); t.TextXAlignment=Enum.TextXAlignment.Left
            local d=Instance.new("TextLabel",fr); d.BackgroundTransparency=1; d.Position=UDim2.new(0,8,0,math.floor(20*SCALE)); d.Size=UDim2.new(1,-70,0,math.floor(16*SCALE))
            d.Font=Enum.Font.Gotham; d.TextSize=math.floor(11*SCALE); d.TextColor3=Color3.fromRGB(170,170,170); d.TextXAlignment=Enum.TextXAlignment.Left; d.Text=desc or ""
            local track=Instance.new("Frame",fr); track.BackgroundColor3=Color3.fromRGB(24,25,32); track.Size=UDim2.fromOffset(math.floor(50*SCALE),math.floor(22*SCALE)); track.Position=UDim2.new(1,-math.floor(62*SCALE),0,math.floor(8*SCALE))
            Instance.new("UICorner",track).CornerRadius=UDim.new(1,0)
            local dot=Instance.new("Frame",track); dot.Size=UDim2.fromOffset(math.floor(18*SCALE),math.floor(18*SCALE)); dot.Position=UDim2.new(0,math.floor(2*SCALE),0,math.floor(2*SCALE)); dot.BackgroundColor3=ACCENT; dot.BackgroundTransparency=.6
            Instance.new("UICorner",dot).CornerRadius=UDim.new(1,0)

            local btn=Instance.new("TextButton",fr); btn.BackgroundTransparency=1; btn.Size=UDim2.new(1,0,1,0); btn.Text=""
            local on=false
            local function apply()
                tw(dot,.12,{Position=on and UDim2.new(1,-math.floor(20*SCALE),0,math.floor(2*SCALE)) or UDim2.new(0,math.floor(2*SCALE),0,math.floor(2*SCALE)), BackgroundTransparency=on and 0 or .6})
                cb(on)
            end
            btn.MouseButton1Click:Connect(function() on=not on; apply() end)
            return { Set=function(_,v) if v~=on then on=v; apply() end end }
        end

        function PageAPI:CreateBox(placeholder,_,cb)
            cb=cb or function() end
            local fr=Card(32)
            local t=Instance.new("TextLabel",fr); t.BackgroundTransparency=1; t.Font=Enum.Font.GothamBlack; t.TextSize=math.floor(12*SCALE); t.TextColor3=Color3.fromRGB(200,205,230)
            t.Text=string.upper(placeholder or "INPUT"); t.TextXAlignment=Enum.TextXAlignment.Left; t.Position=UDim2.new(0,8,0,0); t.Size=UDim2.new(1,-8,0,18)
            local tb=Instance.new("TextBox",fr); tb.BackgroundColor3=Color3.fromRGB(24,25,32); tb.Position=UDim2.new(0,8,0,20); tb.Size=UDim2.new(1,-16,0,26)
            tb.ClearTextOnFocus=false; tb.Text=""; tb.Font=Enum.Font.Gotham; tb.TextSize=math.floor(11*SCALE); tb.TextColor3=Color3.new(1,1,1); tb.PlaceholderText=placeholder or ""; tb.PlaceholderColor3=ACCENT_TEXT
            Instance.new("UICorner",tb).CornerRadius=UDim.new(0,8)
            tb.FocusLost:Connect(function() cb(tb.Text) end)
            return { SetText=function(_,t2) tb.Text=t2 or "" end }
        end

        function PageAPI:CreateDropdown(title, options, onChanged)
            options=options or {}; onChanged=onChanged or function() end
            local fr=Card(28); fr.Name="Dropdown"
            local ttl=Instance.new("TextLabel",fr); ttl.BackgroundTransparency=1; ttl.Position=UDim2.new(0,8,0,0); ttl.Size=UDim2.new(1,-40,0,18)
            ttl.Font=Enum.Font.GothamBlack; ttl.TextSize=math.floor(12*SCALE); ttl.TextColor3=Color3.new(1,1,1); ttl.Text=string.upper(title)
            local caret=Instance.new("TextLabel",fr); caret.BackgroundTransparency=1; caret.Size=UDim2.fromOffset(math.floor(16*SCALE),math.floor(16*SCALE)); caret.Position=UDim2.new(1,-math.floor(24*SCALE),0,0)
            caret.Font=Enum.Font.GothamBlack; caret.Text="â–¼"; caret.TextSize=math.floor(11*SCALE); caret.TextColor3=ACCENT

            local holder=Instance.new("Frame",fr); holder.BackgroundColor3=Color3.fromRGB(26,26,32)
            holder.Position=UDim2.new(0,6,0,20); holder.Size=UDim2.new(1,-12,0,0)
            holder.AutomaticSize=Enum.AutomaticSize.Y; holder.Visible=false
            Instance.new("UICorner",holder).CornerRadius=UDim.new(0,8)
            Instance.new("UIListLayout",holder).Padding=UDim.new(0,4)
            local pad=Instance.new("UIPadding",holder); pad.PaddingTop=UDim.new(0,6); pad.PaddingBottom=UDim.new(0,6); pad.PaddingLeft=UDim.new(0,6); pad.PaddingRight=UDim.new(0,6)

            local current=nil
            local function rebuild(list)
                for _,c in ipairs(holder:GetChildren()) do if c:IsA("TextButton") then c:Destroy() end end
                for _,opt in ipairs(list) do
                    local b=Instance.new("TextButton",holder)
                    b.Size=UDim2.new(1,0,0,24); b.BackgroundColor3=BG_CARD
                    b.Text=opt; b.Font=Enum.Font.Gotham; b.TextSize=math.floor(11*SCALE); b.TextColor3=Color3.new(1,1,1)
                    Instance.new("UICorner",b).CornerRadius=UDim.new(0,8)
                    b.MouseButton1Click:Connect(function()
                        current=opt; ttl.Text=string.upper(("%s : %s"):format(title,opt))
                        holder.Visible=false; tw(caret,.12,{Rotation=0})
                        onChanged(opt)
                    end)
                end
            end
            rebuild(options)

            local open=false
            local header=Instance.new("TextButton",fr); header.BackgroundTransparency=1; header.Size=UDim2.new(1,0,0,20); header.Position=UDim2.new(0,0,0,0); header.Text=""
            header.MouseButton1Click:Connect(function()
                open=not open; holder.Visible=open; tw(caret,.12,{Rotation=open and 180 or 0})
            end)

            return {
                SetValue=function(_,v) current=v; ttl.Text=string.upper(("%s : %s"):format(title,tostring(v))) end,
                GetValue=function() return current end,
                SetOptions=function(_,opts) rebuild(opts or {}) end
            }
        end

        -- >>> NEW: Slider (min, max, cb) <<<
        function PageAPI:CreateSlider(title, min, max, cb)
            min = tonumber(min) or 0
            max = tonumber(max) or 100
            cb  = cb or function() end

            local fr = Card(44)
            local t  = Instance.new("TextLabel", fr)
            t.BackgroundTransparency = 1
            t.Position = UDim2.new(0,8,0,2)
            t.Size = UDim2.new(1,-8,0,18)
            t.Font = Enum.Font.GothamBlack
            t.TextSize = math.floor(12*SCALE)
            t.TextColor3 = Color3.new(1,1,1)
            t.Text = string.upper(title or "SLIDER")
            t.TextXAlignment = Enum.TextXAlignment.Left

            local bar = Instance.new("Frame", fr)
            bar.BackgroundColor3 = Color3.fromRGB(24,25,32)
            bar.Position = UDim2.new(0,8,0,22)
            bar.Size = UDim2.new(1,-16,0,8)
            bar.BorderSizePixel = 0
            Instance.new("UICorner", bar).CornerRadius = UDim.new(0,8)

            local fill = Instance.new("Frame", bar)
            fill.BackgroundColor3 = ACCENT
            fill.Size = UDim2.new(0,0,1,0)
            fill.BorderSizePixel = 0
            Instance.new("UICorner", fill).CornerRadius = UDim.new(0,8)

            local valLbl = Instance.new("TextLabel", fr)
            valLbl.BackgroundTransparency = 1
            valLbl.Size = UDim2.new(0,60,0,16)
            valLbl.Position = UDim2.new(1,-68,0,2)
            valLbl.Font = Enum.Font.Gotham
            valLbl.TextSize = math.floor(11*SCALE)
            valLbl.TextColor3 = ACCENT_TEXT
            valLbl.TextXAlignment = Enum.TextXAlignment.Right

            local value = min
            local function render()
                local alpha = (value - min) / math.max(1, (max-min))
                fill.Size = UDim2.new(math.clamp(alpha,0,1), 0, 1, 0)
                valLbl.Text = tostring(math.floor(value))
            end
            render()

            local dragging = false
            bar.InputBegan:Connect(function(io)
                if io.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                end
            end)
            bar.InputEnded:Connect(function(io)
                if io.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = false
                end
            end)
            RunService.RenderStepped:Connect(function()
                if dragging then
                    local abs = bar.AbsolutePosition
                    local size = bar.AbsoluteSize
                    local mx = UIS:GetMouseLocation().X
                    local pct = math.clamp((mx - abs.X) / size.X, 0, 1)
                    value = math.floor(min + pct * (max-min))
                    render()
                    cb(value)
                end
            end)

            return {
                Set = function(_,v)
                    value = math.clamp(tonumber(v) or value, min, max)
                    render()
                    cb(value)
                end
            }
        end

        return PageAPI
    end

    -- Objek tab yang sesuai pemakaian: Tab = win:CreateTab("X"); Page = Tab:CreateFrame("Y")
    local winAPI = {}

    function winAPI:CreateTab(title)
        local tabObj = {}
        function tabObj:CreateFrame(pageTitle)
            return makePage(pageTitle or title or "Page")
        end
        -- auto buat 1 page default saat dipanggil kalau mau langsung dipakai:
        -- return setmetatable(tabObj, {__index = tabObj}):CreateFrame(title)
        return setmetatable(tabObj, {__index = tabObj})
    end

    return setmetatable({}, { __index = winAPI })
end

-- Buat window
local win = library:CreateWindow("AegisHub â€¢ Fish It", "Premium", 10044538000)

--========================================================
-- AUTO FISH (Manual Input Delay + Perfect Casting)
--========================================================

local TabFarm   = win:CreateTab("Farm")
local PageFarm  = TabFarm:CreateFrame("Farm")
PageFarm:CreateLabel("FARM MENU")

-- Services
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players           = game:GetService("Players")
local Workspace         = game:GetService("Workspace")
local LocalPlayer       = Players.LocalPlayer

-- sleitnick/net remotes
local netIndex = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")

local net = netIndex:WaitForChild("net")

local RF_Charge            = net:WaitForChild("RF/ChargeFishingRod")
local RF_RequestMinigame   = net:WaitForChild("RF/RequestFishingMinigameStarted")
local RE_FishingCompleted  = net:WaitForChild("RE/FishingCompleted")
local RE_EquipHotbar       = net:WaitForChild("RE/EquipToolFromHotbar")
local RE_TextEffect        = net:WaitForChild("RE/ReplicateTextEffect")

-- STATE
local Farm = {
    AutoFish = false,
    PerfectCasting = true,
    ReelDelay = 2.8,            -- default
    CompleteDelay = 1.145,      -- default
}

--========================================================
-- PERFECT CASTING
--========================================================

local BASE_X, BASE_Y = -0.7499996423721313, 1

local function castPerfect()
    RE_EquipHotbar:FireServer(1)
    task.wait(0.10)

    local startTime = Workspace:GetServerTimeNow()
    RF_Charge:InvokeServer(startTime)

    -- detect "Perfect"
    local perfectDetected = false
    local connection
    connection = RE_TextEffect.OnClientEvent:Connect(function(data)
        if data and data.TextData and data.TextData.Text == "Perfect" then
            perfectDetected = true
        end
    end)

    local timer = 0
    while not perfectDetected and timer < 3 do
        task.wait(0.05)
        timer += 0.05
    end

    if connection then
        connection:Disconnect()
    end

    -- randomize tiny offset
    local rx = BASE_X + (math.random(-250, 250) / 1e7)
    local ry = BASE_Y + (math.random(-250, 250) / 1e7)

    -- tanpa timestamp (lebih stabil)
    RF_RequestMinigame:InvokeServer(rx, ry)
end

--========================================================
-- AUTO COMPLETE (detect Exclaim)
--========================================================

RE_TextEffect.OnClientEvent:Connect(function(data)
    if not Farm.AutoFish then return end
    if not data or not data.TextData then return end
    if data.TextData.EffectType ~= "Exclaim" then return end

    local head = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head")
    if head and data.Container == head then
        task.wait(Farm.CompleteDelay)
        RE_FishingCompleted:FireServer()
    end
end)

--========================================================
-- MAIN AUTO LOOP
--========================================================

local farmThread

local function castOnce()
    castPerfect()
    task.wait(Farm.ReelDelay)
    RE_FishingCompleted:FireServer()
end

local function startAutoFish()
    if farmThread then return end
    farmThread = task.spawn(function()
        while Farm.AutoFish do
            castOnce()
            task.wait(0.15)
        end
    end)
end

local function stopAutoFish()
    if farmThread then
        task.cancel(farmThread)
        farmThread = nil
    end
end

PageFarm:CreateToggle("Auto Fish", "Auto lempar & tarik pancing", function(on)
    Farm.AutoFish = on
    if on then startAutoFish() else stopAutoFish() end
end)

PageFarm:CreateToggle("Perfect Casting", "Selalu lempar perfect", function(on)
    Farm.PerfectCasting = on
end)

--========================================================
-- UI INPUT
--========================================================

PageFarm:CreateBox("Reel Delay", "Delay sebelum loop restart", function(txt)
    local num = tonumber(txt)
    if num then
        Farm.ReelDelay = num
    end
end, tostring(Farm.ReelDelay))

PageFarm:CreateBox("Custom Complete Delay", "Delay sebelum FishingCompleted", function(txt)
    local num = tonumber(txt)
    if num then
        Farm.CompleteDelay = num
    end
end, tostring(Farm.CompleteDelay))

local TabTrade  = win:CreateTab("Trade")
local PageTrade = TabTrade:CreateFrame("Trade")
PageTrade:CreateLabel("TRADE MENU")

--========================================================
-- TELEPORT (Island / NPC / Player)
--========================================================
-- ---------- Helper umum ----------
local function tpTo(pos: Vector3)
    if not pos then return end
    local plr = Players.LocalPlayer
    local ch  = plr and (plr.Character or plr.CharacterAdded:Wait())
    local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
    if hrp then
        hrp.CFrame = CFrame.new(pos + Vector3.new(0, 5, 0))
    end
end

--========================================================
-- TELEPORT (Island / NPC / Player)
--========================================================
local TabTP  = win:CreateTab("Teleport")
local PageTP = TabTP:CreateFrame("Teleport")
PageTP:CreateLabel("TELEPORT MENU")

-- ---------- ISLAND (static list) ----------
local islands = {
    ["Weather Machine"]            = Vector3.new(-1471,-3,1929),
    ["Esoteric Depths"]            = Vector3.new(3157,-1303,1439),
    ["Tropical Grove"]             = Vector3.new(-2038,3,3650),
    ["Stingray Shores"]            = Vector3.new(-32,4,2773),
    ["Kohana Volcano"]             = Vector3.new(-519,24,189),
    ["Coral Reefs"]                = Vector3.new(-3095,1,2177),
    ["Crater Island"]              = Vector3.new(968,1,4854),
    ["Kohana"]                     = Vector3.new(-658,3,719),
    ["Winter Fest"]                = Vector3.new(1611,4,3280),
    ["Esoteric Island"]            = Vector3.new(1987,4,1400),
    ["Treasure Room"]              = Vector3.new(-3600,-267,-1558),
    ["Lost Shore"]                 = Vector3.new(-3663,38,-989),
    ["Sisyphus"]                   = Vector3.new(-3792,-135,-986),
    ["Crystal Cavern"]             = Vector3.new(-2026,-440,7428),
    ["Halloween"]                  = Vector3.new(2127,78,3334),
    ["Ancient Underground Cave"]   = Vector3.new(2102,-91,-709),
    ["Ancient Inside Temple"]      = Vector3.new(1506,-22,-641),
    ["Ancient Jungle"]             = Vector3.new(1268,78,-183),
    ["Fisherman Island"]           = Vector3.new(-3,17,2840),
}
local islandList = {}
for name in pairs(islands) do table.insert(islandList, name) end
table.sort(islandList)

local currentIsland = islandList[1]
local ddIslandFull = PageTP:CreateDropdown("Teleport Island", islandList, function(choice)
    currentIsland = choice
    local v = islands[choice]
    if v then tpTo(v) end
end)
if currentIsland and ddIslandFull and ddIslandFull.SetValue then
    ddIslandFull:SetValue(currentIsland)
end

-- ---------- NPC (scan workspace, exclude player chars) ----------
local function scanNPC_Models()
    local found = {}
    for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and #m.Name >= 3 then
            -- abaikan karakter player
            if Players:GetPlayerFromCharacter(m) == nil then
                local hasHum = m:FindFirstChildOfClass("Humanoid") ~= nil
                local hasPrompt = false
                if not hasHum then
                    for _,d in ipairs(m:GetDescendants()) do
                        if d:IsA("ProximityPrompt") then hasPrompt = true break end
                    end
                end
                if hasHum or hasPrompt then
                    found[m.Name] = true
                end
            end
        end
    end
    local list = {}
    for k in pairs(found) do table.insert(list, k) end
    table.sort(list)
    return list
end

local npcList = scanNPC_Models()
local currentNPC = npcList[1]
local ddNPC = PageTP:CreateDropdown("Teleport NPC", npcList, function(nm)
    currentNPC = nm
    if not nm or nm == "" then return end
    local me   = Players.LocalPlayer
    local ch   = me and (me.Character or me.CharacterAdded:Wait())
    local hrp  = ch and ch:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    -- pilih instance NPC terdekat dengan nama mengandung 'nm'
    local best,dist
    for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and Players:GetPlayerFromCharacter(m) == nil then
            if string.find(string.lower(m.Name), string.lower(nm), 1, true) then
                local p = m:FindFirstChild("HumanoidRootPart") or m.PrimaryPart or m:FindFirstChildWhichIsA("BasePart")
                if p then
                    local d = (p.Position - hrp.Position).Magnitude
                    if not dist or d < dist then best = p; dist = d end
                end
            end
        end
    end
    if best then tpTo(best.Position) end
end)
if currentNPC and ddNPC and ddNPC.SetValue then
    ddNPC:SetValue(currentNPC)
end

-- ---------- PLAYER (dynamic list) ----------
local function playersList()
    local t = {}
    for _,pl in ipairs(Players:GetPlayers()) do
        if pl ~= Players.LocalPlayer then table.insert(t, pl.Name) end
    end
    table.sort(t)
    return t
end

local plrList = playersList()
local currentPlayer = plrList[1]
local ddPlayer = PageTP:CreateDropdown("Teleport Player", plrList, function(nm)
    currentPlayer = nm
    local p = Players:FindFirstChild(nm)
    if p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
        tpTo(p.Character.HumanoidRootPart.Position)
    end
end)
if currentPlayer and ddPlayer and ddPlayer.SetValue then
    ddPlayer:SetValue(currentPlayer)
end

-- ---------- Refresh berkala untuk NPC & Player ----------
task.spawn(function()
    while true do
        task.wait(8)
        -- NPC
        local newNPC = scanNPC_Models()
        if ddNPC and ddNPC.SetOptions then
            ddNPC:SetOptions(newNPC)
            if currentNPC then
                -- jaga pilihan jika masih ada
                for _,name in ipairs(newNPC) do
                    if name == currentNPC and ddNPC.SetValue then ddNPC:SetValue(currentNPC) break end
                end
            end
        end
        -- Player
        local newPL = playersList()
        if ddPlayer and ddPlayer.SetOptions then
            ddPlayer:SetOptions(newPL)
            if currentPlayer then
                for _,name in ipairs(newPL) do
                    if name == currentPlayer and ddPlayer.SetValue then ddPlayer:SetValue(currentPlayer) break end
                end
            end
        end
    end
end)

Players.PlayerAdded:Connect(function()
    if ddPlayer and ddPlayer.SetOptions then ddPlayer:SetOptions(playersList()) end
end)
Players.PlayerRemoving:Connect(function()
    if ddPlayer and ddPlayer.SetOptions then ddPlayer:SetOptions(playersList()) end
end)

--========================================================
-- MISC (fitur aktif)
--========================================================
local TabMisc   = win:CreateTab("Misc")
local PageMisc  = TabMisc:CreateFrame("Misc")
PageMisc:CreateLabel("MISC MENU")

-- ---------- STATE ----------
local State = {
    AntiAFK         = true,
    FPSBoost        = true,
    LightingSimple  = true,
    TexturesOff     = true,
    SmoothPlastic   = true,
    FPSCapValue     = 120,
}

-- Simpan efek yang dimatikan supaya bisa reset
local Saved = {
    PostEffects = {},
    GlobalShadows = nil,
    FogEnd = nil,
}

-- ---------- ANTI AFK ----------
local AntiAFK_Conn = nil
local function EnableAntiAFK()
    if AntiAFK_Conn ~= nil then AntiAFK_Conn:Disconnect() end
    AntiAFK_Conn = LocalPlayer.Idled:Connect(function()
        local cam = Workspace.CurrentCamera
        VirtualUser:Button2Down(Vector2.new(0,0), (cam and cam.CFrame) or CFrame.new())
        task.wait(0.7)
        VirtualUser:Button2Up(Vector2.new(0,0), (cam and cam.CFrame) or CFrame.new())
    end)
end
local function DisableAntiAFK()
    if AntiAFK_Conn ~= nil then AntiAFK_Conn:Disconnect(); AntiAFK_Conn = nil end
end

-- ---------- FPS / VISUAL HELPERS ----------
local function ApplySmoothPlastic()
    for _, v in ipairs(game:GetDescendants()) do
        if v:IsA("BasePart") then
            v.Material = Enum.Material.SmoothPlastic
            v.Reflectance = 0
        end
    end
end

local function DisableTextures()
    for _, v in ipairs(game:GetDescendants()) do
        if v:IsA("Decal") or v:IsA("Texture") then
            v.Transparency = 1
        end
    end
end

local function LightingSimplify()
    if Saved.GlobalShadows == nil then
        Saved.GlobalShadows = Lighting.GlobalShadows
    end
    if Saved.FogEnd == nil then
        Saved.FogEnd = Lighting.FogEnd
    end
    if #Saved.PostEffects == 0 then
        for _, eff in ipairs(Lighting:GetChildren()) do
            if eff:IsA("PostEffect") then
                table.insert(Saved.PostEffects, {ref = eff, enabled = eff.Enabled})
            end
        end
    end
    for _, eff in ipairs(Lighting:GetChildren()) do
        if eff:IsA("PostEffect") then
            eff.Enabled = false
        end
    end
    Lighting.GlobalShadows = false
    Lighting.FogEnd = 1e10
end

local function ResetLighting()
    for _, item in ipairs(Saved.PostEffects) do
        if item.ref and item.ref.Parent then
            item.ref.Enabled = item.enabled
        end
    end
    if Saved.GlobalShadows ~= nil then
        Lighting.GlobalShadows = Saved.GlobalShadows
    end
    if Saved.FogEnd ~= nil then
        Lighting.FogEnd = Saved.FogEnd
    end
end

local function FPSBoostApply()
    if State.SmoothPlastic then ApplySmoothPlastic() end
    if State.TexturesOff   then DisableTextures()   end
    if State.LightingSimple then LightingSimplify() end
    settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
end

-- ---------- FPS CAP ----------
local function ApplyFPSCap()
    if typeof(setfpscap) == "function" then
        setfpscap(tonumber(State.FPSCapValue) or 120)
    end
end

-- ---------- UI: TOGGLES / SLIDER / BUTTON ----------
local tgAntiAFK = PageMisc:CreateToggle("Anti AFK", "Cegah kick saat idle (Auto ON)", function(on)
    State.AntiAFK = on
    if on then EnableAntiAFK() else DisableAntiAFK() end
end)

local tgFPSBoost = PageMisc:CreateToggle("FPS Boost", "Optimasi performa (Auto ON)", function(on)
    State.FPSBoost = on
    if on then FPSBoostApply() else ResetLighting() end
end)

local tgLighting = PageMisc:CreateToggle("Lighting Simplify", "Matikan post-effect, shadows, perpanjang Fog (Auto ON)", function(on)
    State.LightingSimple = on
    if on then LightingSimplify() else ResetLighting() end
end)

local tgTextures = PageMisc:CreateToggle("Textures/Decals Off", "Sembunyikan tekstur & decal (Auto ON)", function(on)
    State.TexturesOff = on
    if on then DisableTextures() end
end)

local tgSmooth = PageMisc:CreateToggle("Parts: SmoothPlastic", "Ubah material part ke SmoothPlastic (Auto ON)", function(on)
    State.SmoothPlastic = on
    if on then ApplySmoothPlastic() end
end)

local sliderFPS = PageMisc:CreateSlider("FPS Cap (jika didukung executor)", 30, 360, function(val)
    State.FPSCapValue = math.floor(val)
    ApplyFPSCap()
end)
sliderFPS:Set(State.FPSCapValue)

local btnReset = PageMisc:CreateButton("Reset Visuals", "Kembalikan pengaturan Lighting yang disederhanakan", function()
    ResetLighting()
end)

-- ---------- AUTO-APPLY SAAT STARTUP ----------
if tgAntiAFK and tgAntiAFK.Set then tgAntiAFK.Set(true) end
if tgFPSBoost and tgFPSBoost.Set then tgFPSBoost.Set(true) end
if tgLighting and tgLighting.Set then tgLighting.Set(true) end
if tgTextures and tgTextures.Set then tgTextures.Set(true) end
if tgSmooth  and tgSmooth.Set  then tgSmooth.Set(true)  end

-- Juga jalankan sekali
EnableAntiAFK()
FPSBoostApply()
LightingSimplify()
DisableTextures()
ApplySmoothPlastic()
ApplyFPSCap()

PageMisc:CreateLabel("Semua optimasi & Anti-AFK sudah aktif.")
