--[[
AegisHub • Fish It • Premium — Compact Pro UI (FINAL + Farm + Event Active)
- Tab: Farm / Inventory / Shop / Teleport / Event
- Farm: Auto Fishing + Perfect Casting (benar-benar perfect)
- Event: single dropdown Teleport Now + multi-select & toggle Auto Teleport
- Event position auto: Fishing Boat -> PrimaryPart/GetPivot -> part terdekat -> centroid
]]

if not game:IsLoaded() then game.Loaded:Wait() end

------------------------------ TOKENS ------------------------------
local TOK = {
  color = {
    bg_dark   = Color3.fromRGB(42,44,56),
    bg_card   = Color3.fromRGB(30,31,41),
    bg_field  = Color3.fromRGB(24,25,32),
    accent    = Color3.fromRGB(110,174,255),
    text      = Color3.fromRGB(235,238,255),
    muted     = Color3.fromRGB(206,211,235),
  },
  radii = { win=10, card=12, field=10, sm=8 },
  space = { page=8, gap=8, pad=10 },
  type  = { title=13, heading=12, body=11 }
}

------------------------------ SERVICES ------------------------------
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local RS = game:GetService("RunService")
local UIS = game:GetService("UserInputService")
local TS  = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local TeleportService = game:GetService("TeleportService")
local VirtualUser = game:GetService("VirtualUser")

-- Anti AFK
LocalPlayer.Idled:Connect(function()
  VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
  task.wait(.7)
  VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
end)

------------------------------ UI LIB ------------------------------
local function protect(inst) pcall(function() if syn and syn.protect_gui then syn.protect_gui(inst) end end) end
local function tween(o,t,props) local a=TS:Create(o, TweenInfo.new(t, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), props); a:Play(); return a end

local lib = {}
function lib:Window(name, version, icon)
  name, version, icon = name or "AEGISHUB • FISH IT", version or "PREMIUM", icon or 10044538000

  local Gui = Instance.new("ScreenGui")
  Gui.Name = "AegisHub_CompactPro"
  Gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
  protect(Gui)
  Gui.Parent = CoreGui

  local vp = workspace.CurrentCamera and workspace.CurrentCamera.ViewportSize or Vector2.new(1280,720)
  local SCALE = (math.min(vp.X, vp.Y) <= 720) and 0.92 or 1

  -- Overlay (drag)
  local Fab = Instance.new("ImageButton")
  Fab.Name = "Overlay"
  Fab.Parent = Gui
  Fab.Size = UDim2.fromOffset(44,44)
  Fab.Position = UDim2.fromOffset(14, vp.Y*0.5-22)
  Fab.Image = "rbxassetid://"..icon
  Fab.BackgroundColor3 = TOK.color.bg_field
  Fab.ImageColor3 = TOK.color.accent
  local fabc = Instance.new("UICorner", Fab) fabc.CornerRadius = UDim.new(1,0)

  local dragging, dragStart, startPos
  Fab.InputBegan:Connect(function(i)
    if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then
      dragging=true; dragStart=i.Position; startPos=Fab.Position
      i.Changed:Connect(function() if i.UserInputState==Enum.UserInputState.End then dragging=false end end)
    end
  end)
  UIS.InputChanged:Connect(function(i)
    if dragging and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then
      local d=i.Position - dragStart
      local nx = math.clamp(startPos.X.Offset + d.X, 4, workspace.CurrentCamera.ViewportSize.X-48)
      local ny = math.clamp(startPos.Y.Offset + d.Y, 4, workspace.CurrentCamera.ViewportSize.Y-48)
      Fab.Position = UDim2.fromOffset(nx, ny)
    end
  end)

  -- Window
  local Win = Instance.new("Frame")
  Win.Parent = Gui
  Win.BackgroundColor3 = TOK.color.bg_dark
  Win.Size = UDim2.fromOffset(math.floor(560*SCALE), math.floor(360*SCALE))
  Win.Position = UDim2.new(.5, -Win.Size.X.Offset/2, .52, -Win.Size.Y.Offset/2)
  local wc = Instance.new("UICorner", Win) wc.CornerRadius = UDim.new(0, TOK.radii.win)

  -- Title
  local Bar = Instance.new("Frame", Win)
  Bar.BackgroundTransparency = 1
  Bar.Size = UDim2.new(1,0,0,36)
  local Title = Instance.new("TextLabel", Bar)
  Title.BackgroundTransparency=1
  Title.TextXAlignment = Enum.TextXAlignment.Left
  Title.Position = UDim2.new(0,12,0,0)
  Title.Size = UDim2.new(1,-24,1,0)
  Title.Font = Enum.Font.GothamSemibold
  Title.TextSize = TOK.type.title
  Title.Text = string.upper(name.." • "..version)
  Title.TextColor3 = TOK.color.text

  local underline = Instance.new("Frame", Win)
  underline.BorderSizePixel=0
  underline.BackgroundColor3 = TOK.color.accent
  underline.Size = UDim2.new(1,0,0,2)
  underline.Position = UDim2.new(0,0,0,36)

  -- Drag window
  do
    local wdrag, s, o
    Bar.InputBegan:Connect(function(i)
      if (i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch) and not UIS:GetFocusedTextBox() then
        wdrag=true; s=i.Position; o=Win.Position
        i.Changed:Connect(function() if i.UserInputState==Enum.UserInputState.End then wdrag=false end end)
      end
    end)
    UIS.InputChanged:Connect(function(i)
      if wdrag and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then
        local d=i.Position-s; Win.Position=UDim2.new(o.X.Scale,o.X.Offset+d.X,o.Y.Scale,o.Y.Offset+d.Y)
      end
    end)
  end

  local hidden=false
  Fab.MouseButton1Click:Connect(function()
    hidden=not hidden
    Win.Visible=not hidden
    tween(Fab,.12,{ImageColor3 = hidden and Color3.fromRGB(200,200,200) or TOK.color.accent})
  end)

  -- Rail (tabs)
  local Rail = Instance.new("Frame", Win)
  Rail.BackgroundColor3 = Color3.fromRGB(39,40,51)
  Rail.Position = UDim2.new(0,8,0,46)
  Rail.Size = UDim2.new(0,148,1,-54)
  local rc = Instance.new("UICorner", Rail) rc.CornerRadius = UDim.new(0, TOK.radii.card)

  local RTitle = Instance.new("TextLabel", Rail)
  RTitle.BackgroundTransparency=1
  RTitle.TextXAlignment = Enum.TextXAlignment.Left
  RTitle.Position = UDim2.new(0,12,0,6)
  RTitle.Size = UDim2.new(1,-24,0,20)
  RTitle.Font = Enum.Font.GothamBlack
  RTitle.TextSize = TOK.type.heading
  RTitle.TextColor3 = TOK.color.text
  RTitle.Text = "SECTIONS"

  local RList = Instance.new("UIListLayout", Rail)
  RList.SortOrder=Enum.SortOrder.LayoutOrder
  RList.Padding = UDim.new(0, 10)

  local api = {}
  local first=false

  local function PageAPI(Page)
    local P = {}

    local function Card()
      local f = Instance.new("Frame", Page)
      f.BackgroundColor3 = TOK.color.bg_card
      f.Size = UDim2.new(1,0,0,0)
      f.AutomaticSize = Enum.AutomaticSize.Y
      local c = Instance.new("UICorner", f) c.CornerRadius = UDim.new(0, TOK.radii.card)
      local pad = Instance.new("UIPadding", f)
      pad.PaddingTop = UDim.new(0, TOK.space.pad)
      pad.PaddingBottom = UDim.new(0, TOK.space.pad)
      pad.PaddingLeft = UDim.new(0, TOK.space.pad + 6)
      pad.PaddingRight = UDim.new(0, TOK.space.pad + 6)
      return f
    end
    local function Heading(parent, text)
      local t = Instance.new("TextLabel", parent)
      t.BackgroundTransparency=1
      t.Font=Enum.Font.GothamBlack
      t.TextSize = TOK.type.heading
      t.TextColor3 = TOK.color.text
      t.TextXAlignment = Enum.TextXAlignment.Left
      t.Text = string.upper(text or "")
      t.Size = UDim2.new(1, -90, 0, 18)
      t.Position = UDim2.new(0, 0, 0, 0)
      return t
    end
    local function Small(parent, text)
      local s = Instance.new("TextLabel", parent)
      s.BackgroundTransparency=1
      s.Font=Enum.Font.Gotham
      s.TextSize = TOK.type.body
      s.TextColor3 = TOK.color.muted
      s.TextXAlignment = Enum.TextXAlignment.Left
      s.TextWrapped=true
      s.Text = text or ""
      s.Position = UDim2.new(0,0,0,20)
      s.Size = UDim2.new(1,-90,0,16)
      return s
    end

    function P:CreateLabel(text)
      local f = Card()
      local t = Heading(f, text or "LABEL")
      return { UpdateLabel = function(_,s) t.Text = string.upper(s or "") end }
    end

    function P:CreateButton(title,desc,cb)
      cb = cb or function() end
      local f = Card()
      Heading(f, title or "BUTTON")
      Small(f, desc or "")
      local run = Instance.new("TextButton", f)
      run.Size = UDim2.new(0, 84, 0, 24)
      run.Position = UDim2.new(1, -100, 0, 2)
      run.Text = "Run"
      run.Font = Enum.Font.GothamSemibold
      run.TextSize = TOK.type.body
      run.TextColor3 = TOK.color.text
      run.BackgroundColor3 = TOK.color.bg_field
      local c = Instance.new("UICorner", run) c.CornerRadius = UDim.new(0, TOK.radii.sm)
      run.MouseButton1Click:Connect(cb)
      return {}
    end

    function P:CreateToggle(title, desc, cb)
      cb = cb or function() end
      local f = Card()
      local head = Heading(f, title or "TOGGLE")
      Small(f, desc or "")

      local wrap = Instance.new("Frame", f)
      wrap.BackgroundTransparency=1
      wrap.Size = UDim2.new(0, 60, 0, 24)
      wrap.Position = UDim2.new(1, -70, 0, 2)

      local track = Instance.new("Frame", wrap)
      track.BackgroundColor3 = TOK.color.bg_field
      track.Size = UDim2.fromOffset(52,24)
      local cc = Instance.new("UICorner", track) cc.CornerRadius = UDim.new(1,0)

      local dot = Instance.new("Frame", track)
      dot.Size = UDim2.fromOffset(18,18)
      dot.Position = UDim2.new(0,3,0,3)
      dot.BackgroundColor3 = TOK.color.accent
      dot.BackgroundTransparency=0.6
      local dc = Instance.new("UICorner", dot) dc.CornerRadius = UDim.new(1,0)

      local btn = Instance.new("TextButton", f)
      btn.BackgroundTransparency=1; btn.Text=""; btn.Size=UDim2.new(1,0,0,44)

      local on=false
      local function apply()
        tween(dot,.12,{Position = on and UDim2.new(1,-21,0,3) or UDim2.new(0,3,0,3), BackgroundTransparency = on and 0 or 0.6})
        head.Text = string.upper(title or "TOGGLE")
        cb(on)
      end
      btn.MouseButton1Click:Connect(function() on = not on; apply() end)

      return { Set = function(_,v) if v~=on then on=v; apply() end end }
    end

    function P:CreateBox(placeholder, iconId, cb)
      cb=cb or function() end
      local f=Card()
      local t = Heading(f, placeholder or "INPUT")
      t.TextColor3 = TOK.color.muted
      t.Text = string.upper(placeholder or "INPUT")
      local field = Instance.new("TextBox", f)
      field.BackgroundColor3 = TOK.color.bg_field
      field.Size = UDim2.new(1,-20,0,30)
      field.Position = UDim2.new(0,0,0,26)
      field.ClearTextOnFocus=false
      field.Font=Enum.Font.Gotham
      field.TextSize = TOK.type.body
      field.TextColor3 = TOK.color.text
      field.PlaceholderText = placeholder or ""
      field.PlaceholderColor3 = TOK.color.muted
      local c = Instance.new("UICorner", field) c.CornerRadius = UDim.new(0, TOK.radii.field)
      field.FocusLost:Connect(function() cb(field.Text) end)
      return { SetText=function(_,v) field.Text = v or "" end }
    end

    function P:CreateDropdown(title, options, onChanged)
      options = options or {}; onChanged = onChanged or function() end
      local f = Card()

      local head = Heading(f, title or "DROPDOWN")
      local caret = Instance.new("TextLabel", f)
      caret.BackgroundTransparency=1
      caret.Text = "▼"
      caret.Font = Enum.Font.GothamBlack
      caret.TextSize = TOK.type.body
      caret.TextColor3 = TOK.color.accent
      caret.Size = UDim2.fromOffset(16,16)
      caret.Position = UDim2.new(1,-26,0,2)

      local holder = Instance.new("Frame", f)
      holder.BackgroundColor3 = TOK.color.bg_field
      holder.Position = UDim2.new(0,0,0,28)
      holder.AutomaticSize = Enum.AutomaticSize.Y
      holder.Size = UDim2.new(1, -0, 0, 0)
      holder.Visible=false
      local hc = Instance.new("UICorner", holder) hc.CornerRadius = UDim.new(0, TOK.radii.field)
      local hl = Instance.new("UIListLayout", holder) hl.Padding = UDim.new(0,4)

      local current=nil
      local function rebuild(list)
        for _,c in ipairs(holder:GetChildren()) do if c:IsA("TextButton") then c:Destroy() end end
        for _,opt in ipairs(list) do
          local b = Instance.new("TextButton", holder)
          b.BackgroundColor3 = TOK.color.bg_card
          b.Size = UDim2.new(1, -12, 0, 24)
          b.Text = opt
          b.TextColor3 = TOK.color.text
          b.Font = Enum.Font.Gotham
          b.TextSize = TOK.type.body
          b.Position = UDim2.new(0,6,0,0)
          local bc = Instance.new("UICorner", b) bc.CornerRadius = UDim.new(0, TOK.radii.sm)
          b.MouseButton1Click:Connect(function()
            current = opt
            head.Text = string.upper((title or "DROPDOWN").." : "..tostring(opt))
            holder.Visible=false
            tween(caret,.12,{Rotation=0})
            onChanged(opt)
          end)
        end
      end
      rebuild(options)

      local open=false
      local headerBtn = Instance.new("TextButton", f)
      headerBtn.BackgroundTransparency=1; headerBtn.Text=""; headerBtn.Size=UDim2.new(1,0,0,26)
      headerBtn.MouseButton1Click:Connect(function()
        open = not open; holder.Visible=open; tween(caret,.12,{Rotation=open and 180 or 0})
      end)

      return {
        SetValue=function(_,v) current=v; head.Text = string.upper((title or "DROPDOWN").." : "..tostring(v)) end,
        GetValue=function() return current end,
        SetOptions=function(_,l) rebuild(l or {}) end,
      }
    end

    -- Multi-select (chip style)
    function P:CreateDropdownMulti(title, options, onChanged)
      options = options or {}; onChanged = onChanged or function() end
      local f = Card()

      local head = Heading(f, title or "SELECT")
      local caret = Instance.new("TextLabel", f)
      caret.BackgroundTransparency=1
      caret.Text = "▼"
      caret.Font = Enum.Font.GothamBlack
      caret.TextSize = TOK.type.body
      caret.TextColor3 = TOK.color.accent
      caret.Size = UDim2.fromOffset(16,16)
      caret.Position = UDim2.new(1,-26,0,2)

      local holder = Instance.new("Frame", f)
      holder.BackgroundColor3 = TOK.color.bg_field
      holder.Position = UDim2.new(0,0,0,28)
      holder.AutomaticSize = Enum.AutomaticSize.Y
      holder.Size = UDim2.new(1, -0, 0, 0)
      holder.Visible=false
      local hc = Instance.new("UICorner", holder) hc.CornerRadius = UDim.new(0, TOK.radii.field)
      local hl = Instance.new("UIListLayout", holder) hl.Padding = UDim.new(0,4)

      local selected = {}

      local function updateHead()
        local n=0 for _ in pairs(selected) do n+=1 end
        if n>0 then head.Text = string.upper((title or "SELECT").." : "..n.." SELECTED")
        else head.Text = string.upper(title or "SELECT") end
      end

      local function rebuild(list)
        for _,c in ipairs(holder:GetChildren()) do if c:IsA("Frame") then c:Destroy() end end
        for _,opt in ipairs(list) do
          local row = Instance.new("Frame", holder)
          row.BackgroundColor3 = TOK.color.bg_card
          row.Size = UDim2.new(1, -12, 0, 24)
          row.Position = UDim2.new(0,6,0,0)
          local rc = Instance.new("UICorner", row) rc.CornerRadius = UDim.new(0, TOK.radii.sm)

          local txt = Instance.new("TextLabel", row)
          txt.BackgroundTransparency=1
          txt.TextXAlignment = Enum.TextXAlignment.Left
          txt.Size = UDim2.new(1,-34,1,0)
          txt.Position = UDim2.new(0,8,0,0)
          txt.Text = opt
          txt.TextColor3 = TOK.color.text
          txt.Font = Enum.Font.Gotham
          txt.TextSize = TOK.type.body

          local box = Instance.new("Frame", row)
          box.Size = UDim2.fromOffset(20,20)
          box.Position = UDim2.new(1,-24,0,2)
          box.BackgroundColor3 = TOK.color.bg_field
          local bc = Instance.new("UICorner", box) bc.CornerRadius = UDim.new(0, TOK.radii.sm)

          local tick = Instance.new("Frame", box)
          tick.BackgroundColor3 = TOK.color.accent
          tick.Size = UDim2.new(1,-6,1,-6)
          tick.Position = UDim2.new(0,3,0,3)
          tick.Visible = false
          local tc = Instance.new("UICorner", tick) tc.CornerRadius = UDim.new(0, TOK.radii.sm)

          local btn = Instance.new("TextButton", row)
          btn.BackgroundTransparency=1; btn.Text=""; btn.Size=UDim2.new(1,0,1,0)
          btn.MouseButton1Click:Connect(function()
            selected[opt] = not selected[opt]
            tick.Visible = selected[opt] and true or false
            updateHead()
            onChanged(selected)
          end)
        end
        updateHead()
      end
      rebuild(options)

      local open=false
      local headerBtn = Instance.new("TextButton", f)
      headerBtn.BackgroundTransparency=1; headerBtn.Text=""; headerBtn.Size=UDim2.new(1,0,0,26)
      headerBtn.MouseButton1Click:Connect(function()
        open = not open; holder.Visible=open; tween(caret,.12,{Rotation=open and 180 or 0})
      end)

      return {
        GetSelected=function() return selected end,
        SetOptions=function(_,l) rebuild(l or {}) end,
        SetSelected=function(_,map) selected = map or {}; rebuild(options) end
      }
    end

    return P
  end

  function api:CreateTab(title)
    local Page = Instance.new("ScrollingFrame", Win)
    Page.BackgroundColor3 = TOK.color.bg_dark
    Page.Position = UDim2.new(0, 8+148+8, 0, 46)
    Page.Size = UDim2.new(1, -(148+8+16), 1, -54)
    Page.Visible=false
    Page.ScrollBarThickness=5
    Page.ScrollBarImageColor3 = TOK.color.accent
    Page.AutomaticCanvasSize = Enum.AutomaticSize.Y

    local pad = Instance.new("UIPadding", Page)
    pad.PaddingTop=UDim.new(0, TOK.space.page)
    pad.PaddingBottom=UDim.new(0, TOK.space.page)
    pad.PaddingLeft=UDim.new(0, TOK.space.page)
    pad.PaddingRight=UDim.new(0, TOK.space.page)

    local vlist = Instance.new("UIListLayout", Page)
    vlist.SortOrder=Enum.SortOrder.LayoutOrder
    vlist.Padding = UDim.new(0, TOK.space.gap)

    -- Tab button
    local Btn = Instance.new("TextButton", Rail)
    Btn.BackgroundTransparency=1
    Btn.Size = UDim2.new(1,-16,0,20)
    Btn.Position = UDim2.new(0,8,0,28)
    Btn.Text = string.upper(title or "TAB")
    Btn.Font = Enum.Font.Gotham
    Btn.TextSize = TOK.type.body
    Btn.TextColor3 = TOK.color.text
    Btn.TextTransparency = 0.5

    local line = Instance.new("Frame", Btn)
    line.BorderSizePixel=0
    line.BackgroundColor3 = TOK.color.accent
    line.Size = UDim2.new(0,3,1,-4)
    line.Position = UDim2.new(0,-6,0,2)
    line.Visible=false

    local function select()
      for _,p in ipairs(Win:GetChildren()) do
        if p:IsA("ScrollingFrame") then p.Visible=false end
      end
      for _,b in ipairs(Rail:GetChildren()) do
        if b:IsA("TextButton") then b.TextTransparency=0.5 end
      end
      Btn.TextTransparency=0
      Page.Visible=true
      line.Visible=true
    end
    Btn.MouseButton1Click:Connect(select)
    if not first then first=true; select() end

    return PageAPI(Page)
  end

  return api
end

------------------------------ HELPERS ------------------------------
local function clamp(n,a,b) return math.max(a, math.min(b,n)) end

-- ==== Fishing core (dipakai tab Farm) ====
local net,RF_ChargeFishingRod,RF_RequestMinigame,RE_FishingCompleted,RE_EquipHotbar,RE_RepText
task.spawn(function()
  local function gw(o,n,t) return o:FindFirstChild(n) or o:WaitForChild(n,t or 10) end
  local okNet,mod=pcall(function()
    local p=gw(ReplicatedStorage,"Packages",10); p=gw(p,"_Index",10); p=gw(p,"sleitnick_net@0.2.0",10); return gw(p,"net",10)
  end)
  if not okNet then return end
  net=mod
  RF_ChargeFishingRod=net:FindFirstChild("RF/ChargeFishingRod")
  RF_RequestMinigame=net:FindFirstChild("RF/RequestFishingMinigameStarted")
  RE_FishingCompleted=net:FindFirstChild("RE/FishingCompleted")
  RE_EquipHotbar=net:FindFirstChild("RE/EquipToolFromHotbar")
  RE_RepText=net:FindFirstChild("RE/ReplicateTextEffect")
end)

local farmState = { running=false, perfect=true, lastAction=os.clock() }

local function perfectCoords()
  -- Nilai bias cast yang konsisten perfect di Fish It
  local bx,by=-0.7499996423721313,1
  return bx+(math.random(-500,500)/1e7), by+(math.random(-500,500)/1e7)
end

local function castOnce()
  if RE_EquipHotbar then RE_EquipHotbar:FireServer(1) end
  task.wait(0.02)
  if RF_ChargeFishingRod then RF_ChargeFishingRod:InvokeServer(workspace:GetServerTimeNow()) end
  task.wait(0.18)
  if RF_ChargeFishingRod then RF_ChargeFishingRod:InvokeServer(workspace:GetServerTimeNow()) end
  local x,y = perfectCoords()
  if not farmState.perfect then
    x = math.random(-1000,1000)/1000
    y = math.random(0,1000)/1000
  end
  if RF_RequestMinigame then RF_RequestMinigame:InvokeServer(x,y) end
  farmState.lastAction=os.clock()
end

-- Auto-finish saat bite (sinkron dengan UI)
task.spawn(function()
  repeat task.wait() until RE_RepText
  if not RE_RepText then return end
  RE_RepText.OnClientEvent:Connect(function(d)
    if not farmState.running then return end
    if d and d.TextData and d.TextData.EffectType=="Exclaim" then
      -- "Perfect" = selesaikan secepat mungkin
      task.spawn(function()
        task.wait(0.03)
        pcall(function() if RE_FishingCompleted then RE_FishingCompleted:FireServer() end end)
      end)
    end
  end)
end)

local function StartFarm()
  if farmState.running then return end
  farmState.running=true
  task.spawn(function()
    while farmState.running do
      pcall(function()
        castOnce()
        local t0=os.clock()
        while os.clock()-t0 < 0.45 do
          -- recast anti-stuck
          if (os.clock()-farmState.lastAction) > 2.5 then castOnce(); t0=os.clock() end
          task.wait(0.03)
        end
      end)
      task.wait(0.03)
    end
  end)
end
local function StopFarm() farmState.running=false end

-- ==== Event helpers ====
local staticEvents = { "Admin Event","Shark Hunt","Ghost Shark Hunt","Worm Hunt","Black Hole","Shocked","Ghost Worm","Meteor Rain" }

local function discoverEvents()
  local set = {}
  local props = Workspace:FindFirstChild("Props")
  if props then
    for _,child in ipairs(props:GetChildren()) do
      if (child:IsA("Folder") or child:IsA("Model")) and #child.Name>=3 then
        set[child.Name]=true
      end
    end
  end
  if (next(set)==nil) then for _,n in ipairs(staticEvents) do set[n]=true end end
  local list = {} for k in pairs(set) do table.insert(list,k) end table.sort(list); return list
end

local function findEventCFrame(node)
  if not node then return nil end
  -- 1) Fishing Boat
  local boat = node:FindFirstChild("Fishing Boat")
  if boat and boat.GetPivot then return boat:GetPivot() end
  -- 2) Model dengan PrimaryPart / GetPivot
  if node:IsA("Model") then
    local ok,cf = pcall(function() return node:GetPivot() end)
    if ok and cf then return cf end
    if node.PrimaryPart then return node.PrimaryPart.CFrame end
  end
  -- 3) BasePart anak pertama
  local nearest; local hrp = (LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()):FindFirstChild("HumanoidRootPart")
  local bestDist
  for _,d in ipairs(node:GetDescendants()) do
    if d:IsA("BasePart") then
      if hrp then
        local dist = (d.Position - hrp.Position).Magnitude
        if not bestDist or dist < bestDist then bestDist = dist; nearest = d end
      else
        nearest = d; break
      end
    end
  end
  if nearest then return nearest.CFrame end
  -- 4) Centroid fallback
  local min,max
  for _,d in ipairs(node:GetDescendants()) do
    if d:IsA("BasePart") then
      min = min and Vector3.new(math.min(min.X,d.Position.X), math.min(min.Y,d.Position.Y), math.min(min.Z,d.Position.Z)) or d.Position
      max = max and Vector3.new(math.max(max.X,d.Position.X), math.max(max.Y,d.Position.Y), math.max(max.Z,d.Position.Z)) or d.Position
    end
  end
  if min and max then
    local center = (min+max)/2
    return CFrame.new(center)
  end
  return nil
end

local function tpEventByName(evName)
  local props = Workspace:FindFirstChild("Props")
  if not props then return false,"Props not found" end
  local node = props:FindFirstChild(evName)
  if not node then return false,"Event not found" end
  local cf = findEventCFrame(node)
  if not cf then return false,"No position" end
  local ch = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
  local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
  if not hrp then return false,"HRP missing" end
  hrp.CFrame = cf + Vector3.new(0,15,0)
  return true
end

-- Islands
local islands = {
  ["Weather Machine"] = Vector3.new(-1471,-3,1929),
  ["Esoteric Depths"] = Vector3.new(3157,-1303,1439),
  ["Tropical Grove"]  = Vector3.new(-2038,3,3650),
  ["Stingray Shores"] = Vector3.new(-32,4,2773),
  ["Kohana Volcano"]  = Vector3.new(-519,24,189),
  ["Coral Reefs"]     = Vector3.new(-3095,1,2177),
  ["Crater Island"]   = Vector3.new(968,1,4854),
  ["Kohana"]          = Vector3.new(-658,3,719),
  ["Winter Fest"]     = Vector3.new(1611,4,3280),
  ["Esoteric Island"] = Vector3.new(1987,4,1400),
  ["Treasure Room"]   = Vector3.new(-3600,-267,-1558),
  ["Lost Shore"]      = Vector3.new(-3663,38,-989),
  ["Sisyphus"]        = Vector3.new(-3792,-135,-986),
  ["Crystal Cavern"]  = Vector3.new(-2026,-440,7428),
  ["Halloween"]       = Vector3.new(2127,78,3334),
  ["Ancient Underground Cave"] = Vector3.new(2102,-91,-709),
  ["Ancient Inside Temple"]    = Vector3.new(1506,-22,-641),
  ["Ancient Jungle"]           = Vector3.new(1268,78,-183),
  ["Fisherman Island"]         = Vector3.new(-3,17,2840),
}
local islandList = {} for n in pairs(islands) do table.insert(islandList, n) end table.sort(islandList)

local function tpTo(pos)
  if not pos then return end
  local ch = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
  local hrp = ch:FindFirstChild("HumanoidRootPart")
  if hrp then hrp.CFrame = CFrame.new(pos + Vector3.new(0,5,0)) end
end

local function scanNPC()
  local s = {}
  for _,m in ipairs(Workspace:GetDescendants()) do
    if m:IsA("Model") then
      local hasHum = m:FindFirstChildOfClass("Humanoid")
      local hasPrompt = false
      for _,d in ipairs(m:GetDescendants()) do if d:IsA("ProximityPrompt") then hasPrompt=true break end end
      if (hasHum or hasPrompt) and #m.Name>=3 then s[m.Name]=true end
    end
  end
  local t={} for k in pairs(s) do table.insert(t,k) end table.sort(t)
  return t
end
local function playersList()
  local t={}
  for _,pl in ipairs(Players:GetPlayers()) do if pl ~= LocalPlayer then table.insert(t, pl.Name) end end
  table.sort(t); return t
end

------------------------------ BUILD UI ------------------------------
local UI = lib:Window("AEGISHUB • FISH IT", "PREMIUM", 10044538000)

local TabFarm  = UI:CreateTab("Farm")
local TabInv   = UI:CreateTab("Inventory")
local TabShop  = UI:CreateTab("Shop")
local TabTP    = UI:CreateTab("Teleport")
local TabEvent = UI:CreateTab("Event")

-- === FARM ===
local farmLbl = TabFarm:CreateLabel("FARM • READY")
local togFarm = TabFarm:CreateToggle("AUTO FISHING","Mulai / hentikan farming otomatis", function(on)
  if on then
    farmLbl:UpdateLabel("FARM • RUNNING")
    StartFarm()
  else
    farmLbl:UpdateLabel("FARM • STOPPED")
    StopFarm()
  end
end)
local togPerfect = TabFarm:CreateToggle("PERFECT CASTING","Selalu lempar perfect", function(on)
  farmState.perfect = on
end)
togFarm:Set(false)
togPerfect:Set(true)

-- === Inventory (placeholder tombol praktis) ===
TabInv:CreateButton("SELL ALL","Jual semua item via menu game", function()
  -- Biarkan manual (tergantung server RPC). Tambahkan kalau kamu punya RPC jual
end)

-- === Shop (contoh tombol) ===
TabShop:CreateButton("TRAVELING MERCHANT","Open merchant", function()
  -- Cari prompt terdekat berteks merchant
  local function fire(filter,maxDist)
    local char=LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp=char and char:FindFirstChild("HumanoidRootPart"); if not hrp then return end
    local best,dist
    for _,d in ipairs(Workspace:GetDescendants()) do
      if d:IsA("ProximityPrompt") then
        local use=filter(d)
        if use then
          local p=(d.Parent:IsA("BasePart") and d.Parent.Position) or (d.Parent.Parent and d.Parent.Parent:IsA("BasePart") and d.Parent.Parent.Position)
          if p then local dd=(p-hrp.Position).Magnitude; if dd<=(maxDist or 200) and (not dist or dd<dist) then best=d; dist=dd end end
        end
      end
    end
    if best then pcall(function() fireproximityprompt(best,5) end) end
  end
  fire(function(pp)
    local t=(pp.ObjectText or "").." "..(pp.ActionText or ""):lower()
    local n=(pp.Parent and pp.Parent.Name or ""):lower()
    return t:find("merchant") or n:find("merchant")
  end,200)
end)
TabShop:CreateButton("BOBBER SHOP","", function() end)
TabShop:CreateButton("ROD SHOP","", function() end)
TabShop:CreateButton("WEATHER SHOP","", function() end)

-- === Teleport ===
local coordLbl = TabTP:CreateLabel("COORDINATES")
local ddIsland = TabTP:CreateDropdown("TELEPORT ISLAND", islandList, function(opt) tpTo(islands[opt]) end)
local ddNPC    = TabTP:CreateDropdown("TELEPORT NPC", scanNPC(), function(name)
  local ch = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
  local hrp = ch and ch:FindFirstChild("HumanoidRootPart"); if not hrp then return end
  local best,dist
  for _,m in ipairs(Workspace:GetDescendants()) do
    if m:IsA("Model") and string.find(string.lower(m.Name), string.lower(name)) then
      local p = m:FindFirstChild("HumanoidRootPart") or m:FindFirstChildWhichIsA("BasePart")
      if p then local d=(p.Position-hrp.Position).Magnitude; if not dist or d<dist then best=p; dist=d end end
    end
  end
  if best then tpTo(best.Position) end
end)
local ddPlayers= TabTP:CreateDropdown("TELEPORT PLAYER", playersList(), function(nm)
  local p=Players:FindFirstChild(nm)
  if p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then tpTo(p.Character.HumanoidRootPart.Position) end
end)

-- Auto-refresh NPC/Players
task.spawn(function()
  while true do
    task.wait(8)
    ddNPC:SetOptions(scanNPC())
    ddPlayers:SetOptions(playersList())
  end
end)

-- Live coordinates
RS.RenderStepped:Connect(function()
  local ch = LocalPlayer.Character
  local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
  if hrp and coordLbl and coordLbl.UpdateLabel then
    local p = hrp.Position
    coordLbl:UpdateLabel(string.upper(string.format("COORDINATES  •  X: %.1f  Y: %.1f  Z: %.1f", p.X, p.Y, p.Z)))
  end
end)

-- === Event ===
local AUTO_EVENT_ON = true
local SELECTED_EVENTS = {}
local currentEvents = discoverEvents()

-- Dropdown SINGLE (Teleport Now)
local ddEventSingle = TabEvent:CreateDropdown("EVENT TELEPORT", currentEvents, function(opt)
  tpEventByName(opt)
end)

-- Multi-select + toggle auto
local multi = TabEvent:CreateDropdownMulti("SELECT EVENTS (AUTO)", currentEvents, function(map)
  SELECTED_EVENTS = map or {}
end)

-- Default pilih semua & ON
do
  local all = {} for _,n in ipairs(currentEvents) do all[n]=true end
  SELECTED_EVENTS = all
end
local statusLbl = TabEvent:CreateLabel("EVENT WATCH • SCANNING")
local autoT = TabEvent:CreateToggle("AUTO TELEPORT SELECTED EVENTS","Otomatis teleport ke event aktif", function(on)
  AUTO_EVENT_ON = on
end)
autoT:Set(true)

-- Worker auto-teleport
task.spawn(function()
  while true do
    if AUTO_EVENT_ON then
      local props = Workspace:FindFirstChild("Props")
      if props then
        local teleported=false
        for ev,_ in pairs(SELECTED_EVENTS) do
          if SELECTED_EVENTS[ev] then
            local node = props:FindFirstChild(ev)
            if node then
              local cf = findEventCFrame(node)
              if cf then
                local ch = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
                local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
                if hrp and (hrp.Position - cf.Position).Magnitude > 20 then
                  hrp.CFrame = cf + Vector3.new(0,15,0)
                end
                teleported=true
                if statusLbl and statusLbl.UpdateLabel then statusLbl:UpdateLabel(string.upper("EVENT WATCH • TELEPORTED: "..ev)) end
                break
              end
            end
          end
        end
        if not teleported and statusLbl and statusLbl.UpdateLabel then
          statusLbl:UpdateLabel(string.upper("EVENT WATCH • NO ACTIVE (WAITING)"))
        end
      else
        if statusLbl and statusLbl.UpdateLabel then statusLbl:UpdateLabel(string.upper("EVENT WATCH • PROPS NOT FOUND")) end
      end
    end
    task.wait(1.5)
  end
end)

-- Refresh daftar event berkala (auto update UI)
task.spawn(function()
  while true do
    task.wait(8)
    local fresh = discoverEvents()
    ddEventSingle:SetOptions(fresh)
    multi:SetOptions(fresh)
    currentEvents = fresh
  end
end)

-- Players list reactive
Players.PlayerAdded:Connect(function() ddPlayers:SetOptions(playersList()) end)
Players.PlayerRemoving:Connect(function() ddPlayers:SetOptions(playersList()) end)
