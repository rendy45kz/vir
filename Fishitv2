----------------------------------------------------------------
-- AegisHub UI â€“ Compact Gamer UI (smaller + new elegant theme)
----------------------------------------------------------------
if not game:IsLoaded() then game.Loaded:Wait() end

local TweenService     = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui          = game:GetService("CoreGui")

local library = {}

-- Tema baru: sedikit lebih terang & kalem
local theme = {
    bg     = Color3.fromRGB(14, 16, 24),   -- background utama
    card   = Color3.fromRGB(24, 26, 36),   -- panel / kartu
    stroke = Color3.fromRGB(60, 70, 100),  -- garis luar
    text   = Color3.fromRGB(235, 239, 255),
    accent = Color3.fromRGB(140, 190, 255), -- biru lembut
}

local function tween(obj, dur, props)
    return TweenService:Create(obj, TweenInfo.new(dur, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), props)
end

--------------------------------------------------------------------------------
-- MAIN WINDOW
--------------------------------------------------------------------------------
function library:CreateWindow(title)
    local gui = Instance.new("ScreenGui")
    gui.Name = "AegisHubCompact"
    gui.Parent = CoreGui
    gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    -- main window (diperkecil)
    local main = Instance.new("Frame")
    main.Parent = gui
    main.Size = UDim2.new(0, 460, 0, 300)             -- dulu 520 x 340
    main.Position = UDim2.new(.5, -230, .5, -150)
    main.BackgroundColor3 = theme.bg
    main.BorderSizePixel = 0

    local stroke = Instance.new("UIStroke", main)
    stroke.Thickness = 1
    stroke.Color = theme.stroke

    local cornerMain = Instance.new("UICorner", main)
    cornerMain.CornerRadius = UDim.new(0, 6)

    -- draggable overlay toggle (bulat kecil di samping)
    local overlayBtn = Instance.new("TextButton")
    overlayBtn.Parent = gui
    overlayBtn.Size = UDim2.new(0, 30, 0, 30)
    overlayBtn.Position = UDim2.new(0, 12, 0.5, -15)
    overlayBtn.Text = "â‰¡"
    overlayBtn.Font = Enum.Font.GothamBold
    overlayBtn.TextSize = 16
    overlayBtn.TextColor3 = theme.text
    overlayBtn.BackgroundColor3 = theme.card
    overlayBtn.BorderSizePixel = 0
    overlayBtn.Visible = false

    local ovCorner = Instance.new("UICorner", overlayBtn)
    ovCorner.CornerRadius = UDim.new(1, 0)

    do -- drag overlay
        local dragging, start, offset
        overlayBtn.InputBegan:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1
               or i.UserInputType == Enum.UserInputType.Touch then
                dragging = true
                start    = i.Position
                offset   = overlayBtn.Position
                i.Changed:Connect(function()
                    if i.UserInputState == Enum.UserInputState.End then
                        dragging = false
                    end
                end)
            end
        end)
        UserInputService.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement
                or i.UserInputType == Enum.UserInputType.Touch) then
                local d = i.Position - start
                overlayBtn.Position = UDim2.new(
                    offset.X.Scale, offset.X.Offset + d.X,
                    offset.Y.Scale, offset.Y.Offset + d.Y
                )
            end
        end)
    end

    overlayBtn.MouseButton1Click:Connect(function()
        main.Visible = true
        overlayBtn.Visible = false
    end)

    -- title bar
    local top = Instance.new("Frame")
    top.Parent = main
    top.Size = UDim2.new(1,0,0,30)                 -- sedikit lebih tipis
    top.BackgroundColor3 = theme.card
    top.BorderSizePixel = 0
    local topCorner = Instance.new("UICorner", top)
    topCorner.CornerRadius = UDim.new(0, 6)

    local tlabel = Instance.new("TextLabel")
    tlabel.Parent = top
    tlabel.Size = UDim2.new(1,-80,1,0)
    tlabel.Position = UDim2.new(0,10,0,0)
    tlabel.BackgroundTransparency = 1
    tlabel.Text = tostring(title)
    tlabel.TextXAlignment = Enum.TextXAlignment.Left
    tlabel.Font = Enum.Font.GothamMedium
    tlabel.TextSize = 15
    tlabel.TextColor3 = theme.text

    -- minimize button
    local mini = Instance.new("TextButton")
    mini.Parent = top
    mini.Size = UDim2.new(0,22,1,0)
    mini.Position = UDim2.new(1,-62,0,0)
    mini.Text = "-"
    mini.TextColor3 = Color3.fromRGB(210,210,210)
    mini.BackgroundTransparency = 1
    mini.Font = Enum.Font.GothamBold
    mini.TextSize = 16

    mini.MouseButton1Click:Connect(function()
        main.Visible = false
        overlayBtn.Visible = true
    end)

    -- close button
    local close = Instance.new("TextButton")
    close.Parent = top
    close.Size = UDim2.new(0,36,1,0)
    close.Position = UDim2.new(1,-36,0,0)
    close.Text = "X"
    close.TextColor3 = Color3.fromRGB(255,80,80)
    close.BackgroundTransparency = 1
    close.Font = Enum.Font.GothamBold
    close.TextSize = 16

    close.MouseButton1Click:Connect(function()
        gui:Destroy()
    end)

    ---------------------------
    -- DRAGGING THE WINDOW
    ---------------------------
    do
        local dragging, start, offset
        top.InputBegan:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1
               or i.UserInputType == Enum.UserInputType.Touch then
                dragging = true
                start    = i.Position
                offset   = main.Position
                i.Changed:Connect(function()
                    if i.UserInputState == Enum.UserInputState.End then
                        dragging = false
                    end
                end)
            end
        end)
        UserInputService.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement
                or i.UserInputType == Enum.UserInputType.Touch) then
                local d = i.Position - start
                main.Position = UDim2.new(
                    offset.X.Scale, offset.X.Offset + d.X,
                    offset.Y.Scale, offset.Y.Offset + d.Y
                )
            end
        end)
    end

    ------------------------------------------
    -- LEFT SIDE TAB LIST
    ------------------------------------------
    local sidebar = Instance.new("Frame")
    sidebar.Parent = main
    sidebar.Size = UDim2.new(0,150,1,-30)      -- sedikit lebih kecil
    sidebar.Position = UDim2.new(0,0,0,30)
    sidebar.BackgroundColor3 = theme.card
    sidebar.BorderSizePixel = 0
    local sideCorner = Instance.new("UICorner", sidebar)
    sideCorner.CornerRadius = UDim.new(0, 6)

    local slist = Instance.new("UIListLayout", sidebar)
    slist.SortOrder = Enum.SortOrder.LayoutOrder
    slist.Padding = UDim.new(0,6)
    slist.HorizontalAlignment = Enum.HorizontalAlignment.Center

    ------------------------------------------
    -- RIGHT SIDE PAGE HOLDER
    ------------------------------------------
    local holder = Instance.new("Frame")
    holder.Parent = main
    holder.Size = UDim2.new(1,-150,1,-30)
    holder.Position = UDim2.new(0,150,0,30)
    holder.BackgroundTransparency = 1

    ---------------------------------------------------------------------
    -- TAB CREATOR
    ---------------------------------------------------------------------
    local win = {}

    function win:CreateTab(name)
        local tabBtn = Instance.new("TextButton")
        tabBtn.Parent = sidebar
        tabBtn.Size = UDim2.new(1,-12,0,28)
        tabBtn.BackgroundColor3 = theme.bg
        tabBtn.BorderSizePixel = 0
        tabBtn.Text = name
        tabBtn.Font = Enum.Font.Gotham
        tabBtn.TextSize = 13
        tabBtn.TextColor3 = theme.text

        local tabCorner = Instance.new("UICorner", tabBtn)
        tabCorner.CornerRadius = UDim.new(0, 4)

        local tabStroke = Instance.new("UIStroke", tabBtn)
        tabStroke.Thickness = 1
        tabStroke.Color = theme.stroke

        local page = Instance.new("ScrollingFrame")
        page.Parent = holder
        page.Size = UDim2.new(1,0,1,0)
        page.BackgroundTransparency = 1
        page.ScrollBarThickness = 3
        page.Visible = false
        page.AutomaticCanvasSize = Enum.AutomaticSize.Y

        local plist = Instance.new("UIListLayout", page)
        plist.SortOrder = Enum.SortOrder.LayoutOrder
        plist.Padding = UDim.new(0,6)
        local pad = Instance.new("UIPadding", page)
        pad.PaddingTop = UDim.new(0,6)
        pad.PaddingLeft = UDim.new(0,6)
        pad.PaddingRight = UDim.new(0,6)

        -- select tab
        tabBtn.MouseButton1Click:Connect(function()
            for _,pg in ipairs(holder:GetChildren()) do
                if pg:IsA("ScrollingFrame") then pg.Visible=false end
            end
            page.Visible = true
        end)

        -- first tab auto-selected
        local numPages = 0
        for _,pg in ipairs(holder:GetChildren()) do
            if pg:IsA("ScrollingFrame") then numPages = numPages + 1 end
        end
        if numPages == 1 then
            page.Visible = true
        end

        ------------------------------------------------------------
        -- COMPONENT API
        ------------------------------------------------------------
        local api = {}

        ---------------------
        -- Label
        ---------------------
        function api:Label(text)
            local lbl = Instance.new("TextLabel")
            lbl.Parent = page
            lbl.Size = UDim2.new(1,-4,0,20)
            lbl.BackgroundTransparency = 1
            lbl.Text = text
            lbl.Font = Enum.Font.GothamBold
            lbl.TextSize = 13
            lbl.TextColor3 = theme.text
            lbl.TextXAlignment = Enum.TextXAlignment.Left
        end

        ---------------------
        -- Toggle
        ---------------------
        function api:Toggle(text, callback)
            callback = callback or function() end
            
            local fr = Instance.new("Frame")
            fr.Parent = page
            fr.Size = UDim2.new(1,-4,0,26)
            fr.BackgroundColor3 = theme.card
            fr.BorderSizePixel = 0
            local frCorner = Instance.new("UICorner", fr)
            frCorner.CornerRadius = UDim.new(0,4)

            local lbl = Instance.new("TextLabel")
            lbl.Parent = fr
            lbl.Size = UDim2.new(1,-40,1,0)
            lbl.Position = UDim2.new(0,8,0,0)
            lbl.BackgroundTransparency = 1
            lbl.Text = text
            lbl.TextColor3 = theme.text
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.Font = Enum.Font.Gotham
            lbl.TextSize = 12

            local btn = Instance.new("Frame")
            btn.Parent = fr
            btn.Size = UDim2.new(0,20,0,20)
            btn.Position = UDim2.new(1,-26,0.5,-10)
            btn.BackgroundColor3 = theme.bg
            btn.BorderSizePixel = 0
            local btnCorner = Instance.new("UICorner", btn)
            btnCorner.CornerRadius = UDim.new(0,4)

            local tick = Instance.new("TextLabel", btn)
            tick.Size = UDim2.new(1,0,1,0)
            tick.BackgroundTransparency = 1
            tick.Font = Enum.Font.GothamBold
            tick.Text = ""
            tick.TextColor3 = theme.accent
            tick.TextSize = 14

            local click = Instance.new("TextButton")
            click.Parent = fr
            click.Size = UDim2.new(1,0,1,0)
            click.BackgroundTransparency = 1
            click.Text = ""

            local state = false
            local function apply()
                tick.Text = state and "âœ“" or ""
                callback(state)
            end
            click.MouseButton1Click:Connect(function()
                state = not state
                apply()
            end)

            return {
                Set = function(_,v)
                    state = v and true or false
                    apply()
                end
            }
        end

        ---------------------
        -- Slider
        ---------------------
        function api:Slider(text, min, max, default, callback)
            callback = callback or function() end
            min = min or 0
            max = max or 100
            default = default or min

            local fr = Instance.new("Frame")
            fr.Parent = page
            fr.Size = UDim2.new(1,-4,0,34)
            fr.BackgroundColor3 = theme.card
            fr.BorderSizePixel = 0
            local frCorner = Instance.new("UICorner", fr)
            frCorner.CornerRadius = UDim.new(0,4)

            local lbl = Instance.new("TextLabel")
            lbl.Parent = fr
            lbl.Text = text
            lbl.Size = UDim2.new(1,-8,0,16)
            lbl.Position = UDim2.new(0,8,0,0)
            lbl.BackgroundTransparency = 1
            lbl.TextColor3 = theme.text
            lbl.Font = Enum.Font.Gotham
            lbl.TextSize = 12
            lbl.TextXAlignment = Enum.TextXAlignment.Left

            local bar = Instance.new("Frame", fr)
            bar.Size = UDim2.new(1,-16,0,5)
            bar.Position = UDim2.new(0,8,0,20)
            bar.BackgroundColor3 = theme.bg
            bar.BorderSizePixel = 0
            local barCorner = Instance.new("UICorner", bar)
            barCorner.CornerRadius = UDim.new(0,4)

            local fill = Instance.new("Frame", bar)
            fill.Size = UDim2.new(0,0,1,0)
            fill.BackgroundColor3 = theme.accent
            fill.BorderSizePixel = 0
            local fillCorner = Instance.new("UICorner", fill)
            fillCorner.CornerRadius = UDim.new(0,4)

            local dragging = false
            local value = default

            local function setFromPct(pct)
                pct = math.clamp(pct,0,1)
                value = math.floor(min + pct*(max-min))
                fill.Size = UDim2.new(pct,0,1,0)
                callback(value)
            end

            local function update(px)
                local pct = (px - bar.AbsolutePosition.X) / bar.AbsoluteSize.X
                setFromPct(pct)
            end

            bar.InputBegan:Connect(function(i)
                if i.UserInputType == Enum.UserInputType.MouseButton1 
                or i.UserInputType == Enum.UserInputType.Touch then
                    dragging = true
                    update(i.Position.X)
                end
            end)
            bar.InputEnded:Connect(function(i)
                if i.UserInputType == Enum.UserInputType.MouseButton1 
                or i.UserInputType == Enum.UserInputType.Touch then
                    dragging = false
                end
            end)

            UserInputService.InputChanged:Connect(function(i)
                if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement
                    or i.UserInputType == Enum.UserInputType.Touch) then
                    update(i.Position.X)
                end
            end)

            setFromPct((default-min)/(max-min))

            return {
                Set = function(_, v)
                    v = math.clamp(v or value, min, max)
                    setFromPct((v-min)/(max-min))
                end
            }
        end

        ---------------------
        -- TextBox
        ---------------------
        function api:Box(placeholder, callback)
            callback = callback or function() end

            local fr = Instance.new("Frame")
            fr.Parent = page
            fr.Size = UDim2.new(1,-4,0,30)
            fr.BackgroundColor3 = theme.card
            fr.BorderSizePixel = 0
            local frCorner = Instance.new("UICorner", fr)
            frCorner.CornerRadius = UDim.new(0,4)

            local box = Instance.new("TextBox")
            box.Parent = fr
            box.PlaceholderText = placeholder
            box.Text = ""
            box.Size = UDim2.new(1,-12,1,-6)
            box.Position = UDim2.new(0,6,0,3)
            box.BackgroundColor3 = theme.bg
            box.BorderSizePixel = 0
            box.Font = Enum.Font.Gotham
            box.TextSize = 12
            box.TextColor3 = theme.text

            box.FocusLost:Connect(function()
                callback(box.Text)
            end)

            return {
                Set = function(_,v)
                    box.Text = v
                end
            }
        end

        ---------------------
        -- Button
        ---------------------
        function api:Button(text, callback)
            callback = callback or function() end

            local fr = Instance.new("TextButton")
            fr.Parent = page
            fr.Size = UDim2.new(1,-4,0,28)
            fr.BackgroundColor3 = theme.card
            fr.BorderSizePixel = 0
            fr.Text = text
            fr.Font = Enum.Font.GothamSemibold
            fr.TextSize = 13
            fr.TextColor3 = theme.text
            local frCorner = Instance.new("UICorner", fr)
            frCorner.CornerRadius = UDim.new(0,4)

            fr.MouseButton1Click:Connect(callback)
        end

        ---------------------
        -- Dropdown (Single Select)
        ---------------------
        function api:Dropdown(text, list, callback)
            callback = callback or function() end
            list = list or {}
            local selected = nil

            local fr = Instance.new("Frame")
            fr.Parent = page
            fr.Size = UDim2.new(1,-4,0,30)
            fr.AutomaticSize = Enum.AutomaticSize.Y
            fr.BackgroundColor3 = theme.card
            fr.BorderSizePixel = 0
            local frCorner = Instance.new("UICorner", fr)
            frCorner.CornerRadius = UDim.new(0,4)

            local lbl = Instance.new("TextLabel")
            lbl.Parent = fr
            lbl.Size = UDim2.new(1,-30,0,30)
            lbl.Position = UDim2.new(0,8,0,0)
            lbl.BackgroundTransparency = 1
            lbl.Font = Enum.Font.Gotham
            lbl.TextColor3 = theme.text
            lbl.TextSize = 12
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.Text = text

            local arrow = Instance.new("TextLabel")
            arrow.Parent = fr
            arrow.Size = UDim2.new(0,18,0,30)
            arrow.Position = UDim2.new(1,-18,0,0)
            arrow.BackgroundTransparency = 1
            arrow.Text = "v"
            arrow.Font = Enum.Font.GothamBold
            arrow.TextColor3 = theme.accent

            local holder = Instance.new("Frame")
            holder.Parent = fr
            holder.Position = UDim2.new(0,0,0,30)
            holder.Size = UDim2.new(1,0,0,0)
            holder.BackgroundColor3 = theme.bg
            holder.BorderSizePixel = 0
            holder.Visible = false
            holder.AutomaticSize = Enum.AutomaticSize.Y
            local hCorner = Instance.new("UICorner", holder)
            hCorner.CornerRadius = UDim.new(0,4)

            local hlist = Instance.new("UIListLayout", holder)
            hlist.Padding = UDim.new(0,2)

            local open = false
            local headBtn = Instance.new("TextButton")
            headBtn.Parent = fr
            headBtn.Size = UDim2.new(1,0,0,30)
            headBtn.BackgroundTransparency = 1
            headBtn.Text = ""

            local function rebuild(opts)
                for _,c in ipairs(holder:GetChildren()) do
                    if c:IsA("TextButton") then c:Destroy() end
                end
                for _,opt in ipairs(opts) do
                    local b = Instance.new("TextButton")
                    b.Parent = holder
                    b.Size = UDim2.new(1,0,0,24)
                    b.BackgroundColor3 = theme.card
                    b.BorderSizePixel = 0
                    b.Text = opt
                    b.Font = Enum.Font.Gotham
                    b.TextSize = 12
                    b.TextColor3 = theme.text
                    local bc = Instance.new("UICorner", b)
                    bc.CornerRadius = UDim.new(0,4)

                    b.MouseButton1Click:Connect(function()
                        selected = opt
                        lbl.Text = text.." : "..opt
                        holder.Visible = false
                        open = false
                        callback(opt)
                    end)
                end
            end
            rebuild(list)

            headBtn.MouseButton1Click:Connect(function()
                open = not open
                holder.Visible = open
            end)

            return {
                Set = function(_, opt)
                    selected = opt
                    lbl.Text = text.." : "..opt
                end,
                SetOptions = function(_, opts)
                    list = opts or {}
                    rebuild(list)
                end
            }
        end

        ---------------------
        -- Multi Dropdown
        ---------------------
        function api:MultiDropdown(text, list, callback)
            callback = callback or function() end
            list = list or {}

            local selected = {}

            local fr = Instance.new("Frame")
            fr.Parent = page
            fr.Size = UDim2.new(1,-4,0,32)
            fr.AutomaticSize = Enum.AutomaticSize.Y
            fr.BackgroundColor3 = theme.card
            fr.BorderSizePixel = 0
            local frCorner = Instance.new("UICorner", fr)
            frCorner.CornerRadius = UDim.new(0,4)

            local lbl = Instance.new("TextLabel")
            lbl.Parent = fr
            lbl.Size = UDim2.new(1,-30,0,32)
            lbl.Position = UDim2.new(0,8,0,0)
            lbl.BackgroundTransparency = 1
            lbl.TextColor3 = theme.text
            lbl.Font = Enum.Font.Gotham
            lbl.TextSize = 12
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.Text = text.." : None"

            local arrow = Instance.new("TextLabel", fr)
            arrow.Size = UDim2.new(0,18,0,32)
            arrow.Position = UDim2.new(1,-18,0,0)
            arrow.Font = Enum.Font.GothamBold
            arrow.TextColor3 = theme.accent
            arrow.Text = "v"
            arrow.BackgroundTransparency = 1

            local holder = Instance.new("Frame", fr)
            holder.Position = UDim2.new(0,0,0,32)
            holder.Size = UDim2.new(1,0,0,0)
            holder.BackgroundColor3 = theme.bg
            holder.Visible = false
            holder.BorderSizePixel = 0
            holder.AutomaticSize = Enum.AutomaticSize.Y
            local hCorner = Instance.new("UICorner", holder)
            hCorner.CornerRadius = UDim.new(0,4)
            local hlist = Instance.new("UIListLayout", holder)
            hlist.Padding = UDim.new(0,2)

            local open = false
            local headBtn = Instance.new("TextButton")
            headBtn.Parent = fr
            headBtn.BackgroundTransparency = 1
            headBtn.Size = UDim2.new(1,0,0,32)
            headBtn.Text = ""

            headBtn.MouseButton1Click:Connect(function()
                open = not open
                holder.Visible = open
            end)

            local function updateText()
                local list2 = {}
                for k,v in pairs(selected) do
                    if v then table.insert(list2,k) end
                end
                table.sort(list2)
                if #list2 == 0 then
                    lbl.Text = text.." : None"
                else
                    lbl.Text = text.." : "..table.concat(list2,", ")
                end
            end

            local function rebuild(opts)
                for _,c in ipairs(holder:GetChildren()) do
                    if c:IsA("TextButton") then c:Destroy() end
                end
                for _,opt in ipairs(opts) do
                    local b = Instance.new("TextButton")
                    b.Parent = holder
                    b.Size = UDim2.new(1,0,0,24)
                    b.BackgroundColor3 = theme.card
                    b.BorderSizePixel = 0
                    b.Text = opt
                    b.Font = Enum.Font.Gotham
                    b.TextSize = 12
                    b.TextColor3 = theme.text
                    local bc = Instance.new("UICorner", b)
                    bc.CornerRadius = UDim.new(0,4)

                    b.MouseButton1Click:Connect(function()
                        selected[opt] = not selected[opt]
                        callback(opt, selected[opt])
                        updateText()
                    end)
                end
                updateText()
            end

            rebuild(list)

            return {
                Set = function(_, opt, state)
                    selected[opt] = state and true or false
                    updateText()
                end,
                List = function()
                    local t={}
                    for k,v in pairs(selected) do if v then table.insert(t,k) end end
                    return t
                end,
                SetOptions = function(_, opts)
                    list = opts or {}
                    rebuild(list)
                end
            }
        end

        return api
    end

    return win
end


----------------------------------------------------------------
-- BUAT WINDOW
----------------------------------------------------------------
local win = library:CreateWindow("AegisHub - Fish It")


------------------------------------------------------------
-- AUTO FISHING (port dari farm/fishing.lua ke UI AegisHub)
-- - Pakai tab "Auto" dari library UI kamu
-- - Setting setara dengan:
--     AutoInstantCatchDelay
--     AutoInstantCatchDelayPerClickPower
--     AutoFishingMethod ("Fast"/"Instant")
--     AutoFishing (true/false)
------------------------------------------------------------

--== SERVICES & REMOTES ==--
local Players        = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace      = game:GetService("Workspace")

local LocalPlayer    = Players.LocalPlayer

-- net folder (sama seperti script lain di hub kamu)
local netIndex = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")

local net = netIndex:WaitForChild("net")

-- remotes utama untuk mancing
local RE_EquipToolFromHotbar    = net:WaitForChild("RE/EquipToolFromHotbar")
local RF_ChargeFishingRod       = net:WaitForChild("RF/ChargeFishingRod")
local RF_RequestFishingMinigame = net:WaitForChild("RF/RequestFishingMinigameStarted")
local RE_FishingCompleted       = net:WaitForChild("RE/FishingCompleted")

------------------------------------------------------------
-- CONFIG (setara dengan Window:GetConfigValue pada module PC)
------------------------------------------------------------
local FishingConfig = {
    AutoFishing                     = false,       -- Flag "AutoFishing"
    AutoFishingMethod               = "Instant",   -- Flag "AutoFishingMethod" ("Fast"/"Instant")
    AutoInstantCatchDelay           = 1.30,        -- Flag "AutoInstantCatchDelay"
    AutoInstantCatchDelayPerClickPower = 0.25,     -- Flag "AutoInstantCatchDelayPerClickPower"
    AutoPerfectCast                 = true,        -- selalu near perfect cast
}

local Fishing = {}          -- object pengganti module m
local autoLoopRunning = false

local function GetServerTime()
    if Workspace.GetServerTimeNow then
        local ok, t = pcall(function()
            return Workspace:GetServerTimeNow()
        end)
        if ok and t then return t end
    end
    return tick()
end

------------------------------------------------------------
-- CAST POWER & UTIL
------------------------------------------------------------
local function CalculateCastPower()
    -- sama konsepnya dengan m:CalculateCastPower
    local minCastPower = 0.5
    if FishingConfig.AutoPerfectCast then
        -- dipaksa sangat dekat ke perfect
        minCastPower = 0.999
    end
    local castPower = minCastPower + math.random() * (0.9999 - minCastPower)
    return math.clamp(castPower, 0, 0.9999)
end

-- versi sederhana dari m:GetElapsedFromPower (nggak dipakai berat, tapi disediakan)
local function GetElapsedFromPower(seedTime, castPower)
    castPower = math.clamp(castPower or 0, 0, 1)
    local frequency = Random.new(seedTime):NextInteger(4, 10)

    if castPower == 1 then
        return math.pi / frequency
    elseif castPower == 0 then
        return 0
    end

    local theta = math.asin(1 - 2 * castPower)
    local elapsed = (theta - math.pi / 2) / frequency
    if elapsed < 0 then
        elapsed = elapsed + (2 * math.pi) / frequency
    end
    return elapsed
end

local function ensureCharacter()
    local char = LocalPlayer.Character
    if not char or not char.Parent then
        char = LocalPlayer.CharacterAdded:Wait()
    end
    return char
end

------------------------------------------------------------
-- LOOP UTAMA AUTO FISHING
------------------------------------------------------------
local function AutoFishingLoop()
    if autoLoopRunning then return end
    autoLoopRunning = true
    print("[AegisHub AutoFishing] loop start")

    while FishingConfig.AutoFishing do
        local okCycle, err = pcall(function()
            -- pastikan karakter & HRP ada
            local char = ensureCharacter()
            local hrp = char and char:FindFirstChild("HumanoidRootPart")
            if not hrp then
                warn("[AutoFishing] HRP not found")
                task.wait(1)
                return
            end

            -- Equip rod di slot 1 (sama seperti module PC: AutoEquipFishingRod)
            pcall(function()
                RE_EquipToolFromHotbar:FireServer(1)
            end)
            task.wait(0.5)

            local method = FishingConfig.AutoFishingMethod

            ----------------------------------------------------------------
            -- MODE "FAST"  (pakai timing castPower agak mirip module PC)
            ----------------------------------------------------------------
            if method == "Fast" then
                local now = GetServerTime()
                local castPower = CalculateCastPower()
                local elapsed   = GetElapsedFromPower(now, castPower)
                local chargeTime = now - elapsed

                -- charge rod dengan waktu mundur (trik original module)
                pcall(function()
                    RF_ChargeFishingRod:InvokeServer(chargeTime)
                end)

                task.wait(0.1)

                -- Y kira-kira sedikit di bawah kaki
                local yPos = hrp.Position.Y - 10

                local okStart, res = pcall(function()
                    if typeof(RF_RequestFishingMinigame.InvokeServer) == "function" then
                        return RF_RequestFishingMinigame:InvokeServer(yPos, castPower, GetServerTime())
                    else
                        RF_RequestFishingMinigame:FireServer(yPos, castPower, GetServerTime())
                        return true
                    end
                end)
                if not okStart then
                    warn("[AutoFishing Fast] StartMini failed:", res)
                end

                -- delay kecil, lalu langsung complete
                local delay = math.max(FishingConfig.AutoInstantCatchDelayPerClickPower or 0.25, 0.05)
                task.wait(delay)

                pcall(function()
                    RE_FishingCompleted:FireServer()
                end)

            ----------------------------------------------------------------
            -- MODE "INSTANT" (loop instan, cast perfect, delay antar cast)
            ----------------------------------------------------------------
            else -- "Instant" default
                local now = GetServerTime()
                local castPower = CalculateCastPower()

                -- charge rod full (nggak perlu offset ribet, server cukup nerima now)
                pcall(function()
                    RF_ChargeFishingRod:InvokeServer(now)
                end)

                task.wait(0.12)

                local yPos = hrp.Position.Y - 10
                local okStart, res = pcall(function()
                    if typeof(RF_RequestFishingMinigame.InvokeServer) == "function" then
                        return RF_RequestFishingMinigame:InvokeServer(yPos, castPower, GetServerTime())
                    else
                        RF_RequestFishingMinigame:FireServer(yPos, castPower, GetServerTime())
                        return true
                    end
                end)
                if not okStart then
                    warn("[AutoFishing Instant] StartMini failed:", res)
                end

                -- delay antar cast (AutoInstantCatchDelay)
                local delay = math.max(FishingConfig.AutoInstantCatchDelay or 1.3, 0.1)
                task.wait(delay)

                pcall(function()
                    RE_FishingCompleted:FireServer()
                end)
            end

            -- cooldown kecil supaya server nggak kepenuhan
            task.wait(0.05)
        end)

        if not okCycle then
            warn("[AegisHub AutoFishing] cycle error:", err)
            task.wait(1)
        end
    end

    autoLoopRunning = false
    print("[AegisHub AutoFishing] loop end")
end

------------------------------------------------------------
-- API mirip module: StartAutoFishing / StopAutoFishing
------------------------------------------------------------
function Fishing:StartAutoFishing()
    if FishingConfig.AutoFishing then return end
    FishingConfig.AutoFishing = true
    task.spawn(AutoFishingLoop)
end

function Fishing:StopAutoFishing()
    FishingConfig.AutoFishing = false
end

------------------------------------------------------------
-- UI "FishingSection" versi UI AegisHub (tab: Auto)
-- (ganti Auto tab lama kamu dengan blok ini)
------------------------------------------------------------
local TabAuto = win:CreateTab("Auto")

TabAuto:Label("Auto Fishing (Instant / Fast)")

-- Toggle Auto Fishing
TabAuto:Toggle("Auto Fishing ðŸŽ£", function(value)
    if value then
        Fishing:StartAutoFishing()
    else
        Fishing:StopAutoFishing()
    end
end)

-- Fishing Method to Use ("Fast" / "Instant")
TabAuto:Dropdown("Fishing Method to Use", {"Fast","Instant"}, function(opt)
    if opt == "Fast" or opt == "Instant" then
        FishingConfig.AutoFishingMethod = opt
        print("[AutoFishing] Method =", opt)
    end
end)

-- Delay between casts (AutoInstantCatchDelay)
TabAuto:Box("Reel Delay (seconds)", function(txt)
    local n = tonumber(txt)
    if n then
        n = math.clamp(n, 0.1, 20)
        FishingConfig.AutoInstantCatchDelay = n
        print("[AutoFishing] AutoInstantCatchDelay =", n)
    end
end)

-- Delay per click power (dipakai mode Fast sebagai delay mini)
TabAuto:Box("Custom Complate Delay (seconds)", function(txt)
    local n = tonumber(txt)
    if n then
        n = math.clamp(n, 0.1, 1.0)
        FishingConfig.AutoInstantCatchDelayPerClickPower = n
        print("[AutoFishing] AutoInstantCatchDelayPerClickPower =", n)
    end
end)

----------------------------------------------------------------
-- TAB SHOP â€“ BUY OLD ROD (VULN)
----------------------------------------------------------------
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- net remotes (pakai path yang sama dengan script lain)
local netFolder = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")
    :WaitForChild("net")

local RF_PurchaseFishingRod = netFolder:WaitForChild("RF/PurchaseFishingRod")

-- folder items
local RodItemsPath = ReplicatedStorage:WaitForChild("Items")

-- buat tab shop (kalau sudah ada TabShop, tinggal pakai yang lama)
local TabShop = win:CreateTab("Shop")

TabShop:Label("Rods Shop")

-- build list rod lama (module name diawali "!!!")
local oldRodOptions = {}   -- label yang tampil di dropdown
local oldRodIdMap   = {}   -- [displayName] = id

do
    for _, item in ipairs(RodItemsPath:GetChildren()) do
        if item:IsA("ModuleScript") and item.Name:sub(1, 3) == "!!!" then
            local ok, data = pcall(require, item)
            if ok and data and data.Data then
                local rodId   = data.Data.Id
                local rodName = data.Data.Name or item.Name:gsub("^!!!", "")
                local price   = data.Data.Price or data.Price

                if rodId and rodName then
                    local label = rodName
                    if price then
                        label = string.format("%s | Price: %s", rodName, tostring(price))
                    end

                    table.insert(oldRodOptions, label)
                    -- map pakai nama bersih tanpa harga
                    oldRodIdMap[rodName] = rodId
                end
            end
        end
    end

    table.sort(oldRodOptions, function(a,b)
        return a:lower() < b:lower()
    end)
end

-- kalau tidak ada rod lama, kasih info saja
if #oldRodOptions == 0 then
    TabShop:Label("Tidak ada old rod (!!!) di ReplicatedStorage.Items")
else
    -- dropdown pakai UI kamu sendiri
    TabShop:Dropdown("Buy Rods", oldRodOptions, function(option)
        if not option or option == "" then return end

        -- ambil nama rod tanpa bagian " | Price: xxx"
        local pureName = option:split(" |")[1]
        local rodId    = oldRodIdMap[pureName]

        if not rodId then
            warn("[OldRodShop] RodId tidak ditemukan untuk:", tostring(pureName))
            return
        end

        -- invoke server (vuln: bisa beli rod yang sudah tidak ada di shop)
        local ok, err = pcall(function()
            RF_PurchaseFishingRod:InvokeServer(rodId)
        end)

        if ok then
            print("[OldRodShop] Berhasil beli rod:", pureName, " | Id:", rodId)
        else
            warn("[OldRodShop] Gagal beli rod:", pureName, "Error:", err)
        end
    end)
end

----------------------------------------------------------------
-- TAB SHOP â€“ BUY BAIT (VULN)
----------------------------------------------------------------
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- net remotes (path sama seperti script lain)
local netFolder = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")
    :WaitForChild("net")

-- GANTI nama remote ini kalau di game beda (cek hasil spy / scan)
local RF_PurchaseBait = netFolder:WaitForChild("RF/PurchaseBait")

-- folder baits (dari screenshot: ReplicatedStorage.Baits)
local BaitsFolder = ReplicatedStorage:WaitForChild("Baits")

-- kalau sudah ada TabShop sebelumnya (rod shop), pakai yang lama
local TabShop = TabShop or win:CreateTab("Shop")

TabShop:Label("Bait Shop")

-- build list bait dari ReplicatedStorage.Baits (ModuleScript)
local baitOptions = {}   -- label di dropdown
local baitIdMap   = {}   -- [displayName] = id

do
    for _, item in ipairs(BaitsFolder:GetChildren()) do
        if item:IsA("ModuleScript") then
            local ok, data = pcall(require, item)
            if ok and data and data.Data then
                local baitId   = data.Data.Id
                local baitName = data.Data.Name or item.Name
                local price    = data.Data.Price or data.Price

                if baitId and baitName then
                    local label = baitName
                    if price then
                        label = string.format("%s | Price: %s", baitName, tostring(price))
                    end

                    table.insert(baitOptions, label)
                    -- map pakai nama bersih (tanpa info price)
                    baitIdMap[baitName] = baitId
                end
            end
        end
    end

    table.sort(baitOptions, function(a, b)
        return a:lower() < b:lower()
    end)
end

if #baitOptions == 0 then
    TabShop:Label("Tidak ada bait ModuleScript di ReplicatedStorage.Baits")
else
    -- dropdown pakai UI compact kamu
    TabShop:Dropdown("Buy Baits", baitOptions, function(option)
        if not option or option == "" then return end

        -- ambil nama bait tanpa bagian " | Price: ..."
        local pureName = option:split(" |")[1]
        local baitId   = baitIdMap[pureName]

        if not baitId then
            warn("[BaitShop] baitId tidak ditemukan untuk:", tostring(pureName))
            return
        end

        -- invoke server (vuln: bisa beli bait yang sudah tidak ada di shop)
        local ok, err = pcall(function()
            RF_PurchaseBait:InvokeServer(baitId)
        end)

        if ok then
            print("[BaitShop] Berhasil beli bait:", pureName, " | Id:", baitId)
        else
            warn("[BaitShop] Gagal beli bait:", pureName, "Error:", err)
        end
    end)
end




----------------------------------------------------------------
-- TAB TRADE â€“ AUTO GIVE ITEMS (V2, UI mirip ThanHub)
----------------------------------------------------------------
local netIndex = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")

local net = netIndex:WaitForChild("net")

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players          = game:GetService("Players")
local LocalPlayer      = Players.LocalPlayer

-- pakai folder net yang sama dengan Farm / Shop
local RF_InitiateTrade        = net:WaitForChild("RF/InitiateTrade")
local RF_AwaitTradeResponse   = net:WaitForChild("RF/AwaitTradeResponse")

-- coba ambil Replion + Utility dari ReplicatedStorage (fallback _G kalau ada)
local Replion = rawget(_G, "Replion")
if not Replion then
    pcall(function()
        Replion = require(ReplicatedStorage.Packages.Replion)
    end)
end

local ItemUtility, ItemStringUtility
pcall(function()
    ItemUtility      = require(ReplicatedStorage.Shared.ItemUtility)
    ItemStringUtility = require(ReplicatedStorage.Modules.ItemStringUtility)
end)

-- STATE TRADE
local Trade = {
    AutoGive       = false,
    AutoAccept     = false,
    SkipFavorited  = true,
    TargetPlayer   = nil,   -- string nama target
    Thread         = nil,
}

-- CACHE INVENTORY  (key = label tampilan)
local inventoryDisplayList = {}           -- { "Candy Butterfly (Qty : 1)", ... }
local inventoryDataByLabel = {}           -- [label] = { name = "Candy Butterfly", uuids = {..}, selected = bool }

-- dropdown handle (dari UI library kamu)
local DD_Player   = nil
local DD_Items    = nil

------------------------------------------------------------
-- Helper: Player List
------------------------------------------------------------
local function getPlayerList()
    local list = {}
    for _,p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            table.insert(list, p.Name)
        end
    end
    table.sort(list)
    return list
end

------------------------------------------------------------
-- Helper: Refresh Player Dropdown
------------------------------------------------------------
local function refreshPlayerDropdown()
    if not DD_Player or not DD_Player.SetOptions then return end
    DD_Player:SetOptions(getPlayerList())
end

Players.PlayerAdded:Connect(refreshPlayerDropdown)
Players.PlayerRemoving:Connect(refreshPlayerDropdown)

------------------------------------------------------------
-- REFRESH INVENTORY (Fish + Enchant Stones, grouped)
------------------------------------------------------------
local function refreshInventoryForTrade()
    table.clear(inventoryDisplayList)
    table.clear(inventoryDataByLabel)

    if not (Replion and ItemUtility and ItemStringUtility) then
        warn("[Trade] Replion / ItemUtility / ItemStringUtility tidak ditemukan")
        return
    end

    local dataReplion = Replion.Client:WaitReplion("Data")
    if not dataReplion then
        warn("[Trade] DataReplion nil")
        return
    end

    local items = dataReplion:Get({ "Inventory", "Items" }) or {}
    if not items then return end

    -- group per nama dinamis
    local grouped = {}     -- [name] = { count = n, uuids = { .. } }

    for _, inv in ipairs(items) do
        local base = ItemUtility:GetItemData(inv.Id)
        if base and base.Data then
            local typ = base.Data.Type

            -- hanya Fish & Enchant Stones seperti script asli
            if typ == "Fish" or typ == "Enchant Stones" then
                -- opsi: skip favorit
                if not (Trade.SkipFavorited and inv.Favorited) then
                    local dynName = ItemStringUtility.GetItemName(inv, base)

                    if not grouped[dynName] then
                        grouped[dynName] = { count = 0, uuids = {} }
                    end
                    grouped[dynName].count = grouped[dynName].count + 1
                    table.insert(grouped[dynName].uuids, inv.UUID)
                end
            end
        end
    end

    -- jadikan label seperti ThanHub: "Name (Qty : X)"
    for name, data in pairs(grouped) do
        local label = string.format("%s (Qty : %d)", name, data.count)
        table.insert(inventoryDisplayList, label)
        inventoryDataByLabel[label] = {
            name     = name,
            uuids    = data.uuids,
            selected = false,
        }
    end

    table.sort(inventoryDisplayList)

    if DD_Items and DD_Items.SetOptions then
        DD_Items:SetOptions(inventoryDisplayList)
    end
end

------------------------------------------------------------
-- AUTO GIVE LOOP
------------------------------------------------------------
local function startAutoGiveLoop()
    if Trade.Thread or not Trade.AutoGive then return end

    Trade.Thread = task.spawn(function()
        while Trade.AutoGive do
            -- butuh player + minimal 1 item ter-select
            if not Trade.TargetPlayer then
                task.wait(1)
                continue
            end

            local targetPlayer = Players:FindFirstChild(Trade.TargetPlayer)
            if not targetPlayer then
                task.wait(1)
                continue
            end

            -- cari label yang selected dan masih punya uuid
            local chosenLabel, chosenData
            for label, data in pairs(inventoryDataByLabel) do
                if data.selected and data.uuids and #data.uuids > 0 then
                    chosenLabel = label
                    chosenData  = data
                    break
                end
            end

            if not chosenLabel then
                -- tidak ada item yang dipilih / habis
                task.wait(1.5)
                continue
            end

            local uuid = table.remove(chosenData.uuids) -- ambil 1
            if not uuid then
                task.wait(0.5)
                continue
            end

            local ok, res = pcall(function()
                return RF_InitiateTrade:InvokeServer(targetPlayer.UserId, uuid)
            end)

            if ok then
                print("[Trade] Sent", chosenData.name, "â†’", targetPlayer.Name, "| UUID:", uuid)
            else
                warn("[Trade] Gagal trade:", chosenData.name, "err:", res)
            end

            -- kecilkan qty di label (visual saja)
            local newCount = math.max(0, (#chosenData.uuids))
            -- (biarkan teks label di dropdown tetap, nanti beres saat refresh backpack)

            task.wait(4) -- delay antar trade, jangan spam server
        end

        Trade.Thread = nil
    end)
end

------------------------------------------------------------
-- AUTO ACCEPT TRADE (opsional)
------------------------------------------------------------
RF_AwaitTradeResponse.OnClientInvoke = function(itemType, itemData, sender)
    if Trade.AutoAccept then
        print("[Trade] Auto accept trade dari:", tostring(sender))
        return true
    end
    return false
end

------------------------------------------------------------
-- UI: TAB TRADE
------------------------------------------------------------
local TabTrade = win:CreateTab("Trade")

TabTrade:Label("Trade Status: gunakan Auto Give untuk mass trade.")
TabTrade:Label("Select Fish from Backpack (unfavorited only jika opsi aktif).")

-- Toggle: Skip Favorited
TabTrade:Toggle("Skip Favorited (jangan kirim yang di-favorite)", function(state)
    Trade.SkipFavorited = state
    refreshInventoryForTrade()
end):Set(true) -- default ON

-- Dropdown item (Multi, mirip gambar 2: daftar nama + Qty)
DD_Items = TabTrade:MultiDropdown("Backpack Items", {}, function(label, state)
    local data = inventoryDataByLabel[label]
    if data then
        data.selected = state and true or false
    end
end)

-- Tombol refresh backpack
TabTrade:Button("Refresh Backpack", function()
    refreshInventoryForTrade()
end)

-- Dropdown pilih player
DD_Player = TabTrade:Dropdown("Select Target Player", getPlayerList(), function(name)
    Trade.TargetPlayer = name
    print("[Trade] Target player set ke:", tostring(name))
end)

-- Toggle Auto Give
TabTrade:Toggle("Auto Give Selected Items", function(state)
    Trade.AutoGive = state
    if state then
        startAutoGiveLoop()
    end
end)

-- Toggle Auto Accept incoming trades
TabTrade:Toggle("Auto Accept Incoming Trades", function(state)
    Trade.AutoAccept = state
end)

-- inisialisasi awal
task.defer(function()
    refreshPlayerDropdown()
    refreshInventoryForTrade()
end)





    


-- sleitnick/net
local netIndex = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")

local net = netIndex:WaitForChild("net")

-- FARM REMOTES
local RE_ObtainedNewFish  = net:WaitForChild("RE/ObtainedNewFishNotification")
local RE_FavoriteItem     = net:WaitForChild("RE/FavoriteItem")
local RF_SellAllItems     = net:WaitForChild("RF/SellAllItems")
local RF_PurchaseWeather  = net:WaitForChild("RF/PurchaseWeatherEvent")
local RE_ActivateEnchant  = net:WaitForChild("RE/ActivateEnchantingAltar")
local RE_EquipHotbar      = net:WaitForChild("RE/EquipToolFromHotbar")

----------------------------------------------------------------
-- TAB FARM (MAIN)
----------------------------------------------------------------
local TabFarm  = win:CreateTab("Farm")

----------------------------------------------------------------
-- STATE FARM
----------------------------------------------------------------
local Farm = {
    AutoFavoriteEnabled = false,
    FavoriteRarity = {
        COMMON=true, UNCOMMON=false, RARE=false, EPIC=false,
        LEGENDARY=false, MYTHIC=false, SECRET=false,
    },

    AutoSellEnabled  = false,
    AutoSellThreshold = 30,
    AutoSellDelay     = 1.0,

    AutoWeatherEnabled = false,
    AutoWeatherList = {
        ["Storm"]=false, ["Cloudy"]=false, ["Snow"]=false,
        ["Wind"]=false, ["Radiant"]=false, ["Shark Hunt"]=false,
    },

    AutoEnchant_LastRun = 0,
}

----------------------------------------------------------------
-- BUILD RARITY MAP (FishId â†’ Rarity)
----------------------------------------------------------------
local FishIdToRarity = {}
local tierToRarity = {
    [1]="COMMON",[2]="UNCOMMON",[3]="RARE",
    [4]="EPIC",[5]="LEGENDARY",[6]="MYTHIC",[7]="SECRET"
}

local itemsFolder = ReplicatedStorage:FindFirstChild("Items")
if itemsFolder then
    for _,module in ipairs(itemsFolder:GetChildren()) do
        if module:IsA("ModuleScript") then
            local ok,data = pcall(require,module)
            if ok and data and data.Data and data.Data.Type=="Fish" then
                local id   = data.Data.Id
                local tier = tonumber(data.Data.Tier) or 0
                local rar  = data.Data.Rarity or tierToRarity[tier]
                if id then
                    FishIdToRarity[id] = string.upper(rar or "COMMON")
                end
            end
        end
    end
end

----------------------------------------------------------------
-- AUTO FAVORITE + AUTO SELL HANDLER
----------------------------------------------------------------
local autoSellCount     = 0
local autoSellCooldown  = false

RE_ObtainedNewFish.OnClientEvent:Connect(function(itemId, _, info)
    if not info or not info.InventoryItem then return end
    local uuid = info.InventoryItem.UUID
    if not uuid then return end

    -- AUTO FAVORITE
    if Farm.AutoFavoriteEnabled and itemId then
        local rarity = FishIdToRarity[itemId] or "COMMON"
        if Farm.FavoriteRarity[rarity] then
            pcall(function()
                RE_FavoriteItem:FireServer(uuid)
            end)
        end
    end

    -- AUTO SELL ALL
    if Farm.AutoSellEnabled then
        autoSellCount += 1
        if autoSellCount >= Farm.AutoSellThreshold and not autoSellCooldown then
            autoSellCooldown = true
            task.spawn(function()
                pcall(function()
                    RF_SellAllItems:InvokeServer()
                end)
                task.wait(Farm.AutoSellDelay)
                autoSellCount    = 0
                autoSellCooldown = false
            end)
        end
    end
end)

----------------------------------------------------------------
-- WEATHER LOOP
----------------------------------------------------------------
local WeatherThreads = {}

local function randomDelay(min,max)
    return math.random(min*100,max*100)/100
end

local function StartWeatherLoop(weather)
    if WeatherThreads[weather] then return end

    WeatherThreads[weather] = task.spawn(function()
        while Farm.AutoWeatherEnabled and Farm.AutoWeatherList[weather] do
            pcall(function()
                RF_PurchaseWeather:InvokeServer(weather)
            end)

            local dur = 900 + randomDelay(2,6)
            local t0 = tick()
            while tick() - t0 < dur do
                if not (Farm.AutoWeatherEnabled and Farm.AutoWeatherList[weather]) then
                    break
                end
                task.wait(1)
            end
        end
        WeatherThreads[weather] = nil
    end)
end

----------------------------------------------------------------
-- AUTO ENCHANT FUNCTION
----------------------------------------------------------------
local ENCHANT_POS = Vector3.new(3231,-1303,1402)

local function AutoEnchant_Rod()
    local chars = Workspace:FindFirstChild("Characters")
    local char = chars and chars:FindFirstChild(LocalPlayer.Name)
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local original = hrp.CFrame
    task.wait(.4)

    hrp.CFrame = CFrame.new(ENCHANT_POS + Vector3.new(0,5,0))
    task.wait(.8)

    pcall(function()
        RE_EquipHotbar:FireServer(5)
        task.wait(.4)
        RE_ActivateEnchant:FireServer()
    end)

    task.wait(6)
    hrp.CFrame = original
end

----------------------------------------------------------------
-- UI â€“ FARM MENU
----------------------------------------------------------------
local farmUI = TabFarm

farmUI:Label("Auto Favorite")

local tgFav = farmUI:Toggle("Enable Auto Favorite", function(v)
    Farm.AutoFavoriteEnabled = v
end)

local rarityList = {"COMMON","UNCOMMON","RARE","EPIC","LEGENDARY","MYTHIC","SECRET"}

local ddFav = farmUI:MultiDropdown("Favorite Rarity", rarityList, function(r, state)
    Farm.FavoriteRarity[r] = state
end)

----------------------------------------------------------------
farmUI:Label("Auto Sell (Sell All)")

farmUI:Dropdown("Sell Mode", {
    "Off","10 Fish","20 Fish","30 Fish","50 Fish"
}, function(opt)
    if opt=="Off" then
        Farm.AutoSellEnabled=false
        autoSellCount=0
    else
        Farm.AutoSellEnabled=true
        local n = tonumber(opt:match("(%d+)"))
        Farm.AutoSellThreshold = n or 30
    end
end)

farmUI:Box("Sell Delay (seconds)", function(txt)
    local n = tonumber(txt)
    if n then Farm.AutoSellDelay = n end
end)

----------------------------------------------------------------
TabShop:Label("Auto Weather (Multi Select)")

TabShop:Toggle("Enable Auto Weather", function(v)
    Farm.AutoWeatherEnabled = v
    if v then
        for name,flag in pairs(Farm.AutoWeatherList) do
            if flag then StartWeatherLoop(name) end
        end
    end
end)

local weatherList = {"Storm","Cloudy","Snow","Wind","Radiant","Shark Hunt"}
local ddWeather = TabShop:MultiDropdown("Weather List", weatherList, function(opt,state)
    Farm.AutoWeatherList[opt] = state
    if state and Farm.AutoWeatherEnabled then
        StartWeatherLoop(opt)
    end
end)

----------------------------------------------------------------
farmUI:Label("Auto Enchant")

farmUI:Dropdown("Enchant Action", {
    "Idle",
    "Run Enchant Now"
}, function(opt)
    if opt=="Run Enchant Now" then
        if tick() - Farm.AutoEnchant_LastRun < 5 then return end
        Farm.AutoEnchant_LastRun = tick()
        AutoEnchant_Rod()
    end
end)

----------------------------------------------------------------
-- PART 3 â€” TELEPORT + MISC + FPS / PING OVERLAY
----------------------------------------------------------------

local Lighting     = game:GetService("Lighting")
local VirtualUser  = game:GetService("VirtualUser")
local RunService   = game:GetService("RunService")
local Stats        = game:GetService("Stats")

------------------------------------------------------------
-- TELEPORT
------------------------------------------------------------
local function tpTo(pos)
    if not pos then return end
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if hrp then
        hrp.CFrame = CFrame.new(pos + Vector3.new(0,5,0))
    end
end

local TabTP = win:CreateTab("Teleport")

TabTP:Label("Teleport to Island")

local islands = {
    ["Fisherman Island"] = Vector3.new(128.62, 3.53, 2783.18),
    ["Kohana"] = Vector3.new(-663.904236, 3.04580712, 718.796875),
    ["Kohana Volcano"] = Vector3.new(-572.879456, 22.4521465, 148.355331),
    ["Lost Isle"] = Vector3.new(-3618.15698, 240.836655, -1317.45801), 
    ["Sisyphus Statue"] = Vector3.new(-3727.16, -135.07, -1014.40),
    ["Treasure Room"] = Vector3.new(-3606.34985, -266.57373, -1580.97339),    
    ["Esoteric Depths"] = Vector3.new(3248.37109, -1301.53027, 1403.82727),    
    ["Coral Reefs"] = Vector3.new(-3114.78198, 1.32066584, 2237.52295), 
    ["Crater Island"] = Vector3.new(987.96, 3.30, 5148.49), 
    ["Tropical Grove"] = Vector3.new(-2095.34106, 197.199997, 3718.08008), 
    ["Weather Machine"] = Vector3.new(-1488.51196, 83.1732635, 1876.30298),
    ["Underground Cellar"] = Vector3.new(2135.89, -91.20, -698.50),     
    ["Ancient Jungle"] = Vector3.new(1483.11, 11.14, -300.08), 
    ["Sacred Temple"] = Vector3.new(1506.53, -22.13, -640.17), 
    ["Ancient Ruin"] = Vector3.new(6040.64, -578.44, 4715.02), 
    ["Crystalline Passage"] = Vector3.new(6049.71, -538.90, 4385.69), 
    ["Arrow Artifact"] = Vector3.new(881.40, 6.34, -346.27),     
    ["Crescent Artifact"] = Vector3.new(1404.67, 5.08, 120.55),     
    ["Diamond Artifact"] = Vector3.new(1841.52, 2.76, -300.38),  
    ["Hourglass Diamond Artifact"] = Vector3.new(1466.40, 3.19, -846.62),  
}

local islandList = {}
for name in pairs(islands) do table.insert(islandList,name) end
table.sort(islandList)

local ddIsland = TabTP:Dropdown("Select Island", islandList, function(opt)
    tpTo(islands[opt])
end)

------------------------------------------------------------
-- TELEPORT NPC  (scan workspace, pilih NPC terdekat)
------------------------------------------------------------
TabTP:Label("Teleport to NPC")

-- Scan semua Model yang:
--  - BUKAN karakter player
--  - Punya Humanoid ATAU punya ProximityPrompt di dalamnya
local function scanNPC_Models()
    local found = {}
    for _, m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and #m.Name >= 3 then
            -- abaikan karakter player
            if Players:GetPlayerFromCharacter(m) == nil then
                local hasHumanoid = m:FindFirstChildOfClass("Humanoid") ~= nil
                local hasPrompt = false

                if not hasHumanoid then
                    for _, d in ipairs(m:GetDescendants()) do
                        if d:IsA("ProximityPrompt") then
                            hasPrompt = true
                            break
                        end
                    end
                end

                if hasHumanoid or hasPrompt then
                    found[m.Name] = true
                end
            end
        end
    end

    local list = {}
    for name in pairs(found) do
        table.insert(list, name)
    end
    table.sort(list)
    return list
end

local npcList    = scanNPC_Models()
local currentNPC = npcList[1]

-- Dropdown pakai UI AegisHub Compact (Single select)
local ddNPC = TabTP:Dropdown("NPC List", npcList, function(nm)
    currentNPC = nm
    if not nm or nm == "" then return end

    local me   = Players.LocalPlayer
    local ch   = me and (me.Character or me.CharacterAdded:Wait())
    local hrp  = ch and ch:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    -- cari instance NPC terdekat yang namanya mengandung teks yg dipilih
    local best, dist
    local targetLower = string.lower(nm)
    for _, m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and Players:GetPlayerFromCharacter(m) == nil then
            if string.find(string.lower(m.Name), targetLower, 1, true) then
                local p = m:FindFirstChild("HumanoidRootPart") 
                       or m.PrimaryPart 
                       or m:FindFirstChildWhichIsA("BasePart")
                if p then
                    local d = (p.Position - hrp.Position).Magnitude
                    if not dist or d < dist then
                        best  = p
                        dist  = d
                    end
                end
            end
        end
    end

    if best then
        tpTo(best.Position)
    end
end)

-- set default value di dropdown kalau ada NPC
if currentNPC and ddNPC and ddNPC.Set then
    ddNPC:Set(currentNPC)
end

-- OPTIONAL: auto-refresh daftar NPC setiap beberapa detik TANPA bikin dropdown baru
task.spawn(function()
    while true do
        task.wait(8)
        if ddNPC and ddNPC.SetOptions then
            local newList = scanNPC_Models()
            ddNPC:SetOptions(newList)
        end
    end
end)


------------------------------------------------------------
-- TELEPORT PLAYER
------------------------------------------------------------
TabTP:Label("Teleport to Player")

local function playerList()
    local t={}
    for _,p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then table.insert(t,p.Name) end
    end
    table.sort(t)
    return t
end

local ddPlayer = TabTP:Dropdown("Choose Player", playerList(), function(name)
    local pl = Players:FindFirstChild(name)
    if pl and pl.Character and pl.Character:FindFirstChild("HumanoidRootPart") then
        tpTo(pl.Character.HumanoidRootPart.Position)
    end
end)

------------------------------------------------------------
-- AUTO REFRESH NPC & PLAYER LIST (TANPA BUAT DROPDOWN BARU)
------------------------------------------------------------
task.spawn(function()
    while true do
        task.wait(8)
        local newNPC = scanNPC()
        ddNPC:SetOptions(newNPC)

        local newPL = playerList()
        ddPlayer:SetOptions(newPL)
    end
end)

Players.PlayerAdded:Connect(function()
    ddPlayer:SetOptions(playerList())
end)
Players.PlayerRemoving:Connect(function()
    ddPlayer:SetOptions(playerList())
end)



                

------------------------------------------------------------
-- MISC TAB
------------------------------------------------------------
local TabMisc = win:CreateTab("Misc")

TabMisc:Label("Anti AFK")
local AntiAFKConn

TabMisc:Toggle("Enable Anti AFK", function(state)
    if state then
        if AntiAFKConn then AntiAFKConn:Disconnect() end
        AntiAFKConn = LocalPlayer.Idled:Connect(function()
            VirtualUser:Button2Down(Vector2.new(), Workspace.CurrentCamera.CFrame)
            task.wait(0.6)
            VirtualUser:Button2Up(Vector2.new(), Workspace.CurrentCamera.CFrame)
        end)
    else
        if AntiAFKConn then AntiAFKConn:Disconnect() AntiAFKConn=nil end
    end
end)

------------------------------------------------------------
-- FPS BOOST
------------------------------------------------------------
TabMisc:Label("FPS Boost System")

local Misc = {
    HideTextures = false,
    SmoothParts  = false,
    NoLighting   = false,
    NoEffects    = false,
    FPSCap       = 120,
}

local function HideAllTextures()
    for _,v in ipairs(game:GetDescendants()) do
        if v:IsA("Decal") or v:IsA("Texture") then
            v.Transparency = 1
        end
    end
end

local function ApplySmoothPlastic()
    for _,v in ipairs(game:GetDescendants()) do
        if v:IsA("BasePart") then
            v.Material = Enum.Material.SmoothPlastic
        end
    end
end

local function ApplyNoLighting()
    Lighting.GlobalShadows = false
    Lighting.FogEnd = 1e10
    Lighting.Brightness = 1
end

local function RemoveEffects()
    for _,v in ipairs(game:GetDescendants()) do
        if v:IsA("ParticleEmitter")
        or v:IsA("Beam")
        or v:IsA("Trail")
        or v:IsA("Smoke")
        or v:IsA("Fire")
        or v:IsA("Sparkles") then
            v.Enabled = false
        end
    end
end

TabMisc:Toggle("Hide Textures", function(v)
    Misc.HideTextures = v
    if v then HideAllTextures() end
end)

TabMisc:Toggle("Smooth Plastic", function(v)
    Misc.SmoothParts = v
    if v then ApplySmoothPlastic() end
end)

TabMisc:Toggle("No Lighting", function(v)
    Misc.NoLighting = v
    if v then ApplyNoLighting() end
end)

TabMisc:Toggle("Disable Effects", function(v)
    Misc.NoEffects = v
    if v then RemoveEffects() end
end)

------------------------------------------------------------
-- FPS CAP
------------------------------------------------------------
TabMisc:Label("FPS Cap")
TabMisc:Slider("Set FPS Cap", 30, 300, 120, function(v)
    Misc.FPSCap = v
    if setfpscap then
        setfpscap(v)
    end
end)

------------------------------------------------------------
-- FPS / PING OVERLAY (TOP SCREEN)
------------------------------------------------------------
TabMisc:Label("Stats Overlay")

local function CreateOverlay()
    local gui = Instance.new("ScreenGui")
    gui.Name = "StatsOverlay_Aegis"
    gui.Parent = CoreGui

    local label = Instance.new("TextLabel")
    label.Parent = gui
    label.BackgroundTransparency = 1
    label.Position = UDim2.new(0,8,0,6)
    label.Size = UDim2.new(0,260,0,20)
    label.Font = Enum.Font.Code
    label.TextSize = 14
    label.TextColor3 = Color3.new(1,1,1)
    label.TextXAlignment = Enum.TextXAlignment.Left

    local fpsAvg = 0
    local alpha = 0.18

    RunService.RenderStepped:Connect(function(dt)
        local fps = 1/math.max(dt,1/1000)
        fpsAvg = fpsAvg + (fps - fpsAvg)*alpha

        local ping = 0
        pcall(function()
            local s = Stats.Network.ServerStatsItem["Data Ping"]:GetValueString()
            ping = tonumber(string.match(s,"(%d+)")) or 0
        end)

        label.Text = string.format("FPS: %d | Ping: %dms", fpsAvg, ping)
    end)

    return gui
end

local OverlayObj = nil

TabMisc:Toggle("Enable Stats Overlay", function(v)
    if v then
        if not OverlayObj then
            OverlayObj = CreateOverlay()
        end
    else
        if OverlayObj then
            OverlayObj:Destroy()
            OverlayObj = nil
        end
    end
end)
