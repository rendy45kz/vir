----------------------------------------------------------------
-- AegisHub UI â€“ Compact Gamer UI (smaller + new elegant theme)
----------------------------------------------------------------
if not game:IsLoaded() then game.Loaded:Wait() end

local TweenService     = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local CoreGui          = game:GetService("CoreGui")

local library = {}

-- Tema baru: sedikit lebih terang & kalem
local theme = {
    bg     = Color3.fromRGB(14, 16, 24),   -- background utama
    card   = Color3.fromRGB(24, 26, 36),   -- panel / kartu
    stroke = Color3.fromRGB(60, 70, 100),  -- garis luar
    text   = Color3.fromRGB(235, 239, 255),
    accent = Color3.fromRGB(140, 190, 255), -- biru lembut
}

local function tween(obj, dur, props)
    return TweenService:Create(obj, TweenInfo.new(dur, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), props)
end

--------------------------------------------------------------------------------
-- MAIN WINDOW
--------------------------------------------------------------------------------
function library:CreateWindow(title)
    local gui = Instance.new("ScreenGui")
    gui.Name = "AegisHubCompact"
    gui.Parent = CoreGui
    gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling

    -- main window (diperkecil)
    local main = Instance.new("Frame")
    main.Parent = gui
    main.Size = UDim2.new(0, 460, 0, 300)             -- dulu 520 x 340
    main.Position = UDim2.new(.5, -230, .5, -150)
    main.BackgroundColor3 = theme.bg
    main.BorderSizePixel = 0

    local stroke = Instance.new("UIStroke", main)
    stroke.Thickness = 1
    stroke.Color = theme.stroke

    local cornerMain = Instance.new("UICorner", main)
    cornerMain.CornerRadius = UDim.new(0, 6)

    -- draggable overlay toggle (bulat kecil di samping)
    local overlayBtn = Instance.new("TextButton")
    overlayBtn.Parent = gui
    overlayBtn.Size = UDim2.new(0, 30, 0, 30)
    overlayBtn.Position = UDim2.new(0, 12, 0.5, -15)
    overlayBtn.Text = "â‰¡"
    overlayBtn.Font = Enum.Font.GothamBold
    overlayBtn.TextSize = 16
    overlayBtn.TextColor3 = theme.text
    overlayBtn.BackgroundColor3 = theme.card
    overlayBtn.BorderSizePixel = 0
    overlayBtn.Visible = false

    local ovCorner = Instance.new("UICorner", overlayBtn)
    ovCorner.CornerRadius = UDim.new(1, 0)

    do -- drag overlay
        local dragging, start, offset
        overlayBtn.InputBegan:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1
               or i.UserInputType == Enum.UserInputType.Touch then
                dragging = true
                start    = i.Position
                offset   = overlayBtn.Position
                i.Changed:Connect(function()
                    if i.UserInputState == Enum.UserInputState.End then
                        dragging = false
                    end
                end)
            end
        end)
        UserInputService.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement
                or i.UserInputType == Enum.UserInputType.Touch) then
                local d = i.Position - start
                overlayBtn.Position = UDim2.new(
                    offset.X.Scale, offset.X.Offset + d.X,
                    offset.Y.Scale, offset.Y.Offset + d.Y
                )
            end
        end)
    end

    overlayBtn.MouseButton1Click:Connect(function()
        main.Visible = true
        overlayBtn.Visible = false
    end)

    -- title bar
    local top = Instance.new("Frame")
    top.Parent = main
    top.Size = UDim2.new(1,0,0,30)                 -- sedikit lebih tipis
    top.BackgroundColor3 = theme.card
    top.BorderSizePixel = 0
    local topCorner = Instance.new("UICorner", top)
    topCorner.CornerRadius = UDim.new(0, 6)

    local tlabel = Instance.new("TextLabel")
    tlabel.Parent = top
    tlabel.Size = UDim2.new(1,-80,1,0)
    tlabel.Position = UDim2.new(0,10,0,0)
    tlabel.BackgroundTransparency = 1
    tlabel.Text = tostring(title)
    tlabel.TextXAlignment = Enum.TextXAlignment.Left
    tlabel.Font = Enum.Font.GothamMedium
    tlabel.TextSize = 15
    tlabel.TextColor3 = theme.text

    -- minimize button
    local mini = Instance.new("TextButton")
    mini.Parent = top
    mini.Size = UDim2.new(0,22,1,0)
    mini.Position = UDim2.new(1,-62,0,0)
    mini.Text = "-"
    mini.TextColor3 = Color3.fromRGB(210,210,210)
    mini.BackgroundTransparency = 1
    mini.Font = Enum.Font.GothamBold
    mini.TextSize = 16

    mini.MouseButton1Click:Connect(function()
        main.Visible = false
        overlayBtn.Visible = true
    end)

    -- close button
    local close = Instance.new("TextButton")
    close.Parent = top
    close.Size = UDim2.new(0,36,1,0)
    close.Position = UDim2.new(1,-36,0,0)
    close.Text = "X"
    close.TextColor3 = Color3.fromRGB(255,80,80)
    close.BackgroundTransparency = 1
    close.Font = Enum.Font.GothamBold
    close.TextSize = 16

    close.MouseButton1Click:Connect(function()
        gui:Destroy()
    end)

    ---------------------------
    -- DRAGGING THE WINDOW
    ---------------------------
    do
        local dragging, start, offset
        top.InputBegan:Connect(function(i)
            if i.UserInputType == Enum.UserInputType.MouseButton1
               or i.UserInputType == Enum.UserInputType.Touch then
                dragging = true
                start    = i.Position
                offset   = main.Position
                i.Changed:Connect(function()
                    if i.UserInputState == Enum.UserInputState.End then
                        dragging = false
                    end
                end)
            end
        end)
        UserInputService.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement
                or i.UserInputType == Enum.UserInputType.Touch) then
                local d = i.Position - start
                main.Position = UDim2.new(
                    offset.X.Scale, offset.X.Offset + d.X,
                    offset.Y.Scale, offset.Y.Offset + d.Y
                )
            end
        end)
    end

    ------------------------------------------
    -- LEFT SIDE TAB LIST
    ------------------------------------------
    local sidebar = Instance.new("Frame")
    sidebar.Parent = main
    sidebar.Size = UDim2.new(0,150,1,-30)      -- sedikit lebih kecil
    sidebar.Position = UDim2.new(0,0,0,30)
    sidebar.BackgroundColor3 = theme.card
    sidebar.BorderSizePixel = 0
    local sideCorner = Instance.new("UICorner", sidebar)
    sideCorner.CornerRadius = UDim.new(0, 6)

    local slist = Instance.new("UIListLayout", sidebar)
    slist.SortOrder = Enum.SortOrder.LayoutOrder
    slist.Padding = UDim.new(0,6)
    slist.HorizontalAlignment = Enum.HorizontalAlignment.Center

    ------------------------------------------
    -- RIGHT SIDE PAGE HOLDER
    ------------------------------------------
    local holder = Instance.new("Frame")
    holder.Parent = main
    holder.Size = UDim2.new(1,-150,1,-30)
    holder.Position = UDim2.new(0,150,0,30)
    holder.BackgroundTransparency = 1

    ---------------------------------------------------------------------
    -- TAB CREATOR
    ---------------------------------------------------------------------
    local win = {}

    function win:CreateTab(name)
        local tabBtn = Instance.new("TextButton")
        tabBtn.Parent = sidebar
        tabBtn.Size = UDim2.new(1,-12,0,28)
        tabBtn.BackgroundColor3 = theme.bg
        tabBtn.BorderSizePixel = 0
        tabBtn.Text = name
        tabBtn.Font = Enum.Font.Gotham
        tabBtn.TextSize = 13
        tabBtn.TextColor3 = theme.text

        local tabCorner = Instance.new("UICorner", tabBtn)
        tabCorner.CornerRadius = UDim.new(0, 4)

        local tabStroke = Instance.new("UIStroke", tabBtn)
        tabStroke.Thickness = 1
        tabStroke.Color = theme.stroke

        local page = Instance.new("ScrollingFrame")
        page.Parent = holder
        page.Size = UDim2.new(1,0,1,0)
        page.BackgroundTransparency = 1
        page.ScrollBarThickness = 3
        page.Visible = false
        page.AutomaticCanvasSize = Enum.AutomaticSize.Y

        local plist = Instance.new("UIListLayout", page)
        plist.SortOrder = Enum.SortOrder.LayoutOrder
        plist.Padding = UDim.new(0,6)
        local pad = Instance.new("UIPadding", page)
        pad.PaddingTop = UDim.new(0,6)
        pad.PaddingLeft = UDim.new(0,6)
        pad.PaddingRight = UDim.new(0,6)

        -- select tab
        tabBtn.MouseButton1Click:Connect(function()
            for _,pg in ipairs(holder:GetChildren()) do
                if pg:IsA("ScrollingFrame") then pg.Visible=false end
            end
            page.Visible = true
        end)

        -- first tab auto-selected
        local numPages = 0
        for _,pg in ipairs(holder:GetChildren()) do
            if pg:IsA("ScrollingFrame") then numPages = numPages + 1 end
        end
        if numPages == 1 then
            page.Visible = true
        end

        ------------------------------------------------------------
        -- COMPONENT API
        ------------------------------------------------------------
        local api = {}

        ---------------------
        -- Label
        ---------------------
                ---------------------
        -- Label  (sekarang return instance)
        ---------------------
        function api:Label(text)
            local lbl = Instance.new("TextLabel")
            lbl.Parent = page
            lbl.Size = UDim2.new(1,-4,0,20)
            lbl.BackgroundTransparency = 1
            lbl.Text = text
            lbl.Font = Enum.Font.GothamBold
            lbl.TextSize = 14
            lbl.TextColor3 = theme.text
            lbl.TextXAlignment = Enum.TextXAlignment.Left

            -- boleh diabaikan kalau nggak dipakai
            return lbl
        end

        ---------------------
        -- TextBox
        ---------------------
        function api:Box(placeholder, callback)
            callback = callback or function() end

            local fr = Instance.new("Frame")
            fr.Parent = page
            fr.Size = UDim2.new(1,-4,0,32)
            fr.BackgroundColor3 = theme.card
            fr.BorderSizePixel = 0

            local box = Instance.new("TextBox")
            box.Parent = fr
            box.PlaceholderText = placeholder
            box.Text = ""
            box.Size = UDim2.new(1,-12,1,-6)
            box.Position = UDim2.new(0,6,0,3)
            box.BackgroundColor3 = theme.bg
            box.BorderSizePixel = 0
            box.Font = Enum.Font.Gotham
            box.TextSize = 13
            box.TextColor3 = theme.text

            box.FocusLost:Connect(function()
                callback(box.Text)
            end)

            return {
                Set = function(_,v)
                    box.Text = v
                end,
                Get = function()
                    return box.Text
                end,
                Object = box
            }
        end

        ---------------------
        -- Toggle
        ---------------------
        function api:Toggle(text, callback)
            callback = callback or function() end
            
            local fr = Instance.new("Frame")
            fr.Parent = page
            fr.Size = UDim2.new(1,-4,0,26)
            fr.BackgroundColor3 = theme.card
            fr.BorderSizePixel = 0
            local frCorner = Instance.new("UICorner", fr)
            frCorner.CornerRadius = UDim.new(0,4)

            local lbl = Instance.new("TextLabel")
            lbl.Parent = fr
            lbl.Size = UDim2.new(1,-40,1,0)
            lbl.Position = UDim2.new(0,8,0,0)
            lbl.BackgroundTransparency = 1
            lbl.Text = text
            lbl.TextColor3 = theme.text
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.Font = Enum.Font.Gotham
            lbl.TextSize = 12

            local btn = Instance.new("Frame")
            btn.Parent = fr
            btn.Size = UDim2.new(0,20,0,20)
            btn.Position = UDim2.new(1,-26,0.5,-10)
            btn.BackgroundColor3 = theme.bg
            btn.BorderSizePixel = 0
            local btnCorner = Instance.new("UICorner", btn)
            btnCorner.CornerRadius = UDim.new(0,4)

            local tick = Instance.new("TextLabel", btn)
            tick.Size = UDim2.new(1,0,1,0)
            tick.BackgroundTransparency = 1
            tick.Font = Enum.Font.GothamBold
            tick.Text = ""
            tick.TextColor3 = theme.accent
            tick.TextSize = 14

            local click = Instance.new("TextButton")
            click.Parent = fr
            click.Size = UDim2.new(1,0,1,0)
            click.BackgroundTransparency = 1
            click.Text = ""

            local state = false
            local function apply()
                tick.Text = state and "âœ“" or ""
                callback(state)
            end
            click.MouseButton1Click:Connect(function()
                state = not state
                apply()
            end)

            return {
                Set = function(_,v)
                    state = v and true or false
                    apply()
                end
            }
        end

        ---------------------
        -- Slider
        ---------------------
        function api:Slider(text, min, max, default, callback)
            callback = callback or function() end
            min = min or 0
            max = max or 100
            default = default or min

            local fr = Instance.new("Frame")
            fr.Parent = page
            fr.Size = UDim2.new(1,-4,0,34)
            fr.BackgroundColor3 = theme.card
            fr.BorderSizePixel = 0
            local frCorner = Instance.new("UICorner", fr)
            frCorner.CornerRadius = UDim.new(0,4)

            local lbl = Instance.new("TextLabel")
            lbl.Parent = fr
            lbl.Text = text
            lbl.Size = UDim2.new(1,-8,0,16)
            lbl.Position = UDim2.new(0,8,0,0)
            lbl.BackgroundTransparency = 1
            lbl.TextColor3 = theme.text
            lbl.Font = Enum.Font.Gotham
            lbl.TextSize = 12
            lbl.TextXAlignment = Enum.TextXAlignment.Left

            local bar = Instance.new("Frame", fr)
            bar.Size = UDim2.new(1,-16,0,5)
            bar.Position = UDim2.new(0,8,0,20)
            bar.BackgroundColor3 = theme.bg
            bar.BorderSizePixel = 0
            local barCorner = Instance.new("UICorner", bar)
            barCorner.CornerRadius = UDim.new(0,4)

            local fill = Instance.new("Frame", bar)
            fill.Size = UDim2.new(0,0,1,0)
            fill.BackgroundColor3 = theme.accent
            fill.BorderSizePixel = 0
            local fillCorner = Instance.new("UICorner", fill)
            fillCorner.CornerRadius = UDim.new(0,4)

            local dragging = false
            local value = default

            local function setFromPct(pct)
                pct = math.clamp(pct,0,1)
                value = math.floor(min + pct*(max-min))
                fill.Size = UDim2.new(pct,0,1,0)
                callback(value)
            end

            local function update(px)
                local pct = (px - bar.AbsolutePosition.X) / bar.AbsoluteSize.X
                setFromPct(pct)
            end

            bar.InputBegan:Connect(function(i)
                if i.UserInputType == Enum.UserInputType.MouseButton1 
                or i.UserInputType == Enum.UserInputType.Touch then
                    dragging = true
                    update(i.Position.X)
                end
            end)
            bar.InputEnded:Connect(function(i)
                if i.UserInputType == Enum.UserInputType.MouseButton1 
                or i.UserInputType == Enum.UserInputType.Touch then
                    dragging = false
                end
            end)

            UserInputService.InputChanged:Connect(function(i)
                if dragging and (i.UserInputType == Enum.UserInputType.MouseMovement
                    or i.UserInputType == Enum.UserInputType.Touch) then
                    update(i.Position.X)
                end
            end)

            setFromPct((default-min)/(max-min))

            return {
                Set = function(_, v)
                    v = math.clamp(v or value, min, max)
                    setFromPct((v-min)/(max-min))
                end
            }
        end

        ---------------------
        -- TextBox
        ---------------------
        function api:Box(placeholder, callback)
            callback = callback or function() end

            local fr = Instance.new("Frame")
            fr.Parent = page
            fr.Size = UDim2.new(1,-4,0,30)
            fr.BackgroundColor3 = theme.card
            fr.BorderSizePixel = 0
            local frCorner = Instance.new("UICorner", fr)
            frCorner.CornerRadius = UDim.new(0,4)

            local box = Instance.new("TextBox")
            box.Parent = fr
            box.PlaceholderText = placeholder
            box.Text = ""
            box.Size = UDim2.new(1,-12,1,-6)
            box.Position = UDim2.new(0,6,0,3)
            box.BackgroundColor3 = theme.bg
            box.BorderSizePixel = 0
            box.Font = Enum.Font.Gotham
            box.TextSize = 12
            box.TextColor3 = theme.text

            box.FocusLost:Connect(function()
                callback(box.Text)
            end)

            return {
                Set = function(_,v)
                    box.Text = v
                end
            }
        end

        ---------------------
        -- Button
        ---------------------
        function api:Button(text, callback)
            callback = callback or function() end

            local fr = Instance.new("TextButton")
            fr.Parent = page
            fr.Size = UDim2.new(1,-4,0,28)
            fr.BackgroundColor3 = theme.card
            fr.BorderSizePixel = 0
            fr.Text = text
            fr.Font = Enum.Font.GothamSemibold
            fr.TextSize = 13
            fr.TextColor3 = theme.text
            local frCorner = Instance.new("UICorner", fr)
            frCorner.CornerRadius = UDim.new(0,4)

            fr.MouseButton1Click:Connect(callback)
        end

        ---------------------
        -- Dropdown (Single Select)
        ---------------------
        function api:Dropdown(text, list, callback)
            callback = callback or function() end
            list = list or {}
            local selected = nil

            local fr = Instance.new("Frame")
            fr.Parent = page
            fr.Size = UDim2.new(1,-4,0,30)
            fr.AutomaticSize = Enum.AutomaticSize.Y
            fr.BackgroundColor3 = theme.card
            fr.BorderSizePixel = 0
            local frCorner = Instance.new("UICorner", fr)
            frCorner.CornerRadius = UDim.new(0,4)

            local lbl = Instance.new("TextLabel")
            lbl.Parent = fr
            lbl.Size = UDim2.new(1,-30,0,30)
            lbl.Position = UDim2.new(0,8,0,0)
            lbl.BackgroundTransparency = 1
            lbl.Font = Enum.Font.Gotham
            lbl.TextColor3 = theme.text
            lbl.TextSize = 12
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.Text = text

            local arrow = Instance.new("TextLabel")
            arrow.Parent = fr
            arrow.Size = UDim2.new(0,18,0,30)
            arrow.Position = UDim2.new(1,-18,0,0)
            arrow.BackgroundTransparency = 1
            arrow.Text = "v"
            arrow.Font = Enum.Font.GothamBold
            arrow.TextColor3 = theme.accent

            local holder = Instance.new("Frame")
            holder.Parent = fr
            holder.Position = UDim2.new(0,0,0,30)
            holder.Size = UDim2.new(1,0,0,0)
            holder.BackgroundColor3 = theme.bg
            holder.BorderSizePixel = 0
            holder.Visible = false
            holder.AutomaticSize = Enum.AutomaticSize.Y
            local hCorner = Instance.new("UICorner", holder)
            hCorner.CornerRadius = UDim.new(0,4)

            local hlist = Instance.new("UIListLayout", holder)
            hlist.Padding = UDim.new(0,2)

            local open = false
            local headBtn = Instance.new("TextButton")
            headBtn.Parent = fr
            headBtn.Size = UDim2.new(1,0,0,30)
            headBtn.BackgroundTransparency = 1
            headBtn.Text = ""

            local function rebuild(opts)
                for _,c in ipairs(holder:GetChildren()) do
                    if c:IsA("TextButton") then c:Destroy() end
                end
                for _,opt in ipairs(opts) do
                    local b = Instance.new("TextButton")
                    b.Parent = holder
                    b.Size = UDim2.new(1,0,0,24)
                    b.BackgroundColor3 = theme.card
                    b.BorderSizePixel = 0
                    b.Text = opt
                    b.Font = Enum.Font.Gotham
                    b.TextSize = 12
                    b.TextColor3 = theme.text
                    local bc = Instance.new("UICorner", b)
                    bc.CornerRadius = UDim.new(0,4)

                    b.MouseButton1Click:Connect(function()
                        selected = opt
                        lbl.Text = text.." : "..opt
                        holder.Visible = false
                        open = false
                        callback(opt)
                    end)
                end
            end
            rebuild(list)

            headBtn.MouseButton1Click:Connect(function()
                open = not open
                holder.Visible = open
            end)

            return {
                Set = function(_, opt)
                    selected = opt
                    lbl.Text = text.." : "..opt
                end,
                SetOptions = function(_, opts)
                    list = opts or {}
                    rebuild(list)
                end
            }
        end

        ---------------------
        -- LiveLabel (text dinamis, pakai function)
        ---------------------
        function api:LiveLabel(getTextFn, refreshDelay)
            -- getTextFn = function() return "teks..." end
            -- refreshDelay = detik update (default 0.5)
            refreshDelay = refreshDelay or 0.5

            local lbl = Instance.new("TextLabel")
            lbl.Parent = page
            lbl.Size = UDim2.new(1,-4,0,40)
            lbl.AutomaticSize = Enum.AutomaticSize.Y
            lbl.BackgroundTransparency = 1
            lbl.Text = ""
            lbl.Font = Enum.Font.Gotham
            lbl.TextSize = 13
            lbl.TextColor3 = theme.text
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.TextYAlignment = Enum.TextYAlignment.Top
            lbl.TextWrapped = true

            -- loop update teks
            task.spawn(function()
                while lbl.Parent do
                    local ok, txt = pcall(getTextFn)
                    if ok and txt ~= nil then
                        lbl.Text = tostring(txt)
                    end
                    task.wait(refreshDelay)
                end
            end)

            return lbl
        end


        ---------------------
        -- Multi Dropdown
        ---------------------
        function api:MultiDropdown(text, list, callback)
            callback = callback or function() end
            list = list or {}

            local selected = {}

            local fr = Instance.new("Frame")
            fr.Parent = page
            fr.Size = UDim2.new(1,-4,0,32)
            fr.AutomaticSize = Enum.AutomaticSize.Y
            fr.BackgroundColor3 = theme.card
            fr.BorderSizePixel = 0
            local frCorner = Instance.new("UICorner", fr)
            frCorner.CornerRadius = UDim.new(0,4)

            local lbl = Instance.new("TextLabel")
            lbl.Parent = fr
            lbl.Size = UDim2.new(1,-30,0,32)
            lbl.Position = UDim2.new(0,8,0,0)
            lbl.BackgroundTransparency = 1
            lbl.TextColor3 = theme.text
            lbl.Font = Enum.Font.Gotham
            lbl.TextSize = 12
            lbl.TextXAlignment = Enum.TextXAlignment.Left
            lbl.Text = text.." : None"

            local arrow = Instance.new("TextLabel", fr)
            arrow.Size = UDim2.new(0,18,0,32)
            arrow.Position = UDim2.new(1,-18,0,0)
            arrow.Font = Enum.Font.GothamBold
            arrow.TextColor3 = theme.accent
            arrow.Text = "v"
            arrow.BackgroundTransparency = 1

            local holder = Instance.new("Frame", fr)
            holder.Position = UDim2.new(0,0,0,32)
            holder.Size = UDim2.new(1,0,0,0)
            holder.BackgroundColor3 = theme.bg
            holder.Visible = false
            holder.BorderSizePixel = 0
            holder.AutomaticSize = Enum.AutomaticSize.Y
            local hCorner = Instance.new("UICorner", holder)
            hCorner.CornerRadius = UDim.new(0,4)
            local hlist = Instance.new("UIListLayout", holder)
            hlist.Padding = UDim.new(0,2)

            local open = false
            local headBtn = Instance.new("TextButton")
            headBtn.Parent = fr
            headBtn.BackgroundTransparency = 1
            headBtn.Size = UDim2.new(1,0,0,32)
            headBtn.Text = ""

            headBtn.MouseButton1Click:Connect(function()
                open = not open
                holder.Visible = open
            end)

            local function updateText()
                local list2 = {}
                for k,v in pairs(selected) do
                    if v then table.insert(list2,k) end
                end
                table.sort(list2)
                if #list2 == 0 then
                    lbl.Text = text.." : None"
                else
                    lbl.Text = text.." : "..table.concat(list2,", ")
                end
            end

            local function rebuild(opts)
                for _,c in ipairs(holder:GetChildren()) do
                    if c:IsA("TextButton") then c:Destroy() end
                end
                for _,opt in ipairs(opts) do
                    local b = Instance.new("TextButton")
                    b.Parent = holder
                    b.Size = UDim2.new(1,0,0,24)
                    b.BackgroundColor3 = theme.card
                    b.BorderSizePixel = 0
                    b.Text = opt
                    b.Font = Enum.Font.Gotham
                    b.TextSize = 12
                    b.TextColor3 = theme.text
                    local bc = Instance.new("UICorner", b)
                    bc.CornerRadius = UDim.new(0,4)

                    b.MouseButton1Click:Connect(function()
                        selected[opt] = not selected[opt]
                        callback(opt, selected[opt])
                        updateText()
                    end)
                end
                updateText()
            end

            rebuild(list)

            return {
                Set = function(_, opt, state)
                    selected[opt] = state and true or false
                    updateText()
                end,
                List = function()
                    local t={}
                    for k,v in pairs(selected) do if v then table.insert(t,k) end end
                    return t
                end,
                SetOptions = function(_, opts)
                    list = opts or {}
                    rebuild(list)
                end
            }
        end

        return api
    end

    return win
end


----------------------------------------------------------------
-- BUAT WINDOW
----------------------------------------------------------------
local win = library:CreateWindow("AegisHub - Fish It")


------------------------------------------------------------
-- SERVICES & BASE
------------------------------------------------------------
local Players           = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace         = game:GetService("Workspace")

local LocalPlayer       = Players.LocalPlayer

------------------------------------------------------------
-- NET EVENTS (PASTIKAN SAMA PERSIS DENGAN GAME)
------------------------------------------------------------
local netIndex = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")

local net = netIndex:WaitForChild("net")

local Events = {
    completeFish = net:WaitForChild("RE/FishingCompleted"),
    sellAll      = net:WaitForChild("RF/SellAllItems"),

    chargeRod    = net:WaitForChild("RF/ChargeFishingRod"),
    startMini    = net:WaitForChild("RF/RequestFishingMinigameStarted"),
    cancelMini   = net:WaitForChild("RF/CancelFishingInputs"),

    equipHotbar  = net:WaitForChild("RE/EquipToolFromHotbar"),
    unequipTool  = net:WaitForChild("RE/UnequipToolFromHotbar"),

    gotFish      = net:FindFirstChild("RE/ObtainedNewFishNotification"), -- kalau ada
}

------------------------------------------------------------
-- CONFIG
------------------------------------------------------------
local Config = {
    AutoFish        = false,     -- toggle utama
    FishDelayRatio  = "1/3",     -- "1/4", "1/3", "1/2"
    FishDelayOffset = 0.15,      -- tambahan offset (detik)
    CatchDelay      = 0.80,      -- delay sesudah spam complete sebelum loop berikutnya
    PerfectCast     = false,     -- kalau mau tetap random, biar mirip player
}

-- internal state
local loopRunning  = false

------------------------------------------------------------
-- HELPER
------------------------------------------------------------

-- delay kecil random biar nggak terlalu robot banget
local function randomDelay()
    local fpsChoices = {60, 90, 120, 240}
    local fps = fpsChoices[math.random(1, #fpsChoices)]
    return 1 / fps
end

local function getServerTime()
    local ok, t = pcall(function()
        return Workspace:GetServerTimeNow()
    end)
    return ok and t or tick()
end

local function ensureCharacter()
    local char = LocalPlayer.Character
    if not char or not char.Parent then
        char = LocalPlayer.CharacterAdded:Wait()
    end
    return char
end

-- hitung cast power (kalau PerfectCast false, dia agak random)
local function getCastPower()
    if Config.PerfectCast then
        return 0.99
    else
        local min = 0.75
        local max = 0.97
        return min + (max - min) * math.random()
    end
end

-- rumus FISH DELAY:
-- FishDelay = CatchDelay * rasio + offset
local function computeFishDelay()
    local ratio = 1/3
    if Config.FishDelayRatio == "1/4" then
        ratio = 1/4
    elseif Config.FishDelayRatio == "1/2" then
        ratio = 1/2
    end

    local fd = (Config.CatchDelay ) * ratio + (Config.FishDelayOffset)
    -- clamp biar nggak absurd
    if fd < 0.05 then fd = 0.05 end
    return fd
end

------------------------------------------------------------
-- SATU SIKLUS BLATANT (x5 SPEED)
------------------------------------------------------------
local function doOneBlatantCycle()
    local char = ensureCharacter()
    local hrp  = char:FindFirstChild("HumanoidRootPart")
    if not hrp then
        warn("[BlatantFish] HRP not found")
        task.wait(0.005)
        return
    end

    local dSmall  = randomDelay()
    local fishDel = computeFishDelay()
    local catchDel = math.max(Config.CatchDelay)

    ----------------------------------------------------------------
    -- 1) EQUIP ROD SLOT 1
    ----------------------------------------------------------------
    pcall(function()
        Events.equipHotbar:FireServer(1)
    end)
    task.wait(dSmall)

    ----------------------------------------------------------------
    -- 2) CHARGE + START MINIGAME
    ----------------------------------------------------------------
    local castPower = getCastPower()
    local now       = getServerTime()
    local yPos      = hrp.Position.Y - 10

    -- charge rod (boleh Invoke / Fire, tapi di game ini pakai Invoke)
    pcall(function()
        Events.chargeRod:InvokeServer(now)
    end)
    task.wait(0.03)

    -- request minigame
    local okStart, res = pcall(function()
        if typeof(Events.startMini.InvokeServer) == "function" then
            return Events.startMini:InvokeServer(yPos, castPower, getServerTime())
        else
            Events.startMini:FireServer(yPos, castPower, getServerTime())
            return true
        end
    end)

    if not okStart then
        warn("[BlatantFish] StartMini failed:", res)
        task.wait(fishDel)
        return
    end

    ----------------------------------------------------------------
    -- 3) TUNGGU FISH DELAY (BLATANT)
    ----------------------------------------------------------------
    task.wait(fishDel)

    ----------------------------------------------------------------
    -- 4) SPAM COMPLETE x5 (masih halus)
    ----------------------------------------------------------------

    for i = 1, 5 do
        pcall(function()
            Events.completeFish:FireServer()
        end)
        task.wait(catchDel)
    end

    ----------------------------------------------------------------
    -- 5) TUNGGU CATCH DELAY SEBELUM CAST LAGI
    ----------------------------------------------------------------
    task.wait(catchDel)
end

------------------------------------------------------------
-- LOOP UTAMA
------------------------------------------------------------
local function mainFishingLoop()
    if loopRunning then return end
    loopRunning = true
    print("[BlatantFish] loop started")

    while Config.AutoFish do
        local ok, err = pcall(doOneBlatantCycle)
        if not ok then
            warn("[BlatantFish] cycle error:", err)
            task.wait(0.05)
        end
        -- sedikit napas antar cycle
        task.wait(0.01)
    end

    loopRunning = false
    print("[BlatantFish] loop stopped")
end

local Fishing = {}

function Fishing:Start()
    if Config.AutoFish then return end
    Config.AutoFish = true
    task.spawn(mainFishingLoop)
end

function Fishing:Stop()
    Config.AutoFish = false
end

------------------------------------------------------------
-- UI AEGISHUB â€“ TAB AUTO
------------------------------------------------------------
local TabAuto = win:CreateTab("Auto")

TabAuto:Label("Blatant Auto Fishing ðŸŽ£")

-- Toggle utama
TabAuto:Toggle("Enable Blatant Auto Fishing", function(state)
    if state then
        Fishing:Start()
    else
        Fishing:Stop()
    end
end)

-- Rasio FishDelay (1/4, 1/3, 1/2)
TabAuto:Dropdown("FishDelay Ratio (FishDelay / CatchDelay)", {"1/4","1/3","1/2"}, function(opt)
    Config.FishDelayRatio = opt
    print("[BlatantFish] Ratio set:", opt)
end)

-- Offset tambahan (detik)
TabAuto:Box("FishDelay Offset (0.00 - 0.30)", function(txt)
    local n = tonumber(txt)
    if n then
        n = math.clamp(n, 0, 0.30)
        Config.FishDelayOffset = n
        print("[BlatantFish] Offset set:", n)
    end
end)

-- Catch Delay (delay sesudah complete sebelum cast ulang)
TabAuto:Box("Catch Delay (seconds)", function(txt)
    local n = tonumber(txt)
    if n then
        n = math.clamp(n, 0.10, 3.0)
        Config.CatchDelay = n
        print("[BlatantFish] CatchDelay set:", n)
    end
end)

-- Optional: perfect cast on/off
TabAuto:Toggle("Use Perfect Cast", function(state)
    Config.PerfectCast = state
    print("[BlatantFish] PerfectCast:", state)
end)



----------------------------------------------------------------
-- TAB SHOP â€“ BUY OLD ROD (VULN)
----------------------------------------------------------------
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- net remotes (pakai path yang sama dengan script lain)
local netFolder = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")
    :WaitForChild("net")

local RF_PurchaseFishingRod = netFolder:WaitForChild("RF/PurchaseFishingRod")

-- folder items
local RodItemsPath = ReplicatedStorage:WaitForChild("Items")

-- buat tab shop (kalau sudah ada TabShop, tinggal pakai yang lama)
local TabShop = win:CreateTab("Shop")

TabShop:Label("Rods Shop")

-- build list rod lama (module name diawali "!!!")
local oldRodOptions = {}   -- label yang tampil di dropdown
local oldRodIdMap   = {}   -- [displayName] = id

do
    for _, item in ipairs(RodItemsPath:GetChildren()) do
        if item:IsA("ModuleScript") and item.Name:sub(1, 3) == "!!!" then
            local ok, data = pcall(require, item)
            if ok and data and data.Data then
                local rodId   = data.Data.Id
                local rodName = data.Data.Name or item.Name:gsub("^!!!", "")
                local price   = data.Data.Price or data.Price

                if rodId and rodName then
                    local label = rodName
                    if price then
                        label = string.format("%s | Price: %s", rodName, tostring(price))
                    end

                    table.insert(oldRodOptions, label)
                    -- map pakai nama bersih tanpa harga
                    oldRodIdMap[rodName] = rodId
                end
            end
        end
    end

    table.sort(oldRodOptions, function(a,b)
        return a:lower() < b:lower()
    end)
end

-- kalau tidak ada rod lama, kasih info saja
if #oldRodOptions == 0 then
    TabShop:Label("Tidak ada old rod (!!!) di ReplicatedStorage.Items")
else
    -- dropdown pakai UI kamu sendiri
    TabShop:Dropdown("Buy Rods", oldRodOptions, function(option)
        if not option or option == "" then return end

        -- ambil nama rod tanpa bagian " | Price: xxx"
        local pureName = option:split(" |")[1]
        local rodId    = oldRodIdMap[pureName]

        if not rodId then
            warn("[OldRodShop] RodId tidak ditemukan untuk:", tostring(pureName))
            return
        end

        -- invoke server (vuln: bisa beli rod yang sudah tidak ada di shop)
        local ok, err = pcall(function()
            RF_PurchaseFishingRod:InvokeServer(rodId)
        end)

        if ok then
            print("[OldRodShop] Berhasil beli rod:", pureName, " | Id:", rodId)
        else
            warn("[OldRodShop] Gagal beli rod:", pureName, "Error:", err)
        end
    end)
end

----------------------------------------------------------------
-- TAB SHOP â€“ BUY BAIT (VULN)
----------------------------------------------------------------
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- net remotes (path sama seperti script lain)
local netFolder = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")
    :WaitForChild("net")

-- GANTI nama remote ini kalau di game beda (cek hasil spy / scan)
local RF_PurchaseBait = netFolder:WaitForChild("RF/PurchaseBait")

-- folder baits (dari screenshot: ReplicatedStorage.Baits)
local BaitsFolder = ReplicatedStorage:WaitForChild("Baits")

-- kalau sudah ada TabShop sebelumnya (rod shop), pakai yang lama
local TabShop = TabShop or win:CreateTab("Shop")

TabShop:Label("Bait Shop")

-- build list bait dari ReplicatedStorage.Baits (ModuleScript)
local baitOptions = {}   -- label di dropdown
local baitIdMap   = {}   -- [displayName] = id

do
    for _, item in ipairs(BaitsFolder:GetChildren()) do
        if item:IsA("ModuleScript") then
            local ok, data = pcall(require, item)
            if ok and data and data.Data then
                local baitId   = data.Data.Id
                local baitName = data.Data.Name or item.Name
                local price    = data.Data.Price or data.Price

                if baitId and baitName then
                    local label = baitName
                    if price then
                        label = string.format("%s | Price: %s", baitName, tostring(price))
                    end

                    table.insert(baitOptions, label)
                    -- map pakai nama bersih (tanpa info price)
                    baitIdMap[baitName] = baitId
                end
            end
        end
    end

    table.sort(baitOptions, function(a, b)
        return a:lower() < b:lower()
    end)
end

if #baitOptions == 0 then
    TabShop:Label("Tidak ada bait ModuleScript di ReplicatedStorage.Baits")
else
    -- dropdown pakai UI compact kamu
    TabShop:Dropdown("Buy Baits", baitOptions, function(option)
        if not option or option == "" then return end

        -- ambil nama bait tanpa bagian " | Price: ..."
        local pureName = option:split(" |")[1]
        local baitId   = baitIdMap[pureName]

        if not baitId then
            warn("[BaitShop] baitId tidak ditemukan untuk:", tostring(pureName))
            return
        end

        -- invoke server (vuln: bisa beli bait yang sudah tidak ada di shop)
        local ok, err = pcall(function()
            RF_PurchaseBait:InvokeServer(baitId)
        end)

        if ok then
            print("[BaitShop] Berhasil beli bait:", pureName, " | Id:", baitId)
        else
            warn("[BaitShop] Gagal beli bait:", pureName, "Error:", err)
        end
    end)
end




-- sleitnick/net
local netIndex = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")

local net = netIndex:WaitForChild("net")

-- FARM REMOTES
local RE_ObtainedNewFish  = net:WaitForChild("RE/ObtainedNewFishNotification")
local RE_FavoriteItem     = net:WaitForChild("RE/FavoriteItem")
local RF_SellAllItems     = net:WaitForChild("RF/SellAllItems")
local RF_PurchaseWeather  = net:WaitForChild("RF/PurchaseWeatherEvent")
local RE_ActivateEnchant  = net:WaitForChild("RE/ActivateEnchantingAltar")
local RE_EquipHotbar      = net:WaitForChild("RE/EquipToolFromHotbar")

----------------------------------------------------------------
-- TAB FARM (MAIN)
----------------------------------------------------------------
local TabFarm  = win:CreateTab("Farm")


------------------------------------------------------------
-- â› FARM â€“ AUTO RESPAWN 500 FISH + TELEPORT BALIK + EQUIP ROD
------------------------------------------------------------
local FARM_FISH_LIMIT = 10

local farmRespawnState = {
    enabled    = false,
    sessionCnt = 0,
    savedPos   = nil,   -- Vector3 posisi awal
}

-- remote notifikasi ikan baru
local RE_ObtainedNewFishNotification = net:WaitForChild("RE/ObtainedNewFishNotification")

-- ambil remote equip rod SENDIRI (tidak pakai dari Auto Fishing)
local EquipHotbar = net:WaitForChild("RE/EquipToolFromHotbar")

------------------------------------------------------------
-- helper teleport balik ke posisi awal
------------------------------------------------------------
local function tpBackToSaved()
    if not farmRespawnState.savedPos then return end

    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp  = char:WaitForChild("HumanoidRootPart", 8)
    if not hrp then return end

    hrp.CFrame = CFrame.new(farmRespawnState.savedPos + Vector3.new(0, 3, 0))
end

------------------------------------------------------------
-- helper EQUIP ROD SETELAH RESPAWN (mandiri)
------------------------------------------------------------
local function equipRodAfterRespawn()
    pcall(function()
        EquipHotbar:FireServer(1)
     task.wait(0.2)
EquipHotbar:FireServer(1)
task.wait(0.2)
EquipHotbar:FireServer(1)
    end)
end



------------------------------------------------------------
-- TAB FARM â€“ TOGGLE AUTO RESPAWN
------------------------------------------------------------
local TabFarm = TabFarm or win:CreateTab("Farm")

TabFarm:LiveLabel(function()
    return string.format("Session Fish: %d / %d", farmRespawnState.sessionCnt, FARM_FISH_LIMIT)
end, 0.3)

TabFarm:Toggle("Auto Respawn setelah 500 Fish", function(state)
    farmRespawnState.enabled    = state
    farmRespawnState.sessionCnt = 0

    if state then
        local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
        local hrp  = char and char:FindFirstChild("HumanoidRootPart")
        farmRespawnState.savedPos = hrp and hrp.Position or nil
        print("[Farm] Auto respawn ON, posisi awal tersimpan:", farmRespawnState.savedPos)
    else
        print("[Farm] Auto respawn OFF")
    end
end)

------------------------------------------------------------
-- HOOK SAAT DAPAT IKAN
------------------------------------------------------------
RE_ObtainedNewFishNotification.OnClientEvent:Connect(function(...)
    farmRespawnState.sessionCnt += 1

    if not farmRespawnState.enabled then
        return
    end

    if farmRespawnState.sessionCnt < FARM_FISH_LIMIT then
        return
    end

    print(string.format("[Farm] Limit %d fish tercapai, respawnâ€¦", FARM_FISH_LIMIT))

    -- reset counter untuk sesi baru
    farmRespawnState.sessionCnt = 0

    task.spawn(function()
        -- siapkan listener CharacterAdded dulu
        local alreadyHandled = false
        local conn
        conn = LocalPlayer.CharacterAdded:Connect(function(char)
            if alreadyHandled then return end
            alreadyHandled = true
            if conn then conn:Disconnect() end

            -- tunggu HRP & world siap
            local hrp = char:WaitForChild("HumanoidRootPart", 8)
            if not hrp then return end

            task.wait(1.2)

            -- teleport balik ke posisi awal
            tpBackToSaved()

            -- equip rod setelah balik
            task.wait(0.5)
            for i = 1, 2 do
                pcall(function() 
                    EquipHotbar:FireServer(1) 
                end)
                task.wait(0.1)
            end

            print("[Farm] Respawn + balik posisi + equip rod dijalankan")
        end)

        -- kill karakter untuk respawn
        local char = LocalPlayer.Character
        local hum  = char and char:FindFirstChildOfClass("Humanoid")
        if hum then
            hum.Health = 0
        elseif char then
            char:BreakJoints()
        end
    end)
end)




----------------------------------------------------------------
-- STATE FARM
----------------------------------------------------------------
local Farm = {
    AutoFavoriteEnabled = false,
    FavoriteRarity = {
        COMMON=true, UNCOMMON=false, RARE=false, EPIC=false,
        LEGENDARY=false, MYTHIC=false, SECRET=false,
    },

    AutoSellEnabled  = false,
    AutoSellThreshold = 30,
    AutoSellDelay     = 1.0,

    AutoWeatherEnabled = false,
    AutoWeatherList = {
        ["Storm"]=false, ["Cloudy"]=false, ["Snow"]=false,
        ["Wind"]=false, ["Radiant"]=false, ["Shark Hunt"]=false,
    },

    AutoEnchant_LastRun = 0,
}

----------------------------------------------------------------
-- BUILD RARITY MAP (FishId â†’ Rarity)
----------------------------------------------------------------
local FishIdToRarity = {}
local tierToRarity = {
    [1]="COMMON",[2]="UNCOMMON",[3]="RARE",
    [4]="EPIC",[5]="LEGENDARY",[6]="MYTHIC",[7]="SECRET"
}

local itemsFolder = ReplicatedStorage:FindFirstChild("Items")
if itemsFolder then
    for _,module in ipairs(itemsFolder:GetChildren()) do
        if module:IsA("ModuleScript") then
            local ok,data = pcall(require,module)
            if ok and data and data.Data and data.Data.Type=="Fish" then
                local id   = data.Data.Id
                local tier = tonumber(data.Data.Tier) or 0
                local rar  = data.Data.Rarity or tierToRarity[tier]
                if id then
                    FishIdToRarity[id] = string.upper(rar or "COMMON")
                end
            end
        end
    end
end

----------------------------------------------------------------
-- AUTO FAVORITE + AUTO SELL HANDLER
----------------------------------------------------------------
local autoSellCount     = 0
local autoSellCooldown  = false

RE_ObtainedNewFish.OnClientEvent:Connect(function(itemId, _, info)
    if not info or not info.InventoryItem then return end
    local uuid = info.InventoryItem.UUID
    if not uuid then return end

    -- AUTO FAVORITE
    if Farm.AutoFavoriteEnabled and itemId then
        local rarity = FishIdToRarity[itemId] or "COMMON"
        if Farm.FavoriteRarity[rarity] then
            pcall(function()
                RE_FavoriteItem:FireServer(uuid)
            end)
        end
    end

    -- AUTO SELL ALL
    if Farm.AutoSellEnabled then
        autoSellCount += 1
        if autoSellCount >= Farm.AutoSellThreshold and not autoSellCooldown then
            autoSellCooldown = true
            task.spawn(function()
                pcall(function()
                    RF_SellAllItems:InvokeServer()
                end)
                task.wait(Farm.AutoSellDelay)
                autoSellCount    = 0
                autoSellCooldown = false
            end)
        end
    end
end)

----------------------------------------------------------------
-- WEATHER LOOP
----------------------------------------------------------------
local WeatherThreads = {}

local function randomDelay(min,max)
    return math.random(min*100,max*100)/100
end

local function StartWeatherLoop(weather)
    if WeatherThreads[weather] then return end

    WeatherThreads[weather] = task.spawn(function()
        while Farm.AutoWeatherEnabled and Farm.AutoWeatherList[weather] do
            pcall(function()
                RF_PurchaseWeather:InvokeServer(weather)
            end)

            local dur = 900 + randomDelay(2,6)
            local t0 = tick()
            while tick() - t0 < dur do
                if not (Farm.AutoWeatherEnabled and Farm.AutoWeatherList[weather]) then
                    break
                end
                task.wait(1)
            end
        end
        WeatherThreads[weather] = nil
    end)
end

----------------------------------------------------------------
-- AUTO ENCHANT FUNCTION
----------------------------------------------------------------

local Players           = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace         = game:GetService("Workspace")

local LocalPlayer       = Players.LocalPlayer

-- net / remotes
local netIndex = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")

local net = netIndex:WaitForChild("net")

local RE_EquipHotbar     = net:WaitForChild("RE/EquipToolFromHotbar")
local RE_ActivateEnchant = net:WaitForChild("RE/ActivateEnchantingAltar")
local RE_EquipItem       = net:FindFirstChild("RE/EquipItem")
local RE_UnequipItem     = net:FindFirstChild("RE/UnequipItem")

------------------------------------------------------------
-- IMPORT MODULES (Replion, PlayerStatsUtility, ItemUtility,
--                 TierUtility, Enchants)
------------------------------------------------------------
local Replion, DataReplion
local PlayerStatsUtility, ItemUtility, TierUtility
local EnchantDefs

do
    local okR, modR = pcall(function()
        return require(ReplicatedStorage:WaitForChild("Packages"):WaitForChild("Replion"))
    end)
    if okR and modR then
        Replion = modR
        local okD, rep = pcall(function()
            return Replion.Client:WaitReplion("Data")
        end)
        if okD then DataReplion = rep end
    end

    local shared = ReplicatedStorage:FindFirstChild("Shared")
    if shared then
        pcall(function() PlayerStatsUtility = require(shared:WaitForChild("PlayerStatsUtility")) end)
        pcall(function() ItemUtility        = require(shared:WaitForChild("ItemUtility")) end)
        pcall(function() TierUtility        = require(shared:WaitForChild("TierUtility")) end)
    end

    pcall(function()
        EnchantDefs = require(ReplicatedStorage:WaitForChild("Enchants"))
    end)
end

------------------------------------------------------------
-- KONFIGURASI / STATE AUTO ENCHANT (mirip module PC)
------------------------------------------------------------
local EnchantConfig = {
    AutoEnchant1 = false,
    AutoEnchant2 = false,
    Delay1 = 2,  -- detik antar enchant slot 1
    Delay2 = 2,  -- detik antar enchant slot 2
    TargetEnchant1 = {}, -- isinya [namaEnchant] = true
    TargetEnchant2 = "", -- single string
}
local Enchant = {}
local loop1Running = false
local loop2Running = false


local ENCHANT_ALTAR_CFRAME = CFrame.new(
    3234.55444, -1302.85486, 1400.52197,
    0.354458153, -3.30675043e-08, -0.935071886,
    -2.43329872e-08, 1, -4.45875159e-08,
    0.935071886, 3.85574985e-08, 0.354458153
)

local function ensureCharacter()
    local char = LocalPlayer.Character
    if not char or not char.Parent then
        char = LocalPlayer.CharacterAdded:Wait()
    end
    return char
end

------------------------------------------------------------
-- LIST INVENTORY ENCHANT STONES
------------------------------------------------------------
function Enchant:ListInventoryEnchantStones()
    local enchantStones = {}
    if not (DataReplion and ItemUtility) then return enchantStones end

    local inventory = DataReplion:Get({ "Inventory" })
    local items = inventory and inventory["Items"] or {}
    if not items then return enchantStones end

    for _, item in pairs(items) do
        local ok, itemData = pcall(function()
            return ItemUtility.GetItemDataFromItemType("EnchantStones", item.Id)
        end)
        if ok and itemData and itemData.Data then
            if itemData.Data.Type == "EnchantStones" then
                table.insert(enchantStones, {
                    UUID = item.UUID,
                    Id   = item.Id,
                    Name = itemData.Data.Name or "Unknown",
                    Type = itemData.Data.Type or "Unknown",
                })
            end
        end
    end

    return enchantStones
end

------------------------------------------------------------
-- EQUIP ENCHANT STONE PERTAMA DI INVENTORY
------------------------------------------------------------
function Enchant:EquipEnchantStone(unequipUUID)
    local stones = self:ListInventoryEnchantStones()
    if #stones == 0 then
        warn("[AutoEnchant] Tidak ada EnchantStones di inventory.")
        return
    end

    local first = stones[1]

    if RE_UnequipItem and unequipUUID then
        pcall(function()
            RE_UnequipItem:FireServer(unequipUUID)
        end)
        task.wait(0.15)
    end

    if RE_EquipItem then
        pcall(function()
            RE_EquipItem:FireServer(first.UUID, first.Type or "EnchantStones")
        end)
    else
        warn("[AutoEnchant] RE/EquipItem tidak ditemukan, tidak bisa equip enchant stone otomatis.")
    end
end

------------------------------------------------------------
-- INFO ROD SEKARANG (Nama, tier, enchant1, enchant2)
------------------------------------------------------------
function Enchant:GetCurrentRodDetails()
    if not (DataReplion and PlayerStatsUtility and ItemUtility and TierUtility) then
        return {
            UUID = nil,
            Id = nil,
            Name = "Unknown",
            Tier = "Unknown",
            TierIndex = 100,
            Power = 0,
            MaxWeight = 0,
            Resilience = 0,
            Luck = 0,
            Enchant1 = "None",
            Enchant2 = "None",
        }
    end

    local equippedItem = DataReplion:Get("EquippedItems")
    if not (equippedItem and equippedItem[1]) then
        return {
            Name = "None", Enchant1 = "None", Enchant2 = "None"
        }
    end

    local slotUUID = equippedItem[1]
    local inventoryItem = PlayerStatsUtility:GetItemFromInventory(DataReplion, function(item)
        return item.UUID == slotUUID
    end)

    if not inventoryItem then
        return {
            Name = "None", Enchant1 = "None", Enchant2 = "None"
        }
    end

    local inventory = DataReplion:Get({ "Inventory" })
    local rods = inventory and inventory["Fishing Rods"] or {}
    local metadata
    for _, it in pairs(rods) do
        if it.UUID == inventoryItem.UUID then
            metadata = it.Metadata
            break
        end
    end

    local enchant1, enchant2 = "None", "None"
    for k, v in pairs(inventoryItem.Metadata or {}) do
        local ok, enchantData = pcall(function()
            return ItemUtility:GetEnchantData(v)
        end)
        if ok and enchantData and enchantData.Data then
            if k == "EnchantId" then
                enchant1 = enchantData.Data.Name or "Unknown"
            elseif k == "EnchantId2" then
                enchant2 = enchantData.Data.Name or "Unknown"
            end
        end
    end

    local okItemData, equippedItemData = pcall(function()
        return ItemUtility.GetItemDataFromItemType("Fishing Rods", inventoryItem.Id)
    end)

    if not (okItemData and equippedItemData and equippedItemData.Data) then
        return {
            UUID = inventoryItem.UUID,
            Id   = inventoryItem.Id,
            Name = "Unknown",
            Tier = "Unknown",
            TierIndex = 100,
            Power = 0,
            MaxWeight = 0,
            Resilience = 0,
            Luck = 0,
            Enchant1 = enchant1,
            Enchant2 = enchant2,
        }
    end

    local tierIndex = equippedItemData.Data.Tier or 100
    local tierName  = "Unknown"
    local okTier, tierDetail = pcall(function()
        return TierUtility:GetTier(tierIndex)
    end)
    if okTier and tierDetail and tierDetail.Name then
        tierName = tierDetail.Name
    end

    return {
        UUID       = inventoryItem.UUID,
        Id         = inventoryItem.Id,
        Name       = equippedItemData.Data.Name or "Unknown",
        Tier       = tierName,
        TierIndex  = tierIndex,
        Power      = equippedItemData.ClickPower or 0,
        MaxWeight  = equippedItemData.MaxWeight or 0,
        Resilience = equippedItemData.Resilience or 0,
        Luck       = equippedItemData.Data.BaseLuck or 0,
        Enchant1   = enchant1,
        Enchant2   = enchant2,
    }
end

------------------------------------------------------------
-- LIST SEMUA ENCHANT NAME
------------------------------------------------------------
function Enchant:GetListEnchant()
    local list = {}
    if not EnchantDefs then return list end

    for _, v in pairs(EnchantDefs) do
        if v and v.Data and v.Data.Name then
            table.insert(list, v.Data.Name)
        end
    end
    table.sort(list)
    return list
end

------------------------------------------------------------
-- TELEPORT KE ALTAR + EQUIP BATU & AKTIFKAN (fungsi umum)
------------------------------------------------------------
local function doEnchantCast()
    -- kalau dua-duanya OFF, langsung nggak usah jalan
    if not (EnchantConfig.AutoEnchant1 or EnchantConfig.AutoEnchant2) then
        return
    end

    local char = ensureCharacter()
    if not char then return end

    local hrp  = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local curPos   = hrp.Position
    local flatCur  = Vector3.new(curPos.X, 0, curPos.Z)
    local flatAltr = Vector3.new(ENCHANT_ALTAR_CFRAME.X, 0, ENCHANT_ALTAR_CFRAME.Z)

    -- TELEPORT KE ALTAR JIKA JAUH
    if (flatCur - flatAltr).Magnitude > 5 then
        hrp.CFrame = ENCHANT_ALTAR_CFRAME + Vector3.new(0, 5, 0)

        -- dulu: task.wait(1)
        -- sekarang: wait pendek + cek toggle biar bisa batal
        local t = 0
        local maxDelay = 0.8
        while t < maxDelay and (EnchantConfig.AutoEnchant1 or EnchantConfig.AutoEnchant2) do
            task.wait(0.1)
            t += 0.1
        end
        -- kalau di tengahÂ² user matiin toggle â†’ stop di sini
        if not (EnchantConfig.AutoEnchant1 or EnchantConfig.AutoEnchant2) then
            return
        end
    end

    -- CARI ENCHANT STONE DI HOTBAR
    local hotBarIndex = nil
    if DataReplion and PlayerStatsUtility and ItemUtility then
        local equipped = DataReplion:Get("EquippedItems") or {}

        for k, v in pairs(equipped) do
            local invItem = PlayerStatsUtility:GetItemFromInventory(DataReplion, function(it)
                return it.UUID == v
            end)
            if invItem then
                local okI, itemData = pcall(function()
                    return ItemUtility:GetItemData(invItem.Id)
                end)
                if okI and itemData and itemData.Data and itemData.Data.Type == "EnchantStones" then
                    hotBarIndex = k
                    break
                end
            end
        end

        -- kalau belum ada yang ke-equip, equip 1 batu enchant dulu
        if not hotBarIndex then
            local equippedList = DataReplion:Get("EquippedItems") or {}
            if #equippedList > 0 then
                Enchant:EquipEnchantStone(equippedList[#equippedList])
                hotBarIndex = #equippedList
            end
        end
    end

    if not hotBarIndex then
        hotBarIndex = 2 -- fallback
    end

    -- EQUIP STONE
    if not (EnchantConfig.AutoEnchant1 or EnchantConfig.AutoEnchant2) then
        return
    end

    pcall(function()
        RE_EquipHotbar:FireServer(hotBarIndex)
    end)

    -- tunggu pendek tapi bisa dibatalkan
    do
        local t = 0
        local maxDelay = 0.2
        while t < maxDelay and (EnchantConfig.AutoEnchant1 or EnchantConfig.AutoEnchant2) do
            task.wait(0.05)
            t += 0.05
        end
        if not (EnchantConfig.AutoEnchant1 or EnchantConfig.AutoEnchant2) then
            return
        end
    end

    -- AKTIVASI ALTAR
    pcall(function()
        RE_ActivateEnchant:FireServer()
    end)
end


------------------------------------------------------------
-- START AUTO ENCHANT SLOT 1 (SATU KALI PROSES)
------------------------------------------------------------
function Enchant:StartAutoEnchant1()
    if not EnchantConfig.AutoEnchant1 then return end

    local targetNames = {}
    for name, state in pairs(EnchantConfig.TargetEnchant1) do
        if state then table.insert(targetNames, name) end
    end
    if #targetNames == 0 then
        warn("[AutoEnchant] TargetEnchant1 kosong.")
        return
    end

    local currentRod = self:GetCurrentRodDetails()
    if not currentRod or not currentRod.Name then
        warn("[AutoEnchant] Tidak ada fishing rod equipped.")
        return
    end

    if table.find(targetNames, currentRod.Enchant1) then
        print("[AutoEnchant] Enchant1 sudah salah satu target:", currentRod.Enchant1)
        return
    end

    -- di sini dia bener2 coba enchant sekali
    doEnchantCast()
    print("[AutoEnchant] Proses enchant SLOT 1 dijalankan â†’ target:", table.concat(targetNames, ", "))
end

------------------------------------------------------------
-- START AUTO ENCHANT SLOT 2 (SATU KALI PROSES)
------------------------------------------------------------
function Enchant:StartAutoEnchant2()
    if not EnchantConfig.AutoEnchant2 then return end
    local target2 = EnchantConfig.TargetEnchant2
    if not target2 or target2 == "" then
        warn("[AutoEnchant] TargetEnchant2 belum dipilih.")
        return
    end

    local currentRod = self:GetCurrentRodDetails()
    if not currentRod or not currentRod.Name then
        warn("[AutoEnchant] Tidak ada fishing rod equipped.")
        return
    end

    if currentRod.Enchant2 == target2 then
        print("[AutoEnchant] Enchant2 sudah sesuai target:", target2)
        return
    end

    doEnchantCast()
    print("[AutoEnchant] Proses enchant SLOT 2 dijalankan â†’ target:", target2)
end

------------------------------------------------------------
-- LOOP AUTO ENCHANT 1
------------------------------------------------------------
local function AutoEnchantLoop1()
    if loop1Running then return end
    loop1Running = true
    print("[AutoEnchant] Loop1 START")

    while EnchantConfig.AutoEnchant1 do
        -- satu kali attempt enchant slot 1
        local ok, err = pcall(function()
            Enchant:StartAutoEnchant1()
        end)
        if not ok then
            warn("[AutoEnchant] Error slot1:", err)
        end

        -- delay yang bisa â€œdiputusâ€ saat toggle off
        local total = EnchantConfig.Delay1 or 2
        local t = 0
        while t < total and EnchantConfig.AutoEnchant1 do
            task.wait(0.1)
            t += 0.1
        end
    end

    loop1Running = false
    print("[AutoEnchant] Loop1 STOP")
end

------------------------------------------------------------
-- LOOP AUTO ENCHANT 2
------------------------------------------------------------
local function AutoEnchantLoop2()
    if loop2Running then return end
    loop2Running = true
    print("[AutoEnchant] Loop2 START")

    while EnchantConfig.AutoEnchant2 do
        local ok, err = pcall(function()
            Enchant:StartAutoEnchant2()
        end)
        if not ok then
            warn("[AutoEnchant] Error slot2:", err)
        end

        local total = EnchantConfig.Delay2 or 2
        local t = 0
        while t < total and EnchantConfig.AutoEnchant2 do
            task.wait(0.1)
            t += 0.1
        end
    end

    loop2Running = false
    print("[AutoEnchant] Loop2 STOP")
end


----------------------------------------------------------------
-- UI â€“ FARM MENU
----------------------------------------------------------------
local farmUI = TabFarm

farmUI:Label("Auto Favorite")

local tgFav = farmUI:Toggle("Enable Auto Favorite", function(v)
    Farm.AutoFavoriteEnabled = v
end)

local rarityList = {"COMMON","UNCOMMON","RARE","EPIC","LEGENDARY","MYTHIC","SECRET"}

local ddFav = farmUI:MultiDropdown("Favorite Rarity", rarityList, function(r, state)
    Farm.FavoriteRarity[r] = state
end)

----------------------------------------------------------------
farmUI:Label("Auto Sell (Sell All)")

farmUI:Dropdown("Sell Mode", {
    "Off","10 Fish","20 Fish","30 Fish","50 Fish"
}, function(opt)
    if opt=="Off" then
        Farm.AutoSellEnabled=false
        autoSellCount=0
    else
        Farm.AutoSellEnabled=true
        local n = tonumber(opt:match("(%d+)"))
        Farm.AutoSellThreshold = n or 30
    end
end)

farmUI:Box("Sell Delay (seconds)", function(txt)
    local n = tonumber(txt)
    if n then Farm.AutoSellDelay = n end
end)

----------------------------------------------------------------
TabShop:Label("Auto Weather (Multi Select)")

TabShop:Toggle("Enable Auto Weather", function(v)
    Farm.AutoWeatherEnabled = v
    if v then
        for name,flag in pairs(Farm.AutoWeatherList) do
            if flag then StartWeatherLoop(name) end
        end
    end
end)

local weatherList = {"Storm","Cloudy","Snow","Wind","Radiant","Shark Hunt"}
local ddWeather = TabShop:MultiDropdown("Weather List", weatherList, function(opt,state)
    Farm.AutoWeatherList[opt] = state
    if state and Farm.AutoWeatherEnabled then
        StartWeatherLoop(opt)
    end
end)

----------------------------------------------------------------
farmUI:Label("Auto Enchant")

------------------------------------------------------------
-- UI TAB "Enchant" (struktur sama seperti PC, tapi pakai UI kamu)
------------------------------------------------------------



farmUI:LiveLabel(function()
    -- ganti Enchant_GetCurrentRodDetails() dengan fungsi kamu sendiri
    local r = Enchant_GetCurrentRodDetails and Enchant_GetCurrentRodDetails() 
              or (Enchant and Enchant.GetCurrentRodDetails and Enchant:GetCurrentRodDetails())
              or nil

    if not r then
        return "Current Rod: N/A\nEnchant 1: None\nEnchant 2: None"
    end

    return string.format(
        "Current Rod: %s\nEnchant 1: %s\nEnchant 2: %s",
        r.Name or "N/A",
        r.Enchant1 or "None",
        r.Enchant2 or "None"
    )
end, 0.5) -- 0.5 = update setiap 0.5 detik



-- daftar enchant dari Enchants
local enchantNames = Enchant:GetListEnchant()

farmUI:Label("Enchant 1 (Target Bisa Banyak)")
farmUI:MultiDropdown("Select Target Enchant 1", enchantNames, function(name, state)
    EnchantConfig.TargetEnchant1[name] = state and true or false
end)

farmUI:Toggle("Auto Enchant Slot 1", function(state)
    EnchantConfig.AutoEnchant1 = state
    if state then
        task.spawn(AutoEnchantLoop1)
    end
end)

farmUI:Label("")
farmUI:Label("Enchant 2 (Target Single)")

farmUI:Dropdown("Select Target Enchant 2", enchantNames, function(name)
    EnchantConfig.TargetEnchant2 = name
    print("[AutoEnchant] TargetEnchant2 =", name)
end)

farmUI:Toggle("Auto Enchant Slot 2", function(state)
    EnchantConfig.AutoEnchant2 = state
    if state then
        task.spawn(AutoEnchantLoop2)
    end
end)

-- expose ke global kalau nanti mau dipakai modul lain
_G.AegisEnchant       = Enchant
_G.AegisEnchantConfig = EnchantConfig

----------------------------------------------------------------

------------------------------------------------------------
-- TAB EVENT â€“ AUTO TELEPORT EVENT (SCAN WORKSPACE)
------------------------------------------------------------
local Players           = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace         = game:GetService("Workspace")

local LocalPlayer       = Players.LocalPlayer
local EventsFolder      = ReplicatedStorage:FindFirstChild("Events")

local EventConfig = {
    AutoEvent     = false,
    SelectedEvent = nil,
}

local originalCFrame    = nil
local isAtEvent         = false
local eventLoopRunning  = false

------------------------------------------------------------
-- TELEPORT HELPER (pakai tpTo kalau sudah ada)
------------------------------------------------------------
local function safeTpTo(cfOrPos)
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp  = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    if typeof(cfOrPos) == "CFrame" then
        hrp.CFrame = cfOrPos + Vector3.new(0, 5, 0)
    elseif typeof(cfOrPos) == "Vector3" then
        hrp.CFrame = CFrame.new(cfOrPos + Vector3.new(0, 5, 0))
    end
end

------------------------------------------------------------
-- CEK ACTIVE DARI ReplicatedStorage.Events (kalau ada)
------------------------------------------------------------
local function isEventActiveInRep(ev)
    if not ev then return false end

    local activeAttr = ev:GetAttribute("Active")
                    or ev:GetAttribute("IsActive")
                    or ev:GetAttribute("Enabled")

    if type(activeAttr) == "boolean" then
        return activeAttr
    end

    for _,v in ipairs(ev:GetChildren()) do
        if v:IsA("BoolValue")
           and (v.Name == "Active" or v.Name == "IsActive" or v.Name == "Enabled") then
            return v.Value == true
        end
    end

    return false
end

------------------------------------------------------------
-- CARI POSISI EVENT DI WORKSPACE DARI NAMA EVENT
------------------------------------------------------------
local function findEventCFrameByName(eventName)
    if not eventName or eventName == "" then return nil end

    local lname = string.lower(eventName)
    local char = LocalPlayer.Character
    local hrp  = char and char:FindFirstChild("HumanoidRootPart")
    local origin = hrp and hrp.Position or Vector3.new()

    local bestPart, bestDist

    for _, inst in ipairs(Workspace:GetDescendants()) do
        if inst:IsA("BasePart") then
            local iname = string.lower(inst.Name or "")
            -- cocok nama event di mana saja (Contains)
            if iname:find(lname, 1, true) then
                local d = (inst.Position - origin).Magnitude
                if not bestDist or d < bestDist then
                    bestDist = d
                    bestPart = inst
                end
            end
        elseif inst:IsA("Model") then
            local iname = string.lower(inst.Name or "")
            if iname:find(lname, 1, true) then
                local p = inst:FindFirstChild("HumanoidRootPart")
                    or inst.PrimaryPart
                    or inst:FindFirstChildWhichIsA("BasePart")
                if p then
                    local d = (p.Position - origin).Magnitude
                    if not bestDist or d < bestDist then
                        bestDist = d
                        bestPart = p
                    end
                end
            end
        end
    end

    if bestPart then
        print(string.format("[Event] Found workspace target for '%s' at %s (dist=%.1f)",
            eventName, tostring(bestPart.Position), bestDist or 0))
        return bestPart.CFrame
    else
        print("[Event] No workspace match for event:", eventName)
    end

    return nil
end

------------------------------------------------------------
-- BUILD LIST EVENT DARI ReplicatedStorage.Events
------------------------------------------------------------
local function getEventNames()
    local list = {}
    if not EventsFolder then
        warn("[Event] ReplicatedStorage.Events tidak ditemukan")
        return list
    end

    for _,ev in ipairs(EventsFolder:GetChildren()) do
        table.insert(list, ev.Name)
    end
    table.sort(list)
    return list
end

------------------------------------------------------------
-- LOOP AUTO EVENT
------------------------------------------------------------
local function EventAutoLoop()
    if eventLoopRunning then return end
    eventLoopRunning = true
    print("[AegisHub Event] loop start")

    while EventConfig.AutoEvent do
        local evName = EventConfig.SelectedEvent

        if evName and evName ~= "" then
            local evDef = EventsFolder and EventsFolder:FindFirstChild(evName) or nil
            local activeRep = evDef and isEventActiveInRep(evDef) or false

            -- cari posisi event di workspace
            local cf = findEventCFrameByName(evName)

            local active = activeRep or (cf ~= nil)

            print(string.format(
                "[Event] Check '%s' | activeRep=%s | foundPos=%s",
                evName, tostring(activeRep), tostring(cf ~= nil)
            ))

            if active and cf then
                if not isAtEvent then
                    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
                    local hrp  = char and char:FindFirstChild("HumanoidRootPart")
                    if hrp then
                        originalCFrame = hrp.CFrame
                    end

                    safeTpTo(cf)
                    isAtEvent = true
                    print("[Event] Teleport to event:", evName)
                end
            else
                if isAtEvent and originalCFrame then
                    safeTpTo(originalCFrame)
                    print("[Event] Event ended / not found, return to original.")
                end
                isAtEvent = false
            end
        end

        task.wait(1.5)
    end

    -- toggle OFF â†’ balikin posisi
    if isAtEvent and originalCFrame then
        safeTpTo(originalCFrame)
        print("[Event] AutoEvent OFF, return to original pos.")
    end

    isAtEvent        = false
    originalCFrame   = nil
    eventLoopRunning = false
    print("[AegisHub Event] loop end")
end

------------------------------------------------------------
-- UI TAB EVENT (Dropdown + Toggle + Refresh)
------------------------------------------------------------
local TabEvent = win:CreateTab("Event")

TabEvent:Label("Auto Teleport Event")

local eventNames = getEventNames()
local ddEvent = TabEvent:Dropdown("Select Event", eventNames, function(opt)
    EventConfig.SelectedEvent = opt
    print("[AegisHub Event] SelectedEvent =", tostring(opt))
end)

TabEvent:Button("Refresh Event List", function()
    local list = getEventNames()
    if ddEvent and ddEvent.SetOptions then
        ddEvent:SetOptions(list)
    end
    print("[AegisHub Event] Event list refreshed.")
end)

TabEvent:Toggle("Auto Teleport Selected Event", function(state)
    EventConfig.AutoEvent = state
    print("[AegisHub Event] AutoEvent =", state)
    if state then
        task.spawn(EventAutoLoop)
    end
end)




----------------------------------------------------------------
-- PART 3 â€” TELEPORT + MISC + FPS / PING OVERLAY
----------------------------------------------------------------

local Lighting     = game:GetService("Lighting")
local VirtualUser  = game:GetService("VirtualUser")
local RunService   = game:GetService("RunService")
local Stats        = game:GetService("Stats")

------------------------------------------------------------
-- TELEPORT
------------------------------------------------------------
local function tpTo(pos)
    if not pos then return end
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if hrp then
        hrp.CFrame = CFrame.new(pos + Vector3.new(0,5,0))
    end
end

local TabTP = win:CreateTab("Teleport")

TabTP:Label("Teleport to Your Spot Fishing")

------------------------------------------------------------
-- LIVE COORDINATE + SAVE ISLAND
------------------------------------------------------------
local RunService     = game:GetService("RunService")
local HttpService    = game:GetService("HttpService")
local Players        = game:GetService("Players")
local LocalPlayer    = Players.LocalPlayer

-- label live posisi & nama island
local coordLabel = TabTP:LiveLabel("Pos: 0, 0, 0")
local islandLiveLabel = TabTP:LiveLabel("Island: Unknown")

-- update setiap frame
RunService.RenderStepped:Connect(function()
    local char = LocalPlayer.Character
    local hrp  = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp or not coordLabel or not coordLabel.Parent then return end

    local p = hrp.Position
    coordLabel.Text = string.format("Pos: %.1f, %.1f, %.1f", p.X, p.Y, p.Z)

    -- coba ambil nama island dari GUI lokasi (kalau ada)
    local islandName = "Unknown"
    local pg = LocalPlayer:FindFirstChild("PlayerGui")
    if pg then
        local ok, guiLoc = pcall(function()
            return pg.Events.Frame.Location.Label
        end)
        if ok and guiLoc and guiLoc.Text ~= "" then
            islandName = guiLoc.Text
        end
    end
    islandLiveLabel.Text = "Island: "..islandName
end)

------------------------------------------------------------
-- SAVE / LOAD ISLAND COORDS
------------------------------------------------------------
local SavedIslands = {}   -- [name] = Vector3
local SAVE_FILE    = "AegisHub_FishIt_Islands.json"

local function encodeVec(v) return {x = v.X, y = v.Y, z = v.Z} end
local function decodeVec(t) return Vector3.new(t.x, t.y, t.z) end

local function LoadIslands()
    if not readfile then return end
    local ok, data = pcall(readfile, SAVE_FILE)
    if not ok or not data then return end

    local ok2, decoded = pcall(function()
        return HttpService:JSONDecode(data)
    end)
    if not ok2 or type(decoded) ~= "table" then return end

    for name, vec in pairs(decoded) do
        if vec.x and vec.y and vec.z then
            SavedIslands[name] = decodeVec(vec)
        end
    end
end

local function SaveIslands()
    if not writefile then return end
    local serial = {}
    for name, v in pairs(SavedIslands) do
        serial[name] = encodeVec(v)
    end
    local ok, json = pcall(function()
        return HttpService:JSONEncode(serial)
    end)
    if not ok then return end
    pcall(writefile, SAVE_FILE, json)
end

LoadIslands()

------------------------------------------------------------
-- UI: INPUT NAMA, SAVE, LIST, TELEPORT
------------------------------------------------------------
local currentIslandName = ""
local lastSelectedIsland = nil
local islandDropdown

-- input nama island
local nameBox = TabTP:Box("Nama island (kosong = pakai nama lokasi GUI)", function(text)
    currentIslandName = text or ""
end)

-- tombol save posisi sekarang
TabTP:Button("Save current position as Island", function()
    local char = LocalPlayer.Character
    local hrp  = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local name = currentIslandName

    -- kalau kosong, pakai nama dari GUI lokasi / fallback ke koordinat
    if name == "" then
        local pg = LocalPlayer:FindFirstChild("PlayerGui")
        local islandName = nil
        if pg then
            local ok, guiLoc = pcall(function()
                return pg.Events.Frame.Location.Label
            end)
            if ok and guiLoc and guiLoc.Text ~= "" then
                islandName = guiLoc.Text
            end
        end
        name = islandName or string.format("Island (%.0f, %.0f, %.0f)", hrp.Position.X, hrp.Position.Y, hrp.Position.Z)
    end

    SavedIslands[name] = hrp.Position
    SaveIslands()
    if islandDropdown and islandDropdown.SetOptions then
        -- refresh list
        local list = {}
        for k in pairs(SavedIslands) do table.insert(list, k) end
        table.sort(list)
        islandDropdown:SetOptions(list)
    end
end)

-- helper buat build list dropdown
local function buildIslandList()
    local t = {}
    for name in pairs(SavedIslands) do
        table.insert(t, name)
    end
    table.sort(t)
    return t
end

-- dropdown island tersimpan
islandDropdown = TabTP:Dropdown("Saved Islands", buildIslandList(), function(opt)
    lastSelectedIsland = opt
    local pos = SavedIslands[opt]
    if pos then
        tpTo(pos)
    end
end)

-- tombol hapus island yang dipilih
TabTP:Button("Delete Selected Island", function()
    if not lastSelectedIsland then return end
    SavedIslands[lastSelectedIsland] = nil
    SaveIslands()
    lastSelectedIsland = nil
    if islandDropdown and islandDropdown.SetOptions then
        islandDropdown:SetOptions(buildIslandList())
    end
end)

TabTP:Label("")

TabTP:Label("Teleport to Island")

local islands = {
    ["Fisherman Island"] = Vector3.new(128.62, 3.53, 2783.18),
    ["Kohana"] = Vector3.new(-663.904236, 3.04580712, 718.796875),
    ["Kohana Volcano"] = Vector3.new(-572.879456, 22.4521465, 148.355331),
    ["Lost Isle"] = Vector3.new(-3618.15698, 240.836655, -1317.45801), 
    ["Sisyphus Statue"] = Vector3.new(-3727.16, -135.07, -1014.40),
    ["Treasure Room"] = Vector3.new(-3606.34985, -266.57373, -1580.97339),    
    ["Esoteric Depths"] = Vector3.new(3248.37109, -1301.53027, 1403.82727),    
    ["Coral Reefs"] = Vector3.new(-3114.78198, 1.32066584, 2237.52295), 
    ["Crater Island"] = Vector3.new(987.96, 3.30, 5148.49), 
    ["Tropical Grove"] = Vector3.new(-2095.34106, 197.199997, 3718.08008), 
    ["Weather Machine"] = Vector3.new(-1488.51196, 83.1732635, 1876.30298),
    ["Underground Cellar"] = Vector3.new(2135.89, -91.20, -698.50),     
    ["Ancient Jungle"] = Vector3.new(1483.11, 11.14, -300.08), 
    ["Sacred Temple"] = Vector3.new(1506.53, -22.13, -640.17), 
    ["Ancient Ruin"] = Vector3.new(6040.64, -578.44, 4715.02), 
    ["Crystalline Passage"] = Vector3.new(6049.71, -538.90, 4385.69), 
    ["Arrow Artifact"] = Vector3.new(881.40, 6.34, -346.27),     
    ["Crescent Artifact"] = Vector3.new(1404.67, 5.08, 120.55),     
    ["Diamond Artifact"] = Vector3.new(1841.52, 2.76, -300.38),  
    ["Hourglass Diamond Artifact"] = Vector3.new(1466.40, 3.19, -846.62),  
    ["Classic Island"] = Vector3.new(1246.1,13.7,2852.7),     
    ["Iron Cavern"] = Vector3.new(-8795.1,-580.0,91.6),  
    ["Iron Cafe"] = Vector3.new(-8641.5,-542.8,161.3), 
}

local islandList = {}
for name in pairs(islands) do table.insert(islandList,name) end
table.sort(islandList)

local ddIsland = TabTP:Dropdown("Select Island", islandList, function(opt)
    tpTo(islands[opt])
end)

------------------------------------------------------------
-- TELEPORT NPC  (scan workspace, pilih NPC terdekat)
------------------------------------------------------------
TabTP:Label("Teleport to NPC")

-- Scan semua Model yang:
--  - BUKAN karakter player
--  - Punya Humanoid ATAU punya ProximityPrompt di dalamnya
local function scanNPC_Models()
    local found = {}
    for _, m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and #m.Name >= 3 then
            -- abaikan karakter player
            if Players:GetPlayerFromCharacter(m) == nil then
                local hasHumanoid = m:FindFirstChildOfClass("Humanoid") ~= nil
                local hasPrompt = false

                if not hasHumanoid then
                    for _, d in ipairs(m:GetDescendants()) do
                        if d:IsA("ProximityPrompt") then
                            hasPrompt = true
                            break
                        end
                    end
                end

                if hasHumanoid or hasPrompt then
                    found[m.Name] = true
                end
            end
        end
    end

    local list = {}
    for name in pairs(found) do
        table.insert(list, name)
    end
    table.sort(list)
    return list
end

local npcList    = scanNPC_Models()
local currentNPC = npcList[1]

-- Dropdown pakai UI AegisHub Compact (Single select)
local ddNPC = TabTP:Dropdown("NPC List", npcList, function(nm)
    currentNPC = nm
    if not nm or nm == "" then return end

    local me   = Players.LocalPlayer
    local ch   = me and (me.Character or me.CharacterAdded:Wait())
    local hrp  = ch and ch:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    -- cari instance NPC terdekat yang namanya mengandung teks yg dipilih
    local best, dist
    local targetLower = string.lower(nm)
    for _, m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and Players:GetPlayerFromCharacter(m) == nil then
            if string.find(string.lower(m.Name), targetLower, 1, true) then
                local p = m:FindFirstChild("HumanoidRootPart") 
                       or m.PrimaryPart 
                       or m:FindFirstChildWhichIsA("BasePart")
                if p then
                    local d = (p.Position - hrp.Position).Magnitude
                    if not dist or d < dist then
                        best  = p
                        dist  = d
                    end
                end
            end
        end
    end

    if best then
        tpTo(best.Position)
    end
end)

-- set default value di dropdown kalau ada NPC
if currentNPC and ddNPC and ddNPC.Set then
    ddNPC:Set(currentNPC)
end

-- OPTIONAL: auto-refresh daftar NPC setiap beberapa detik TANPA bikin dropdown baru
task.spawn(function()
    while true do
        task.wait(8)
        if ddNPC and ddNPC.SetOptions then
            local newList = scanNPC_Models()
            ddNPC:SetOptions(newList)
        end
    end
end)


------------------------------------------------------------
-- TELEPORT PLAYER
------------------------------------------------------------
TabTP:Label("Teleport to Player")

local function playerList()
    local t={}
    for _,p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then table.insert(t,p.Name) end
    end
    table.sort(t)
    return t
end

local ddPlayer = TabTP:Dropdown("Choose Player", playerList(), function(name)
    local pl = Players:FindFirstChild(name)
    if pl and pl.Character and pl.Character:FindFirstChild("HumanoidRootPart") then
        tpTo(pl.Character.HumanoidRootPart.Position)
    end
end)

------------------------------------------------------------
-- AUTO REFRESH NPC & PLAYER LIST (TANPA BUAT DROPDOWN BARU)
------------------------------------------------------------
task.spawn(function()
    while true do
        task.wait(8)
        local newNPC = scanNPC()
        ddNPC:SetOptions(newNPC)

        local newPL = playerList()
        ddPlayer:SetOptions(newPL)
    end
end)

Players.PlayerAdded:Connect(function()
    ddPlayer:SetOptions(playerList())
end)
Players.PlayerRemoving:Connect(function()
    ddPlayer:SetOptions(playerList())
end)




               
------------------------------------------------------------
-- MISC TAB
------------------------------------------------------------
local TabMisc = win:CreateTab("Misc")

TabMisc:Label("Anti AFK")
local AntiAFKConn

TabMisc:Toggle("Enable Anti AFK", function(state)
    if state then
        if AntiAFKConn then AntiAFKConn:Disconnect() end
        AntiAFKConn = LocalPlayer.Idled:Connect(function()
            VirtualUser:Button2Down(Vector2.new(), Workspace.CurrentCamera.CFrame)
            task.wait(0.6)
            VirtualUser:Button2Up(Vector2.new(), Workspace.CurrentCamera.CFrame)
        end)
    else
        if AntiAFKConn then AntiAFKConn:Disconnect() AntiAFKConn=nil end
    end
end)

------------------------------------------------------------
-- FPS BOOST
------------------------------------------------------------
TabMisc:Label("FPS Boost System")

local Misc = {
    HideTextures = false,
    SmoothParts  = false,
    NoLighting   = false,
    NoEffects    = false,
    FPSCap       = 120,
}

local function HideAllTextures()
    for _,v in ipairs(game:GetDescendants()) do
        if v:IsA("Decal") or v:IsA("Texture") then
            v.Transparency = 1
        end
    end
end

local function ApplySmoothPlastic()
    for _,v in ipairs(game:GetDescendants()) do
        if v:IsA("BasePart") then
            v.Material = Enum.Material.SmoothPlastic
        end
    end
end

local function ApplyNoLighting()
    Lighting.GlobalShadows = false
    Lighting.FogEnd = 1e10
    Lighting.Brightness = 1
end

local function RemoveEffects()
    for _,v in ipairs(game:GetDescendants()) do
        if v:IsA("ParticleEmitter")
        or v:IsA("Beam")
        or v:IsA("Trail")
        or v:IsA("Smoke")
        or v:IsA("Fire")
        or v:IsA("Sparkles") then
            v.Enabled = false
        end
    end
end

TabMisc:Toggle("Hide Textures", function(v)
    Misc.HideTextures = v
    if v then HideAllTextures() end
end)

TabMisc:Toggle("Smooth Plastic", function(v)
    Misc.SmoothParts = v
    if v then ApplySmoothPlastic() end
end)

TabMisc:Toggle("No Lighting", function(v)
    Misc.NoLighting = v
    if v then ApplyNoLighting() end
end)

TabMisc:Toggle("Disable Effects", function(v)
    Misc.NoEffects = v
    if v then RemoveEffects() end
end)

------------------------------------------------------------
-- FPS CAP
------------------------------------------------------------
TabMisc:Label("FPS Cap")
TabMisc:Slider("Set FPS Cap", 30, 300, 120, function(v)
    Misc.FPSCap = v
    if setfpscap then
        setfpscap(v)
    end
end)

------------------------------------------------------------
-- FPS / PING OVERLAY (TOP SCREEN)
------------------------------------------------------------
TabMisc:Label("Stats Overlay")

local function CreateOverlay()
    local gui = Instance.new("ScreenGui")
    gui.Name = "StatsOverlay_Aegis"
    gui.Parent = CoreGui

    local label = Instance.new("TextLabel")
    label.Parent = gui
    label.BackgroundTransparency = 1
    label.Position = UDim2.new(0,8,0,6)
    label.Size = UDim2.new(0,260,0,20)
    label.Font = Enum.Font.Code
    label.TextSize = 14
    label.TextColor3 = Color3.new(1,1,1)
    label.TextXAlignment = Enum.TextXAlignment.Left

    local fpsAvg = 0
    local alpha = 0.18

    RunService.RenderStepped:Connect(function(dt)
        local fps = 1/math.max(dt,1/1000)
        fpsAvg = fpsAvg + (fps - fpsAvg)*alpha

        local ping = 0
        pcall(function()
            local s = Stats.Network.ServerStatsItem["Data Ping"]:GetValueString()
            ping = tonumber(string.match(s,"(%d+)")) or 0
        end)

        label.Text = string.format("FPS: %d | Ping: %dms", fpsAvg, ping)
    end)

    return gui
end

local OverlayObj = nil

TabMisc:Toggle("Enable Stats Overlay", function(v)
    if v then
        if not OverlayObj then
            OverlayObj = CreateOverlay()
        end
    else
        if OverlayObj then
            OverlayObj:Destroy()
            OverlayObj = nil
        end
    end
end)
