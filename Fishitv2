--========================================================
-- FISH IT FARM - Auto Fish + Blatant cepat (NO STUCK, DELAY INPUT + SPEED X)
--========================================================

local TabFarm   = win:CreateTab("Farm")
local PageFarm  = TabFarm:CreateFrame("Farm")
PageFarm:CreateLabel("FARM MENU")

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players2          = game:GetService("Players")
local Workspace2        = game:GetService("Workspace")
local LocalPlayer2      = Players2.LocalPlayer

-- sleitnick/net
local netIndex = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")

local net = netIndex:WaitForChild("net")

local RF_Charge            = net:WaitForChild("RF/ChargeFishingRod")
local RF_RequestMinigame   = net:WaitForChild("RF/RequestFishingMinigameStarted")
local RE_FishingCompleted  = net:WaitForChild("RE/FishingCompleted")
local RE_EquipHotbar       = net:WaitForChild("RE/EquipToolFromHotbar")
local RE_TextEffect        = net:WaitForChild("RE/ReplicateTextEffect")
local RE_FishCaught        = net:FindFirstChild("RE/FishCaught") -- gak dipakai

-- STATE FARM
local Farm = {
    -- AUTO FISH (Legit)
    AutoFish_Enabled       = false,
    AutoFish_ReelDelay     = 2.8,

    -- BLATANT MODE (Metode sama, tapi delay sendiri + speed)
    Blatant_Enabled        = false,
    Blatant_ReelDelay      = 1.9,  -- nilai dasar (sebelum dibagi speed)
    Blatant_CompleteDelay  = 1.1,  -- nilai dasar (sebelum dibagi speed)
    Blatant_SpeedMultiplier= 5,    -- 5x lebih cepat (default)

    -- UTIL
    AutoBait               = true,
    AutoBestRod            = true,
}

local LEGIT_COMPLETE_DELAY = 1.145  -- auto fish aman

-- Best Luck Rod
local function getBestLuckRod()
    local backpack = LocalPlayer2.Backpack
    local char = LocalPlayer2.Character

    local bestRod = nil
    local highestLuck = -999

    local function check(tool)
        if tool:FindFirstChild("Stats") and tool.Stats:FindFirstChild("Luck") then
            local luck = tool.Stats.Luck.Value
            if luck > highestLuck then
                highestLuck = luck
                bestRod = tool
            end
        end
    end

    for _, tool in ipairs(backpack:GetChildren()) do
        check(tool)
    end
    if char then
        for _, tool in ipairs(char:GetChildren()) do
            check(tool)
        end
    end

    return bestRod
end

local function AutoEquipBestRod()
    if not Farm.AutoBestRod then return end
    local rod = getBestLuckRod()
    if rod then
        RE_EquipHotbar:FireServer(1) -- slot 1
    end
end

local function ApplyBaitIfNeeded()
    if not Farm.AutoBait then return end
    local baitFolder = LocalPlayer2:FindFirstChild("Baits")
    if not baitFolder then return end

    for _, bait in ipairs(baitFolder:GetChildren()) do
        if bait.Value and bait.Value > 0 then
            RE_EquipHotbar:FireServer(2) -- bait slot 2
            return
        end
    end
end

-- CAST UTAMA
local BASE_X, BASE_Y = -0.75, 1

local function DoCastOnce()
    AutoEquipBestRod()
    ApplyBaitIfNeeded()

    RE_EquipHotbar:FireServer(1)
    task.wait(0.10)

    RF_Charge:InvokeServer(Workspace2:GetServerTimeNow())

    local rx = BASE_X + math.random(-300, 300) / 1e7
    local ry = BASE_Y + math.random(-300, 300) / 1e7

    RF_RequestMinigame:InvokeServer(rx, ry)
end

--========================================================
-- HANDLER EXCLAIM (Auto Fish & Blatant, beda delay + speed)
--========================================================
RE_TextEffect.OnClientEvent:Connect(function(data)
    if not data or not data.TextData then return end
    if data.TextData.EffectType ~= "Exclaim" then return end

    local char = LocalPlayer2.Character
    local head = char and char:FindFirstChild("Head")
    if not head or data.Container ~= head then return end

    -- BLATANT: metode sama, tapi delay dibagi speed
    if Farm.Blatant_Enabled then
        local baseComplete = tonumber(Farm.Blatant_CompleteDelay) or 1.1
        local baseReel     = tonumber(Farm.Blatant_ReelDelay)     or 1.9
        local spd          = tonumber(Farm.Blatant_SpeedMultiplier) or 1

        if spd < 1 then spd = 1 end

        local completeDelay = baseComplete / spd
        local reelDelay     = baseReel     / spd

        if completeDelay < 0 then completeDelay = 0 end
        if reelDelay     < 0 then reelDelay     = 0 end

        task.delay(completeDelay, function()
            if not Farm.Blatant_Enabled then return end
            RE_FishingCompleted:FireServer()

            -- setelah tarik ikan, tunggu ReelDelay lalu cast lagi
            task.delay(reelDelay, function()
                if Farm.Blatant_Enabled then
                    DoCastOnce()
                end
            end)
        end)

        return
    end

    -- AUTO FISH: delay legit, sekali complete
    if Farm.AutoFish_Enabled then
        task.delay(LEGIT_COMPLETE_DELAY, function()
            if Farm.AutoFish_Enabled then
                RE_FishingCompleted:FireServer()
            end
        end)
    end
end)

--========================================================
-- LOOP FARM HANYA UNTUK AUTO FISH (Blatant pakai event Exclaim)
--========================================================

local autoFishThread = nil

local function StopAutoFishLoop()
    if autoFishThread then
        task.cancel(autoFishThread)
        autoFishThread = nil
    end
end

local function AutoFish_Normal_Step()
    DoCastOnce()
    task.wait(Farm.AutoFish_ReelDelay)
end

local function StartAutoFishLoop()
    StopAutoFishLoop()
    if not Farm.AutoFish_Enabled then return end

    autoFishThread = task.spawn(function()
        while Farm.AutoFish_Enabled do
            AutoFish_Normal_Step()
            task.wait(0.01)
        end
        autoFishThread = nil
    end)
end

--========================================================
-- UI: FARM
--========================================================

PageFarm:CreateLabel("AUTO FISH MODE")

PageFarm:CreateToggle("Auto Fish", "Mode normal (pakai Exclaim, lebih aman)", function(on)
    Farm.AutoFish_Enabled = on

    if on and Farm.Blatant_Enabled then
        Farm.Blatant_Enabled = false
    end

    if on then
        StartAutoFishLoop()
    else
        StopAutoFishLoop()
    end
end)

PageFarm:CreateBox("Reel Delay (Auto Fish)", "Delay antar cast mode legit", function(txt)
    local num = tonumber(txt)
    if num and num > 0 then
        Farm.AutoFish_ReelDelay = num
    end
end)

-- Group Blatant
PageFarm:CreateLabel("BLATANT MODE (FAST FISHING)")

PageFarm:CreateToggle("Blatant Mode", "Very fast fishing mode (metode sama, delay + speed)", function(on)
    Farm.Blatant_Enabled = on

    if on and Farm.AutoFish_Enabled then
        Farm.AutoFish_Enabled = false
        StopAutoFishLoop()
    end

    if on then
        DoCastOnce()
    end
end)

PageFarm:CreateBox("Reel Delay (Blatant)", "Delay dasar sebelum restart loop (sebelum dibagi speed)", function(txt)
    local num = tonumber(txt)
    if num and num > 0 then
        Farm.Blatant_ReelDelay = num
    end
end)

PageFarm:CreateBox("Custom Complete Delay", "Delay dasar setelah ! (sebelum dibagi speed)", function(txt)
    local num = tonumber(txt)
    if num and num >= 0 then
        Farm.Blatant_CompleteDelay = num
    end
end)

-- Slider speed multiplier: 1x - 10x
local sliderSpeed = PageFarm:CreateSlider("Blatant Speed (x)", 1, 10, function(val)
    Farm.Blatant_SpeedMultiplier = math.floor(val)
end)
sliderSpeed:Set(Farm.Blatant_SpeedMultiplier)

PageFarm:CreateButton("Cancel Fishing", "Use this if you're stuck", function()
    DoCastOnce()
end)

-- Utility
PageFarm:CreateLabel("UTILITY")

PageFarm:CreateToggle("Auto Bait", "Pakai bait otomatis", function(on)
    Farm.AutoBait = on
end)

PageFarm:CreateToggle("Auto Best Luck Rod", "Rod luck tertinggi otomatis", function(on)
    Farm.AutoBestRod = on
end)
