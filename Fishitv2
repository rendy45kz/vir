--[[ 
AegisHub • Fish It • Premium (UI Polished + Menu Icons + Auto Islands)
- UI Library (Blue, Compact, Adaptive Scale, Persistent Overlay)
- Rail “Sections” pakai ikon
- Dropdown rapi (auto-size, no scrollbar), card auto-tinggi
- Teleport Island: AUTO-DETECT dari dunia (tanpa daftar hard-coded) dan auto-refresh
- Fitur: Fishing V1/V2, Inventory, Shop, Teleport (Island/NPC/Player), Event
]]

if not game:IsLoaded() then game.Loaded:Wait() end

----------------------------------------------------------------
-- ================== UI LIBRARY (Polished v3) =================
----------------------------------------------------------------
local ACCENT      = Color3.fromRGB(110,175,255)
local ACCENT_TEXT = Color3.fromRGB(227,229,255)
local BG_DARK     = Color3.fromRGB(42,44,56)
local BG_CARD     = Color3.fromRGB(30,31,41)
local UIS         = game:GetService("UserInputService")
local TS          = game:GetService("TweenService")
local CoreGui     = game:GetService("CoreGui")

local function protect(inst) pcall(function() if syn and syn.protect_gui then syn.protect_gui(inst) end end) end
local function tw(o,t,props) local a=TS:Create(o,TweenInfo.new(t,Enum.EasingStyle.Quad,Enum.EasingDirection.Out),props); a:Play(); return a end

local library = {}
function library:CreateWindow(name, version, icon)
    name,version,icon = name or "AegisHub", version or "Premium", icon or 10044538000

    local Gui = Instance.new("ScreenGui")
    protect(Gui); Gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling; Gui.IgnoreGuiInset = false
    Gui.Parent = CoreGui

    local function calcScale()
        local vp = workspace.CurrentCamera and workspace.CurrentCamera.ViewportSize or Vector2.new(1280,720)
        local shortest = math.min(vp.X, vp.Y)
        if shortest <= 720 then return 0.85 elseif shortest <= 900 then return 0.92 else return 1 end
    end
    local SCALE = calcScale()

    local Overlay = Instance.new("ImageButton")
    Overlay.Name="AegisHubOverlay"; Overlay.Parent=Gui
    Overlay.Size=UDim2.fromOffset(40,40)
    Overlay.BackgroundColor3=Color3.fromRGB(32,34,46); Overlay.Image="rbxassetid://10045753138"; Overlay.ImageColor3=ACCENT
    Instance.new("UICorner",Overlay).CornerRadius=UDim.new(1,0)
    local ox = Gui:GetAttribute("ovx") or 12
    local oy = Gui:GetAttribute("ovy") or math.floor((workspace.CurrentCamera.ViewportSize.Y/2)-20)
    Overlay.Position = UDim2.fromOffset(ox, oy)
    do
        local dragging, start, origin
        Overlay.InputBegan:Connect(function(i)
            if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then
                dragging=true; start=i.Position; origin=Overlay.Position
                i.Changed:Connect(function() if i.UserInputState==Enum.UserInputState.End then
                    dragging=false
                    Gui:SetAttribute("ovx", Overlay.Position.X.Offset)
                    Gui:SetAttribute("ovy", Overlay.Position.Y.Offset)
                end end)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then
                local d=i.Position-start
                local nx = math.clamp(origin.X.Offset + d.X, 4, workspace.CurrentCamera.ViewportSize.X-44)
                local ny = math.clamp(origin.Y.Offset + d.Y, 4, workspace.CurrentCamera.ViewportSize.Y-44)
                Overlay.Position = UDim2.fromOffset(nx, ny)
            end
        end)
    end

    local Window = Instance.new("Frame")
    protect(Window); Window.Parent=Gui; Window.BackgroundColor3=BG_DARK; Window.ClipsDescendants=false
    Window.Size=UDim2.fromOffset(math.floor(520*SCALE), math.floor(320*SCALE))
    Window.Position=UDim2.new(.5, -Window.Size.X.Offset/2, .52, -Window.Size.Y.Offset/2)
    Instance.new("UICorner",Window).CornerRadius=UDim.new(0,6)

    local Title=Instance.new("Frame",Window); Title.BackgroundTransparency=1; Title.Size=UDim2.new(1,0,0,math.floor(30*SCALE))
    local Icon=Instance.new("ImageLabel",Title); Icon.BackgroundTransparency=1; Icon.Size=UDim2.fromOffset(math.floor(18*SCALE),math.floor(18*SCALE))
    Icon.Position=UDim2.new(0,8,0,6); Icon.Image="rbxassetid://"..tostring(icon); Icon.ImageColor3=ACCENT
    local TitleText=Instance.new("TextLabel",Title); TitleText.BackgroundTransparency=1
    TitleText.Position=UDim2.new(0,30,0,0); TitleText.Size=UDim2.new(1,-30,1,0)
    TitleText.Font=Enum.Font.GothamMedium; TitleText.TextSize=math.floor(12*SCALE); TitleText.TextXAlignment=Enum.TextXAlignment.Left
    TitleText.TextColor3=Color3.new(1,1,1); TitleText.Text=("%s • %s"):format(name,version)
    local Under=Instance.new("Frame",Title); Under.BorderSizePixel=0; Under.BackgroundColor3=ACCENT
    Under.Size=UDim2.new(1,0,0,1); Under.Position=UDim2.new(0,0,1,0)

    do local dragging,start,origin
        Title.InputBegan:Connect(function(i)
            if (i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch) and not UIS:GetFocusedTextBox() then
                dragging=true; start=i.Position; origin=Window.Position
                i.Changed:Connect(function() if i.UserInputState==Enum.UserInputState.End then dragging=false end end)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then
                local d=i.Position-start; Window.Position=UDim2.new(origin.X.Scale,origin.X.Offset+d.X,origin.Y.Scale,origin.Y.Offset+d.Y)
            end
        end)
    end

    local hidden=false
    Overlay.MouseButton1Click:Connect(function()
        hidden=not hidden; Window.Visible=not hidden
        tw(Overlay,.12,{ImageColor3 = hidden and Color3.fromRGB(200,200,200) or ACCENT})
    end)

    local TabsRail=Instance.new("Frame",Window); TabsRail.BackgroundColor3=Color3.fromRGB(39,40,51)
    TabsRail.Position=UDim2.new(0,6,0,math.floor(36*SCALE)); TabsRail.Size=UDim2.new(0,math.floor(136*SCALE),1,-math.floor(42*SCALE))
    Instance.new("UICorner",TabsRail).CornerRadius=UDim.new(0,6)
    local trlbl=Instance.new("TextLabel",TabsRail); trlbl.BackgroundTransparency=1; trlbl.Size=UDim2.new(1,-8,0,math.floor(22*SCALE)); trlbl.Position=UDim2.new(0,8,0,0)
    trlbl.Font=Enum.Font.GothamBlack; trlbl.Text="Sections"; trlbl.TextSize=math.floor(11*SCALE); trlbl.TextXAlignment=Enum.TextXAlignment.Left; trlbl.TextColor3=Color3.new(1,1,1)
    local trlist=Instance.new("UIListLayout",TabsRail); trlist.Padding=UDim.new(0,math.floor(4*SCALE)); trlist.SortOrder=Enum.SortOrder.LayoutOrder; trlist.HorizontalAlignment=Enum.HorizontalAlignment.Right

    local firstShown=false
    local TabsAPI={}
    function TabsAPI:CreateFrame(title, iconId)
        title = title or "Page"

        local Page=Instance.new("ScrollingFrame",Window)
        Page.Name="Page"; Page.Active=true; Page.ScrollBarThickness=4; Page.ScrollBarImageColor3=ACCENT
        Page.AutomaticCanvasSize=Enum.AutomaticSize.Y; Page.CanvasSize=UDim2.fromOffset(0,0)
        Page.BackgroundColor3=BG_DARK
        Page.Position=UDim2.new(0,math.floor(150*SCALE),0,math.floor(36*SCALE))
        Page.Size=UDim2.new(1,-math.floor(156*SCALE),1,-math.floor(42*SCALE))
        Page.Visible=false
        Instance.new("UICorner",Page).CornerRadius=UDim.new(0,6)
        local pad=Instance.new("UIPadding",Page); pad.PaddingTop=UDim.new(0,math.floor(6*SCALE)); pad.PaddingLeft=UDim.new(0,math.floor(6*SCALE)); pad.PaddingRight=UDim.new(0,math.floor(6*SCALE)); pad.PaddingBottom=UDim.new(0,math.floor(6*SCALE))
        local vlist=Instance.new("UIListLayout",Page); vlist.Padding=UDim.new(0,math.floor(6*SCALE)); vlist.SortOrder=Enum.SortOrder.LayoutOrder; vlist.HorizontalAlignment=Enum.HorizontalAlignment.Center

        local TabBtn=Instance.new("TextButton",TabsRail)
        TabBtn.BackgroundTransparency=1
        TabBtn.Size=UDim2.new(1,-8,0,math.floor(18*SCALE))
        TabBtn.Font=Enum.Font.Gotham
        TabBtn.TextSize=math.floor(11*SCALE)
        TabBtn.TextColor3=Color3.new(1,1,1)
        TabBtn.TextTransparency=.5
        TabBtn.TextXAlignment = Enum.TextXAlignment.Left
        TabBtn.Text = "      "..title

        local IconImg = Instance.new("ImageLabel", TabBtn)
        IconImg.BackgroundTransparency = 1
        IconImg.Size = UDim2.fromOffset(math.floor(14*SCALE), math.floor(14*SCALE))
        IconImg.Position = UDim2.new(0, 2, 0, math.floor(2*SCALE))
        IconImg.Image = "rbxassetid://"..tostring(iconId or 10044538000)
        IconImg.ImageColor3 = ACCENT

        local indicator=Instance.new("Frame",TabBtn); indicator.BackgroundColor3=ACCENT; indicator.Size=UDim2.new(0,2,1,-4)
        indicator.Position=UDim2.new(0,-8,0,2); indicator.BorderSizePixel=0; indicator.Visible=false

        local function selectThis()
            indicator.Visible=true
            for _,v in ipairs(Window:GetChildren()) do if v:IsA("ScrollingFrame") and v.Name=="Page" then v.Visible=false end end
            for _,v in ipairs(TabsRail:GetChildren()) do if v:IsA("TextButton") then v.TextTransparency=.5 end end
            TabBtn.TextTransparency=0; Page.Visible=true
        end
        TabBtn.MouseButton1Click:Connect(selectThis)
        if not firstShown then firstShown=true; selectThis() end

        local function Card(baseH)
            local fr=Instance.new("Frame",Page)
            fr.BackgroundColor3=BG_CARD
            fr.Size=UDim2.new(1,0,0,math.floor((baseH or 40)*SCALE))
            fr.AutomaticSize = Enum.AutomaticSize.Y
            fr.ClipsDescendants=false
            Instance.new("UICorner",fr).CornerRadius=UDim.new(0,6)
            return fr
        end

        local PageAPI={}
        function PageAPI:CreateLabel(text)
            local fr=Card(24)
            local lb=Instance.new("TextLabel",fr); lb.BackgroundTransparency=1; lb.Position=UDim2.new(0,8,0,0); lb.Size=UDim2.new(1,-8,1,0)
            lb.Font=Enum.Font.Gotham; lb.TextSize=math.floor(11*SCALE); lb.TextXAlignment=Enum.TextXAlignment.Left; lb.TextColor3=Color3.new(1,1,1); lb.Text=text or "Label"
            return { UpdateLabel=function(_,t) lb.Text=t end }
        end
        function PageAPI:CreateButton(name,desc,cb)
            cb=cb or function() end
            local fr=Card(42)
            local t=Instance.new("TextLabel",fr); t.BackgroundTransparency=1; t.Position=UDim2.new(0,8,0,2); t.Size=UDim2.new(1,-8,0,math.floor(18*SCALE))
            t.Font=Enum.Font.GothamBlack; t.TextSize=math.floor(11*SCALE); t.TextColor3=Color3.new(1,1,1); t.Text=name or "Button"
            local d=Instance.new("TextLabel",fr); d.BackgroundTransparency=1; d.Position=UDim2.new(0,8,0,math.floor(20*SCALE)); d.Size=UDim2.new(1,-8,0,math.floor(16*SCALE))
            d.Font=Enum.Font.Gotham; d.TextSize=math.floor(11*SCALE); d.TextColor3=Color3.fromRGB(170,170,170); d.TextXAlignment=Enum.TextXAlignment.Left; d.Text=desc or ""
            local hit=Instance.new("TextButton",fr); hit.BackgroundTransparency=1; hit.Size=UDim2.new(1,0,1,0); hit.Text=""; hit.MouseButton1Click:Connect(cb)
            return {}
        end
        function PageAPI:CreateToggle(title,desc,cb)
            cb=cb or function() end
            local fr=Card(42)
            local t=Instance.new("TextLabel",fr); t.BackgroundTransparency=1; t.Position=UDim2.new(0,8,0,2); t.Size=UDim2.new(1,-52,0,math.floor(18*SCALE))
            t.Font=Enum.Font.GothamBlack; t.TextSize=math.floor(11*SCALE); t.TextColor3=Color3.new(1,1,1); t.Text=title or "Toggle"
            local d=Instance.new("TextLabel",fr); d.BackgroundTransparency=1; d.Position=UDim2.new(0,8,0,math.floor(20*SCALE)); d.Size=UDim2.new(1,-52,0,math.floor(16*SCALE))
            d.Font=Enum.Font.Gotham; d.TextSize=math.floor(11*SCALE); d.TextColor3=Color3.fromRGB(170,170,170); d.Text=desc or ""; d.TextXAlignment=Enum.TextXAlignment.Left
            local knob=Instance.new("Frame",fr); knob.Size=UDim2.fromOffset(math.floor(34*SCALE),math.floor(18*SCALE)); knob.Position=UDim2.new(1,-math.floor(42*SCALE),0,math.floor(12*SCALE))
            knob.BackgroundColor3=Color3.fromRGB(20,20,24); Instance.new("UICorner",knob).CornerRadius=UDim.new(1,0)
            local dot=Instance.new("Frame",knob); dot.Size=UDim2.fromOffset(math.floor(14*SCALE),math.floor(14*SCALE)); dot.Position=UDim2.new(0,2,0,2)
            dot.BackgroundColor3=ACCENT; dot.BackgroundTransparency=1; Instance.new("UICorner",dot).CornerRadius=UDim.new(1,0)
            local btn=Instance.new("TextButton",fr); btn.BackgroundTransparency=1; btn.Size=UDim2.new(1,0,1,0); btn.Text=""
            local on=false
            btn.MouseButton1Click:Connect(function()
                on=not on
                tw(dot,.12,{BackgroundTransparency=on and 0 or 1, Position=on and UDim2.new(1,-math.floor(16*SCALE),0,2) or UDim2.new(0,2,0,2)})
                task.spawn(function() cb(on) end)
            end)
            return { Set=function(_,v) if v~=on then btn:MouseButton1Click() end end }
        end
        function PageAPI:CreateBox(placeholder,iconId,cb)
            cb=cb or function() end
            local fr=Card(32)
            local ic=Instance.new("ImageLabel",fr); ic.BackgroundTransparency=1; ic.Size=UDim2.fromOffset(math.floor(18*SCALE),math.floor(18*SCALE))
            ic.Position=UDim2.new(0,8,0,7); ic.Image="rbxassetid://"..tostring(iconId or 10045753138); ic.ImageColor3=ACCENT
            local tb=Instance.new("TextBox",fr); tb.BackgroundTransparency=1; tb.Position=UDim2.new(0,30,0,0); tb.Size=UDim2.new(1,-34,1,0)
            tb.ClearTextOnFocus = false; tb.Text = ""
            tb.Font=Enum.Font.Gotham; tb.TextSize=math.floor(11*SCALE); tb.TextColor3=Color3.new(1,1,1)
            tb.PlaceholderText=placeholder or ""; tb.PlaceholderColor3=ACCENT_TEXT
            tb.FocusLost:Connect(function() cb(tb.Text) end)
            return { SetText=function(_,t) tb.Text=t or "" end }
        end
        function PageAPI:CreateDropdown(title, options, onChanged)
            options=options or {}; onChanged=onChanged or function() end
            local fr=Card(32); fr.Name="Dropdown"

            local header=Instance.new("TextButton",fr)
            header.BackgroundColor3 = BG_CARD; header.AutoButtonColor  = true
            header.Size=UDim2.new(1,0,0,math.floor(32*SCALE)); header.Text=""
            Instance.new("UICorner",header).CornerRadius=UDim.new(0,6)

            local ttl=Instance.new("TextLabel",header); ttl.BackgroundTransparency=1
            ttl.Position=UDim2.new(0,8,0,0); ttl.Size=UDim2.new(1,-40,1,0)
            ttl.Font=Enum.Font.GothamBlack; ttl.TextSize=math.floor(11*SCALE); ttl.TextColor3=Color3.new(1,1,1); ttl.Text=title

            local caret=Instance.new("TextLabel",header); caret.BackgroundTransparency=1
            caret.Size=UDim2.fromOffset(math.floor(16*SCALE),math.floor(16*SCALE)); caret.Position=UDim2.new(1,-math.floor(22*SCALE),0,math.floor(8*SCALE))
            caret.Font=Enum.Font.GothamBlack; caret.Text="▼"; caret.TextSize=math.floor(11*SCALE); caret.TextColor3=ACCENT

            local holder=Instance.new("Frame",fr)
            holder.BackgroundColor3=Color3.fromRGB(26,26,32)
            holder.Position=UDim2.new(0,0,0,math.floor(36*SCALE))
            holder.Size=UDim2.new(1,0,0,0)
            holder.AutomaticSize = Enum.AutomaticSize.Y
            holder.Visible=false
            Instance.new("UICorner",holder).CornerRadius=UDim.new(0,6)
            local lv=Instance.new("UIListLayout",holder); lv.Padding=UDim.new(0,2)
            local pad=Instance.new("UIPadding",holder); pad.PaddingTop=UDim.new(0,4); pad.PaddingBottom=UDim.new(0,4); pad.PaddingLeft=UDim.new(0,4); pad.PaddingRight=UDim.new(0,4)

            local current=nil
            local ROWH = math.floor(22*SCALE)
            local function rebuild(list)
                for _,c in ipairs(holder:GetChildren()) do if c:IsA("TextButton") then c:Destroy() end end
                for _,opt in ipairs(list) do
                    local b=Instance.new("TextButton",holder)
                    b.Size=UDim2.new(1,0,0,ROWH)
                    b.BackgroundColor3=BG_CARD
                    b.Text=opt; b.Font=Enum.Font.Gotham; b.TextSize=math.floor(11*SCALE); b.TextColor3=Color3.new(1,1,1)
                    Instance.new("UICorner",b).CornerRadius=UDim.new(0,6)
                    b.MouseButton1Click:Connect(function()
                        current=opt; ttl.Text=("%s : %s"):format(title,opt); onChanged(opt)
                        holder.Visible=false; tw(caret,.12,{Rotation=0})
                    end)
                end
            end
            rebuild(options)

            local open=false
            header.MouseButton1Click:Connect(function()
                open = not open; holder.Visible = open
                tw(caret,.12,{Rotation=open and 180 or 0})
            end)

            return {
                SetValue   = function(_,v) current=v; ttl.Text=("%s : %s"):format(title,tostring(v)) end,
                GetValue   = function() return current end,
                SetOptions = function(_,opts) rebuild(opts or {}) end
            }
        end

        return PageAPI
    end

    local winAPI={}
    function winAPI:CreateTab(_) return setmetatable({}, { __index = TabsAPI }) end
    return winAPI
end

----------------------------------------------------------------
-- ======================= PREMIUM SCRIPT ======================
----------------------------------------------------------------
local Players            = game:GetService("Players")
local LocalPlayer        = Players.LocalPlayer
local RS                 = game:GetService("RunService")
local TeleportService    = game:GetService("TeleportService")
local VirtualUser        = game:GetService("VirtualUser")
local ReplicatedStorage  = game:GetService("ReplicatedStorage")
local Workspace          = game:GetService("Workspace")

local TARGET_PLACE = 121864768012064

-- Anti AFK ON
LocalPlayer.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    task.wait(.7); VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
end)

-- State
local state={AFon=false,AFfishing=false,blatant=false,instant=false,perfectCast=true,autoRecast=true,idleDelay=3,
             floating=false,floatForce=Vector3.new(0,35,0),SPEED=5,reelPreset=1.2,completePreset=2.5,
             reelOverride=nil,completeOverride=nil,autoSellAll=false,lastSell=0,autoSellEvery=45,
             sellCustomAmount=0,coughSellAmount=0,lastAction=os.clock()}
local function clamp(n,a,b) return math.max(a,math.min(b,n)) end
local function effDelays()
    if state.blatant then local c=(state.completeOverride or .4); local r=(state.reelOverride or .18); return clamp(c,.15,12),clamp(r,.10,6) end
    local c=(state.completeOverride or state.completePreset)/state.SPEED
    local r=(state.reelOverride or state.reelPreset)/state.SPEED
    return clamp(c,.35,12),clamp(r,.15,6)
end

-- Remotes/modules
local net,RF_ChargeFishingRod,RF_RequestMinigame,RE_FishingCompleted,RE_EquipHotbar,RE_RepText,RF_SellAll
local animator,AIdle,AReel,AShake
local Replion,ItemUtility

task.spawn(function()
    local function gw(o,n,t) return o:FindFirstChild(n) or o:WaitForChild(n,t or 10) end
    local okNet,mod=pcall(function() local p=gw(ReplicatedStorage,"Packages",10); p=gw(p,"_Index",10); p=gw(p,"sleitnick_net@0.2.0",10); return gw(p,"net",10) end)
    if okNet then net=mod
        RF_ChargeFishingRod=net:FindFirstChild("RF/ChargeFishingRod")
        RF_RequestMinigame=net:FindFirstChild("RF/RequestFishingMinigameStarted")
        RE_FishingCompleted=net:FindFirstChild("RE/FishingCompleted")
        RE_EquipHotbar=net:FindFirstChild("RE/EquipToolFromHotbar")
        RE_RepText=net:FindFirstChild("RE/ReplicateTextEffect")
        RF_SellAll=net:FindFirstChild("RF/SellAllItems")
    end
    local char=LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hum=char:WaitForChild("Humanoid"); animator=hum:FindFirstChildOfClass("Animator") or Instance.new("Animator",hum)
    local okI,I=pcall(function() return ReplicatedStorage.Modules.Animations.FishingRodReelIdle end)
    local okR,R=pcall(function() return ReplicatedStorage.Modules.Animations.EasyFishReelStart end)
    local okS,S=pcall(function() return ReplicatedStorage.Modules.Animations.CastFromFullChargePosition1Hand end)
    AIdle=okI and animator:LoadAnimation(I) or nil; AReel=okR and animator:LoadAnimation(R) or nil; AShake=okS and animator:LoadAnimation(S) or nil
    local okRp,modRp=pcall(function() return require(ReplicatedStorage:WaitForChild("Packages"):WaitForChild("replion")) end)
    if okRp then Replion=modRp end
    local okU,modU=pcall(function() return require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("ItemUtility")) end)
    if okU then ItemUtility=modU end
end)

-- Rod helpers
local RodDelays={["Ares Rod"]={custom=1.12,bypass=1.45},["Angler Rod"]={custom=1.12,bypass=1.45},["Ghostfinn Rod"]={custom=1.12,bypass=1.45},
["Astral Rod"]={custom=1.90,bypass=1.45},["Chrome Rod"]={custom=2.30,bypass=2.00},["Steampunk Rod"]={custom=2.50,bypass=2.30},
["Lucky Rod"]={custom=3.50,bypass=3.60},["Midnight Rod"]={custom=3.30,bypass=3.40},["Demascus Rod"]={custom=3.90,bypass=3.80},
["Grass Rod"]={custom=3.80,bypass=3.90},["Luck Rod"]={custom=4.20,bypass=4.10},["Carbon Rod"]={custom=4.00,bypass=3.80},
["Lava Rod"]={custom=4.20,bypass=4.10},["Starter Rod"]={custom=4.30,bypass=4.20},}
local function getEquippedRodName()
    local pg=LocalPlayer:FindFirstChild("PlayerGui"); local display=pg and pg:FindFirstChild("Backpack") and pg.Backpack:FindFirstChild("Display")
    if not display then return nil end
    for _,tile in ipairs(display:GetChildren()) do local ok,lbl=pcall(function() return tile.Inner.Tags.ItemName end)
        if ok and lbl and lbl:IsA("TextLabel") and RodDelays[lbl.Text] then return lbl.Text end end
    return nil
end
local function refreshRodDelays() local rod=getEquippedRodName()
    if rod and RodDelays[rod] then state.completePreset=RodDelays[rod].custom; state.reelPreset=RodDelays[rod].bypass else state.completePreset=10; state.reelPreset=1 end end

-- Floating
local floatBV
local function setFloating(on)
    state.floating=on; local char=LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait(); local hrp=char:FindFirstChild("HumanoidRootPart")
    if on and hrp then floatBV=floatBV or Instance.new("BodyVelocity"); floatBV.MaxForce=Vector3.new(0,1e5,0); floatBV.Velocity=state.floatForce; floatBV.Parent=hrp
    else if floatBV then floatBV:Destroy(); floatBV=nil end end
end

-- Auto-finish
task.spawn(function()
    repeat task.wait() until RE_RepText
    if not RE_RepText then return end
    RE_RepText.OnClientEvent:Connect(function(d)
        if not (state.AFon and state.AFfishing) then return end
        if not (d and d.TextData and d.TextData.EffectType=="Exclaim") then return end
        if state.instant then pcall(function() if RE_FishingCompleted then RE_FishingCompleted:FireServer() end end); return end
        task.spawn(function() local _,r=effDelays(); task.wait(r); pcall(function() if RE_FishingCompleted then RE_FishingCompleted:FireServer() end end) end)
    end)
end)

-- Fishing
local function castOnce()
    state.AFfishing=true
    if RE_EquipHotbar then RE_EquipHotbar:FireServer(1) end
    task.wait(.02); if RF_ChargeFishingRod then RF_ChargeFishingRod:InvokeServer(workspace:GetServerTimeNow()) end
    task.wait(state.blatant and .05 or .20); if AShake then AShake:Play() end
    pcall(function() if RF_ChargeFishingRod then RF_ChargeFishingRod:InvokeServer(workspace:GetServerTimeNow()) end end)
    local bx,by=-0.7499996423721313,1; local x,y
    if state.perfectCast then x=bx+(math.random(-500,500)/1e7); y=by+(math.random(-500,500)/1e7) else x=math.random(-1000,1000)/1000; y=math.random(0,1000)/1000 end
    if AIdle then AIdle:Play() end; if RF_RequestMinigame then RF_RequestMinigame:InvokeServer(x,y) end
    state.lastAction=os.clock()
end
function StartAutoFish()
    if state.AFon then return end; state.AFon=true; refreshRodDelays()
    task.spawn(function()
        while state.AFon do
            pcall(function()
                castOnce(); local c,r=effDelays(); local waitTime = state.instant and .05 or c
                local t0=os.clock()
                while os.clock()-t0<waitTime do
                    if state.autoRecast and (os.clock()-state.lastAction)>state.idleDelay then castOnce(); t0=os.clock() end
                    task.wait(.02)
                end
                task.wait(state.instant and .03 or r); state.AFfishing=false; refreshRodDelays()
            end)
            task.wait(state.blatant and .01 or .05)
        end
    end)
end
function StopAutoFish() state.AFon=false; state.AFfishing=false; pcall(function() if AIdle then AIdle:Stop() end; if AReel then AReel:Stop() end; if AShake then AShake:Stop() end end) end

-- Inventory helpers
local function eachInventory(fn)
    if not Replion then return end
    local Data=Replion.Client:WaitReplion("Data"); local items=Data and Data:Get({"Inventory","Items"})
    if type(items)~="table" then return end; for _,it in ipairs(items) do fn(it) end
end
local function setFavByPredicate(pred,fav)
    if not (Replion and ItemUtility) then return end
    eachInventory(function(it)
        local base=ItemUtility:GetItemData(it.Id); local name=(base and base.Data and tostring(base.Data.Name)) or ""
        if pred(it,name) then it.Favorited=fav end
    end)
end
local function SellAll() if RF_SellAll then pcall(function() RF_SellAll:InvokeServer() end) end end
task.spawn(function() while true do if state.autoSellAll and (os.time()-state.lastSell)>=state.autoSellEvery then SellAll(); state.lastSell=os.time() end task.wait(3) end end)
local function sellAnyAmount(n)
    if n<=0 then return end; setFavByPredicate(function() return true end,true)
    local left=n; eachInventory(function(it) if left>0 and it.Favorited then it.Favorited=false; left=left-(it.Count or 1) end end)
    SellAll(); setFavByPredicate(function() return true end,true)
end
local function sellCoughAmount(n)
    if n<=0 then return end
    setFavByPredicate(function(_,name) return not string.find(string.lower(name),"cough") end,true)
    local left=n
    setFavByPredicate(function(it,name)
        if left<=0 then return false end
        if string.find(string.lower(name),"cough") and it.Favorited then it.Favorited=false; left=left-(it.Count or 1); return true end
        return false
    end,false)
    SellAll(); setFavByPredicate(function() return true end,true)
end

-- Teleport core
local function tpTo(pos)
    local cf=Workspace:FindFirstChild("Characters"); local ch=cf and cf:FindFirstChild(LocalPlayer.Name)
    local hrp=ch and (ch:FindFirstChild("HumanoidRootPart") or ch:WaitForChild("HumanoidRootPart",2))
    if hrp and pos then hrp.CFrame=CFrame.new(pos+Vector3.new(0,4,0)) end
end

-- ===================== AUTO-DETECT ISLANDS ====================
-- Membangun index pulau dari dunia secara generik:
-- 1) Cari ProximityPrompt yang mengandung kata kunci “island/reef/shore/…”
-- 2) Juga cari Model besar yang namanya mengandung kata kunci; pos = center (GetBoundingBox)
local ISLAND_KEYWORDS = {
    "island","shore","reef","volcano","depth","grove","cove","caves","hall","statue",
    "winter","tropical","treasure","weather","stingray","coral","crater","lost","esoteric","kohana"
}

local function _titlecase(s)
    s = tostring(s or "")
    return (s:gsub("(%a)([%w_']*)", function(a,b) return a:upper()..b:lower() end))
end

local function _containsIslandWord(txt)
    txt = string.lower(tostring(txt or ""))
    for _,kw in ipairs(ISLAND_KEYWORDS) do
        if string.find(txt, kw) then return true end
    end
    return false
end

local function _dedupeInsert(map, name, pos)
    if not (name and pos) then return end
    if not map[name] then map[name] = pos end
end

local function scanIslands()
    local found = {}

    -- (A) dari ProximityPrompt (biasanya dekat dock/teleporter)
    for _,d in ipairs(Workspace:GetDescendants()) do
        if d:IsA("ProximityPrompt") then
            local label = ((d.ObjectText or "").." "..(d.ActionText or ""))
            local parentName = (d.Parent and d.Parent.Name) or ""
            local combined = label ~= "" and label or parentName
            if _containsIslandWord(combined) then
                local part = d.Parent and (d.Parent:IsA("BasePart") and d.Parent or d.Parent:FindFirstChildWhichIsA("BasePart"))
                if not part and d.Parent and d.Parent.Parent then
                    local pp = d.Parent.Parent
                    if pp:IsA("BasePart") then part = pp else part = pp:FindFirstChildWhichIsA("BasePart") end
                end
                local nice = _titlecase(string.match(combined, "[%a%s]+") or parentName)
                if part then _dedupeInsert(found, nice, part.Position) end
            end
        end
    end

    -- (B) dari Model besar bernama pulau
    for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and _containsIslandWord(m.Name) then
            local cf,size = m:GetBoundingBox()
            if size.Magnitude > 150 then  -- kira-kira ukuran area
                _dedupeInsert(found, _titlecase(m.Name), cf.Position)
            end
        end
    end

    -- hasil berupa list terurut dan map
    local list = {}
    for name,_ in pairs(found) do table.insert(list, name) end
    table.sort(list)
    return list, found
end

----------------------------------------------------------------
-- ========================= UI BUILD ==========================
----------------------------------------------------------------
local UI = library:CreateWindow("AegisHub • Fish It","Premium",10044538000)
local Tab = UI:CreateTab("Sections")

local ICONS = {
  ["Fishing V1"] = 6031091002,
  ["Fishing V2"] = 6031091002,
  ["Inventory"]  = 6031068429,
  ["Shop"]       = 6031265976,
  ["Teleport"]   = 6035190846,
  ["Event"]      = 6034509993,
}

local PageV1    = Tab:CreateFrame("Fishing V1", ICONS["Fishing V1"])
local PageV2    = Tab:CreateFrame("Fishing V2", ICONS["Fishing V2"])
local PageInv   = Tab:CreateFrame("Inventory",  ICONS["Inventory"])
local PageShop  = Tab:CreateFrame("Shop",       ICONS["Shop"])
local PageTP    = Tab:CreateFrame("Teleport",   ICONS["Teleport"])
local PageEvent = Tab:CreateFrame("Event",      ICONS["Event"])

-- V1
local Live = PageV1:CreateLabel("Rod: ?  • Reel: -  • Cmpl: -  • Mode: normal")
PageV1:CreateToggle("Blatant Mode","Very fast fishing mode",function(v) state.blatant=v end)
PageV1:CreateBox("Reel Delay (seconds)",10044538000,function(t) state.reelOverride=tonumber(t) end)
PageV1:CreateBox("Custom Complete Delay (seconds)",10044538000,function(t) state.completeOverride=tonumber(t) end)
PageV1:CreateToggle("Start / Stop","Mulai / hentikan loop",function(v) if v then StartAutoFish() else StopAutoFish() end end)
PageV1:CreateButton("Cancel Fishing","Batalkan siklus",function() StopAutoFish() end)

-- V2
PageV2:CreateToggle("Instant Fishing","Selesaikan segera saat bite",function(v) state.instant=v end)
PageV2:CreateToggle("Perfect Cast","Akurasi maksimal",function(v) state.perfectCast=v end)
PageV2:CreateToggle("Auto Recast / Anti Stuck","Recast saat idle lama",function(v) state.autoRecast=v end)
PageV2:CreateBox("Idle Delay (detik)",10044538000,function(t) state.idleDelay = clamp(tonumber(t) or 3,0.3,20) end)
PageV2:CreateToggle("Floating","Mengambang di udara",function(v) setFloating(v) end)

-- Inventory
PageInv:CreateToggle("Auto Sell All (periodic)","Jual semua berkala",function(v) state.autoSellAll=v end)
PageInv:CreateBox("Auto Sell Input Amount",10044538000,function(t) state.sellCustomAmount=math.max(0,math.floor(tonumber(t) or 0)) end)
PageInv:CreateButton("Run: Sell Custom Amount","",function() if state.sellCustomAmount>0 then sellAnyAmount(state.sellCustomAmount) end end)
PageInv:CreateBox("Auto Sell Cough Fish (amount)",10044538000,function(t) state.coughSellAmount=math.max(0,math.floor(tonumber(t) or 0)) end)
PageInv:CreateButton("Run: Sell Cough Fish Amount","",function() if state.coughSellAmount>0 then sellCoughAmount(state.coughSellAmount) end end)
PageInv:CreateButton("Sell ALL Now","",function() SellAll() end)

-- Shop
local function fireNearestPrompt(filterFn,maxDist)
    maxDist=maxDist or 120
    local char=LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait(); local hrp=char:FindFirstChild("HumanoidRootPart"); if not hrp then return false end
    local best,dist
    for _,d in ipairs(Workspace:GetDescendants()) do
        if d:IsA("ProximityPrompt") then
            local ok,use=pcall(function() return filterFn(d) end)
            if ok and use then
                local p; if d.Parent and d.Parent:IsA("BasePart") then p=d.Parent.Position end
                if not p and d.Parent and d.Parent.Parent and d.Parent.Parent:IsA("BasePart") then p=d.Parent.Parent.Position end
                if p then local dd=(p-hrp.Position).Magnitude; if dd<=maxDist and (not dist or dd<dist) then best=d; dist=dd end end
            end
        end
    end
    if best then pcall(function() fireproximityprompt(best,5) end); return true end
    return false
end
local function openShopByKeyword(keys)
    keys=keys or {}
    return fireNearestPrompt(function(pp)
        local t=(pp.ObjectText or "").." "..(pp.ActionText or ""); t=string.lower(t)
        for _,k in ipairs(keys) do if string.find(t,string.lower(k)) then return true end end
        local n=(pp.Parent and pp.Parent.Name or ""); n=string.lower(n)
        for _,k in ipairs(keys) do if string.find(n,string.lower(k)) then return true end end
        return false
    end,200)
end

PageShop:CreateButton("Traveling Merchant","Open merchant",function() openShopByKeyword({"traveling","merchant","travelling"}) end)
PageShop:CreateButton("Bobber Shop","",function() openShopByKeyword({"bobber","shop"}) end)
PageShop:CreateButton("Rod Shop","",function() openShopByKeyword({"rod","shop"}) end)
PageShop:CreateButton("Weather Shop","",function() openShopByKeyword({"weather","shop"}) end)

-- Teleport (Islands = AUTO)
local autoIslandList, autoIslandMap = scanIslands()
local islandsDD = PageTP:CreateDropdown("Teleport Island", autoIslandList, function(choice)
    local pos = autoIslandMap[choice]; if pos then tpTo(pos) end
end)

-- refresh otomatis (jika ada island baru)
task.spawn(function()
    while true do
        task.wait(10)
        local list, map = scanIslands()
        autoIslandList, autoIslandMap = list, map
        islandsDD:SetOptions(list)
    end
end)

-- Teleport NPC (scan dinamis)
local function tpTo(pos) -- redefine local for this scope too (safe)
    local cf=Workspace:FindFirstChild("Characters"); local ch=cf and cf:FindFirstChild(LocalPlayer.Name)
    local hrp=ch and (ch:FindFirstChild("HumanoidRootPart") or ch:WaitForChild("HumanoidRootPart",2))
    if hrp and pos then hrp.CFrame=CFrame.new(pos+Vector3.new(0,4,0)) end
end
local function tpNearestModel(partial)
    local char=LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait(); local hrp=char:FindFirstChild("HumanoidRootPart"); if not hrp then return end
    local best,dist
    for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and string.find(string.lower(m.Name),string.lower(partial)) then
            local p=m:FindFirstChild("HumanoidRootPart") or m:FindFirstChildWhichIsA("BasePart")
            if p then local d=(p.Position-hrp.Position).Magnitude; if not dist or d<dist then best=p; dist=d end end
        end
    end
    if best then tpTo(best.Position) end
end
local function scanNPC()
    local s={} for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") then
            local hasHum=m:FindFirstChildOfClass("Humanoid"); local hasPrompt=false
            for _,d in ipairs(m:GetDescendants()) do if d:IsA("ProximityPrompt") then hasPrompt=true break end end
            if (hasHum or hasPrompt) and #m.Name>=3 then s[m.Name]=true end
        end
    end
    local t={} for k in pairs(s) do table.insert(t,k) end table.sort(t); return t
end
local npcDD = PageTP:CreateDropdown("Teleport NPC", scanNPC(), function(nm) if nm then tpNearestModel(nm) end end)
task.spawn(function() while true do task.wait(8) npcDD:SetOptions(scanNPC()) end end)

-- Teleport Player (dinamis)
local function playersList() local t={} for _,pl in ipairs(Players:GetPlayers()) do if pl~=LocalPlayer then table.insert(t,pl.Name) end end table.sort(t); return t end
local plDD = PageTP:CreateDropdown("Teleport Player", playersList(), function(nm)
    local p=Players:FindFirstChild(nm); if p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then tpTo(p.Character.HumanoidRootPart.Position) end
end)
Players.PlayerAdded:Connect(function() plDD:SetOptions(playersList()) end)
Players.PlayerRemoving:Connect(function() plDD:SetOptions(playersList()) end)

if game.PlaceId ~= TARGET_PLACE then
    PageTP:CreateButton("Teleport ke Fish It","Masuk ke game Fish It",function() TeleportService:Teleport(TARGET_PLACE,LocalPlayer) end)
end

-- Event
PageEvent:CreateLabel("Event Options")
PageEvent:CreateButton("Teleport to Nearest Event","",function()
    fireNearestPrompt(function(pp) local t=(pp.ObjectText or "").." "..(pp.ActionText or ""); t=string.lower(t); return string.find(t,"event") or string.find(t,"quest") or string.find(t,"challenge") end,300)
end)
PageEvent:CreateLabel("Halloween Event")
PageEvent:CreateButton("Teleport to Halloween","",function()
    fireNearestPrompt(function(pp) local t=(pp.ObjectText or "").." "..(pp.ActionText or ""); t=string.lower(t); local n=(pp.Parent and pp.Parent.Name and string.lower(pp.Parent.Name)) or ""; return string.find(t,"halloween") or string.find(n,"halloween") end,400)
end)
PageEvent:CreateButton("Tricks or Treats","",function()
    fireNearestPrompt(function(pp) local t=string.lower(pp.ActionText or ""); return string.find(t,"trick") or string.find(t,"treat") end,100)
end)

-- Live HUD
RS.RenderStepped:Connect(function()
    local rod=getEquippedRodName() or "?"
    local c,r=effDelays()
    pcall(function() if Live and Live.UpdateLabel then Live:UpdateLabel(("Rod: %s  • Reel: %.2fs  • Cmpl: %.2fs  • Mode: %s"):format(rod,r,c,state.blatant and "blatant" or "normal")) end end)
end)

-- Preset refresh on backpack change
task.spawn(function()
    local pg=LocalPlayer:WaitForChild("PlayerGui"); local display=pg:WaitForChild("Backpack"):WaitForChild("Display")
    display.ChildAdded:Connect(function() task.wait(.05) refreshRodDelays() end)
end)
