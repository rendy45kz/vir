if not game:IsLoaded() then game.Loaded:Wait() end

----------------------------------------------------------------
-- ================== UI LIBRARY (Polished v2) =================
----------------------------------------------------------------
local ACCENT      = Color3.fromRGB(110,175,255)
local ACCENT_TEXT = Color3.fromRGB(227,229,255)
local BG_DARK     = Color3.fromRGB(42,44,56)
local BG_CARD     = Color3.fromRGB(30,31,41)
local UIS         = game:GetService("UserInputService")
local TS          = game:GetService("TweenService")
local CoreGui     = game:GetService("CoreGui")

local function protect(inst) pcall(function() if syn and syn.protect_gui then syn.protect_gui(inst) end end) end
local function tw(o,t,props) local a=TS:Create(o,TweenInfo.new(t,Enum.EasingStyle.Quad,Enum.EasingDirection.Out),props); a:Play(); return a end

local library = {}
function library:CreateWindow(name, version, icon)
    name,version,icon = name or "AegisHub", version or "Premium", icon or 10044538000

    local Gui = Instance.new("ScreenGui")
    protect(Gui); Gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling; Gui.IgnoreGuiInset = false
    Gui.Parent = CoreGui

    local function calcScale()
        local vp = workspace.CurrentCamera and workspace.CurrentCamera.ViewportSize or Vector2.new(1280,720)
        local shortest = math.min(vp.X, vp.Y)
        if shortest <= 720 then return 0.85 elseif shortest <= 900 then return 0.92 else return 1 end
    end
    local SCALE = calcScale()

    -- Overlay (toggle open/close & draggable)
    local Overlay = Instance.new("ImageButton")
    Overlay.Name="AegisHubOverlay"; Overlay.Parent=Gui
    Overlay.Size=UDim2.fromOffset(40,40); Overlay.AutoButtonColor=true
    Overlay.BackgroundColor3=Color3.fromRGB(32,34,46); Overlay.Image="rbxassetid://10045753138"; Overlay.ImageColor3=ACCENT
    local oc=Instance.new("UICorner",Overlay); oc.CornerRadius=UDim.new(1,0)
    local os=Instance.new("UIStroke",Overlay); os.Transparency=.85; os.Color=Color3.fromRGB(255,255,255)
    local ox = Gui:GetAttribute("ovx") or 12
    local oy = Gui:GetAttribute("ovy") or math.floor((workspace.CurrentCamera.ViewportSize.Y/2)-20)
    Overlay.Position = UDim2.fromOffset(ox, oy)
    do
        local dragging, start, origin
        Overlay.InputBegan:Connect(function(i)
            if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then
                dragging=true; start=i.Position; origin=Overlay.Position
                i.Changed:Connect(function() if i.UserInputState==Enum.UserInputState.End then
                    dragging=false
                    Gui:SetAttribute("ovx", Overlay.Position.X.Offset)
                    Gui:SetAttribute("ovy", Overlay.Position.Y.Offset)
                end end)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then
                local d=i.Position-start
                local nx = math.clamp(origin.X.Offset + d.X, 4, workspace.CurrentCamera.ViewportSize.X-44)
                local ny = math.clamp(origin.Y.Offset + d.Y, 4, workspace.CurrentCamera.ViewportSize.Y-44)
                Overlay.Position = UDim2.fromOffset(nx, ny)
            end
        end)
    end

    -- Window
    local Window = Instance.new("Frame")
    protect(Window); Window.Parent=Gui; Window.BackgroundColor3=BG_DARK; Window.ClipsDescendants=false
    Window.Size=UDim2.fromOffset(math.floor(520*SCALE), math.floor(320*SCALE))
    Window.Position=UDim2.new(.5, -Window.Size.X.Offset/2, .52, -Window.Size.Y.Offset/2)
    local wCorner=Instance.new("UICorner",Window); wCorner.CornerRadius=UDim.new(0,6)

    -- Title bar
    local Title=Instance.new("Frame",Window); Title.BackgroundTransparency=1; Title.Size=UDim2.new(1,0,0,math.floor(30*SCALE))
    local Icon=Instance.new("ImageLabel",Title); Icon.BackgroundTransparency=1; Icon.Size=UDim2.fromOffset(math.floor(18*SCALE),math.floor(18*SCALE))
    Icon.Position=UDim2.new(0,8,0,6); Icon.Image="rbxassetid://"..tostring(icon); Icon.ImageColor3=ACCENT
    local TitleText=Instance.new("TextLabel",Title); TitleText.BackgroundTransparency=1
    TitleText.Position=UDim2.new(0,30,0,0); TitleText.Size=UDim2.new(1,-30,1,0)
    TitleText.Font=Enum.Font.GothamMedium; TitleText.TextSize=math.floor(12*SCALE); TitleText.TextXAlignment=Enum.TextXAlignment.Left
    TitleText.TextColor3=Color3.new(1,1,1); TitleText.Text=("%s • %s"):format(name,version)
    local Under=Instance.new("Frame",Title); Under.BorderSizePixel=0; Under.BackgroundColor3=ACCENT
    Under.Size=UDim2.new(1,0,0,1); Under.Position=UDim2.new(0,0,1,0)

    -- Drag window
    do local dragging,start,origin
        Title.InputBegan:Connect(function(i)
            if (i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch) and not UIS:GetFocusedTextBox() then
                dragging=true; start=i.Position; origin=Window.Position
                i.Changed:Connect(function() if i.UserInputState==Enum.UserInputState.End then dragging=false end end)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then
                local d=i.Position-start; Window.Position=UDim2.new(origin.X.Scale,origin.X.Offset+d.X,origin.Y.Scale,origin.Y.Offset+d.Y)
            end
        end)
    end

    -- Overlay toggle
    local hidden=false
    Overlay.MouseButton1Click:Connect(function()
        hidden=not hidden; Window.Visible=not hidden
        tw(Overlay,.12,{ImageColor3 = hidden and Color3.fromRGB(200,200,200) or ACCENT})
    end)

    -- Tabs rail
    local TabsRail=Instance.new("Frame",Window); TabsRail.BackgroundColor3=Color3.fromRGB(39,40,51)
    TabsRail.Position=UDim2.new(0,6,0,math.floor(36*SCALE)); TabsRail.Size=UDim2.new(0,math.floor(136*SCALE),1,-math.floor(42*SCALE))
    local trc=Instance.new("UICorner",TabsRail); trc.CornerRadius=UDim.new(0,6)
    local trlbl=Instance.new("TextLabel",TabsRail); trlbl.BackgroundTransparency=1; trlbl.Size=UDim2.new(1,-8,0,math.floor(22*SCALE)); trlbl.Position=UDim2.new(0,8,0,0)
    trlbl.Font=Enum.Font.GothamBlack; trlbl.Text="Sections"; trlbl.TextSize=math.floor(11*SCALE); trlbl.TextXAlignment=Enum.TextXAlignment.Left; trlbl.TextColor3=Color3.new(1,1,1)
    local trlist=Instance.new("UIListLayout",TabsRail); trlist.Padding=UDim.new(0,math.floor(4*SCALE)); trlist.SortOrder=Enum.SortOrder.LayoutOrder; trlist.HorizontalAlignment=Enum.HorizontalAlignment.Right

    -- Tabs API
    local firstShown=false
    local TabsAPI={}
    function TabsAPI:CreateFrame(title)
        title = title or "Page"

        local Page=Instance.new("ScrollingFrame",Window)
        Page.Name="Page"; Page.Active=true; Page.ScrollBarThickness=4; Page.ScrollBarImageColor3=ACCENT
        Page.AutomaticCanvasSize=Enum.AutomaticSize.Y; Page.CanvasSize=UDim2.fromOffset(0,0)
        Page.BackgroundColor3=BG_DARK
        Page.Position=UDim2.new(0,math.floor(150*SCALE),0,math.floor(36*SCALE))
        Page.Size=UDim2.new(1,-math.floor(156*SCALE),1,-math.floor(42*SCALE))
        Page.Visible=false
        local pc=Instance.new("UICorner",Page); pc.CornerRadius=UDim.new(0,6)
        local pad=Instance.new("UIPadding",Page); pad.PaddingTop=UDim.new(0,math.floor(6*SCALE)); pad.PaddingLeft=UDim.new(0,math.floor(6*SCALE)); pad.PaddingRight=UDim.new(0,math.floor(6*SCALE)); pad.PaddingBottom=UDim.new(0,math.floor(6*SCALE))
        local vlist=Instance.new("UIListLayout",Page); vlist.Padding=UDim.new(0,math.floor(6*SCALE)); vlist.SortOrder=Enum.SortOrder.LayoutOrder; vlist.HorizontalAlignment=Enum.HorizontalAlignment.Center

        local TabBtn=Instance.new("TextButton",TabsRail); TabBtn.BackgroundTransparency=1
        TabBtn.Size=UDim2.new(1,-8,0,math.floor(18*SCALE)); TabBtn.Text=title; TabBtn.Font=Enum.Font.Gotham
        TabBtn.TextSize=math.floor(11*SCALE); TabBtn.TextColor3=Color3.new(1,1,1); TabBtn.TextTransparency=.5
        local indicator=Instance.new("Frame",TabBtn); indicator.BackgroundColor3=ACCENT; indicator.Size=UDim2.new(0,2,1,-4)
        indicator.Position=UDim2.new(0,-8,0,2); indicator.BorderSizePixel=0; indicator.Visible=false

        local function selectThis()
            indicator.Visible=true
            for _,v in ipairs(Window:GetChildren()) do if v:IsA("ScrollingFrame") and v.Name=="Page" then v.Visible=false end end
            for _,v in ipairs(TabsRail:GetChildren()) do if v:IsA("TextButton") then v.TextTransparency=.5 end end
            TabBtn.TextTransparency=0; Page.Visible=true
        end
        TabBtn.MouseButton1Click:Connect(selectThis)
        if not firstShown then firstShown=true; selectThis() end

        local function Card(baseH)
            local fr=Instance.new("Frame",Page)
            fr.BackgroundColor3=BG_CARD
            fr.Size=UDim2.new(1,0,0,math.floor((baseH or 40)*SCALE))
            fr.AutomaticSize = Enum.AutomaticSize.Y
            fr.ClipsDescendants=false
            local c=Instance.new("UICorner",fr); c.CornerRadius=UDim.new(0,6)
            return fr
        end

        local PageAPI={}
        function PageAPI:CreateLabel(text)
            local parent = self._raw or self
            local lb = Instance.new("TextLabel")
            lb.Parent = parent
            lb.BackgroundTransparency = 1
            lb.Position = UDim2.new(0, 8, 0, 0)
            lb.Size = UDim2.new(1, -8, 0, math.floor(16 * SCALE))
            lb.Font = Enum.Font.GothamBlack
            lb.TextSize = math.floor(12 * SCALE)
            lb.TextXAlignment = Enum.TextXAlignment.Left
            lb.TextColor3 = Color3.new(1, 1, 1)
            lb.Text = string.upper(text or "Label")
            return { UpdateLabel=function(_,t) lb.Text=string.upper(t or "") end, _raw=lb }
        end

        function PageAPI:CreateButton(name,desc,cb)
            cb=cb or function() end
            local fr=Card(40)
            local t=Instance.new("TextLabel",fr); t.BackgroundTransparency=1; t.Position=UDim2.new(0,8,0,2); t.Size=UDim2.new(1,-100,0,math.floor(18*SCALE))
            t.Font=Enum.Font.GothamBlack; t.TextSize=math.floor(12*SCALE); t.TextColor3=Color3.new(1,1,1); t.Text=string.upper(name or "Button"); t.TextXAlignment=Enum.TextXAlignment.Left
            local d=Instance.new("TextLabel",fr); d.BackgroundTransparency=1; d.Position=UDim2.new(0,8,0,math.floor(20*SCALE)); d.Size=UDim2.new(1,-100,0,math.floor(16*SCALE))
            d.Font=Enum.Font.Gotham; d.TextSize=math.floor(11*SCALE); d.TextColor3=Color3.fromRGB(170,170,170); d.TextXAlignment=Enum.TextXAlignment.Left; d.Text=desc or ""
            local run=Instance.new("TextButton",fr); run.BackgroundColor3=Color3.fromRGB(24,25,32); run.Size=UDim2.new(0,84,0,24); run.Position=UDim2.new(1,-100,0,6)
            run.Text="RUN"; run.Font=Enum.Font.GothamSemibold; run.TextSize=math.floor(11*SCALE); run.TextColor3=Color3.new(1,1,1); local rc=Instance.new("UICorner",run); rc.CornerRadius=UDim.new(0,8)
            run.MouseButton1Click:Connect(cb)
            return {}
        end
        function PageAPI:CreateToggle(title,desc,cb)
            cb=cb or function() end
            local fr=Card(40)
            local t=Instance.new("TextLabel",fr); t.BackgroundTransparency=1; t.Position=UDim2.new(0,8,0,2); t.Size=UDim2.new(1,-70,0,math.floor(18*SCALE))
            t.Font=Enum.Font.GothamBlack; t.TextSize=math.floor(12*SCALE); t.TextColor3=Color3.new(1,1,1); t.Text=string.upper(title or "Toggle"); t.TextXAlignment=Enum.TextXAlignment.Left
            local d=Instance.new("TextLabel",fr); d.BackgroundTransparency=1; d.Position=UDim2.new(0,8,0,math.floor(20*SCALE)); d.Size=UDim2.new(1,-70,0,math.floor(16*SCALE))
            d.Font=Enum.Font.Gotham; d.TextSize=math.floor(11*SCALE); d.TextColor3=Color3.fromRGB(170,170,170); d.TextXAlignment=Enum.TextXAlignment.Left; d.Text=desc or ""
            local track=Instance.new("Frame",fr); track.BackgroundColor3=Color3.fromRGB(24,25,32); track.Size=UDim2.fromOffset(math.floor(50*SCALE),math.floor(22*SCALE)); track.Position=UDim2.new(1,-math.floor(62*SCALE),0,math.floor(8*SCALE)); local kc=Instance.new("UICorner",track); kc.CornerRadius=UDim.new(1,0)
            local dot=Instance.new("Frame",track); dot.Size=UDim2.fromOffset(math.floor(18*SCALE),math.floor(18*SCALE)); dot.Position=UDim2.new(0,math.floor(2*SCALE),0,math.floor(2*SCALE)); dot.BackgroundColor3=ACCENT; dot.BackgroundTransparency=.6; local dc=Instance.new("UICorner",dot); dc.CornerRadius=UDim.new(1,0)
            local btn=Instance.new("TextButton",fr); btn.BackgroundTransparency=1; btn.Size=UDim2.new(1,0,1,0); btn.Text=""
            local on=false
            local function apply() tw(dot,.12,{Position=on and UDim2.new(1,-math.floor(20*SCALE),0,math.floor(2*SCALE)) or UDim2.new(0,math.floor(2*SCALE),0,math.floor(2*SCALE)), BackgroundTransparency=on and 0 or .6}); cb(on) end
            btn.MouseButton1Click:Connect(function() on=not on; apply() end)
            return { Set=function(_,v) if v~=on then on=v; apply() end end }
        end
        function PageAPI:CreateBox(placeholder,iconId,cb)
            cb=cb or function() end
            local fr=Card(32)
            local t=Instance.new("TextLabel",fr); t.BackgroundTransparency=1; t.Font=Enum.Font.GothamBlack; t.TextSize=math.floor(12*SCALE); t.TextColor3=Color3.fromRGB(200,205,230)
            t.Text=string.upper(placeholder or "INPUT"); t.TextXAlignment=Enum.TextXAlignment.Left; t.Position=UDim2.new(0,8,0,0); t.Size=UDim2.new(1,-8,0,18)
            local tb=Instance.new("TextBox",fr); tb.BackgroundColor3=Color3.fromRGB(24,25,32); tb.Position=UDim2.new(0,8,0,20); tb.Size=UDim2.new(1,-16,0,26)
            tb.ClearTextOnFocus=false; tb.Text=""; tb.Font=Enum.Font.Gotham; tb.TextSize=math.floor(11*SCALE); tb.TextColor3=Color3.new(1,1,1); tb.PlaceholderText=placeholder or ""; tb.PlaceholderColor3=ACCENT_TEXT; local c=Instance.new("UICorner",tb); c.CornerRadius=UDim.new(0,8)
            tb.FocusLost:Connect(function() cb(tb.Text) end)
            return { SetText=function(_,t2) tb.Text=t2 or "" end }
        end
        function PageAPI:CreateDropdown(title, options, onChanged)
            options=options or {}; onChanged=onChanged or function() end
            local fr=Card(28); fr.Name="Dropdown"
            local ttl=Instance.new("TextLabel",fr); ttl.BackgroundTransparency=1; ttl.Position=UDim2.new(0,8,0,0); ttl.Size=UDim2.new(1,-40,0,18)
            ttl.Font=Enum.Font.GothamBlack; ttl.TextSize=math.floor(12*SCALE); ttl.TextColor3=Color3.new(1,1,1); ttl.Text=string.upper(title)
            local caret=Instance.new("TextLabel",fr); caret.BackgroundTransparency=1; caret.Size=UDim2.fromOffset(math.floor(16*SCALE),math.floor(16*SCALE)); caret.Position=UDim2.new(1,-math.floor(24*SCALE),0,0)
            caret.Font=Enum.Font.GothamBlack; caret.Text="▼"; caret.TextSize=math.floor(11*SCALE); caret.TextColor3=ACCENT
            local holder=Instance.new("Frame",fr); holder.BackgroundColor3=Color3.fromRGB(26,26,32); holder.Position=UDim2.new(0,6,0,20); holder.Size=UDim2.new(1,-12,0,0); holder.AutomaticSize=Enum.AutomaticSize.Y; holder.Visible=false; local lc=Instance.new("UICorner",holder); lc.CornerRadius=UDim.new(0,8)
            local lv=Instance.new("UIListLayout",holder); lv.Padding=UDim.new(0,4)
            local pad=Instance.new("UIPadding",holder); pad.PaddingTop=UDim.new(0,6); pad.PaddingBottom=UDim.new(0,6); pad.PaddingLeft=UDim.new(0,6); pad.PaddingRight=UDim.new(0,6)
            local current=nil
            local function rebuild(list)
                for _,c in ipairs(holder:GetChildren()) do if c:IsA("TextButton") then c:Destroy() end end
                for _,opt in ipairs(list) do
                    local b=Instance.new("TextButton",holder); b.Size=UDim2.new(1,0,0,24); b.BackgroundColor3=BG_CARD; b.Text=opt; b.Font=Enum.Font.Gotham; b.TextSize=math.floor(11*SCALE); b.TextColor3=Color3.new(1,1,1)
                    local bc=Instance.new("UICorner",b); bc.CornerRadius=UDim.new(0,8)
                    b.MouseButton1Click:Connect(function()
                        current=opt; ttl.Text=string.upper(("%s : %s"):format(title,opt)); holder.Visible=false; tw(caret,.12,{Rotation=0}); onChanged(opt)
                    end)
                end
            end
            rebuild(options)
            local open=false
            local header=Instance.new("TextButton",fr); header.BackgroundTransparency=1; header.Size=UDim2.new(1,0,0,20); header.Position=UDim2.new(0,0,0,0); header.Text=""
            header.MouseButton1Click:Connect(function() open=not open; holder.Visible=open; tw(caret,.12,{Rotation=open and 180 or 0}) end)
            return { SetValue=function(_,v) current=v; ttl.Text=string.upper(("%s : %s"):format(title,tostring(v))) end, GetValue=function() return current end, SetOptions=function(_,opts) rebuild(opts or {}) end }
        end
        return PageAPI
    end

    local winAPI={}
    function winAPI:CreateTab(_) return setmetatable({}, { __index = TabsAPI }) end
    return winAPI
end

----------------------------------------------------------------
-- ======================= PREMIUM SCRIPT ======================
----------------------------------------------------------------
local Players            = game:GetService("Players")
local LocalPlayer        = Players.LocalPlayer
local RS                 = game:GetService("RunService")
local TeleportService    = game:GetService("TeleportService")
local VirtualUser        = game:GetService("VirtualUser")
local ReplicatedStorage  = game:GetService("ReplicatedStorage")
local Workspace          = game:GetService("Workspace")
local VIM                = game:GetService("VirtualInputManager")

local TARGET_PLACE = 121864768012064

-- Anti AFK ON
LocalPlayer.Idled:Connect(function()
    VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    task.wait(.7); VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
end)

-- Inventory utils (tetap dipakai)
local Replion,ItemUtility
task.spawn(function()
    local function gw(o,n,t) return o:FindFirstChild(n) or o:WaitForChild(n,t or 10) end
    local okRp,modRp=pcall(function() return require(ReplicatedStorage:WaitForChild("Packages"):WaitForChild("replion")) end)
    if okRp then Replion=modRp end
    local okU,modU=pcall(function() return require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("ItemUtility")) end)
    if okU then ItemUtility=modU end
end)
local function eachInventory(fn)
    if not Replion then return end
    local Data=Replion.Client:WaitReplion("Data"); local items=Data and Data:Get({"Inventory","Items"})
    if type(items)~="table" then return end; for _,it in ipairs(items) do fn(it) end
end

-- ===================== Teleport data =====================
local islands = {
    ["Weather Machine"]   = Vector3.new(-1471,-3,1929),
    ["Esoteric Depths"]   = Vector3.new(3157,-1303,1439),
    ["Tropical Grove"]    = Vector3.new(-2038,3,3650),
    ["Stingray Shores"]   = Vector3.new(-32,4,2773),
    ["Kohana Volcano"]    = Vector3.new(-519,24,189),
    ["Coral Reefs"]       = Vector3.new(-3095,1,2177),
    ["Crater Island"]     = Vector3.new(968,1,4854),
    ["Kohana"]            = Vector3.new(-658,3,719),
    ["Winter Fest"]       = Vector3.new(1611,4,3280),
    ["Esoteric Island"]   = Vector3.new(1987,4,1400),
    ["Treasure Room"]     = Vector3.new(-3600,-267,-1558),
    ["Lost Shore"]        = Vector3.new(-3663,38,-989),
    ["Sisyphus"]          = Vector3.new(-3792,-135,-986),
    ["Crystal Cavern"]    = Vector3.new(-2026,-440,7428),
    ["Halloween"]         = Vector3.new(2127,78,3334),
    ["Ancient Underground Cave"]  = Vector3.new(2102,-91,-709),
    ["Ancient Inside Temple"]     = Vector3.new(1506,-22,-641),
    ["Ancient Jungle"]            = Vector3.new(1268,78,-183),
    ["Fisherman Island"]          = Vector3.new(-3,17,2840),
}
local islandList = {} for n,_ in pairs(islands) do table.insert(islandList, n) end table.sort(islandList)

local function tpTo(pos)
    if not pos then return end
    local char=LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp=char:FindFirstChild("HumanoidRootPart")
    if hrp then hrp.CFrame=CFrame.new(pos+Vector3.new(0,4,0)) end
end

-- ================= UI BUILD =================
local UI = library:CreateWindow("AegisHub • Fish It","Premium",10044538000)
local Tab = UI:CreateTab("Sections")

-- Halaman YANG DIPAKAI
local PageInv   = Tab:CreateFrame("Inventory")
local PageShop  = Tab:CreateFrame("Shop")
local PageTP    = Tab:CreateFrame("Teleport")
local PageFarm  = Tab:CreateFrame("Farm")      -- <--- BARU

-- Inventory (placeholder)
PageInv:CreateLabel("INVENTORY")

-- Shop
PageShop:CreateButton("Traveling Merchant","Open merchant",function() end)
PageShop:CreateButton("Bobber Shop","",function() end)
PageShop:CreateButton("Rod Shop","",function() end)
PageShop:CreateButton("Weather Shop","",function() end)

-- Teleport
local CoordLabel = PageTP:CreateLabel("COORDINATES • X: 0.0  Y: 0.0  Z: 0.0")
local islandsDD = PageTP:CreateDropdown("Teleport Island", islandList, function(choice)
    local pos = islands[choice]
    if pos then tpTo(pos) end
end)

-- NPC dynamic
local function scanNPC()
    local s={} for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") then
            local hasHum=m:FindFirstChildOfClass("Humanoid"); local hasPrompt=false
            for _,d in ipairs(m:GetDescendants()) do if d:IsA("ProximityPrompt") then hasPrompt=true break end end
            if (hasHum or hasPrompt) and #m.Name>=3 then s[m.Name]=true end
        end
    end
    local t={} for k in pairs(s) do table.insert(t,k) end table.sort(t); return t
end
local function tpNearestModel(partial)
    local char=LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait(); local hrp=char:FindFirstChild("HumanoidRootPart"); if not hrp then return end
    local best,dist
    for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and string.find(string.lower(m.Name),string.lower(partial)) then
            local p=m:FindFirstChild("HumanoidRootPart") or m:FindFirstChildWhichIsA("BasePart")
            if p then local d=(p.Position-hrp.Position).Magnitude; if not dist or d<dist then best=p; dist=d end end
        end
    end
    if best then tpTo(best.Position) end
end
local npcDD = PageTP:CreateDropdown("Teleport NPC", scanNPC(), function(nm) if nm then tpNearestModel(nm) end end)

-- Players
local function playersList() local t={} for _,pl in ipairs(Players:GetPlayers()) do if pl~=LocalPlayer then table.insert(t,pl.Name) end end table.sort(t); return t end
local plDD = PageTP:CreateDropdown("Teleport Player", playersList(), function(nm)
    local p=Players:FindFirstChild(nm); if p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then tpTo(p.Character.HumanoidRootPart.Position) end
end)
Players.PlayerAdded:Connect(function() plDD:SetOptions(playersList()) end)
Players.PlayerRemoving:Connect(function() plDD:SetOptions(playersList()) end)

if game.PlaceId ~= TARGET_PLACE then
    PageTP:CreateButton("Teleport ke Fish It","Masuk ke game Fish It",function() TeleportService:Teleport(TARGET_PLACE,LocalPlayer) end)
end

-- Live Coordinates updater
RS.RenderStepped:Connect(function()
    local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp = char and char:FindFirstChild("HumanoidRootPart")
    if hrp and CoordLabel and CoordLabel.UpdateLabel then
        local p = hrp.Position
        CoordLabel:UpdateLabel(("COORDINATES • X: %.1f  Y: %.1f  Z: %.1f"):format(p.X,p.Y,p.Z):upper())
    end
end)

----------------------------------------------------------------
-- ========================== FARM ============================
----------------------------------------------------------------

-- FLAGS
local Flags = {
    AutoFish = false,
    PerfectCast = false,
    AutoFavorite = false,
    AutoSell = false,
}

-- SAFE HELPERS

local function safeFindFirst(desc, pred)
    for _,d in ipairs(desc) do if pred(d) then return d end end
end

local function clickAtCenter(guiObj)
    if not guiObj or not guiObj:IsA("GuiObject") then return end
    local absPos, absSize = guiObj.AbsolutePosition, guiObj.AbsoluteSize
    local cx, cy = absPos.X + absSize.X/2, absPos.Y + absSize.Y/2
    VIM:SendMouseButtonEvent(cx, cy, 0, true, game, 0)
    task.wait()
    VIM:SendMouseButtonEvent(cx, cy, 0, false, game, 0)
end

local function pressKey(enumKey, t)
    VIM:SendKeyEvent(true, enumKey, false, game); task.wait(t or 0.03); VIM:SendKeyEvent(false, enumKey, false, game)
end

-- Cari GUI fishing (heuristik umum)
local function getFishingGui()
    local pg = LocalPlayer:FindFirstChildOfClass("PlayerGui")
    if not pg then return nil end
    -- Pola umum: nama mengandung "Fish", "Cast", "Reel", "Bar"
    for _,g in ipairs(pg:GetDescendants()) do
        if g:IsA("ScreenGui") or g:IsA("Frame") then
            local n = string.lower(g.Name)
            if n:find("fish") or n:find("cast") or n:find("reel") or n:find("bar") then
                return g
            end
        end
    end
    return nil
end

-- Trigger ProximityPrompt (untuk Sell/NPC jika perlu)
local function triggerNearestPrompt(filterText, maxDist)
    local char=LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local hrp=char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    local best, bestD, bestPrompt
    for _,p in ipairs(Workspace:GetDescendants()) do
        if p:IsA("ProximityPrompt") then
            local ok, part = pcall(function() return p.Parent:IsA("BasePart") and p.Parent or p.Parent:FindFirstChildWhichIsA("BasePart") end)
            local pos = ok and part and part.Position
            if pos then
                local d=(pos-hrp.Position).Magnitude
                if (not maxDist or d<=maxDist) then
                    local name = (p.ObjectText or p.Name or ""):lower()
                    if (not filterText) or name:find(filterText:lower()) then
                        if not bestD or d < bestD then best, bestD, bestPrompt = part, d, p end
                    end
                end
            end
        end
    end
    if bestPrompt then
        pcall(function() fireproximityprompt(bestPrompt, 1, true) end)
        return true
    end
    return false
end

-- Remote heuristik (favorit/sell) – diam jika tak ditemukan
local function fireRemoteByName(partial, ...)
    local args={...}
    local function tryContainer(container)
        for _,v in ipairs(container:GetDescendants()) do
            if (v:IsA("RemoteEvent") or v:IsA("RemoteFunction")) and v.Name:lower():find(partial:lower()) then
                local ok
                if v:IsA("RemoteEvent") then ok=pcall(function() v:FireServer(unpack(args)) end)
                else ok=pcall(function() v:InvokeServer(unpack(args)) end) end
                if ok then return true end
            end
        end
        return false
    end
    return tryContainer(ReplicatedStorage) or tryContainer(game:GetService("StarterGui")) or false
end

----------------------------------------------------------------
-- ============== IMPLEMENTASI FITUR FARMING ==================
----------------------------------------------------------------

-- 1) AUTO FISH (cast -> mini game -> reel)
task.spawn(function()
    while true do
        if Flags.AutoFish then
            -- 1. Cari tombol/GUI cast atau gunakan key/mouse umum
            local ui = getFishingGui()
            local castButton
            if ui then
                castButton = safeFindFirst(ui:GetDescendants(), function(o)
                    return o:IsA("TextButton") and (o.Text and o.Text:lower():find("cast"))
                        or (o:IsA("ImageButton") and o.Name:lower():find("cast"))
                end)
            end

            if castButton then
                clickAtCenter(castButton)
            else
                -- fallback: klik tengah layar / tekan spasi
                local cam = workspace.CurrentCamera
                if cam then
                    local vp = cam.ViewportSize
                    VIM:SendMouseButtonEvent(vp.X/2, vp.Y/2, 0, true, game, 0)
                    task.wait(0.02)
                    VIM:SendMouseButtonEvent(vp.X/2, vp.Y/2, 0, false, game, 0)
                end
                pressKey(Enum.KeyCode.Space, 0.02)
            end

            -- 2. Tunggu indikator "bite" / progress bar
            local biteDetected=false
            for i=1,100 do
                task.wait(0.05)
                local gui = getFishingGui()
                if gui then
                    local lbl = safeFindFirst(gui:GetDescendants(), function(o)
                        return o:IsA("TextLabel") and ((o.Text or ""):lower():find("bite") or (o.Text or ""):lower():find("reel"))
                    end)
                    local bar = safeFindFirst(gui:GetDescendants(), function(o)
                        return o:IsA("Frame") and (o.Name:lower():find("bar") or o.Name:lower():find("progress"))
                    end)
                    if lbl or bar then biteDetected=true break end
                end
            end

            -- 3. Reel (spam klik / spasi secukupnya)
            if biteDetected then
                for k=1,40 do
                    if not Flags.AutoFish then break end
                    pressKey(Enum.KeyCode.Space, 0.01)
                    local cam = workspace.CurrentCamera
                    if cam then
                        local vp = cam.ViewportSize
                        VIM:SendMouseButtonEvent(vp.X/2, vp.Y/2, 0, true, game, 0)
                        VIM:SendMouseButtonEvent(vp.X/2, vp.Y/2, 0, false, game, 0)
                    end
                    task.wait(0.06)
                end
            end
        end
        task.wait(0.25)
    end
end)

-- 2) PERFECT CASTING (bidik zona hijau saat bar muncul)
task.spawn(function()
    while true do
        if Flags.PerfectCast then
            local gui = getFishingGui()
            if gui then
                local bar = safeFindFirst(gui:GetDescendants(), function(o)
                    return o:IsA("Frame") and (o.Name:lower():find("bar") or o.Name:lower():find("cast"))
                end)
                if bar then
                    -- coba cari "Perfect"/"Green" zone
                    local targetZone = safeFindFirst(bar:GetDescendants(), function(o)
                        if not o:IsA("GuiObject") then return false end
                        local n = o.Name:lower()
                        if n:find("perfect") or n:find("green") or n:find("sweet") then return true end
                        if o:IsA("TextLabel") and (o.Text or ""):lower():find("perfect") then return true end
                        return false
                    end)
                    if targetZone then
                        clickAtCenter(targetZone)
                    else
                        -- fallback: klik di tengah bar
                        clickAtCenter(bar)
                    end
                end
            end
        end
        task.wait(0.08)
    end
end)

-- 3) AUTO FAVORITE FISH (heuristik: cari item bertipe fish dan favoritkan via remote/flag yg tersedia)
task.spawn(function()
    while true do
        if Flags.AutoFavorite then
            pcall(function()
                eachInventory(function(it)
                    -- Heuristik penentuan item ikan
                    local name = (it.Name or it.ItemName or ""):lower()
                    local typeName = (it.Type or it.Category or ""):lower()
                    local isFish = typeName:find("fish") or name:find("fish") or name:find("shark") or name:find("ray") or name:find("worm")
                    local fav = it.Favorite or it.Favourite or it.favorite or it.favourite
                    if isFish and not fav then
                        -- Coba berbagai bentuk argumen umum: (uuid) atau (name)
                        local uuid = it.UUID or it.Uuid or it.Id or it.ID
                        local ok = false
                        if uuid then ok = fireRemoteByName("favor", uuid) end
                        if not ok then ok = fireRemoteByName("favor", name) end
                        -- diam jika gagal (server mungkin berbeda)
                    end
                end)
            end)
        end
        task.wait(2.0)
    end
end)

-- 4) AUTO SELL FISH (heuristik: remote atau ProximityPrompt "Sell")
task.spawn(function()
    while true do
        if Flags.AutoSell then
            local sold = false
            -- 4a. coba remote "sell"
            pcall(function()
                eachInventory(function(it)
                    local name = (it.Name or it.ItemName or ""):lower()
                    local typeName = (it.Type or it.Category or ""):lower()
                    local isFish = typeName:find("fish") or name:find("fish") or name:find("shark") or name:find("ray") or name:find("worm")
                    if isFish then
                        local uuid = it.UUID or it.Uuid or it.Id or it.ID
                        if uuid and fireRemoteByName("sell", uuid) then sold = true end
                    end
                end)
            end)
            -- 4b. jika remote tak ada, coba prompt terdekat bertuliskan Sell
            if not sold then
                triggerNearestPrompt("sell", 50) -- jarak 50 stud
            end
        end
        task.wait(3.0)
    end
end)

-- ====================== UI FARM =======================
PageFarm:CreateLabel("FARMING")
PageFarm:CreateToggle("Auto Fish","Otomatis memancing & menarik reel", function(on) Flags.AutoFish = on end)
PageFarm:CreateToggle("Perfect Casting","Coba klik tepat di zona 'perfect' saat bar muncul", function(on) Flags.PerfectCast = on end)
PageFarm:CreateToggle("Auto Favorite Fish","Tandai ikan di inventory sebagai favorit (heuristik)", function(on) Flags.AutoFavorite = on end)
PageFarm:CreateToggle("Auto Sell Fish","Jual ikan via remote/prompt terdekat (heuristik)", function(on) Flags.AutoSell = on end)

-- ================== REFRESH LIST DINAMIS =================
task.spawn(function()
    while true do
        task.wait(8)
        npcDD:SetOptions(scanNPC())
        plDD:SetOptions(playersList())
    end
end)
