--========================================================
-- AEGISHUB UI LIBRARY - BIGGER UI
--========================================================
if not game:IsLoaded() then game.Loaded:Wait() end

-- Services
local Players            = game:GetService("Players")
local RunService         = game:GetService("RunService")
local Lighting           = game:GetService("Lighting")
local Workspace          = game:GetService("Workspace")
local UserInputService   = game:GetService("UserInputService")
local TweenService       = game:GetService("TweenService")
local CoreGui            = game:GetService("CoreGui")
local LocalPlayer        = Players.LocalPlayer
local VirtualUser        = game:GetService("VirtualUser")

----------------------------------------------------------------
-- ============== UI LIBRARY (Polished v2) =====================
----------------------------------------------------------------
local ACCENT      = Color3.fromRGB(110,175,255)
local ACCENT_TEXT = Color3.fromRGB(227,229,255)
local BG_DARK     = Color3.fromRGB(42,44,56)
local BG_CARD     = Color3.fromRGB(30,31,41)

local function protect(inst)
    if syn and syn.protect_gui then
        syn.protect_gui(inst)
    end
end

local UIS = UserInputService

local function tw(o,t,props)
    local a = TweenService:Create(o, TweenInfo.new(t, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), props)
    a:Play()
    return a
end

local library = {}

function library:CreateWindow(name, version, icon)
    name,version,icon = name or "AegisHub", version or "Premium", icon or 10044538000

    -- ScreenGui
    local Gui = Instance.new("ScreenGui")
    Gui.Name = "AegisHub_UIv2"
    Gui.IgnoreGuiInset = false
    Gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    Gui.ResetOnSpawn = false
    Gui.DisplayOrder = 9999
    protect(Gui)
    Gui.Parent = CoreGui

    -- Scale kecil utk layar kecil
    local function calcScale()
        local cam = Workspace.CurrentCamera
        local vp = cam and cam.ViewportSize or Vector2.new(1280,720)
        local shortest = math.min(vp.X, vp.Y)
        if shortest <= 720 then return 0.85 elseif shortest <= 900 then return 0.92 else return 1 end
    end
    local SCALE = calcScale()

    -- Overlay toggle (bulat di samping, buat show/hide window)
    local Overlay = Instance.new("ImageButton")
    Overlay.Name="AegisHubOverlay"; Overlay.Parent=Gui
    Overlay.Size=UDim2.fromOffset(40,40); Overlay.AutoButtonColor=true
    Overlay.BackgroundColor3=Color3.fromRGB(32,34,46)
    Overlay.Image="rbxassetid://10045753138"; Overlay.ImageColor3=ACCENT
    Instance.new("UICorner", Overlay).CornerRadius = UDim.new(1,0)
    local os=Instance.new("UIStroke",Overlay); os.Transparency=.85; os.Color=Color3.fromRGB(255,255,255)

    local cam = Workspace.CurrentCamera
    local ox = Gui:GetAttribute("ovx") or 12
    local oy = Gui:GetAttribute("ovy") or math.floor((cam.ViewportSize.Y/2)-20)
    Overlay.Position = UDim2.fromOffset(ox, oy)

    do
        local dragging, start, origin
        Overlay.InputBegan:Connect(function(i)
            if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then
                dragging=true; start=i.Position; origin=Overlay.Position
                i.Changed:Connect(function()
                    if i.UserInputState==Enum.UserInputState.End then
                        dragging=false
                        Gui:SetAttribute("ovx", Overlay.Position.X.Offset)
                        Gui:SetAttribute("ovy", Overlay.Position.Y.Offset)
                    end
                end)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then
                local d=i.Position-start
                local vp=Workspace.CurrentCamera.ViewportSize
                local nx = math.clamp(origin.X.Offset + d.X, 4, vp.X-44)
                local ny = math.clamp(origin.Y.Offset + d.Y, 4, vp.Y-44)
                Overlay.Position = UDim2.fromOffset(nx, ny)
            end
        end)
    end

    -- Window
    local Window = Instance.new("Frame")
    protect(Window)
    Window.Parent=Gui
    Window.BackgroundColor3=BG_DARK
    Window.ClipsDescendants=false
    Window.Size=UDim2.fromOffset(math.floor(520*SCALE), math.floor(340*SCALE))
    Window.Position=UDim2.new(.5, -Window.Size.X.Offset/2, .52, -Window.Size.Y.Offset/2)
    Instance.new("UICorner",Window).CornerRadius=UDim.new(0,6)

    -- Title bar
    local Title=Instance.new("Frame",Window)
    Title.BackgroundTransparency=1
    Title.Size=UDim2.new(1,0,0,math.floor(30*SCALE))

    local Icon=Instance.new("ImageLabel",Title)
    Icon.BackgroundTransparency=1
    Icon.Size=UDim2.fromOffset(math.floor(18*SCALE),math.floor(18*SCALE))
    Icon.Position=UDim2.new(0,8,0,6)
    Icon.Image="rbxassetid://"..tostring(icon)
    Icon.ImageColor3=ACCENT

    local TitleText=Instance.new("TextLabel",Title)
    TitleText.BackgroundTransparency=1
    TitleText.Position=UDim2.new(0,30,0,0)
    TitleText.Size=UDim2.new(1,-30,1,0)
    TitleText.Font=Enum.Font.GothamMedium
    TitleText.TextSize=math.floor(12*SCALE)
    TitleText.TextXAlignment=Enum.TextXAlignment.Left
    TitleText.TextColor3=Color3.new(1,1,1)
    TitleText.Text=(name .. " - " .. version)

    local Under=Instance.new("Frame",Title)
    Under.BorderSizePixel=0; Under.BackgroundColor3=ACCENT
    Under.Size=UDim2.new(1,0,0,1); Under.Position=UDim2.new(0,0,1,0)

    -- Tombol X (tutup menu utama)
    local CloseBtn = Instance.new("TextButton")
    CloseBtn.Name = "CloseButton"
    CloseBtn.Parent = Title
    CloseBtn.BackgroundTransparency = 1
    CloseBtn.BorderSizePixel = 0
    CloseBtn.AnchorPoint = Vector2.new(1, 0)
    CloseBtn.Position = UDim2.new(1, -6, 0, 4)
    CloseBtn.Size = UDim2.new(0, math.floor(18 * SCALE), 0, math.floor(18 * SCALE))
    CloseBtn.Font = Enum.Font.GothamBold
    CloseBtn.Text = "X"
    CloseBtn.TextSize = math.floor(14 * SCALE)
    CloseBtn.TextColor3 = Color3.fromRGB(255, 80, 80)
    CloseBtn.AutoButtonColor = false

    CloseBtn.MouseButton1Click:Connect(function()
        if Gui and Gui.Parent then
            Gui:Destroy() -- hanya menu utama & tombol overlay
        end
    end)

    -- Drag window
    do local dragging,start,origin
        Title.InputBegan:Connect(function(i)
            if (i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch) and not UIS:GetFocusedTextBox() then
                dragging=true; start=i.Position; origin=Window.Position
                i.Changed:Connect(function() if i.UserInputState==Enum.UserInputState.End then dragging=false end end)
            end
        end)
        UIS.InputChanged:Connect(function(i)
            if dragging and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then
                local d=i.Position-start
                Window.Position=UDim2.new(origin.X.Scale,origin.X.Offset+d.X,origin.Y.Scale,origin.Y.Offset+d.Y)
            end
        end)
    end

    -- Overlay toggle show/hide window
    local hidden=false
    Overlay.MouseButton1Click:Connect(function()
        hidden=not hidden; Window.Visible=not hidden
        tw(Overlay,.12,{ImageColor3 = hidden and Color3.fromRGB(200,200,200) or ACCENT})
    end)

    -- Tabs rail
    local TabsRail=Instance.new("Frame",Window)
    TabsRail.BackgroundColor3=Color3.fromRGB(39,40,51)
    TabsRail.Position=UDim2.new(0,6,0,math.floor(36*SCALE))
    TabsRail.Size=UDim2.new(0,math.floor(136*SCALE),1,-math.floor(42*SCALE))
    Instance.new("UICorner",TabsRail).CornerRadius=UDim.new(0,6)

    local trlbl=Instance.new("TextLabel",TabsRail)
    trlbl.BackgroundTransparency=1
    trlbl.Size=UDim2.new(1,-8,0,math.floor(22*SCALE))
    trlbl.Position=UDim2.new(0,8,0,0)
    trlbl.Font=Enum.Font.GothamBlack; trlbl.Text="Sections"
    trlbl.TextSize=math.floor(11*SCALE); trlbl.TextXAlignment=Enum.TextXAlignment.Left
    trlbl.TextColor3=Color3.new(1,1,1)

    local trlist=Instance.new("UIListLayout",TabsRail)
    trlist.Padding=UDim.new(0,math.floor(4*SCALE))
    trlist.SortOrder=Enum.SortOrder.LayoutOrder
    trlist.HorizontalAlignment=Enum.HorizontalAlignment.Right

    ------------------------------------------------------------
    -- Tab/Page API
    ------------------------------------------------------------
    local firstShown=false

    local function makePage(title)
        title = title or "Page"

        local Page=Instance.new("ScrollingFrame",Window)
        Page.Name="Page"; Page.Active=true; Page.ScrollBarThickness=4; Page.ScrollBarImageColor3=ACCENT
        Page.AutomaticCanvasSize=Enum.AutomaticSize.Y; Page.CanvasSize=UDim2.new(0,0,0,0)
        Page.BackgroundColor3=BG_DARK
        Page.Position=UDim2.new(0,math.floor(150*SCALE),0,math.floor(36*SCALE))
        Page.Size=UDim2.new(1,-math.floor(156*SCALE),1,-math.floor(42*SCALE))
        Page.Visible=false
        Instance.new("UICorner",Page).CornerRadius=UDim.new(0,6)
        local pad=Instance.new("UIPadding",Page)
        pad.PaddingTop=UDim.new(0,math.floor(6*SCALE))
        pad.PaddingLeft=UDim.new(0,math.floor(6*SCALE))
        pad.PaddingRight=UDim.new(0,math.floor(6*SCALE))
        pad.PaddingBottom=UDim.new(0,math.floor(6*SCALE))
        local vlist=Instance.new("UIListLayout",Page)
        vlist.Padding=UDim.new(0,math.floor(6*SCALE))
        vlist.SortOrder=Enum.SortOrder.LayoutOrder
        vlist.HorizontalAlignment=Enum.HorizontalAlignment.Center

        local TabBtn=Instance.new("TextButton",TabsRail)
        TabBtn.BackgroundTransparency=1
        TabBtn.Size=UDim2.new(1,-8,0,math.floor(18*SCALE))
        TabBtn.Text=title; TabBtn.Font=Enum.Font.Gotham
        TabBtn.TextSize=math.floor(11*SCALE); TabBtn.TextColor3=Color3.new(1,1,1)
        TabBtn.TextTransparency=.5

        local indicator=Instance.new("Frame",TabBtn)
        indicator.BackgroundColor3=ACCENT
        indicator.Size=UDim2.new(0,2,1,-4)
        indicator.Position=UDim2.new(0,-8,0,2)
        indicator.BorderSizePixel=0
        indicator.Visible=false

        local function selectThis()
            for _,v in ipairs(Window:GetChildren()) do
                if v:IsA("ScrollingFrame") and v.Name=="Page" then v.Visible=false end
            end
            for _,btn in ipairs(TabsRail:GetChildren()) do
                if btn:IsA("TextButton") then
                    btn.TextTransparency = .5
                    local ind = btn:FindFirstChildWhichIsA("Frame")
                    if ind then ind.Visible=false end
                end
            end
            TabBtn.TextTransparency=0
            Page.Visible=true
            indicator.Visible=true
        end
        TabBtn.MouseButton1Click:Connect(selectThis)
        if not firstShown then firstShown=true; selectThis() end

        local function Card(baseH)
            local fr=Instance.new("Frame",Page)
            fr.BackgroundColor3=BG_CARD
            fr.Size=UDim2.new(1,0,0,math.floor((baseH or 40)*SCALE))
            fr.AutomaticSize = Enum.AutomaticSize.Y
            fr.ClipsDescendants=false
            Instance.new("UICorner",fr).CornerRadius=UDim.new(0,6)
            return fr
        end

        local PageAPI = {}

        function PageAPI:CreateLabel(text)
            local lb = Instance.new("TextLabel")
            lb.Parent = Page
            lb.BackgroundTransparency = 1
            lb.Size = UDim2.new(1, -8, 0, math.floor(16 * SCALE))
            lb.Position = UDim2.new(0, 8, 0, 0)
            lb.Font = Enum.Font.GothamBlack
            lb.TextSize = math.floor(12 * SCALE)
            lb.TextXAlignment = Enum.TextXAlignment.Left
            lb.TextColor3 = Color3.new(1, 1, 1)
            lb.Text = string.upper(text or "LABEL")
            return { UpdateLabel=function(_,t) lb.Text=string.upper(t or "") end }
        end

        function PageAPI:CreateButton(name,desc,cb)
            cb=cb or function() end
            local fr=Card(40)
            local t=Instance.new("TextLabel",fr)
            t.BackgroundTransparency=1; t.Position=UDim2.new(0,8,0,2); t.Size=UDim2.new(1,-100,0,math.floor(18*SCALE))
            t.Font=Enum.Font.GothamBlack; t.TextSize=math.floor(12*SCALE); t.TextColor3=Color3.new(1,1,1); t.Text=string.upper(name or "BUTTON"); t.TextXAlignment=Enum.TextXAlignment.Left
            local d=Instance.new("TextLabel",fr)
            d.BackgroundTransparency=1; d.Position=UDim2.new(0,8,0,math.floor(20*SCALE)); d.Size=UDim2.new(1,-100,0,math.floor(16*SCALE))
            d.Font=Enum.Font.Gotham; d.TextSize=math.floor(11*SCALE); d.TextColor3=Color3.fromRGB(170,170,170); d.TextXAlignment=Enum.TextXAlignment.Left; d.Text=desc or ""
            local run=Instance.new("TextButton",fr)
            run.BackgroundColor3=Color3.fromRGB(24,25,32); run.Size=UDim2.new(0,84,0,24); run.Position=UDim2.new(1,-100,0,6)
            run.Text="RUN"; run.Font=Enum.Font.GothamSemibold; run.TextSize=math.floor(11*SCALE); run.TextColor3=Color3.new(1,1,1)
            Instance.new("UICorner",run).CornerRadius=UDim.new(0,8)
            run.MouseButton1Click:Connect(cb)
            return {}
        end

        function PageAPI:CreateToggle(title,desc,cb)
            cb=cb or function() end
            local fr=Card(40)
            local t=Instance.new("TextLabel",fr)
            t.BackgroundTransparency=1; t.Position=UDim2.new(0,8,0,2); t.Size=UDim2.new(1,-70,0,math.floor(18*SCALE))
            t.Font=Enum.Font.GothamBlack; t.TextSize=math.floor(12*SCALE); t.TextColor3=Color3.new(1,1,1); t.Text=string.upper(title or "TOGGLE"); t.TextXAlignment=Enum.TextXAlignment.Left
            local d=Instance.new("TextLabel",fr)
            d.BackgroundTransparency=1; d.Position=UDim2.new(0,8,0,math.floor(20*SCALE)); d.Size=UDim2.new(1,-70,0,math.floor(16*SCALE))
            d.Font=Enum.Font.Gotham; d.TextSize=math.floor(11*SCALE); d.TextColor3=Color3.fromRGB(170,170,170); d.TextXAlignment=Enum.TextXAlignment.Left; d.Text=desc or ""
            local track=Instance.new("Frame",fr)
            track.BackgroundColor3=Color3.fromRGB(24,25,32); track.Size=UDim2.fromOffset(math.floor(50*SCALE),math.floor(22*SCALE)); track.Position=UDim2.new(1,-math.floor(62*SCALE),0,math.floor(8*SCALE))
            Instance.new("UICorner",track).CornerRadius=UDim.new(1,0)
            local dot=Instance.new("Frame",track)
            dot.Size=UDim2.fromOffset(math.floor(18*SCALE),math.floor(18*SCALE)); dot.Position=UDim2.new(0,math.floor(2*SCALE),0,math.floor(2*SCALE)); dot.BackgroundColor3=ACCENT; dot.BackgroundTransparency=.6
            Instance.new("UICorner",dot).CornerRadius=UDim.new(1,0)

            local btn=Instance.new("TextButton",fr); btn.BackgroundTransparency=1; btn.Size=UDim2.new(1,0,1,0); btn.Text=""
            local on=false
            local function apply()
                tw(dot,.12,{
                    Position=on and UDim2.new(1,-math.floor(20*SCALE),0,math.floor(2*SCALE))
                               or UDim2.new(0,math.floor(2*SCALE),0,math.floor(2*SCALE)),
                    BackgroundTransparency=on and 0 or .6
                })
                cb(on)
            end
            btn.MouseButton1Click:Connect(function() on=not on; apply() end)
            return { Set=function(_,v) if v~=on then on=v; apply() end end }
        end

        function PageAPI:CreateBox(placeholder,_,cb)
            cb=cb or function() end
            local fr=Card(32)
            local t=Instance.new("TextLabel",fr)
            t.BackgroundTransparency=1; t.Font=Enum.Font.GothamBlack; t.TextSize=math.floor(12*SCALE); t.TextColor3=Color3.fromRGB(200,205,230)
            t.Text=string.upper(placeholder or "INPUT"); t.TextXAlignment=Enum.TextXAlignment.Left; t.Position=UDim2.new(0,8,0,0); t.Size=UDim2.new(1,-8,0,18)
            local tb=Instance.new("TextBox",fr)
            tb.BackgroundColor3=Color3.fromRGB(24,25,32); tb.Position=UDim2.new(0,8,0,20); tb.Size=UDim2.new(1,-16,0,26)
            tb.ClearTextOnFocus=false; tb.Text=""; tb.Font=Enum.Font.Gotham; tb.TextSize=math.floor(11*SCALE); tb.TextColor3=Color3.new(1,1,1); tb.PlaceholderText=placeholder or ""; tb.PlaceholderColor3=ACCENT_TEXT
            Instance.new("UICorner",tb).CornerRadius=UDim.new(0,8)
            tb.FocusLost:Connect(function() cb(tb.Text) end)
            return { SetText=function(_,t2) tb.Text=t2 or "" end }
        end

        function PageAPI:CreateDropdown(title, options, onChanged)
            options=options or {}; onChanged=onChanged or function() end
            local fr=Card(28); fr.Name="Dropdown"
            local ttl=Instance.new("TextLabel",fr)
            ttl.BackgroundTransparency=1; ttl.Position=UDim2.new(0,8,0,0); ttl.Size=UDim2.new(1,-40,0,18)
            ttl.Font=Enum.Font.GothamBlack; ttl.TextSize=math.floor(12*SCALE); ttl.TextColor3=Color3.new(1,1,1); ttl.Text=string.upper(title)
            local caret=Instance.new("TextLabel",fr)
            caret.BackgroundTransparency=1; caret.Size=UDim2.fromOffset(math.floor(16*SCALE),math.floor(16*SCALE)); caret.Position=UDim2.new(1,-math.floor(24*SCALE),0,0)
            caret.Font=Enum.Font.GothamBlack; caret.Text="v"; caret.TextSize=math.floor(11*SCALE); caret.TextColor3=ACCENT

            local holder=Instance.new("Frame",fr); holder.BackgroundColor3=Color3.fromRGB(26,26,32)
            holder.Position=UDim2.new(0,6,0,20); holder.Size=UDim2.new(1,-12,0,0)
            holder.AutomaticSize=Enum.AutomaticSize.Y; holder.Visible=false
            Instance.new("UICorner",holder).CornerRadius=UDim.new(0,8)
            Instance.new("UIListLayout",holder).Padding=UDim.new(0,4)
            local pad=Instance.new("UIPadding",holder); pad.PaddingTop=UDim.new(0,6); pad.PaddingBottom=UDim.new(0,6); pad.PaddingLeft=UDim.new(0,6); pad.PaddingRight=UDim.new(0,6)

            local current=nil
            local function rebuild(list)
                for _,c in ipairs(holder:GetChildren()) do if c:IsA("TextButton") then c:Destroy() end end
                for _,opt in ipairs(list) do
                    local b=Instance.new("TextButton",holder)
                    b.Size=UDim2.new(1,0,0,24); b.BackgroundColor3=BG_CARD
                    b.Text=opt; b.Font=Enum.Font.Gotham; b.TextSize=math.floor(11*SCALE); b.TextColor3=Color3.new(1,1,1)
                    Instance.new("UICorner",b).CornerRadius=UDim.new(0,8)
                    b.MouseButton1Click:Connect(function()
                        current=opt; ttl.Text=string.upper(("%s : %s"):format(title,opt))
                        holder.Visible=false; tw(caret,.12,{Rotation=0})
                        onChanged(opt)
                    end)
                end
            end
            rebuild(options)

            local open=false
            local header=Instance.new("TextButton",fr)
            header.BackgroundTransparency=1; header.Size=UDim2.new(1,0,0,20); header.Position=UDim2.new(0,0,0,0); header.Text=""
            header.MouseButton1Click:Connect(function()
                open=not open; holder.Visible=open; tw(caret,.12,{Rotation=open and 180 or 0})
            end)

            return {
                SetValue=function(_,v) current=v; ttl.Text=string.upper(("%s : %s"):format(title,tostring(v))) end,
                GetValue=function() return current end,
                SetOptions=function(_,opts) rebuild(opts or {}) end
            }
        end

        function PageAPI:CreateSlider(title, min, max, cb)
            min = tonumber(min) or 0
            max = tonumber(max) or 100
            cb  = cb or function() end

            local fr = Card(44)
            local t  = Instance.new("TextLabel", fr)
            t.BackgroundTransparency = 1
            t.Position = UDim2.new(0,8,0,2)
            t.Size = UDim2.new(1,-8,0,18)
            t.Font = Enum.Font.GothamBlack
            t.TextSize = math.floor(12*SCALE)
            t.TextColor3 = Color3.new(1,1,1)
            t.Text = string.upper(title or "SLIDER")
            t.TextXAlignment = Enum.TextXAlignment.Left

            local bar = Instance.new("Frame", fr)
            bar.BackgroundColor3 = Color3.fromRGB(24,25,32)
            bar.Position = UDim2.new(0,8,0,22)
            bar.Size = UDim2.new(1,-16,0,8)
            bar.BorderSizePixel = 0
            Instance.new("UICorner", bar).CornerRadius = UDim.new(0,8)

            local fill = Instance.new("Frame", bar)
            fill.BackgroundColor3 = ACCENT
            fill.Size = UDim2.new(0,0,1,0)
            fill.BorderSizePixel = 0
            Instance.new("UICorner", fill).CornerRadius = UDim.new(0,8)

            local valLbl = Instance.new("TextLabel", fr)
            valLbl.BackgroundTransparency = 1
            valLbl.Size = UDim2.new(0,60,0,16)
            valLbl.Position = UDim2.new(1,-68,0,2)
            valLbl.Font = Enum.Font.Gotham
            valLbl.TextSize = math.floor(11*SCALE)
            valLbl.TextColor3 = ACCENT_TEXT
            valLbl.TextXAlignment = Enum.TextXAlignment.Right

            local value = min
            local function render()
                local alpha = (value - min) / math.max(1, (max-min))
                fill.Size = UDim2.new(math.clamp(alpha,0,1), 0, 1, 0)
                valLbl.Text = tostring(math.floor(value))
            end
            render()

            local dragging = false
            bar.InputBegan:Connect(function(io)
                if io.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = true
                end
            end)
            bar.InputEnded:Connect(function(io)
                if io.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = false
                end
            end)
            RunService.RenderStepped:Connect(function()
                if dragging then
                    local abs = bar.AbsolutePosition
                    local size = bar.AbsoluteSize
                    local mx = UIS:GetMouseLocation().X
                    local pct = math.clamp((mx - abs.X) / size.X, 0, 1)
                    value = math.floor(min + pct * (max-min))
                    render()
                    cb(value)
                end
            end)

            return {
                Set = function(_,v)
                    value = math.clamp(tonumber(v) or value, min, max)
                    render()
                    cb(value)
                end
            }
        end

        return PageAPI
    end

    local winAPI = {}

    function winAPI:CreateTab(title)
        local tabObj = {}
        function tabObj:CreateFrame(pageTitle)
            return makePage(pageTitle or title or "Page")
        end
        return setmetatable(tabObj, {__index = tabObj})
    end

    return setmetatable({}, { __index = winAPI })
end

-- Buat window
local win = library:CreateWindow("AegisHub - Fish It", "Premium", 10044538000)

--========================================================
-- PART 2 - FARM (Auto Fish + Auto Favorite + Auto Sell + Auto Enchant + Weather)
--========================================================

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players2          = game:GetService("Players")
local Workspace2        = game:GetService("Workspace")
local LocalPlayer2      = Players2.LocalPlayer

-- sleitnick/net
local netIndex = ReplicatedStorage:WaitForChild("Packages")
    :WaitForChild("_Index")
    :WaitForChild("sleitnick_net@0.2.0")

local net = netIndex:WaitForChild("net")

local RF_Charge              = net:WaitForChild("RF/ChargeFishingRod")
local RF_RequestMinigame     = net:WaitForChild("RF/RequestFishingMinigameStarted")
local RE_FishingCompleted    = net:WaitForChild("RE/FishingCompleted")
local RE_EquipHotbar         = net:WaitForChild("RE/EquipToolFromHotbar")
local RE_TextEffect          = net:WaitForChild("RE/ReplicateTextEffect")
local RE_FishCaught          = net:FindFirstChild("RE/FishCaught")

-- Tambahan dari decompile (favorit, jual, weather, enchant)
local RE_ObtainedNewFish     = net:WaitForChild("RE/ObtainedNewFishNotification")
local RE_FavoriteItem        = net:WaitForChild("RE/FavoriteItem")
local RF_SellAllItems        = net:WaitForChild("RF/SellAllItems")
local RF_PurchaseWeather     = net:WaitForChild("RF/PurchaseWeatherEvent")
local RE_ActivateEnchant     = net:WaitForChild("RE/ActivateEnchantingAltar")

--========================================================
-- TAB FARM
--========================================================
local TabFarm   = win:CreateTab("Main")
local PageFarm  = TabFarm:CreateFrame("Main")
PageFarm:CreateLabel("MAIN MENU")

--========================================================
-- STATE FARM
--========================================================
local Farm = {
    -- AUTO FISH
    AutoFish_Enabled        = false,
    AutoFish_CompleteDelay  = 0.10, -- jeda dari ! ke tarik
    AutoFish_ReelDelay      = 0.05, -- jeda dari tarik ke lempar

    -- FAVORITE
    AutoFavorite_Enabled    = false,
    AutoFavorite_Rarity     = {
        COMMON    = false,
        UNCOMMON  = false,
        RARE      = false,
        EPIC      = false,
        LEGENDARY = false,
        MYTHIC    = false,
        SECRET    = false,
    },

    -- AUTO SELL
    AutoSell_Enabled        = false,
    AutoSell_Threshold      = 30,
    AutoSell_Delay          = 1.0,

    -- AUTO WEATHER (hanya satu aktif sekaligus via dropdown)
    AutoWeather             = {
        Storm   = false,
        Cloudy  = false,
        Snow    = false,
        Wind    = false,
        Radiant = false,
    },

    -- AUTO ENCHANT (manual sekali via dropdown)
    AutoEnchant_LastRun     = 0,
}

--========================================================
-- EQUIP ROD SEKALI
--========================================================
local RodEquippedOnce = false

local function EquipRodOnce()
    if RodEquippedOnce then return end
    RodEquippedOnce = true
    RE_EquipHotbar:FireServer(1) -- slot 1
    task.wait(0.30)
end

--========================================================
-- AUTO FISH - CAST + EXCLAIM HANDLER GLOBAL
--========================================================
local BASE_X, BASE_Y = -0.75, 1

local function DoCastOnce()
    if not Farm.AutoFish_Enabled then return end

    EquipRodOnce()

    local serverTime = Workspace2:GetServerTimeNow()
    RF_Charge:InvokeServer(serverTime)

    local rx = BASE_X + math.random(-300, 300) / 1e7
    local ry = BASE_Y + math.random(-300, 300) / 1e7

    RF_RequestMinigame:InvokeServer(rx, ry)
end

-- Exclaim global → tarik + recast (bypass delay = delay kecil, bisa diatur)
RE_TextEffect.OnClientEvent:Connect(function(data)
    if not Farm.AutoFish_Enabled then return end
    if not data or not data.TextData then return end
    if data.TextData.EffectType ~= "Exclaim" then return end

    local char = LocalPlayer2.Character
    local head = char and char:FindFirstChild("Head")
    if not head or data.Container ~= head then return end

    local completeDelay = tonumber(Farm.AutoFish_CompleteDelay) or 0.10
    local reelDelay     = tonumber(Farm.AutoFish_ReelDelay)     or 0.05

    if completeDelay < 0 then completeDelay = 0 end
    if reelDelay     < 0 then reelDelay     = 0 end

    task.delay(completeDelay, function()
        if not Farm.AutoFish_Enabled then return end

        RE_FishingCompleted:FireServer()

        task.delay(reelDelay, function()
            if Farm.AutoFish_Enabled then
                DoCastOnce()
            end
        end)
    end)
end)

--========================================================
-- RARITY MAP (FishId → Rarity) untuk Auto Favorite
--========================================================
local FishIdToRarity = {}
local tierToRarity = {
    [1] = "COMMON",
    [2] = "UNCOMMON",
    [3] = "RARE",
    [4] = "EPIC",
    [5] = "LEGENDARY",
    [6] = "MYTHIC",
    [7] = "SECRET",
}

do
    local itemsFolder = ReplicatedStorage:FindFirstChild("Items")
    if itemsFolder then
        for _, module in ipairs(itemsFolder:GetChildren()) do
            if module:IsA("ModuleScript") then
                local ok, data = pcall(require, module)
                if ok and data and data.Data and data.Data.Type == "Fish" then
                    local id   = data.Data.Id
                    local tier = tonumber(data.Data.Tier) or 0
                    local rarity = data.Data.Rarity
                    if not rarity then
                        rarity = tierToRarity[tier] or "UNKNOWN"
                    end
                    if id then
                        FishIdToRarity[id] = string.upper(tostring(rarity))
                    end
                end
            end
        end
    end
end

--========================================================
-- AUTO FAVORITE + AUTO SELL (pakai ObtainedNewFish)
--========================================================
local AutoSell_Count    = 0
local AutoSell_Cooldown = false

RE_ObtainedNewFish.OnClientEvent:Connect(function(itemId, _, data)
    if not data or not data.InventoryItem then return end
    local invItem = data.InventoryItem
    local uuid    = invItem.UUID
    if not uuid then return end

    -- AUTO FAVORITE BY RARITY
    if Farm.AutoFavorite_Enabled and itemId then
        local rarity = FishIdToRarity[itemId] or "UNKNOWN"
        rarity = string.upper(rarity)
        if Farm.AutoFavorite_Rarity[rarity] then
            pcall(function()
                RE_FavoriteItem:FireServer(uuid)
            end)
        end
    end

    -- AUTO SELL DENGAN DELAY
    if Farm.AutoSell_Enabled then
        AutoSell_Count += 1
        local limit = tonumber(Farm.AutoSell_Threshold) or 30
        if AutoSell_Count >= limit and not AutoSell_Cooldown then
            AutoSell_Cooldown = true
            task.spawn(function()
                pcall(function()
                    RF_SellAllItems:InvokeServer()
                end)
                local delaySell = tonumber(Farm.AutoSell_Delay) or 1.0
                if delaySell < 0 then delaySell = 0 end
                task.wait(delaySell)
                AutoSell_Count    = 0
                AutoSell_Cooldown = false
            end)
        end
    end
end)

--========================================================
-- AUTO ENCHANT ROD (teleport ke altar, slot 5)
--========================================================
local ENCHANT_POSITION = Vector3.new(3231, -1303, 1402) -- contoh dari decompile

local function AutoEnchantRod()
    local chars = Workspace2:FindFirstChild("Characters")
    local char  = chars and chars:FindFirstChild(LocalPlayer2.Name)
    local hrp   = char and char:FindFirstChild("HumanoidRootPart")
    if not hrp then
        warn("[AutoEnchant] HRP tidak ditemukan")
        return
    end

    print("[AutoEnchant] Pastikan Enchant Stone ada di slot 5")

    local originalCFrame = hrp.CFrame

    task.wait(0.5)
    hrp.CFrame = CFrame.new(ENCHANT_POSITION + Vector3.new(0, 5, 0))
    task.wait(1.0)

    pcall(function()
        RE_EquipHotbar:FireServer(5)
        task.wait(0.5)
        RE_ActivateEnchant:FireServer()
    end)

    task.wait(7)
    hrp.CFrame = originalCFrame

    print("[AutoEnchant] Selesai")
end

--========================================================
-- AUTO BUY WEATHER (BISA MULTI)
--========================================================
local function randomDelay(min, max)
    return math.random(min * 100, max * 100) / 100
end

local WeatherThreads = {} -- name -> thread

local function startWeatherLoop(weatherName)
    if WeatherThreads[weatherName] then return end

    WeatherThreads[weatherName] = task.spawn(function()
        while Farm.AutoWeather[weatherName] do
            pcall(function()
                RF_PurchaseWeather:InvokeServer(weatherName)
                print("[AutoWeather] Beli weather:", weatherName)
            end)

            local baseDuration = 900 -- 15 menit
            local extraDelay   = randomDelay(1, 5)
            local totalWait    = baseDuration + extraDelay

            local t0 = tick()
            while tick() - t0 < totalWait do
                if not Farm.AutoWeather[weatherName] then break end
                task.wait(1)
            end
        end
        WeatherThreads[weatherName] = nil
    end)
end

-- Helper: aktifkan AutoFavorite_Enabled bila ada minimal satu rarity ON
local function refreshAutoFavoriteEnabled()
    Farm.AutoFavorite_Enabled = false
    for _, v in pairs(Farm.AutoFavorite_Rarity) do
        if v then
            Farm.AutoFavorite_Enabled = true
            break
        end
    end
end


------------------------------------------------------------
-- 2. AUTO FAVORITE BY RARITY (MULTI SELECT)
------------------------------------------------------------
PageFarm:CreateLabel("Auto Favorite")

local rarityOptions = {
    "COMMON",
    "UNCOMMON",
    "RARE",
    "EPIC",
    "LEGENDARY",
    "MYTHIC",
    "SECRET",
    "[Clear All]"
}

local ddAutoFavorite = PageFarm:CreateDropdown("Select Rarity to Favorite (multi)", rarityOptions, function(opt)
    if opt == "[Clear All]" then
        for k in pairs(Farm.AutoFavorite_Rarity) do
            Farm.AutoFavorite_Rarity[k] = false
        end
    else
        local key = string.upper(opt)
        if Farm.AutoFavorite_Rarity[key] ~= nil then
            Farm.AutoFavorite_Rarity[key] = not Farm.AutoFavorite_Rarity[key]
        end
    end

    refreshAutoFavoriteEnabled()

    -- update teks dropdown: list rarity yang aktif
    local selected = {}
    for r, flag in pairs(Farm.AutoFavorite_Rarity) do
        if flag then table.insert(selected, r) end
    end
    table.sort(selected)
    local summary = (#selected > 0) and table.concat(selected, ", ") or "None"
    ddAutoFavorite:SetValue(summary)
end)
ddAutoFavorite:SetValue("None")

PageFarm:CreateLabel("Auto Favorite Fish")
PageFarm:CreateBox("Info: Akan auto favorite ikan baru sesuai rarity terpilih di atas", function() end)

------------------------------------------------------------
-- 5. AUTO BUY WEATHER (MULTI SELECT)
------------------------------------------------------------
PageFarm:CreateLabel("Weather Option")

local weatherOptions = {
    "Storm",
    "Cloudy",
    "Snow",
    "Wind",
    "Radiant",
    "[Clear All]"
}

local ddWeather = PageFarm:CreateDropdown("Auto Weather (multi)", weatherOptions, function(opt)
    if opt == "[Clear All]" then
        for k in pairs(Farm.AutoWeather) do
            Farm.AutoWeather[k] = false
        end
    else
        local key = opt
        if Farm.AutoWeather[key] ~= nil then
            Farm.AutoWeather[key] = not Farm.AutoWeather[key]
            if Farm.AutoWeather[key] then
                startWeatherLoop(key)
            end
        end
    end

    -- update teks dropdown: list weather yang aktif
    local selected = {}
    for name, flag in pairs(Farm.AutoWeather) do
        if flag then table.insert(selected, name) end
    end
    table.sort(selected)
    local summary = (#selected > 0) and table.concat(selected, ", ") or "Off"
    ddWeather:SetValue(summary)
end)
ddWeather:SetValue("Off")


----------------------------------------------------------------
-- AUTO SELL (dropdown interval + delay)
----------------------------------------------------------------
PageFarm:CreateLabel("AUTO SELL (SELL ALL)")

local ddAutoSell = PageFarm:CreateDropdown("Auto Sell Mode", {
    "Off",
    "10 Fish",
    "20 Fish",
    "30 Fish",
    "50 Fish"
}, function(opt)
    if opt == "Off" then
        Farm.AutoSell_Enabled   = false
        AutoSell_Count          = 0
        return
    end

    Farm.AutoSell_Enabled = true
    if opt == "10 Fish" then
        Farm.AutoSell_Threshold = 10
    elseif opt == "20 Fish" then
        Farm.AutoSell_Threshold = 20
    elseif opt == "30 Fish" then
        Farm.AutoSell_Threshold = 30
    elseif opt == "50 Fish" then
        Farm.AutoSell_Threshold = 50
    end
end)
ddAutoSell:SetValue("Off")

PageFarm:CreateBox("Input delay", function(txt)
    local n = tonumber(txt)
    if n and n >= 0 then
        Farm.AutoSell_Delay = n
    end
end)

----------------------------------------------------------------
-- AUTO ENCHANT (Dropdown trigger sekali)
----------------------------------------------------------------
PageFarm:CreateLabel("AUTO ENCHANT")

local ddAutoEnchant = PageFarm:CreateDropdown("Auto Enchant Action", {
    "Idle",
    "Run once now"
}, function(opt)
    if opt == "Run once now" then
        if tick() - Farm.AutoEnchant_LastRun < 5 then
            warn("[AutoEnchant] Tunggu sebentar sebelum menjalankan lagi.")
            return
        end
        Farm.AutoEnchant_LastRun = tick()
        AutoEnchantRod()
        -- balik ke Idle biar jelas
        ddAutoEnchant:SetValue("Idle")
    end
end)
ddAutoEnchant:SetValue("Idle")



--========================================================
-- PART 3 - TELEPORT + MISC + FPS/PING OVERLAY
--========================================================

local VirtualUser = game:GetService("VirtualUser")
local Stats       = game:GetService("Stats")

--------------------------------------------------------
-- TELEPORT TAB
--------------------------------------------------------
local function tpTo(pos: Vector3)
    if not pos then return end
    local plr = LocalPlayer
    local ch  = plr and (plr.Character or plr.CharacterAdded:Wait())
    local hrp = ch and ch:FindFirstChild("HumanoidRootPart")
    if hrp then
        hrp.CFrame = CFrame.new(pos + Vector3.new(0, 5, 0))
    end
end

local TabTP  = win:CreateTab("Teleport")
local PageTP = TabTP:CreateFrame("Teleport")
PageTP:CreateLabel("TELEPORT MENU")

-- Island list
local islands = {
    ["Weather Machine"]            = Vector3.new(-1471,-3,1929),
    ["Esoteric Depths"]            = Vector3.new(3157,-1303,1439),
    ["Tropical Grove"]             = Vector3.new(-2038,3,3650),
    ["Stingray Shores"]            = Vector3.new(-32,4,2773),
    ["Kohana Volcano"]             = Vector3.new(-519,24,189),
    ["Coral Reefs"]                = Vector3.new(-3095,1,2177),
    ["Crater Island"]              = Vector3.new(968,1,4854),
    ["Kohana"]                     = Vector3.new(-658,3,719),
    ["Winter Fest"]                = Vector3.new(1611,4,3280),
    ["Esoteric Island"]            = Vector3.new(1987,4,1400),
    ["Treasure Room"]              = Vector3.new(-3600,-267,-1558),
    ["Lost Shore"]                 = Vector3.new(-3663,38,-989),
    ["Sisyphus"]                   = Vector3.new(-3792,-135,-986),
    ["Crystal Cavern"]             = Vector3.new(-2026,-440,7428),
    ["Halloween"]                  = Vector3.new(2127,78,3334),
    ["Ancient Underground Cave"]   = Vector3.new(2102,-91,-709),
    ["Ancient Inside Temple"]      = Vector3.new(1506,-22,-641),
    ["Ancient Jungle"]             = Vector3.new(1268,78,-183),
    ["Fisherman Island"]           = Vector3.new(-3,17,2840),
}
local islandList = {}
for name in pairs(islands) do table.insert(islandList, name) end
table.sort(islandList)

PageTP:CreateDropdown("Teleport Island", islandList, function(choice)
    local v = islands[choice]
    if v then tpTo(v) end
end)

-- Scan NPC models
local function scanNPC_Models()
    local found = {}
    for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and #m.Name >= 3 then
            if Players:GetPlayerFromCharacter(m) == nil then
                local hasHum = m:FindFirstChildOfClass("Humanoid") ~= nil
                local hasPrompt = false
                if not hasHum then
                    for _,d in ipairs(m:GetDescendants()) do
                        if d:IsA("ProximityPrompt") then hasPrompt = true break end
                    end
                end
                if hasHum or hasPrompt then
                    found[m.Name] = true
                end
            end
        end
    end
    local list = {}
    for k in pairs(found) do table.insert(list, k) end
    table.sort(list)
    return list
end

local npcList = scanNPC_Models()
local ddNPC = PageTP:CreateDropdown("Teleport NPC", npcList, function(nm)
    if not nm or nm == "" then return end
    local me   = LocalPlayer
    local ch   = me and (me.Character or me.CharacterAdded:Wait())
    local hrp  = ch and ch:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    local best,dist
    for _,m in ipairs(Workspace:GetDescendants()) do
        if m:IsA("Model") and Players:GetPlayerFromCharacter(m) == nil then
            if string.find(string.lower(m.Name), string.lower(nm), 1, true) then
                local p = m:FindFirstChild("HumanoidRootPart") or m.PrimaryPart or m:FindFirstChildWhichIsA("BasePart")
                if p then
                    local d = (p.Position - hrp.Position).Magnitude
                    if not dist or d < dist then best = p; dist = d end
                end
            end
        end
    end
    if best then tpTo(best.Position) end
end)

-- Players dropdown
local function playersList()
    local t = {}
    for _,pl in ipairs(Players:GetPlayers()) do
        if pl ~= LocalPlayer then table.insert(t, pl.Name) end
    end
    table.sort(t)
    return t
end

local plrList = playersList()
local ddPlayer = PageTP:CreateDropdown("Teleport Player", plrList, function(nm)
    local p = Players:FindFirstChild(nm)
    if p and p.Character and p.Character:FindFirstChild("HumanoidRootPart") then
        tpTo(p.Character.HumanoidRootPart.Position)
    end
end)

-- Refresh NPC & Player lists berkala
task.spawn(function()
    while true do
        task.wait(8)
        -- NPC refresh
        local newNPC = scanNPC_Models()
        if ddNPC and ddNPC.SetOptions then
            ddNPC:SetOptions(newNPC)
        end
        -- Player refresh
        local newPL = playersList()
        if ddPlayer and ddPlayer.SetOptions then
            ddPlayer:SetOptions(newPL)
        end
    end
end)

Players.PlayerAdded:Connect(function()
    if ddPlayer and ddPlayer.SetOptions then ddPlayer:SetOptions(playersList()) end
end)
Players.PlayerRemoving:Connect(function()
    if ddPlayer and ddPlayer.SetOptions then ddPlayer:SetOptions(playersList()) end
end)

--------------------------------------------------------
-- MISC TAB (ANTI AFK, FPS BOOST, LIGHTING, DLL)
--------------------------------------------------------
local TabMisc   = win:CreateTab("Misc")
local PageMisc  = TabMisc:CreateFrame("Misc")
PageMisc:CreateLabel("MISC / PERFORMANCE")

local MiscState = {
    AntiAFK        = false,
    FPSBoost       = false,
    LightingSimple = false,
    TexturesOff    = false,
    SmoothPlastic  = false,
    UltraNoEffects = false,
    FPSCapValue    = 190,
}

local Saved = {
    PostEffects   = {},
    GlobalShadows = nil,
    FogEnd        = nil,
}

-- ANTI AFK
local AntiAFK_Conn

local function EnableAntiAFK()
    if AntiAFK_Conn then AntiAFK_Conn:Disconnect() end
    AntiAFK_Conn = LocalPlayer.Idled:Connect(function()
        local cam = Workspace.CurrentCamera
        VirtualUser:Button2Down(Vector2.new(0,0), cam and cam.CFrame or CFrame.new())
        task.wait(0.7)
        VirtualUser:Button2Up(Vector2.new(0,0), cam and cam.CFrame or CFrame.new())
    end)
end

local function DisableAntiAFK()
    if AntiAFK_Conn then AntiAFK_Conn:Disconnect(); AntiAFK_Conn = nil end
end

-- FPS BOOST HELPERS
local function ApplySmoothPlastic()
    for _, v in ipairs(game:GetDescendants()) do
        if v:IsA("BasePart") then
            v.Material = Enum.Material.SmoothPlastic
            v.Reflectance = 0
        end
    end
end

local function DisableTextures()
    for _, v in ipairs(game:GetDescendants()) do
        if v:IsA("Decal") or v:IsA("Texture") then
            v.Transparency = 1
        end
    end
end

local function LightingSimplify()
    if Saved.GlobalShadows == nil then
        Saved.GlobalShadows = Lighting.GlobalShadows
    end
    if Saved.FogEnd == nil then
        Saved.FogEnd = Lighting.FogEnd
    end
    if #Saved.PostEffects == 0 then
        for _, eff in ipairs(Lighting:GetChildren()) do
            if eff:IsA("PostEffect") then
                table.insert(Saved.PostEffects, {ref = eff, enabled = eff.Enabled})
            end
        end
    end

    for _, eff in ipairs(Lighting:GetChildren()) do
        if eff:IsA("PostEffect") then
            eff.Enabled = false
        end
    end

    Lighting.GlobalShadows = false
    Lighting.FogEnd = 1e10
    Lighting.Brightness = 1
    Lighting.EnvironmentDiffuseScale  = 0
    Lighting.EnvironmentSpecularScale = 0
end

local function ResetLighting()
    for _, item in ipairs(Saved.PostEffects) do
        if item.ref and item.ref.Parent then
            item.ref.Enabled = item.enabled
        end
    end
    if Saved.GlobalShadows ~= nil then
        Lighting.GlobalShadows = Saved.GlobalShadows
    end
    if Saved.FogEnd ~= nil then
        Lighting.FogEnd = Saved.FogEnd
    end
end

local function KillCharacterAnimation(char)
    if not char then return end
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    if humanoid then
        for _, track in ipairs(humanoid:GetPlayingAnimationTracks()) do
            pcall(function() track:Stop() end)
        end
        local animator = humanoid:FindFirstChildOfClass("Animator")
        if animator then
            pcall(function() animator:Destroy() end)
        end
    end
    local animate = char:FindFirstChild("Animate")
    if animate then
        pcall(function() animate:Destroy() end)
    end
end

local function KillAllHumanoidAnimations()
    for _, hum in ipairs(game:GetDescendants()) do
        if hum:IsA("Humanoid") then
            KillCharacterAnimation(hum.Parent)
        end
    end
end

local function KillParticlesAndLights()
    for _, v in ipairs(game:GetDescendants()) do
        if v:IsA("ParticleEmitter")
        or v:IsA("Trail")
        or v:IsA("Fire")
        or v:IsA("Smoke")
        or v:IsA("Sparkles")
        or v:IsA("Explosion")
        or v:IsA("Beam") then
            v.Enabled = false
        elseif v:IsA("PointLight")
        or v:IsA("SpotLight")
        or v:IsA("SurfaceLight") then
            v.Enabled = false
        end
    end

    local terrain = Workspace:FindFirstChildOfClass("Terrain")
    if terrain then
        terrain.WaterWaveSize        = 0
        terrain.WaterWaveSpeed       = 0
        terrain.WaterReflectance     = 0
        terrain.WaterTransparency    = 0
    end
end

local function UltraNoEffectsApply()
    KillAllHumanoidAnimations()
    KillParticlesAndLights()

    local function onChar(char)
        task.delay(1, function()
            if MiscState.UltraNoEffects then
                KillCharacterAnimation(char)
            end
        end)
    end

    if LocalPlayer.Character then
        onChar(LocalPlayer.Character)
    end
    LocalPlayer.CharacterAdded:Connect(onChar)
end

local function FPSBoostApply()
    if MiscState.SmoothPlastic   then ApplySmoothPlastic()   end
    if MiscState.TexturesOff     then DisableTextures()      end
    if MiscState.LightingSimple  then LightingSimplify()     end
    if MiscState.UltraNoEffects  then UltraNoEffectsApply()  end

    settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
end

local function ApplyFPSCap()
    if typeof(setfpscap) == "function" then
        setfpscap(tonumber(MiscState.FPSCapValue) or 120)
    end
end

-- UI DROPDOWNS MISC

-- Anti AFK
local ddAntiAFK = PageMisc:CreateDropdown("Anti AFK", {"Off","On"}, function(opt)
    MiscState.AntiAFK = (opt == "On")
    if MiscState.AntiAFK then
        EnableAntiAFK()
    else
        DisableAntiAFK()
    end
end)
ddAntiAFK:SetValue("On")
MiscState.AntiAFK = true
EnableAntiAFK()

-- FPS Boost
local ddFPSBoost = PageMisc:CreateDropdown("FPS Boost (Aggressive)", {"Off","On"}, function(opt)
    MiscState.FPSBoost = (opt == "On")
    if MiscState.FPSBoost then
        FPSBoostApply()
    else
        ResetLighting()
    end
end)
ddFPSBoost:SetValue("On")
MiscState.FPSBoost = true
FPSBoostApply()

-- Lighting Simplify
local ddLighting = PageMisc:CreateDropdown("Lighting Simplify", {"Off","On"}, function(opt)
    MiscState.LightingSimple = (opt == "On")
    if MiscState.LightingSimple then
        LightingSimplify()
    else
        ResetLighting()
    end
end)
ddLighting:SetValue("On")
MiscState.LightingSimple = true
LightingSimplify()

-- Textures/Decals
local ddTextures = PageMisc:CreateDropdown("Textures / Decals", {"Keep","Hide All"}, function(opt)
    MiscState.TexturesOff = (opt == "Hide All")
    if MiscState.TexturesOff then
        DisableTextures()
    end
end)
ddTextures:SetValue("Hide All")
MiscState.TexturesOff = true
DisableTextures()

-- SmoothPlastic
local ddSmooth = PageMisc:CreateDropdown("Part Material", {"Default","SmoothPlastic"}, function(opt)
    MiscState.SmoothPlastic = (opt == "SmoothPlastic")
    if MiscState.SmoothPlastic then
        ApplySmoothPlastic()
    end
end)
ddSmooth:SetValue("SmoothPlastic")
MiscState.SmoothPlastic = true
ApplySmoothPlastic()

-- Ultra No Effects
local ddUltra = PageMisc:CreateDropdown("ULTRA: No Anim/Particles", {"Off","On (One-way)"}, function(opt)
    MiscState.UltraNoEffects = (opt == "On (One-way)")
    if MiscState.UltraNoEffects then
        UltraNoEffectsApply()
    end
end)
ddUltra:SetValue("On (One-way)")
MiscState.UltraNoEffects = true
UltraNoEffectsApply()

-- FPS Cap Dropdown
local ddFPSCap = PageMisc:CreateDropdown("FPS Cap", {"60","90","120","144","240","Unlimited"}, function(opt)
    if opt == "Unlimited" then
        MiscState.FPSCapValue = 1000
    else
        MiscState.FPSCapValue = tonumber(opt) or 120
    end
    ApplyFPSCap()
end)
ddFPSCap:SetValue("120")
MiscState.FPSCapValue = 120
ApplyFPSCap()

-- Reset Lighting action
local ddResetLight = PageMisc:CreateDropdown("Lighting Action", {"Idle","Reset Lighting Now"}, function(opt)
    if opt == "Reset Lighting Now" then
        ResetLighting()
        ddResetLight:SetValue("Idle")
    end
end)
ddResetLight:SetValue("Idle")

--------------------------------------------------------
-- FPS + PING OVERLAY (TEXT, DRAGGABLE)
--------------------------------------------------------
local guiParent = (gethui and gethui()) or CoreGui

local oldOverlay = guiParent:FindFirstChild("FPS_PING_TEXT_ONLY")
if oldOverlay then
    oldOverlay:Destroy()
end

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "FPS_PING_TEXT_ONLY"
screenGui.ResetOnSpawn = false
screenGui.IgnoreGuiInset = true
if syn and syn.protect_gui then
    syn.protect_gui(screenGui)
end
screenGui.Parent = guiParent

local holder = Instance.new("Frame")
holder.Name = "Holder"
holder.Parent = screenGui
holder.BackgroundTransparency = 1
holder.BorderSizePixel = 0
holder.AnchorPoint = Vector2.new(0, 0)
holder.Position = UDim2.new(0, 0, 0, 6)
holder.Size = UDim2.new(0, 320, 0, 20)

task.spawn(function()
    task.wait(0.15)
    local cam3 = Workspace.CurrentCamera
    if cam3 then
        local vp = cam3.ViewportSize
        holder.Position = UDim2.new(0, (vp.X - holder.AbsoluteSize.X) / 2, 0, 6)
    else
        holder.Position = UDim2.new(0, 10, 0, 6)
    end
end)

local hList = Instance.new("UIListLayout", holder)
hList.FillDirection = Enum.FillDirection.Horizontal
hList.SortOrder = Enum.SortOrder.LayoutOrder
hList.VerticalAlignment = Enum.VerticalAlignment.Center
hList.Padding = UDim.new(0, 6)

local infoLabel = Instance.new("TextLabel")
infoLabel.Name = "InfoLabel"
infoLabel.Parent = holder
infoLabel.BackgroundTransparency = 1
infoLabel.BorderSizePixel = 0
infoLabel.Size = UDim2.new(0, 320, 0, 20)
infoLabel.Font = Enum.Font.Code
infoLabel.TextSize = 14
infoLabel.TextXAlignment = Enum.TextXAlignment.Left
infoLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
infoLabel.TextStrokeTransparency = 0.5
infoLabel.TextStrokeColor3 = Color3.fromRGB(0, 0, 0)
infoLabel.Text = "FPS: ... | Ping: ..."

-- drag overlay
do
    local dragging = false
    local dragStart, startPos

    holder.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = holder.Position

            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)

    UIS.InputChanged:Connect(function(input)
        if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
            local delta = input.Position - dragStart
            local newX = startPos.X.Offset + delta.X
            local newY = startPos.Y.Offset + delta.Y

            local cam3 = Workspace.CurrentCamera
            if cam3 then
                local vp = cam3.ViewportSize
                newX = math.clamp(newX, 0, vp.X - holder.AbsoluteSize.X)
                newY = math.clamp(newY, 0, vp.Y - holder.AbsoluteSize.Y)
            end

            holder.Position = UDim2.new(0, newX, 0, newY)
        end
    end)
end

-- FPS smoothing
local fps = 0
local avgFPS = 0
local alphaFPS = 0.15

RunService.RenderStepped:Connect(function(dt)
    local instFPS = 1 / math.max(dt, 1/1000)
    if avgFPS == 0 then
        avgFPS = instFPS
    else
        avgFPS = avgFPS + (instFPS - avgFPS) * alphaFPS
    end
    fps = avgFPS
end)

local function getPingMs()
    local pingStat
    local ok = pcall(function()
        pingStat = Stats.Network.ServerStatsItem["Data Ping"]
    end)

    if ok and pingStat then
        local str = pingStat:GetValueString() or ""
        local num = tonumber(string.match(str, "(%d+)"))
        return num or 0
    end

    return 0
end

task.spawn(function()
    while screenGui.Parent do
        local fpsRounded = math.floor(fps + 0.5)
        local pingMs = getPingMs()

        if pingMs > 0 then
            infoLabel.Text = "FPS: " .. tostring(fpsRounded) .. " | Ping: " .. tostring(pingMs) .. " ms"
        else
            infoLabel.Text = "FPS: " .. tostring(fpsRounded) .. " | Ping: N/A"
        end

        task.wait(0.25)
    end
end)

-- Dropdown untuk show/hide overlay
PageMisc:CreateDropdown("Stats Overlay", {"On","Off"}, function(opt)
    if screenGui then
        screenGui.Enabled = (opt == "On")
    end
end)
