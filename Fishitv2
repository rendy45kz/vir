-- AegisHub • Fish It • Vanis UI (Delta Android Safe, with Overlay Toggle)
-- One-tab-many-frames so every menu shows up | Overlay neon toggle (draggable)

-------------------- Services --------------------
local Players            = game:GetService("Players")
local LocalPlayer        = Players.LocalPlayer
local CoreGui            = game:GetService("CoreGui")
local RS                 = game:GetService("RunService")
local UIS                = game:GetService("UserInputService")
local Lighting           = game:GetService("Lighting")
local HttpService        = game:GetService("HttpService")
local TeleportService    = game:GetService("TeleportService")
local VirtualUser        = game:GetService("VirtualUser")
local ReplicatedStorage  = game:GetService("ReplicatedStorage")

local TARGET_PLACE = 121864768012064 -- Fish It

-------------------- Helpers --------------------
local function mount(gui)
    if syn and syn.protect_gui then pcall(syn.protect_gui, gui) end
    for _,p in ipairs({(gethui and gethui()) or nil, CoreGui, LocalPlayer:FindFirstChild("PlayerGui")}) do
        if p and p:IsDescendantOf(game) then
            if pcall(function() gui.Parent = p end) then
                pcall(function()
                    if gui:IsA("ScreenGui") then
                        gui.DisplayOrder = 1_000_000
                        gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
                    end
                end)
                return
            end
        end
    end
end

-------------------- Anti-AFK --------------------
local AFKConn
local function setAntiAFK(on)
    if on then
        if AFKConn then AFKConn:Disconnect() end
        AFKConn = LocalPlayer.Idled:Connect(function()
            pcall(function()
                VirtualUser:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
                task.wait(0.8)
                VirtualUser:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
            end)
        end)
    else
        if AFKConn then AFKConn:Disconnect(); AFKConn=nil end
    end
end
setAntiAFK(true)

-------------------- State & timing --------------------
local state = {
    SPEED=5, perfectCast=true, AFon=false, AFfishing=false,
    reelPreset=1.2, completePreset=2.5,
    reelOverride=nil, completeOverride=nil,
    protectTiers={Common=false,Uncommon=false,Rare=false,Epic=false,Legendary=true,Mythic=true,Secret=true},
    AutoSell={on=false, threshold=60, last=0},
}
local function clamp(n,a,b) if n<a then return a elseif n>b then return b else return n end end
local function effDelays()
    local c=(state.completeOverride or state.completePreset)/state.SPEED
    local r=(state.reelOverride     or state.reelPreset)/state.SPEED
    return clamp(c,0.35,12), clamp(r,0.15,6)
end

-------------------- Remotes / Anims / Modules --------------------
local net, RF_ChargeFishingRod, RF_RequestMinigame, RE_FishingCompleted, RE_EquipHotbar, RE_RepText, RF_SellAll
local animator, AIdle, AReel, AShake
local Replion, ItemUtility

task.spawn(function()
    local function gw(obj,name,t) return obj:FindFirstChild(name) or obj:WaitForChild(name,t or 10) end
    local okNet, netOrErr = pcall(function()
        local p=gw(ReplicatedStorage,"Packages",10); p=gw(p,"_Index",10); p=gw(p,"sleitnick_net@0.2.0",10); return gw(p,"net",10)
    end)
    if okNet then
        net=netOrErr
        RF_ChargeFishingRod = net:FindFirstChild("RF/ChargeFishingRod")
        RF_RequestMinigame  = net:FindFirstChild("RF/RequestFishingMinigameStarted")
        RE_FishingCompleted = net:FindFirstChild("RE/FishingCompleted")
        RE_EquipHotbar      = net:FindFirstChild("RE/EquipToolFromHotbar")
        RE_RepText          = net:FindFirstChild("RE/ReplicateTextEffect")
        RF_SellAll          = net:FindFirstChild("RF/SellAllItems")
    end

    local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
    local humanoid  = character:WaitForChild("Humanoid")
    animator = humanoid:FindFirstChildOfClass("Animator") or Instance.new("Animator", humanoid)
    local okIdle,RodIdle  = pcall(function() return ReplicatedStorage.Modules.Animations.FishingRodReelIdle end)
    local okReel,RodReel  = pcall(function() return ReplicatedStorage.Modules.Animations.EasyFishReelStart end)
    local okShake,RodShake= pcall(function() return ReplicatedStorage.Modules.Animations.CastFromFullChargePosition1Hand end)
    AIdle  = okIdle  and animator:LoadAnimation(RodIdle) or nil
    AReel  = okReel  and animator:LoadAnimation(RodReel) or nil
    AShake = okShake and animator:LoadAnimation(RodShake) or nil

    local okR,modR=pcall(function() return require(ReplicatedStorage:WaitForChild("Packages"):WaitForChild("replion")) end)
    if okR then Replion=modR end
    local okU,modU=pcall(function() return require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("ItemUtility")) end)
    if okU then ItemUtility=modU end
end)

-------------------- Rod presets & helpers --------------------
local RodDelays = {
    ["Ares Rod"]={custom=1.12,bypass=1.45},["Angler Rod"]={custom=1.12,bypass=1.45},
    ["Ghostfinn Rod"]={custom=1.12,bypass=1.45},["Astral Rod"]={custom=1.90,bypass=1.45},
    ["Chrome Rod"]={custom=2.30,bypass=2.00},["Steampunk Rod"]={custom=2.50,bypass=2.30},
    ["Lucky Rod"]={custom=3.50,bypass=3.60},["Midnight Rod"]={custom=3.30,bypass=3.40},
    ["Demascus Rod"]={custom=3.90,bypass=3.80},["Grass Rod"]={custom=3.80,bypass=3.90},
    ["Luck Rod"]={custom=4.20,bypass=4.10},["Carbon Rod"]={custom=4.00,bypass=3.80},
    ["Lava Rod"]={custom=4.20,bypass=4.10},["Starter Rod"]={custom=4.30,bypass=4.20},
}
local function getEquippedRodName()
    local pg=LocalPlayer:FindFirstChild("PlayerGui")
    local display=pg and pg:FindFirstChild("Backpack") and pg.Backpack:FindFirstChild("Display")
    if not display then return nil end
    for _,tile in ipairs(display:GetChildren()) do
        local ok,lbl=pcall(function() return tile.Inner.Tags.ItemName end)
        if ok and lbl and lbl:IsA("TextLabel") and RodDelays[lbl.Text] then return lbl.Text end
    end
    return nil
end
local function refreshRodDelays()
    local rod=getEquippedRodName()
    if rod and RodDelays[rod] then
        state.completePreset=RodDelays[rod].custom
        state.reelPreset    =RodDelays[rod].bypass
    else
        state.completePreset=10; state.reelPreset=1
    end
end

-------------------- Auto-finish by text effect --------------------
task.spawn(function()
    repeat task.wait() until RE_RepText ~= nil
    if not RE_RepText then return end
    RE_RepText.OnClientEvent:Connect(function(data)
        if not (state.AFon and state.AFfishing) then return end
        if not (data and data.TextData and data.TextData.EffectType=="Exclaim") then return end
        local head=LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Head")
        if head and data.Container==head then
            task.spawn(function()
                local _,rEff=effDelays()
                task.wait(rEff)
                pcall(function() if RE_FishingCompleted then RE_FishingCompleted:FireServer() end end)
            end)
        end
    end)
end)

-------------------- AutoFish core --------------------
function StartAutoFish()
    if state.AFon then return end
    state.AFon=true; refreshRodDelays()
    task.spawn(function()
        while state.AFon do
            pcall(function()
                state.AFfishing=true
                if RE_EquipHotbar then RE_EquipHotbar:FireServer(1) end
                task.wait(0.05)
                local ts=workspace:GetServerTimeNow()
                if RF_ChargeFishingRod then RF_ChargeFishingRod:InvokeServer(ts) end
                task.wait(0.2)
                if AShake then AShake:Play() end
                pcall(function() if RF_ChargeFishingRod then RF_ChargeFishingRod:InvokeServer(workspace:GetServerTimeNow()) end end)
                local bx,by=-0.7499996423721313,1
                local x,y
                if state.perfectCast then
                    x = bx+(math.random(-500,500)/1e7); y = by+(math.random(-500,500)/1e7)
                else
                    x = math.random(-1000,1000)/1000; y = math.random(0,1000)/1000
                end
                if AIdle then AIdle:Play() end
                if RF_RequestMinigame then RF_RequestMinigame:InvokeServer(x,y) end
                local cEff=effDelays()
                task.wait(cEff)
                state.AFfishing=false
                refreshRodDelays()
            end)
            task.wait(0.05)
        end
    end)
end
function StopAutoFish()
    state.AFon=false; state.AFfishing=false
    pcall(function() if AIdle then AIdle:Stop() end; if AReel then AReel:Stop() end; if AShake then AShake:Stop() end end)
end

-------------------- Inventory helpers --------------------
task.spawn(function()
    local okR,modR=pcall(function() return require(ReplicatedStorage:WaitForChild("Packages"):WaitForChild("replion")) end)
    if okR then Replion=modR end
    local okU,modU=pcall(function() return require(ReplicatedStorage:WaitForChild("Modules"):WaitForChild("ItemUtility")) end)
    if okU then ItemUtility=modU end
end)
local function protectByTiers()
    if not (Replion and ItemUtility) then return end
    local Data=Replion.Client:WaitReplion("Data")
    local items=Data and Data:Get({"Inventory","Items"})
    if type(items)~="table" then return end
    for _,it in ipairs(items) do
        local base=ItemUtility:GetItemData(it.Id)
        local tier=base and base.Data and tostring(base.Data.Tier)
        if tier and state.protectTiers[tier] and not it.Favorited then it.Favorited=true end
    end
end
local function sellAllNonFav()
    protectByTiers(); task.wait(0.15)
    if RF_SellAll then pcall(function() RF_SellAll:InvokeServer() end) end
end
task.spawn(function()
    while true do
        if state.AutoSell.on and (os.time()-state.AutoSell.last>=45) and Replion then
            local cnt=0; local Data=Replion.Client:WaitReplion("Data"); local items=Data and Data:Get({"Inventory","Items"})
            if type(items)=="table" then for _,it in ipairs(items) do if not it.Favorited then cnt += (it.Count or 1) end end end
            if cnt>=state.AutoSell.threshold then sellAllNonFav(); state.AutoSell.last=os.time() end
        end
        task.wait(8)
    end
end)

-------------------- FPS Boost --------------------
local function BoostFPS(on)
    if on then
        for _,v in ipairs(game:GetDescendants()) do
            if v:IsA("BasePart") then v.Material=Enum.Material.SmoothPlastic; v.Reflectance=0
            elseif v:IsA("Decal") or v:IsA("Texture") then v.Transparency=1 end
        end
        for _,e in ipairs(Lighting:GetChildren()) do if e:IsA("PostEffect") then e.Enabled=false end end
        Lighting.GlobalShadows=false; Lighting.FogEnd=1e9
        settings().Rendering.QualityLevel="Level01"
    end
end

-------------------- Teleport spots --------------------
local islandCoords={
    ["Weather Machine"]=Vector3.new(-1471,-3,1929),["Esoteric Depths"]=Vector3.new(3157,-1303,1439),
    ["Tropical Grove"]=Vector3.new(-2038,3,3650),  ["Stingray Shores"]=Vector3.new(-32,4,2773),
    ["Kohana Volcano"]=Vector3.new(-519,24,189),   ["Coral Reefs"]=Vector3.new(-3095,1,2177),
    ["Crater Island"]=Vector3.new(968,1,4854),     ["Kohana"]=Vector3.new(-658,3,719),
    ["Winter Fest"]=Vector3.new(1611,4,3280),      ["Isoteric Island"]=Vector3.new(1987,4,1400),
    ["Treasure Hall"]=Vector3.new(-3600,-267,-1558),["Lost Shore"]=Vector3.new(-3663,38,-989),
    ["Sishypus Statue"]=Vector3.new(-3792,-135,-986),
}
local tpNames={}; for n,_ in pairs(islandCoords) do table.insert(tpNames,n) end; table.sort(tpNames)

----------------------------------------------------------------
-- ===================== VANIS UI ==============================
----------------------------------------------------------------
local library = loadstring(game:HttpGet('https://raw.githubusercontent.com/rendy45kz/vir/main/tesfish.lua'))()
local Window  = library:CreateWindow("AegisHub • Fish It", "v2", 10044538000)

-- Satu TAB saja → banyak FRAME (supaya semua menu muncul)
local Tab      = Window:CreateTab("AegisHub")
local PageMain = Tab:CreateFrame("Main")
local PageInv  = Tab:CreateFrame("Inventory")
local PageTP   = Tab:CreateFrame("Teleport")
local PageMisc = Tab:CreateFrame("Misc")

-------------------- MAIN --------------------
local LiveLabel = PageMain:CreateLabel("Rod: ?  • Reel: -  • Cmpl: -  • Spd: 5x")

PageMain:CreateToggle("Auto Fish (per-rod)", "Mulai/berhenti auto fish", function(v)
    if v then StartAutoFish() else StopAutoFish() end
end)
PageMain:CreateToggle("Perfect Cast", "Lemparan presisi", function(v) state.perfectCast = v end)
PageMain:CreateBox("Speed x (1–5, default 5)", 10044538000, function(t)
    local n=tonumber(t) or 5; state.SPEED=math.clamp(math.floor(n+0.5),1,5)
end)
PageMain:CreateBox("Override Reel Delay (opsional, ex: 1.45)", 10044538000, function(t)
    state.reelOverride = tonumber(t)
end)
PageMain:CreateBox("Override Complete Delay (opsional, ex: 3.2)", 10044538000, function(t)
    state.completeOverride = tonumber(t)
end)

-------------------- INVENTORY --------------------
PageInv:CreateToggle("Auto Sell (≥ Threshold)", "Jual otomatis saat cukup", function(v) state.AutoSell.on=v end)
PageInv:CreateBox("Threshold Auto Sell (default 60)", 10044538000, function(t)
    local n=tonumber(t); if n then state.AutoSell.threshold = math.max(1, math.floor(n)) end
end)
PageInv:CreateButton("Protect High Tiers", "Fav Legendary/Mythic/Secret", function()
    state.protectTiers.Legendary=true; state.protectTiers.Mythic=true; state.protectTiers.Secret=true; protectByTiers()
end)
PageInv:CreateButton("Sell Non-Favorite", "Jual semua non-fav", function() sellAllNonFav() end)
for _,tier in ipairs({"Common","Uncommon","Rare","Epic","Legendary","Mythic","Secret"}) do
    PageInv:CreateToggle("Protect "..tier, "Tandai tier ini sebagai favorit", function(v) state.protectTiers[tier]=v end)
end

-------------------- TELEPORT --------------------
local function tpTo(vec)
    local cf = workspace:FindFirstChild("Characters")
    local ch = cf and cf:FindFirstChild(LocalPlayer.Name)
    local hrp = ch and (ch:FindFirstChild("HumanoidRootPart") or ch:WaitForChild("HumanoidRootPart",2))
    if hrp and vec then hrp.CFrame = CFrame.new(vec + Vector3.new(0,5,0)) end
end
for _,name in ipairs(tpNames) do
    PageTP:CreateButton("Teleport: "..name, "Pergi ke "..name, function() tpTo(islandCoords[name]) end)
end
if game.PlaceId ~= TARGET_PLACE then
    PageTP:CreateButton("Teleport ke Fish It", "Masuk ke game Fish It", function()
        TeleportService:Teleport(TARGET_PLACE, LocalPlayer)
    end)
end

-------------------- MISC --------------------
PageMisc:CreateToggle("Anti-AFK", "Cegah idle kick", function(v) setAntiAFK(v) end)
PageMisc:CreateToggle("FPS Boost", "Kurangi efek visual untuk performa", function(v) BoostFPS(v) end)
PageMisc:CreateButton("Rejoin", "Masuk ulang server saat ini", function()
    TeleportService:Teleport(game.PlaceId, LocalPlayer)
end)
PageMisc:CreateButton("Server Hop", "Pindah server publik kosong", function()
    local placeId=game.PlaceId; local servers,cursor={}, ""
    for _=1,3 do
        local url="https://games.roblox.com/v1/games/"..placeId.."/servers/Public?sortOrder=Asc&limit=100"..(cursor~="" and("&cursor="..cursor) or "")
        local ok,res=pcall(function() return HttpService:JSONDecode(game:HttpGet(url)) end)
        if ok and res and res.data then
            for _,sv in ipairs(res.data) do if sv.playing<sv.maxPlayers and sv.id~=game.JobId then table.insert(servers,sv.id) end end
            cursor=res.nextPageCursor or ""; if #servers>0 then break end
        else break end
    end
    if #servers>0 then TeleportService:TeleportToPlaceInstance(placeId, servers[math.random(1,#servers)], LocalPlayer) end
end)

-------------------- Live label (HUD di dalam UI) --------------------
RS.RenderStepped:Connect(function()
    local rod=getEquippedRodName() or "?"
    local cEff,rEff=effDelays()
    pcall(function()
        if LiveLabel and LiveLabel.UpdateLabel then
            LiveLabel:UpdateLabel(("Rod: %s  • Reel: %.2fs  • Cmpl: %.2fs  • Spd: %dx")
                :format(rod, rEff, cEff, state.SPEED))
        end
    end)
end)

-------------------- Refresh preset saat backpack update --------------------
task.spawn(function()
    local pg=LocalPlayer:WaitForChild("PlayerGui")
    local display=pg:WaitForChild("Backpack"):WaitForChild("Display")
    display.ChildAdded:Connect(function()
        task.wait(0.05)
        local rod=getEquippedRodName()
        if rod and RodDelays[rod] then
            state.completePreset=RodDelays[rod].custom
            state.reelPreset    =RodDelays[rod].bypass
        end
    end)
end)

----------------------------------------------------------------
-- ========== Overlay Toggle (Neon, Draggable) ==========
----------------------------------------------------------------
do
    local ToggleSG = Instance.new("ScreenGui")
    ToggleSG.Name = "AegisHub_OverlayToggle"; ToggleSG.IgnoreGuiInset=true; ToggleSG.ResetOnSpawn=false; mount(ToggleSG)

    local Btn = Instance.new("TextButton")
    Btn.Parent = ToggleSG
    Btn.Text = "A"
    Btn.Font = Enum.Font.GothamBold
    Btn.TextSize = 18
    Btn.TextColor3 = Color3.fromRGB(10,10,10)
    Btn.BackgroundColor3 = Color3.fromRGB(95,255,190) -- neon-ish
    Btn.AutoButtonColor = true
    Btn.Size = UDim2.fromOffset(40,40)
    Btn.Position = UDim2.new(0, 18, 0.5, -20)
    local corner = Instance.new("UICorner", Btn); corner.CornerRadius = UDim.new(1,0)
    local stroke = Instance.new("UIStroke", Btn); stroke.Thickness=2; stroke.Color=Color3.fromRGB(20,60,50); stroke.ApplyStrokeMode=Enum.ApplyStrokeMode.Border

    -- drag
    local dragging, start, origin
    Btn.InputBegan:Connect(function(i)
        if i.UserInputType==Enum.UserInputType.MouseButton1 or i.UserInputType==Enum.UserInputType.Touch then
            dragging=true; start=i.Position; origin=Btn.Position
            i.Changed:Connect(function() if i.UserInputState==Enum.UserInputState.End then dragging=false end end)
        end
    end)
    UIS.InputChanged:Connect(function(i)
        if dragging and (i.UserInputType==Enum.UserInputType.MouseMovement or i.UserInputType==Enum.UserInputType.Touch) then
            local delta = i.Position - start
            Btn.Position = UDim2.new(origin.X.Scale, origin.X.Offset + delta.X, origin.Y.Scale, origin.Y.Offset + delta.Y)
        end
    end)

    local visible = true
    Btn.MouseButton1Click:Connect(function()
        visible = not visible
        -- Vanis tidak expose ScreenGui langsung; kita sembunyikan semua descendants dari CoreGui bertema Vanis
        for _,g in ipairs(CoreGui:GetChildren()) do
            if g:IsA("ScreenGui") and g.Name:find("Vanis") then g.Enabled = visible end
        end
        Btn.Text = visible and "A" or "▶"
    end)
end
-- end
